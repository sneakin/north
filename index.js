(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){
var colors={};module.exports=colors,colors.themes={};var util=require("util"),ansiStyles=colors.styles=require("./styles"),defineProps=Object.defineProperties,newLineRegex=new RegExp(/[\r\n]+/g);colors.supportsColor=require("./system/supports-colors").supportsColor,void 0===colors.enabled&&(colors.enabled=!1!==colors.supportsColor()),colors.enable=function(){colors.enabled=!0},colors.disable=function(){colors.enabled=!1},colors.stripColors=colors.strip=function(e){return(""+e).replace(/\x1B\[\d+m/g,"")};var stylize=colors.stylize=function(e,o){return colors.enabled?ansiStyles[o].open+e+ansiStyles[o].close:e+""},matchOperatorsRe=/[|\\{}()[\]^$+*?.]/g,escapeStringRegexp=function(e){if("string"!=typeof e)throw new TypeError("Expected a string");return e.replace(matchOperatorsRe,"\\$&")};function build(e){var o=function e(){return applyStyle.apply(e,arguments)};return o._styles=e,o.__proto__=proto,o}var styles=function(){var e={};return ansiStyles.grey=ansiStyles.gray,Object.keys(ansiStyles).forEach(function(o){ansiStyles[o].closeRe=new RegExp(escapeStringRegexp(ansiStyles[o].close),"g"),e[o]={get:function(){return build(this._styles.concat(o))}}}),e}(),proto=defineProps(function(){},styles);function applyStyle(){var e=Array.prototype.slice.call(arguments).map(function(e){return void 0!==e&&e.constructor===String?e:util.inspect(e)}).join(" ");if(!colors.enabled||!e)return e;for(var o=-1!=e.indexOf("\n"),r=this._styles,s=r.length;s--;){var n=ansiStyles[r[s]];e=n.open+e.replace(n.closeRe,n.open)+n.close,o&&(e=e.replace(newLineRegex,function(e){return n.close+e+n.open}))}return e}function init(){var e={};return Object.keys(styles).forEach(function(o){e[o]={get:function(){return build([o])}}}),e}colors.setTheme=function(e){if("string"!=typeof e)for(var o in e)!function(o){colors[o]=function(r){if("object"==typeof e[o]){var s=r;for(var n in e[o])s=colors[e[o][n]](s);return s}return colors[e[o]](r)}}(o);else console.log("colors.setTheme now only accepts an object, not a string.  If you are trying to set a theme from a file, it is now your (the caller's) responsibility to require the file.  The old syntax looked like colors.setTheme(__dirname + '/../themes/generic-logging.js'); The new syntax looks like colors.setTheme(require(__dirname + '/../themes/generic-logging.js'));")};var sequencer=function(e,o){var r=o.split("");return(r=r.map(e)).join("")};for(var map in colors.trap=require("./custom/trap"),colors.zalgo=require("./custom/zalgo"),colors.maps={},colors.maps.america=require("./maps/america")(colors),colors.maps.zebra=require("./maps/zebra")(colors),colors.maps.rainbow=require("./maps/rainbow")(colors),colors.maps.random=require("./maps/random")(colors),colors.maps)!function(e){colors[e]=function(o){return sequencer(colors.maps[e],o)}}(map);defineProps(colors,init());

},{"./custom/trap":2,"./custom/zalgo":3,"./maps/america":4,"./maps/rainbow":5,"./maps/random":6,"./maps/zebra":7,"./styles":8,"./system/supports-colors":10,"util":120}],2:[function(require,module,exports){
module.exports=function(o,r){var t="";o=(o=o||"Run the trap, drop the bass").split("");var a={a:["@","Ä„","Èº","É…","Î”","Î›","Ð”"],b:["ÃŸ","Æ","Éƒ","É®","Î²","à¸¿"],c:["Â©","È»","Ï¾"],d:["Ã","ÆŠ","Ô€","Ô","Ô‚","Ôƒ"],e:["Ã‹","Ä•","ÆŽ","É˜","Î£","Î¾","Ò¼","à©¬"],f:["Óº"],g:["É¢"],h:["Ä¦","Æ•","Ò¢","Òº","Ó‡","ÔŠ"],i:["à¼"],j:["Ä´"],k:["Ä¸","Ò ","Óƒ","Ôž"],l:["Ä¹"],m:["Ê","Ó","ÓŽ","Ô ","Ô¡","àµ©"],n:["Ã‘","Å‹","Æ","Í¶","Î ","ÒŠ"],o:["Ã˜","Ãµ","Ã¸","Ç¾","Ê˜","Ñº","×","Û","à¹"],p:["Ç·","ÒŽ"],q:["à§"],r:["Â®","Æ¦","È","ÉŒ","Ê€","Ð¯"],s:["Â§","Ïž","ÏŸ","Ï¨"],t:["Å","Å¦","Í³"],u:["Æ±","Õ"],v:["×˜"],w:["Ð¨","Ñ ","Ñ¼","àµ°"],x:["Ò²","Ó¾","Ó¼","Ó½"],y:["Â¥","Ò°","Ó‹"],z:["Æµ","É€"]};return o.forEach(function(o){o=o.toLowerCase();var r=a[o]||[" "],e=Math.floor(Math.random()*r.length);t+=void 0!==a[o]?a[o][e]:o}),t};

},{}],3:[function(require,module,exports){
module.exports=function(i,n){i=i||"   he is here   ";var o={up:["Ì","ÌŽ","Ì„","Ì…","Ì¿","Ì‘","Ì†","Ì","Í’","Í—","Í‘","Ì‡","Ìˆ","ÌŠ","Í‚","Ì“","Ìˆ","ÍŠ","Í‹","ÍŒ","Ìƒ","Ì‚","ÌŒ","Í","Ì€","Ì","Ì‹","Ì","Ì’","Ì“","Ì”","Ì½","Ì‰","Í£","Í¤","Í¥","Í¦","Í§","Í¨","Í©","Íª","Í«","Í¬","Í­","Í®","Í¯","Ì¾","Í›","Í†","Ìš"],down:["Ì–","Ì—","Ì˜","Ì™","Ìœ","Ì","Ìž","ÌŸ","Ì ","Ì¤","Ì¥","Ì¦","Ì©","Ìª","Ì«","Ì¬","Ì­","Ì®","Ì¯","Ì°","Ì±","Ì²","Ì³","Ì¹","Ìº","Ì»","Ì¼","Í…","Í‡","Íˆ","Í‰","Í","ÍŽ","Í“","Í”","Í•","Í–","Í™","Íš","Ì£"],mid:["Ì•","Ì›","Ì€","Ì","Í˜","Ì¡","Ì¢","Ì§","Ì¨","Ì´","Ìµ","Ì¶","Íœ","Í","Íž","ÍŸ","Í ","Í¢","Ì¸","Ì·","Í¡"," Ò‰"]},d=[].concat(o.up,o.down,o.mid);function r(i){return Math.floor(Math.random()*i)}function u(i){var n=!1;return d.filter(function(o){n=o===i}),n}return function(i,n){var d,e,t="";for(e in(n=n||{}).up=void 0===n.up||n.up,n.mid=void 0===n.mid||n.mid,n.down=void 0===n.down||n.down,n.size=void 0!==n.size?n.size:"maxi",i=i.split(""))if(!u(e)){switch(t+=i[e],d={up:0,down:0,mid:0},n.size){case"mini":d.up=r(8),d.mid=r(2),d.down=r(8);break;case"maxi":d.up=r(16)+3,d.mid=r(4)+1,d.down=r(64)+3;break;default:d.up=r(8)+1,d.mid=r(6)/2,d.down=r(8)+1}var a=["up","mid","down"];for(var m in a)for(var f=a[m],p=0;p<=d[f];p++)n[f]&&(t+=o[f][r(o[f].length)])}return t}(i,n)};

},{}],4:[function(require,module,exports){
module.exports=function(e){return function(r,t,n){if(" "===r)return r;switch(t%3){case 0:return e.red(r);case 1:return e.white(r);case 2:return e.blue(r)}}};

},{}],5:[function(require,module,exports){
module.exports=function(e){var n=["red","yellow","green","blue","magenta"];return function(r,t,u){return" "===r?r:e[n[t++%n.length]](r)}};

},{}],6:[function(require,module,exports){
module.exports=function(e){var n=["underline","inverse","grey","yellow","red","green","blue","white","cyan","magenta"];return function(r,t,u){return" "===r?r:e[n[Math.round(Math.random()*(n.length-2))]](r)}};

},{}],7:[function(require,module,exports){
module.exports=function(n){return function(e,r,t){return r%2==0?e:n.inverse(e)}};

},{}],8:[function(require,module,exports){
var styles={};module.exports=styles;var codes={reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],inverse:[7,27],hidden:[8,28],strikethrough:[9,29],black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],grey:[90,39],bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],blackBG:[40,49],redBG:[41,49],greenBG:[42,49],yellowBG:[43,49],blueBG:[44,49],magentaBG:[45,49],cyanBG:[46,49],whiteBG:[47,49]};Object.keys(codes).forEach(function(e){var l=codes[e],a=styles[e]=[];a.open="["+l[0]+"m",a.close="["+l[1]+"m"});

},{}],9:[function(require,module,exports){
(function (process){
"use strict";module.exports=function(e,r){var t=(r=r||process.argv).indexOf("--"),s=/^-{1,2}/.test(e)?"":"--",n=r.indexOf(s+e);return-1!==n&&(-1===t||n<t)};

}).call(this,require('_process'))
},{"_process":118}],10:[function(require,module,exports){
(function (process){
"use strict";var os=require("os"),hasFlag=require("./has-flag.js"),env=process.env,forceColor=void 0;function translateLevel(r){return 0!==r&&{level:r,hasBasic:!0,has256:r>=2,has16m:r>=3}}function supportsColor(r){if(!1===forceColor)return 0;if(hasFlag("color=16m")||hasFlag("color=full")||hasFlag("color=truecolor"))return 3;if(hasFlag("color=256"))return 2;if(r&&!r.isTTY&&!0!==forceColor)return 0;var e=forceColor?1:0;if("win32"===process.platform){var o=os.release().split(".");return Number(process.versions.node.split(".")[0])>=8&&Number(o[0])>=10&&Number(o[2])>=10586?Number(o[2])>=14931?3:2:1}if("CI"in env)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI"].some(function(r){return r in env})||"codeship"===env.CI_NAME?1:e;if("TEAMCITY_VERSION"in env)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(env.TEAMCITY_VERSION)?1:0;if("TERM_PROGRAM"in env){var s=parseInt((env.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(env.TERM_PROGRAM){case"iTerm.app":return s>=3?3:2;case"Hyper":return 3;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(env.TERM)?2:/^screen|^xterm|^vt100|^rxvt|color|ansi|cygwin|linux/i.test(env.TERM)?1:"COLORTERM"in env?1:(env.TERM,e)}function getSupportLevel(r){return translateLevel(supportsColor(r))}hasFlag("no-color")||hasFlag("no-colors")||hasFlag("color=false")?forceColor=!1:(hasFlag("color")||hasFlag("colors")||hasFlag("color=true")||hasFlag("color=always"))&&(forceColor=!0),"FORCE_COLOR"in env&&(forceColor=0===env.FORCE_COLOR.length||0!==parseInt(env.FORCE_COLOR,10)),module.exports={supportsColor:getSupportLevel,stdout:getSupportLevel(process.stdout),stderr:getSupportLevel(process.stderr)};

}).call(this,require('_process'))
},{"./has-flag.js":9,"_process":118,"os":117}],11:[function(require,module,exports){
var colors=require("./lib/colors");module.exports=colors;

},{"./lib/colors":1}],12:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Strings=require("./Strings"),Browser_1=require("./shared/utils/Browser"),RenderDebouncer_1=require("./ui/RenderDebouncer"),Lifecycle_1=require("./ui/Lifecycle"),Lifecycle_2=require("./common/Lifecycle"),MAX_ROWS_TO_READ=20,AccessibilityManager=function(e){function t(t){var i=e.call(this)||this;i._terminal=t,i._liveRegionLineCount=0,i._charsToConsume=[],i._accessibilityTreeRoot=document.createElement("div"),i._accessibilityTreeRoot.classList.add("xterm-accessibility"),i._rowContainer=document.createElement("div"),i._rowContainer.classList.add("xterm-accessibility-tree"),i._rowElements=[];for(var r=0;r<i._terminal.rows;r++)i._rowElements[r]=i._createAccessibilityTreeNode(),i._rowContainer.appendChild(i._rowElements[r]);return i._topBoundaryFocusListener=function(e){return i._onBoundaryFocus(e,0)},i._bottomBoundaryFocusListener=function(e){return i._onBoundaryFocus(e,1)},i._rowElements[0].addEventListener("focus",i._topBoundaryFocusListener),i._rowElements[i._rowElements.length-1].addEventListener("focus",i._bottomBoundaryFocusListener),i._refreshRowsDimensions(),i._accessibilityTreeRoot.appendChild(i._rowContainer),i._renderRowsDebouncer=new RenderDebouncer_1.RenderDebouncer(i._terminal,i._renderRows.bind(i)),i._refreshRows(),i._liveRegion=document.createElement("div"),i._liveRegion.classList.add("live-region"),i._liveRegion.setAttribute("aria-live","assertive"),i._accessibilityTreeRoot.appendChild(i._liveRegion),i._terminal.element.insertAdjacentElement("afterbegin",i._accessibilityTreeRoot),i.register(i._renderRowsDebouncer),i.register(i._terminal.addDisposableListener("resize",function(e){return i._onResize(e.rows)})),i.register(i._terminal.addDisposableListener("refresh",function(e){return i._refreshRows(e.start,e.end)})),i.register(i._terminal.addDisposableListener("scroll",function(e){return i._refreshRows()})),i.register(i._terminal.addDisposableListener("a11y.char",function(e){return i._onChar(e)})),i.register(i._terminal.addDisposableListener("linefeed",function(){return i._onChar("\n")})),i.register(i._terminal.addDisposableListener("a11y.tab",function(e){return i._onTab(e)})),i.register(i._terminal.addDisposableListener("key",function(e){return i._onKey(e)})),i.register(i._terminal.addDisposableListener("blur",function(){return i._clearLiveRegion()})),i.register(i._terminal.addDisposableListener("dprchange",function(){return i._refreshRowsDimensions()})),i.register(i._terminal.renderer.addDisposableListener("resize",function(){return i._refreshRowsDimensions()})),i.register(Lifecycle_1.addDisposableDomListener(window,"resize",function(){return i._refreshRowsDimensions()})),i}return __extends(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this),this._terminal.element.removeChild(this._accessibilityTreeRoot),this._rowElements.length=0},t.prototype._onBoundaryFocus=function(e,t){var i=e.target,r=this._rowElements[0===t?1:this._rowElements.length-2];if(i.getAttribute("aria-posinset")!==(0===t?"1":""+this._terminal.buffer.lines.length)&&e.relatedTarget===r){var n,s;if(0===t?(n=i,s=this._rowElements.pop(),this._rowContainer.removeChild(s)):(n=this._rowElements.shift(),s=i,this._rowContainer.removeChild(n)),n.removeEventListener("focus",this._topBoundaryFocusListener),s.removeEventListener("focus",this._bottomBoundaryFocusListener),0===t){var o=this._createAccessibilityTreeNode();this._rowElements.unshift(o),this._rowContainer.insertAdjacentElement("afterbegin",o)}else{o=this._createAccessibilityTreeNode();this._rowElements.push(o),this._rowContainer.appendChild(o)}this._rowElements[0].addEventListener("focus",this._topBoundaryFocusListener),this._rowElements[this._rowElements.length-1].addEventListener("focus",this._bottomBoundaryFocusListener),this._terminal.scrollLines(0===t?-1:1),this._rowElements[0===t?1:this._rowElements.length-2].focus(),e.preventDefault(),e.stopImmediatePropagation()}},t.prototype._onResize=function(e){this._rowElements[this._rowElements.length-1].removeEventListener("focus",this._bottomBoundaryFocusListener);for(var t=this._rowContainer.children.length;t<this._terminal.rows;t++)this._rowElements[t]=this._createAccessibilityTreeNode(),this._rowContainer.appendChild(this._rowElements[t]);for(;this._rowElements.length>e;)this._rowContainer.removeChild(this._rowElements.pop());this._rowElements[this._rowElements.length-1].addEventListener("focus",this._bottomBoundaryFocusListener),this._refreshRowsDimensions()},t.prototype._createAccessibilityTreeNode=function(){var e=document.createElement("div");return e.setAttribute("role","listitem"),e.tabIndex=-1,this._refreshRowDimensions(e),e},t.prototype._onTab=function(e){for(var t=0;t<e;t++)this._onChar(" ")},t.prototype._onChar=function(e){var t=this;if(this._liveRegionLineCount<MAX_ROWS_TO_READ+1){if(this._charsToConsume.length>0)this._charsToConsume.shift()!==e&&this._announceCharacter(e);else this._announceCharacter(e);"\n"===e&&(this._liveRegionLineCount++,this._liveRegionLineCount===MAX_ROWS_TO_READ+1&&(this._liveRegion.textContent+=Strings.tooMuchOutput)),Browser_1.isMac&&this._liveRegion.textContent&&this._liveRegion.textContent.length>0&&!this._liveRegion.parentNode&&setTimeout(function(){t._accessibilityTreeRoot.appendChild(t._liveRegion)},0)}},t.prototype._clearLiveRegion=function(){this._liveRegion.textContent="",this._liveRegionLineCount=0,Browser_1.isMac&&this._liveRegion.parentNode&&this._accessibilityTreeRoot.removeChild(this._liveRegion)},t.prototype._onKey=function(e){this._clearLiveRegion(),this._charsToConsume.push(e)},t.prototype._refreshRows=function(e,t){this._renderRowsDebouncer.refresh(e,t)},t.prototype._renderRows=function(e,t){for(var i=this._terminal.buffer,r=i.lines.length.toString(),n=e;n<=t;n++){var s=i.translateBufferLineToString(i.ydisp+n,!0),o=(i.ydisp+n+1).toString(),a=this._rowElements[n];a.textContent=0===s.length?Strings.blankLine:s,a.setAttribute("aria-posinset",o),a.setAttribute("aria-setsize",r)}},t.prototype._refreshRowsDimensions=function(){if(this._terminal.renderer.dimensions.actualCellHeight){this._rowElements.length!==this._terminal.rows&&this._onResize(this._terminal.rows);for(var e=0;e<this._terminal.rows;e++)this._refreshRowDimensions(this._rowElements[e])}},t.prototype._refreshRowDimensions=function(e){e.style.height=this._terminal.renderer.dimensions.actualCellHeight+"px"},t.prototype._announceCharacter=function(e){" "===e?this._liveRegion.innerHTML+="&nbsp;":this._liveRegion.textContent+=e},t}(Lifecycle_2.Disposable);exports.AccessibilityManager=AccessibilityManager;

},{"./Strings":24,"./common/Lifecycle":29,"./shared/utils/Browser":57,"./ui/Lifecycle":59,"./ui/RenderDebouncer":61}],13:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var t=function(e,s){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s])})(e,s)};return function(e,s){function r(){this.constructor=e}t(e,s),e.prototype=null===s?Object.create(s):(r.prototype=s.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var CircularList_1=require("./common/CircularList"),EventEmitter_1=require("./common/EventEmitter"),BufferLine_1=require("./BufferLine");exports.DEFAULT_ATTR=131840,exports.CHAR_DATA_ATTR_INDEX=0,exports.CHAR_DATA_CHAR_INDEX=1,exports.CHAR_DATA_WIDTH_INDEX=2,exports.CHAR_DATA_CODE_INDEX=3,exports.MAX_BUFFER_SIZE=4294967295,exports.NULL_CELL_CHAR=" ",exports.NULL_CELL_WIDTH=1,exports.NULL_CELL_CODE=32;var Buffer=function(){function t(t,e){this._terminal=t,this._hasScrollback=e,this.markers=[],this.clear()}return Object.defineProperty(t.prototype,"hasScrollback",{get:function(){return this._hasScrollback&&this.lines.maxLength>this._terminal.rows},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isCursorInViewport",{get:function(){var t=this.ybase+this.y-this.ydisp;return t>=0&&t<this._terminal.rows},enumerable:!0,configurable:!0}),t.prototype._getCorrectBufferLength=function(t){if(!this._hasScrollback)return t;var e=t+this._terminal.options.scrollback;return e>exports.MAX_BUFFER_SIZE?exports.MAX_BUFFER_SIZE:e},t.prototype.fillViewportRows=function(){if(0===this.lines.length)for(var t=this._terminal.rows;t--;)this.lines.push(BufferLine_1.BufferLine.blankLine(this._terminal.cols,exports.DEFAULT_ATTR))},t.prototype.clear=function(){this.ydisp=0,this.ybase=0,this.y=0,this.x=0,this.lines=new CircularList_1.CircularList(this._getCorrectBufferLength(this._terminal.rows)),this.scrollTop=0,this.scrollBottom=this._terminal.rows-1,this.setupTabStops()},t.prototype.resize=function(t,e){var s=this._getCorrectBufferLength(e);if(s>this.lines.maxLength&&(this.lines.maxLength=s),this.lines.length>0){if(this._terminal.cols<t)for(var r=[exports.DEFAULT_ATTR,exports.NULL_CELL_CHAR,exports.NULL_CELL_WIDTH,exports.NULL_CELL_CODE],i=0;i<this.lines.length;i++)for(;this.lines.get(i).length<t;)this.lines.get(i).push(r);var n=0;if(this._terminal.rows<e)for(var o=this._terminal.rows;o<e;o++)this.lines.length<e+this.ybase&&(this.ybase>0&&this.lines.length<=this.ybase+this.y+n+1?(this.ybase--,n++,this.ydisp>0&&this.ydisp--):this.lines.push(BufferLine_1.BufferLine.blankLine(t,exports.DEFAULT_ATTR)));else for(o=this._terminal.rows;o>e;o--)this.lines.length>e+this.ybase&&(this.lines.length>this.ybase+this.y+1?this.lines.pop():(this.ybase++,this.ydisp++));if(s<this.lines.maxLength){var h=this.lines.length-s;h>0&&(this.lines.trimStart(h),this.ybase=Math.max(this.ybase-h,0),this.ydisp=Math.max(this.ydisp-h,0)),this.lines.maxLength=s}this.x=Math.min(this.x,t-1),this.y=Math.min(this.y,e-1),n&&(this.y+=n),this.savedY=Math.min(this.savedY,e-1),this.savedX=Math.min(this.savedX,t-1),this.scrollTop=0}this.scrollBottom=e-1},t.prototype.stringIndexToBufferIndex=function(t,e){for(;e;){for(var s=this.lines.get(t),r=0;r<s.length;++r)if((e-=s.get(r)[exports.CHAR_DATA_CHAR_INDEX].length)<0)return[t,r];t++}return[t,0]},t.prototype.translateBufferLineToString=function(t,e,s,r){void 0===s&&(s=0),void 0===r&&(r=null);var i="",n=this.lines.get(t);if(!n)return"";var o=s;null===r&&(r=n.length);for(var h=r,a=0;a<n.length;a++){var l=n.get(a);i+=l[exports.CHAR_DATA_CHAR_INDEX],0===l[exports.CHAR_DATA_WIDTH_INDEX]?(s>=a&&o--,r>a&&h--):l[exports.CHAR_DATA_CHAR_INDEX].length>1&&(s>a&&(o+=l[exports.CHAR_DATA_CHAR_INDEX].length-1),r>a&&(h+=l[exports.CHAR_DATA_CHAR_INDEX].length-1))}if(e){var _=i.search(/\s+$/);if(-1!==_&&(h=Math.min(h,_)),h<=o)return""}return i.substring(o,h)},t.prototype.getWrappedRangeForLine=function(t){for(var e=t,s=t;e>0&&this.lines.get(e).isWrapped;)e--;for(;s+1<this.lines.length&&this.lines.get(s+1).isWrapped;)s++;return{first:e,last:s}},t.prototype.setupTabStops=function(t){for(null!=t?this.tabs[t]||(t=this.prevStop(t)):(this.tabs={},t=0);t<this._terminal.cols;t+=this._terminal.options.tabStopWidth)this.tabs[t]=!0},t.prototype.prevStop=function(t){for(null==t&&(t=this.x);!this.tabs[--t]&&t>0;);return t>=this._terminal.cols?this._terminal.cols-1:t<0?0:t},t.prototype.nextStop=function(t){for(null==t&&(t=this.x);!this.tabs[++t]&&t<this._terminal.cols;);return t>=this._terminal.cols?this._terminal.cols-1:t<0?0:t},t.prototype.addMarker=function(t){var e=this,s=new Marker(t);return this.markers.push(s),s.register(this.lines.addDisposableListener("trim",function(t){s.line-=t,s.line<0&&s.dispose()})),s.register(s.addDisposableListener("dispose",function(){return e._removeMarker(s)})),s},t.prototype._removeMarker=function(t){this.markers.splice(this.markers.indexOf(t),1)},t.prototype.iterator=function(t,e,s,r,i){return new BufferStringIterator(this,t,e,s,r,i)},t}();exports.Buffer=Buffer;var Marker=function(t){function e(s){var r=t.call(this)||this;return r.line=s,r._id=e._nextId++,r.isDisposed=!1,r}return __extends(e,t),Object.defineProperty(e.prototype,"id",{get:function(){return this._id},enumerable:!0,configurable:!0}),e.prototype.dispose=function(){this.isDisposed||(this.isDisposed=!0,this.emit("dispose"),t.prototype.dispose.call(this))},e._nextId=1,e}(EventEmitter_1.EventEmitter);exports.Marker=Marker;var BufferStringIterator=function(){function t(t,e,s,r,i,n){void 0===s&&(s=0),void 0===r&&(r=t.lines.length),void 0===i&&(i=0),void 0===n&&(n=0),this._buffer=t,this._trimRight=e,this._startIndex=s,this._endIndex=r,this._startOverscan=i,this._endOverscan=n,this._startIndex<0&&(this._startIndex=0),this._endIndex>this._buffer.lines.length&&(this._endIndex=this._buffer.lines.length),this._current=this._startIndex}return t.prototype.hasNext=function(){return this._current<this._endIndex},t.prototype.next=function(){var t=this._buffer.getWrappedRangeForLine(this._current);t.first<this._startIndex-this._startOverscan&&(t.first=this._startIndex-this._startOverscan),t.last>this._endIndex+this._endOverscan&&(t.last=this._endIndex+this._endOverscan),t.first=Math.max(t.first,0),t.last=Math.min(t.last,this._buffer.lines.length);for(var e="",s=t.first;s<=t.last;++s)e+=this._buffer.translateBufferLineToString(s,!!this._trimRight&&s===t.last);return this._current=t.last+1,{range:t,content:e}},t}();exports.BufferStringIterator=BufferStringIterator;

},{"./BufferLine":14,"./common/CircularList":27,"./common/EventEmitter":28}],14:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Buffer_1=require("./Buffer"),BufferLine=function(){function t(t,e,r){if(this.isWrapped=!1,this._data=[],this.length=this._data.length,t){e||(e=[0,Buffer_1.NULL_CELL_CHAR,Buffer_1.NULL_CELL_WIDTH,Buffer_1.NULL_CELL_CODE]);for(var i=0;i<t;i++)this.push(e)}r&&(this.isWrapped=!0)}return t.blankLine=function(e,r,i){return new t(e,[r,Buffer_1.NULL_CELL_CHAR,Buffer_1.NULL_CELL_WIDTH,Buffer_1.NULL_CELL_CODE],i)},t.prototype.get=function(t){return this._data[t]},t.prototype.set=function(t,e){this._data[t]=e},t.prototype.pop=function(){var t=this._data.pop();return this.length=this._data.length,t},t.prototype.push=function(t){this._data.push(t),this.length=this._data.length},t.prototype.splice=function(t,e){for(var r,i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];var s=(r=this._data).splice.apply(r,[t,e].concat(i));return this.length=this._data.length,s},t.prototype.insertCells=function(t,e,r){for(;e--;)this.splice(t,0,r),this.pop()},t.prototype.deleteCells=function(t,e,r){for(;e--;)this.splice(t,1),this.push(r)},t.prototype.replaceCells=function(t,e,r){for(;t<e&&t<this.length;)this.set(t++,r)},t}();exports.BufferLine=BufferLine;

},{"./Buffer":13}],15:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Buffer_1=require("./Buffer"),EventEmitter_1=require("./common/EventEmitter"),BufferSet=function(t){function e(e){var r=t.call(this)||this;return r._terminal=e,r._normal=new Buffer_1.Buffer(r._terminal,!0),r._normal.fillViewportRows(),r._alt=new Buffer_1.Buffer(r._terminal,!1),r._activeBuffer=r._normal,r.setupTabStops(),r}return __extends(e,t),Object.defineProperty(e.prototype,"alt",{get:function(){return this._alt},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"active",{get:function(){return this._activeBuffer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"normal",{get:function(){return this._normal},enumerable:!0,configurable:!0}),e.prototype.activateNormalBuffer=function(){this._activeBuffer!==this._normal&&(this._alt.clear(),this._activeBuffer=this._normal,this.emit("activate",{activeBuffer:this._normal,inactiveBuffer:this._alt}))},e.prototype.activateAltBuffer=function(){this._activeBuffer!==this._alt&&(this._alt.fillViewportRows(),this._activeBuffer=this._alt,this.emit("activate",{activeBuffer:this._alt,inactiveBuffer:this._normal}))},e.prototype.resize=function(t,e){this._normal.resize(t,e),this._alt.resize(t,e)},e.prototype.setupTabStops=function(t){this._normal.setupTabStops(t),this._alt.setupTabStops(t)},e}(EventEmitter_1.EventEmitter);exports.BufferSet=BufferSet;

},{"./Buffer":13,"./common/EventEmitter":28}],16:[function(require,module,exports){
"use strict";function getStringCellWidth(r){for(var t=0,n=0;n<r.length;++n){var e=r.charCodeAt(n);if(55296<=e&&e<=56319){var i=r.charCodeAt(n+1);if(isNaN(i))return t;e=1024*(e-55296)+(i-56320)+65536}56320<=e&&e<=57343||(t+=exports.wcwidth(e))}return t}Object.defineProperty(exports,"__esModule",{value:!0}),exports.wcwidth=function(r){var t=[[768,879],[1155,1158],[1160,1161],[1425,1469],[1471,1471],[1473,1474],[1476,1477],[1479,1479],[1536,1539],[1552,1557],[1611,1630],[1648,1648],[1750,1764],[1767,1768],[1770,1773],[1807,1807],[1809,1809],[1840,1866],[1958,1968],[2027,2035],[2305,2306],[2364,2364],[2369,2376],[2381,2381],[2385,2388],[2402,2403],[2433,2433],[2492,2492],[2497,2500],[2509,2509],[2530,2531],[2561,2562],[2620,2620],[2625,2626],[2631,2632],[2635,2637],[2672,2673],[2689,2690],[2748,2748],[2753,2757],[2759,2760],[2765,2765],[2786,2787],[2817,2817],[2876,2876],[2879,2879],[2881,2883],[2893,2893],[2902,2902],[2946,2946],[3008,3008],[3021,3021],[3134,3136],[3142,3144],[3146,3149],[3157,3158],[3260,3260],[3263,3263],[3270,3270],[3276,3277],[3298,3299],[3393,3395],[3405,3405],[3530,3530],[3538,3540],[3542,3542],[3633,3633],[3636,3642],[3655,3662],[3761,3761],[3764,3769],[3771,3772],[3784,3789],[3864,3865],[3893,3893],[3895,3895],[3897,3897],[3953,3966],[3968,3972],[3974,3975],[3984,3991],[3993,4028],[4038,4038],[4141,4144],[4146,4146],[4150,4151],[4153,4153],[4184,4185],[4448,4607],[4959,4959],[5906,5908],[5938,5940],[5970,5971],[6002,6003],[6068,6069],[6071,6077],[6086,6086],[6089,6099],[6109,6109],[6155,6157],[6313,6313],[6432,6434],[6439,6440],[6450,6450],[6457,6459],[6679,6680],[6912,6915],[6964,6964],[6966,6970],[6972,6972],[6978,6978],[7019,7027],[7616,7626],[7678,7679],[8203,8207],[8234,8238],[8288,8291],[8298,8303],[8400,8431],[12330,12335],[12441,12442],[43014,43014],[43019,43019],[43045,43046],[64286,64286],[65024,65039],[65056,65059],[65279,65279],[65529,65531]],n=[[68097,68099],[68101,68102],[68108,68111],[68152,68154],[68159,68159],[119143,119145],[119155,119170],[119173,119179],[119210,119213],[119362,119364],[917505,917505],[917536,917631],[917760,917999]];function e(r,t){var n,e=0,i=t.length-1;if(r<t[0][0]||r>t[i][1])return!1;for(;i>=e;)if(r>t[n=e+i>>1][1])e=n+1;else{if(!(r<t[n][0]))return!0;i=n-1}return!1}var i=0|r.control,o=null;return function(u){if((u|=0)<32)return 0|i;if(u<127)return 1;var f,l=o||function(){var n;o="undefined"==typeof Uint32Array?new Array(4096):new Uint32Array(4096);for(var i=0;i<4096;++i){for(var u=0,f=16;f--;)u=u<<2|(0===(n=16*i+f)?r.nul:n<32||n>=127&&n<160?r.control:e(n,t)?0:function(r){return r>=4352&&(r<=4447||9001===r||9002===r||r>=11904&&r<=42191&&12351!==r||r>=44032&&r<=55203||r>=63744&&r<=64255||r>=65040&&r<=65049||r>=65072&&r<=65135||r>=65280&&r<=65376||r>=65504&&r<=65510)}(n)?2:1);o[i]=u}return o}();return u<65536?l[u>>4]>>((15&u)<<1)&3:e(f=u,n)?0:f>=131072&&f<=196605||f>=196608&&f<=262141?2:1}}({nul:0,control:0}),exports.getStringCellWidth=getStringCellWidth;

},{}],17:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var CompositionHelper=function(){function t(t,i,e){this._textarea=t,this._compositionView=i,this._terminal=e,this._isComposing=!1,this._isSendingComposition=!1,this._compositionPosition={start:null,end:null}}return t.prototype.compositionstart=function(){this._isComposing=!0,this._compositionPosition.start=this._textarea.value.length,this._compositionView.textContent="",this._compositionView.classList.add("active")},t.prototype.compositionupdate=function(t){var i=this;this._compositionView.textContent=t.data,this.updateCompositionElements(),setTimeout(function(){i._compositionPosition.end=i._textarea.value.length},0)},t.prototype.compositionend=function(){this._finalizeComposition(!0)},t.prototype.keydown=function(t){if(this._isComposing||this._isSendingComposition){if(229===t.keyCode)return!1;if(16===t.keyCode||17===t.keyCode||18===t.keyCode)return!1;this._finalizeComposition(!1)}return 229!==t.keyCode||(this._handleAnyTextareaChanges(),!1)},t.prototype._finalizeComposition=function(t){var i=this;if(this._compositionView.classList.remove("active"),this._isComposing=!1,this._clearTextareaPosition(),t){var e={start:this._compositionPosition.start,end:this._compositionPosition.end};this._isSendingComposition=!0,setTimeout(function(){if(i._isSendingComposition){i._isSendingComposition=!1;var t=void 0;t=i._isComposing?i._textarea.value.substring(e.start,e.end):i._textarea.value.substring(e.start),i._terminal.handler(t)}},0)}else{this._isSendingComposition=!1;var o=this._textarea.value.substring(this._compositionPosition.start,this._compositionPosition.end);this._terminal.handler(o)}},t.prototype._handleAnyTextareaChanges=function(){var t=this,i=this._textarea.value;setTimeout(function(){if(!t._isComposing){var e=t._textarea.value.replace(i,"");e.length>0&&t._terminal.handler(e)}},0)},t.prototype.updateCompositionElements=function(t){var i=this;if(this._isComposing){if(this._terminal.buffer.isCursorInViewport){var e=Math.ceil(this._terminal.charMeasure.height*this._terminal.options.lineHeight),o=this._terminal.buffer.y*e,s=this._terminal.buffer.x*this._terminal.charMeasure.width;this._compositionView.style.left=s+"px",this._compositionView.style.top=o+"px",this._compositionView.style.height=e+"px",this._compositionView.style.lineHeight=e+"px";var n=this._compositionView.getBoundingClientRect();this._textarea.style.left=s+"px",this._textarea.style.top=o+"px",this._textarea.style.width=n.width+"px",this._textarea.style.height=n.height+"px",this._textarea.style.lineHeight=n.height+"px"}t||setTimeout(function(){return i.updateCompositionElements(!0)},0)}},t.prototype._clearTextareaPosition=function(){this._textarea.style.left="",this._textarea.style.top=""},t}();exports.CompositionHelper=CompositionHelper;

},{}],18:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(a,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,a){e.__proto__=a}||function(e,a){for(var r in a)a.hasOwnProperty(r)&&(e[r]=a[r])})(a,r)};return function(a,r){function n(){this.constructor=a}e(a,r),a.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Lifecycle_1=require("./common/Lifecycle");function r(e,a){for(var r=a-e,n=new Array(r);r--;)n[r]=--a;return n}var TransitionTable=function(){function e(e){this.table="undefined"==typeof Uint8Array?new Array(e):new Uint8Array(e)}return e.prototype.add=function(e,a,r,n){this.table[a<<8|e]=(0|r)<<4|(void 0===n?a:n)},e.prototype.addMany=function(e,a,r,n){for(var t=0;t<e.length;t++)this.add(e[t],a,r,n)},e}();exports.TransitionTable=TransitionTable;var PRINTABLES=r(32,127),EXECUTABLES=r(0,24);EXECUTABLES.push(25),EXECUTABLES.concat(r(28,32));var DEFAULT_TRANSITION=16;exports.VT500_TRANSITION_TABLE=function(){var e,a=new TransitionTable(4095),n=r(0,14);for(e in n)for(var t=0;t<160;++t)a.add(t,e,1,0);for(e in a.addMany(PRINTABLES,0,2,0),n)a.addMany([24,26,153,154],e,3,0),a.addMany(r(128,144),e,3,0),a.addMany(r(144,152),e,3,0),a.add(156,e,0,0),a.add(27,e,11,1),a.add(157,e,4,8),a.addMany([152,158,159],e,0,7),a.add(155,e,11,3),a.add(144,e,11,9);return a.addMany(EXECUTABLES,0,3,0),a.addMany(EXECUTABLES,1,3,1),a.add(127,1,0,1),a.addMany(EXECUTABLES,8,0,8),a.addMany(EXECUTABLES,3,3,3),a.add(127,3,0,3),a.addMany(EXECUTABLES,4,3,4),a.add(127,4,0,4),a.addMany(EXECUTABLES,6,3,6),a.addMany(EXECUTABLES,5,3,5),a.add(127,5,0,5),a.addMany(EXECUTABLES,2,3,2),a.add(127,2,0,2),a.add(93,1,4,8),a.addMany(PRINTABLES,8,5,8),a.add(127,8,5,8),a.addMany([156,27,24,26,7],8,6,0),a.addMany(r(28,32),8,0,8),a.addMany([88,94,95],1,0,7),a.addMany(PRINTABLES,7,0,7),a.addMany(EXECUTABLES,7,0,7),a.add(156,7,0,0),a.add(91,1,11,3),a.addMany(r(64,127),3,7,0),a.addMany(r(48,58),3,8,4),a.add(59,3,8,4),a.addMany([60,61,62,63],3,9,4),a.addMany(r(48,58),4,8,4),a.add(59,4,8,4),a.addMany(r(64,127),4,7,0),a.addMany([58,60,61,62,63],4,0,6),a.addMany(r(32,64),6,0,6),a.add(127,6,0,6),a.addMany(r(64,127),6,0,0),a.add(58,3,0,6),a.addMany(r(32,48),3,9,5),a.addMany(r(32,48),5,9,5),a.addMany(r(48,64),5,0,6),a.addMany(r(64,127),5,7,0),a.addMany(r(32,48),4,9,5),a.addMany(r(32,48),1,9,2),a.addMany(r(32,48),2,9,2),a.addMany(r(48,127),2,10,0),a.addMany(r(48,80),1,10,0),a.addMany(r(81,88),1,10,0),a.addMany([89,90,92],1,10,0),a.addMany(r(96,127),1,10,0),a.add(80,1,11,9),a.addMany(EXECUTABLES,9,0,9),a.add(127,9,0,9),a.addMany(r(28,32),9,0,9),a.addMany(r(32,48),9,9,12),a.add(58,9,0,11),a.addMany(r(48,58),9,8,10),a.add(59,9,8,10),a.addMany([60,61,62,63],9,9,10),a.addMany(EXECUTABLES,11,0,11),a.addMany(r(32,128),11,0,11),a.addMany(r(28,32),11,0,11),a.addMany(EXECUTABLES,10,0,10),a.add(127,10,0,10),a.addMany(r(28,32),10,0,10),a.addMany(r(48,58),10,8,10),a.add(59,10,8,10),a.addMany([58,60,61,62,63],10,0,11),a.addMany(r(32,48),10,9,12),a.addMany(EXECUTABLES,12,0,12),a.add(127,12,0,12),a.addMany(r(28,32),12,0,12),a.addMany(r(32,48),12,9,12),a.addMany(r(48,64),12,0,11),a.addMany(r(64,127),12,12,13),a.addMany(r(64,127),10,12,13),a.addMany(r(64,127),9,12,13),a.addMany(EXECUTABLES,13,13,13),a.addMany(PRINTABLES,13,13,13),a.add(127,13,0,13),a.addMany([27,156],13,14,0),a}();var DcsDummy=function(){function e(){}return e.prototype.hook=function(e,a,r){},e.prototype.put=function(e,a,r){},e.prototype.unhook=function(){},e}(),EscapeSequenceParser=function(e){function a(a){void 0===a&&(a=exports.VT500_TRANSITION_TABLE);var r=e.call(this)||this;return r.TRANSITIONS=a,r.initialState=0,r.currentState=r.initialState,r._osc="",r._params=[0],r._collect="",r._printHandlerFb=function(e,a,r){},r._executeHandlerFb=function(e){},r._csiHandlerFb=function(e,a,r){},r._escHandlerFb=function(e,a){},r._oscHandlerFb=function(e,a){},r._dcsHandlerFb=new DcsDummy,r._errorHandlerFb=function(e){return e},r._printHandler=r._printHandlerFb,r._executeHandlers=Object.create(null),r._csiHandlers=Object.create(null),r._escHandlers=Object.create(null),r._oscHandlers=Object.create(null),r._dcsHandlers=Object.create(null),r._activeDcsHandler=null,r._errorHandler=r._errorHandlerFb,r}return __extends(a,e),a.prototype.dispose=function(){this._printHandlerFb=null,this._executeHandlerFb=null,this._csiHandlerFb=null,this._escHandlerFb=null,this._oscHandlerFb=null,this._dcsHandlerFb=null,this._errorHandlerFb=null,this._printHandler=null,this._executeHandlers=null,this._csiHandlers=null,this._escHandlers=null,this._oscHandlers=null,this._dcsHandlers=null,this._activeDcsHandler=null,this._errorHandler=null},a.prototype.setPrintHandler=function(e){this._printHandler=e},a.prototype.clearPrintHandler=function(){this._printHandler=this._printHandlerFb},a.prototype.setExecuteHandler=function(e,a){this._executeHandlers[e.charCodeAt(0)]=a},a.prototype.clearExecuteHandler=function(e){this._executeHandlers[e.charCodeAt(0)]&&delete this._executeHandlers[e.charCodeAt(0)]},a.prototype.setExecuteHandlerFallback=function(e){this._executeHandlerFb=e},a.prototype.setCsiHandler=function(e,a){this._csiHandlers[e.charCodeAt(0)]=a},a.prototype.clearCsiHandler=function(e){this._csiHandlers[e.charCodeAt(0)]&&delete this._csiHandlers[e.charCodeAt(0)]},a.prototype.setCsiHandlerFallback=function(e){this._csiHandlerFb=e},a.prototype.setEscHandler=function(e,a){this._escHandlers[e]=a},a.prototype.clearEscHandler=function(e){this._escHandlers[e]&&delete this._escHandlers[e]},a.prototype.setEscHandlerFallback=function(e){this._escHandlerFb=e},a.prototype.setOscHandler=function(e,a){this._oscHandlers[e]=a},a.prototype.clearOscHandler=function(e){this._oscHandlers[e]&&delete this._oscHandlers[e]},a.prototype.setOscHandlerFallback=function(e){this._oscHandlerFb=e},a.prototype.setDcsHandler=function(e,a){this._dcsHandlers[e]=a},a.prototype.clearDcsHandler=function(e){this._dcsHandlers[e]&&delete this._dcsHandlers[e]},a.prototype.setDcsHandlerFallback=function(e){this._dcsHandlerFb=e},a.prototype.setErrorHandler=function(e){this._errorHandler=e},a.prototype.clearErrorHandler=function(){this._errorHandler=this._errorHandlerFb},a.prototype.reset=function(){this.currentState=this.initialState,this._osc="",this._params=[0],this._collect="",this._activeDcsHandler=null},a.prototype.parse=function(e){for(var a=0,r=0,n=!1,t=this.currentState,d=-1,s=-1,c=this._osc,i=this._collect,l=this._params,o=this.TRANSITIONS.table,u=this._activeDcsHandler,h=null,_=e.length,y=0;y<_;++y)if(a=e.charCodeAt(y),0===t&&a>31&&a<128){d=~d?d:y;do{y++}while(y<_&&e.charCodeAt(y)>31&&e.charCodeAt(y)<128);y--}else if(4===t&&a>47&&a<57)l[l.length-1]=10*l[l.length-1]+a-48;else{switch((r=a<160?o[t<<8|a]:DEFAULT_TRANSITION)>>4){case 2:d=~d?d:y;break;case 3:~d&&(this._printHandler(e,d,y),d=-1),(h=this._executeHandlers[a])?h():this._executeHandlerFb(a);break;case 0:~d?(this._printHandler(e,d,y),d=-1):~s&&(u.put(e,s,y),s=-1);break;case 1:if(a>159)switch(t){case 0:d=~d?d:y;break;case 8:c+=String.fromCharCode(a),r|=8;break;case 6:r|=6;break;case 11:r|=11;break;case 13:s=~s?s:y,r|=13;break;default:n=!0}else n=!0;if(n){if(this._errorHandler({position:y,code:a,currentState:t,print:d,dcs:s,osc:c,collect:i,params:l,abort:!1}).abort)return;n=!1}break;case 7:(h=this._csiHandlers[a])?h(l,i):this._csiHandlerFb(i,l,a);break;case 8:59===a?l.push(0):l[l.length-1]=10*l[l.length-1]+a-48;break;case 9:i+=String.fromCharCode(a);break;case 10:(h=this._escHandlers[i+String.fromCharCode(a)])?h(i,a):this._escHandlerFb(i,a);break;case 11:~d&&(this._printHandler(e,d,y),d=-1),c="",l=[0],i="",s=-1;break;case 12:(u=this._dcsHandlers[i+String.fromCharCode(a)])||(u=this._dcsHandlerFb),u.hook(i,l,a);break;case 13:s=~s?s:y;break;case 14:u&&(~s&&u.put(e,s,y),u.unhook(),u=null),27===a&&(r|=1),c="",l=[0],i="",s=-1;break;case 4:~d&&(this._printHandler(e,d,y),d=-1),c="";break;case 5:c+=e.charAt(y);break;case 6:if(c&&24!==a&&26!==a){var p=c.indexOf(";");if(-1===p)this._oscHandlerFb(-1,c);else{var H=parseInt(c.substring(0,p)),f=c.substring(p+1);(h=this._oscHandlers[H])?h(f):this._oscHandlerFb(H,f)}}27===a&&(r|=1),c="",l=[0],i="",s=-1}t=15&r}0===t&&~d?this._printHandler(e,d,e.length):13===t&&~s&&u&&u.put(e,s,e.length),this._osc=c,this._collect=i,this._params=l,this._activeDcsHandler=u,this.currentState=t},a}(Lifecycle_1.Disposable);exports.EscapeSequenceParser=EscapeSequenceParser;

},{"./common/Lifecycle":29}],19:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function s(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(s.prototype=r.prototype,new s)}}();Object.defineProperty(exports,"__esModule",{value:!0});var EscapeSequences_1=require("./common/data/EscapeSequences"),Charsets_1=require("./core/data/Charsets"),Buffer_1=require("./Buffer"),CharWidth_1=require("./CharWidth"),EscapeSequenceParser_1=require("./EscapeSequenceParser"),Lifecycle_1=require("./common/Lifecycle"),BufferLine_1=require("./BufferLine"),GLEVEL={"(":0,")":1,"*":2,"+":3,"-":1,".":2},DECRQSS=function(){function e(e){this._terminal=e}return e.prototype.hook=function(e,t,r){this._data=""},e.prototype.put=function(e,t,r){this._data+=e.substring(t,r)},e.prototype.unhook=function(){switch(this._data){case'"q':return this._terminal.handler(EscapeSequences_1.C0.ESC+'P1$r0"q'+EscapeSequences_1.C0.ESC+"\\");case'"p':return this._terminal.handler(EscapeSequences_1.C0.ESC+'P1$r61"p'+EscapeSequences_1.C0.ESC+"\\");case"r":var e=this._terminal.buffer.scrollTop+1+";"+(this._terminal.buffer.scrollBottom+1)+"r";return this._terminal.handler(EscapeSequences_1.C0.ESC+"P1$r"+e+EscapeSequences_1.C0.ESC+"\\");case"m":return this._terminal.handler(EscapeSequences_1.C0.ESC+"P1$r0m"+EscapeSequences_1.C0.ESC+"\\");case" q":var t={block:2,underline:4,bar:6}[this._terminal.getOption("cursorStyle")];return t-=this._terminal.getOption("cursorBlink"),this._terminal.handler(EscapeSequences_1.C0.ESC+"P1$r"+t+" q"+EscapeSequences_1.C0.ESC+"\\");default:this._terminal.error("Unknown DCS $q %s",this._data),this._terminal.handler(EscapeSequences_1.C0.ESC+"P0$r"+EscapeSequences_1.C0.ESC+"\\")}},e}(),InputHandler=function(e){function t(t,r){void 0===r&&(r=new EscapeSequenceParser_1.EscapeSequenceParser);var s=e.call(this)||this;s._terminal=t,s._parser=r,s.register(s._parser),s._surrogateHigh="",s._parser.setCsiHandlerFallback(function(e,t,r){s._terminal.error("Unknown CSI code: ",{collect:e,params:t,flag:String.fromCharCode(r)})}),s._parser.setEscHandlerFallback(function(e,t){s._terminal.error("Unknown ESC code: ",{collect:e,flag:String.fromCharCode(t)})}),s._parser.setExecuteHandlerFallback(function(e){s._terminal.error("Unknown EXECUTE code: ",{code:e})}),s._parser.setOscHandlerFallback(function(e,t){s._terminal.error("Unknown OSC code: ",{identifier:e,data:t})}),s._parser.setPrintHandler(function(e,t,r){return s.print(e,t,r)}),s._parser.setCsiHandler("@",function(e,t){return s.insertChars(e)}),s._parser.setCsiHandler("A",function(e,t){return s.cursorUp(e)}),s._parser.setCsiHandler("B",function(e,t){return s.cursorDown(e)}),s._parser.setCsiHandler("C",function(e,t){return s.cursorForward(e)}),s._parser.setCsiHandler("D",function(e,t){return s.cursorBackward(e)}),s._parser.setCsiHandler("E",function(e,t){return s.cursorNextLine(e)}),s._parser.setCsiHandler("F",function(e,t){return s.cursorPrecedingLine(e)}),s._parser.setCsiHandler("G",function(e,t){return s.cursorCharAbsolute(e)}),s._parser.setCsiHandler("H",function(e,t){return s.cursorPosition(e)}),s._parser.setCsiHandler("I",function(e,t){return s.cursorForwardTab(e)}),s._parser.setCsiHandler("J",function(e,t){return s.eraseInDisplay(e)}),s._parser.setCsiHandler("K",function(e,t){return s.eraseInLine(e)}),s._parser.setCsiHandler("L",function(e,t){return s.insertLines(e)}),s._parser.setCsiHandler("M",function(e,t){return s.deleteLines(e)}),s._parser.setCsiHandler("P",function(e,t){return s.deleteChars(e)}),s._parser.setCsiHandler("S",function(e,t){return s.scrollUp(e)}),s._parser.setCsiHandler("T",function(e,t){return s.scrollDown(e,t)}),s._parser.setCsiHandler("X",function(e,t){return s.eraseChars(e)}),s._parser.setCsiHandler("Z",function(e,t){return s.cursorBackwardTab(e)}),s._parser.setCsiHandler("`",function(e,t){return s.charPosAbsolute(e)}),s._parser.setCsiHandler("a",function(e,t){return s.hPositionRelative(e)}),s._parser.setCsiHandler("b",function(e,t){return s.repeatPrecedingCharacter(e)}),s._parser.setCsiHandler("c",function(e,t){return s.sendDeviceAttributes(e,t)}),s._parser.setCsiHandler("d",function(e,t){return s.linePosAbsolute(e)}),s._parser.setCsiHandler("e",function(e,t){return s.vPositionRelative(e)}),s._parser.setCsiHandler("f",function(e,t){return s.hVPosition(e)}),s._parser.setCsiHandler("g",function(e,t){return s.tabClear(e)}),s._parser.setCsiHandler("h",function(e,t){return s.setMode(e,t)}),s._parser.setCsiHandler("l",function(e,t){return s.resetMode(e,t)}),s._parser.setCsiHandler("m",function(e,t){return s.charAttributes(e)}),s._parser.setCsiHandler("n",function(e,t){return s.deviceStatus(e,t)}),s._parser.setCsiHandler("p",function(e,t){return s.softReset(e,t)}),s._parser.setCsiHandler("q",function(e,t){return s.setCursorStyle(e,t)}),s._parser.setCsiHandler("r",function(e,t){return s.setScrollRegion(e,t)}),s._parser.setCsiHandler("s",function(e,t){return s.saveCursor(e)}),s._parser.setCsiHandler("u",function(e,t){return s.restoreCursor(e)}),s._parser.setExecuteHandler(EscapeSequences_1.C0.BEL,function(){return s.bell()}),s._parser.setExecuteHandler(EscapeSequences_1.C0.LF,function(){return s.lineFeed()}),s._parser.setExecuteHandler(EscapeSequences_1.C0.VT,function(){return s.lineFeed()}),s._parser.setExecuteHandler(EscapeSequences_1.C0.FF,function(){return s.lineFeed()}),s._parser.setExecuteHandler(EscapeSequences_1.C0.CR,function(){return s.carriageReturn()}),s._parser.setExecuteHandler(EscapeSequences_1.C0.BS,function(){return s.backspace()}),s._parser.setExecuteHandler(EscapeSequences_1.C0.HT,function(){return s.tab()}),s._parser.setExecuteHandler(EscapeSequences_1.C0.SO,function(){return s.shiftOut()}),s._parser.setExecuteHandler(EscapeSequences_1.C0.SI,function(){return s.shiftIn()}),s._parser.setExecuteHandler(EscapeSequences_1.C1.IND,function(){return s.index()}),s._parser.setExecuteHandler(EscapeSequences_1.C1.NEL,function(){return s.nextLine()}),s._parser.setExecuteHandler(EscapeSequences_1.C1.HTS,function(){return s.tabSet()}),s._parser.setOscHandler(0,function(e){return s.setTitle(e)}),s._parser.setOscHandler(2,function(e){return s.setTitle(e)}),s._parser.setEscHandler("7",function(){return s.saveCursor([])}),s._parser.setEscHandler("8",function(){return s.restoreCursor([])}),s._parser.setEscHandler("D",function(){return s.index()}),s._parser.setEscHandler("E",function(){return s.nextLine()}),s._parser.setEscHandler("H",function(){return s.tabSet()}),s._parser.setEscHandler("M",function(){return s.reverseIndex()}),s._parser.setEscHandler("=",function(){return s.keypadApplicationMode()}),s._parser.setEscHandler(">",function(){return s.keypadNumericMode()}),s._parser.setEscHandler("c",function(){return s.reset()}),s._parser.setEscHandler("n",function(){return s.setgLevel(2)}),s._parser.setEscHandler("o",function(){return s.setgLevel(3)}),s._parser.setEscHandler("|",function(){return s.setgLevel(3)}),s._parser.setEscHandler("}",function(){return s.setgLevel(2)}),s._parser.setEscHandler("~",function(){return s.setgLevel(1)}),s._parser.setEscHandler("%@",function(){return s.selectDefaultCharset()}),s._parser.setEscHandler("%G",function(){return s.selectDefaultCharset()});var i=function(e){n._parser.setEscHandler("("+e,function(){return s.selectCharset("("+e)}),n._parser.setEscHandler(")"+e,function(){return s.selectCharset(")"+e)}),n._parser.setEscHandler("*"+e,function(){return s.selectCharset("*"+e)}),n._parser.setEscHandler("+"+e,function(){return s.selectCharset("+"+e)}),n._parser.setEscHandler("-"+e,function(){return s.selectCharset("-"+e)}),n._parser.setEscHandler("."+e,function(){return s.selectCharset("."+e)}),n._parser.setEscHandler("/"+e,function(){return s.selectCharset("/"+e)})},n=this;for(var a in Charsets_1.CHARSETS)i(a);return s._parser.setErrorHandler(function(e){return s._terminal.error("Parsing error: ",e),e}),s._parser.setDcsHandler("$q",new DECRQSS(s._terminal)),s}return __extends(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this),this._terminal=null},t.prototype.parse=function(e){if(this._terminal){var t=this._terminal.buffer,r=t.x,s=t.y;this._terminal.debug&&this._terminal.log("data: "+e),this._surrogateHigh&&(e=this._surrogateHigh+e,this._surrogateHigh=""),this._parser.parse(e),(t=this._terminal.buffer).x===r&&t.y===s||this._terminal.emit("cursormove")}},t.prototype.print=function(e,t,r){var s,i,n,a,l=this._terminal.buffer,o=this._terminal.charset,_=this._terminal.options.screenReaderMode,u=this._terminal.cols,f=this._terminal.wraparoundMode,c=this._terminal.insertMode,h=this._terminal.curAttr,m=l.lines.get(l.y+l.ybase);this._terminal.updateRange(l.y);for(var p=t;p<r;++p){if(s=e.charAt(p),55296<=(i=e.charCodeAt(p))&&i<=56319){if(n=e.charCodeAt(p+1),isNaN(n)){this._surrogateHigh=s;continue}i=1024*(i-55296)+(n-56320)+65536,s+=e.charAt(p+1)}if(!(56320<=i&&i<=57343))if(a=CharWidth_1.wcwidth(i),o&&(i=(s=o[s]||s).charCodeAt(0)),_&&this._terminal.emit("a11y.char",s),a||!l.x){if(l.x+a-1>=u)if(f)l.x=0,l.y++,l.y>l.scrollBottom?(l.y--,this._terminal.scroll(!0)):l.lines.get(l.y).isWrapped=!0,m=l.lines.get(l.y+l.ybase);else if(2===a)continue;if(c)for(var d=0;d<a;++d){var b=m.pop();C=m.get(l.x-2);0===b[Buffer_1.CHAR_DATA_WIDTH_INDEX]&&C&&2===C[Buffer_1.CHAR_DATA_WIDTH_INDEX]&&m.set(this._terminal.cols-2,[h,Buffer_1.NULL_CELL_CHAR,Buffer_1.NULL_CELL_WIDTH,Buffer_1.NULL_CELL_CODE]),m.splice(l.x,0,[h,Buffer_1.NULL_CELL_CHAR,Buffer_1.NULL_CELL_WIDTH,Buffer_1.NULL_CELL_CODE])}m.set(l.x++,[h,s,a,i]),2===a&&m.set(l.x++,[h,"",0,void 0])}else{var C,y=m.get(l.x-1);y&&(y[Buffer_1.CHAR_DATA_WIDTH_INDEX]?(y[Buffer_1.CHAR_DATA_CHAR_INDEX]+=s,y[Buffer_1.CHAR_DATA_CODE_INDEX]=i):(C=m.get(l.x-2))&&(C[Buffer_1.CHAR_DATA_CHAR_INDEX]+=s,C[Buffer_1.CHAR_DATA_CODE_INDEX]=i))}}this._terminal.updateRange(l.y)},t.prototype.bell=function(){this._terminal.bell()},t.prototype.lineFeed=function(){var e=this._terminal.buffer;this._terminal.options.convertEol&&(e.x=0),e.y++,e.y>e.scrollBottom&&(e.y--,this._terminal.scroll()),e.x>=this._terminal.cols&&e.x--,this._terminal.emit("linefeed")},t.prototype.carriageReturn=function(){this._terminal.buffer.x=0},t.prototype.backspace=function(){this._terminal.buffer.x>0&&this._terminal.buffer.x--},t.prototype.tab=function(){var e=this._terminal.buffer.x;this._terminal.buffer.x=this._terminal.buffer.nextStop(),this._terminal.options.screenReaderMode&&this._terminal.emit("a11y.tab",this._terminal.buffer.x-e)},t.prototype.shiftOut=function(){this._terminal.setgLevel(1)},t.prototype.shiftIn=function(){this._terminal.setgLevel(0)},t.prototype.insertChars=function(e){this._terminal.buffer.lines.get(this._terminal.buffer.y+this._terminal.buffer.ybase).insertCells(this._terminal.buffer.x,e[0]||1,[this._terminal.eraseAttr(),Buffer_1.NULL_CELL_CHAR,Buffer_1.NULL_CELL_WIDTH,Buffer_1.NULL_CELL_CODE]),this._terminal.updateRange(this._terminal.buffer.y)},t.prototype.cursorUp=function(e){var t=e[0];t<1&&(t=1),this._terminal.buffer.y-=t,this._terminal.buffer.y<0&&(this._terminal.buffer.y=0)},t.prototype.cursorDown=function(e){var t=e[0];t<1&&(t=1),this._terminal.buffer.y+=t,this._terminal.buffer.y>=this._terminal.rows&&(this._terminal.buffer.y=this._terminal.rows-1),this._terminal.buffer.x>=this._terminal.cols&&this._terminal.buffer.x--},t.prototype.cursorForward=function(e){var t=e[0];t<1&&(t=1),this._terminal.buffer.x+=t,this._terminal.buffer.x>=this._terminal.cols&&(this._terminal.buffer.x=this._terminal.cols-1)},t.prototype.cursorBackward=function(e){var t=e[0];t<1&&(t=1),this._terminal.buffer.x>=this._terminal.cols&&this._terminal.buffer.x--,this._terminal.buffer.x-=t,this._terminal.buffer.x<0&&(this._terminal.buffer.x=0)},t.prototype.cursorNextLine=function(e){var t=e[0];t<1&&(t=1),this._terminal.buffer.y+=t,this._terminal.buffer.y>=this._terminal.rows&&(this._terminal.buffer.y=this._terminal.rows-1),this._terminal.buffer.x=0},t.prototype.cursorPrecedingLine=function(e){var t=e[0];t<1&&(t=1),this._terminal.buffer.y-=t,this._terminal.buffer.y<0&&(this._terminal.buffer.y=0),this._terminal.buffer.x=0},t.prototype.cursorCharAbsolute=function(e){var t=e[0];t<1&&(t=1),this._terminal.buffer.x=t-1},t.prototype.cursorPosition=function(e){var t,r=e[0]-1;t=e.length>=2?e[1]-1:0,r<0?r=0:r>=this._terminal.rows&&(r=this._terminal.rows-1),t<0?t=0:t>=this._terminal.cols&&(t=this._terminal.cols-1),this._terminal.buffer.x=t,this._terminal.buffer.y=r},t.prototype.cursorForwardTab=function(e){for(var t=e[0]||1;t--;)this._terminal.buffer.x=this._terminal.buffer.nextStop()},t.prototype._eraseInBufferLine=function(e,t,r){this._terminal.buffer.lines.get(this._terminal.buffer.ybase+e).replaceCells(t,r,[this._terminal.eraseAttr(),Buffer_1.NULL_CELL_CHAR,Buffer_1.NULL_CELL_WIDTH,Buffer_1.NULL_CELL_CODE])},t.prototype.eraseInDisplay=function(e){var t;switch(e[0]){case 0:for(t=this._terminal.buffer.y,this._terminal.updateRange(t),this._eraseInBufferLine(t++,this._terminal.buffer.x,this._terminal.cols);t<this._terminal.rows;t++)this._eraseInBufferLine(t,0,this._terminal.cols);this._terminal.updateRange(t);break;case 1:for(t=this._terminal.buffer.y,this._terminal.updateRange(t),this._eraseInBufferLine(t,0,this._terminal.buffer.x+1);t--;)this._eraseInBufferLine(t,0,this._terminal.cols);this._terminal.updateRange(0);break;case 2:for(t=this._terminal.rows,this._terminal.updateRange(t-1);t--;)this._eraseInBufferLine(t,0,this._terminal.cols);this._terminal.updateRange(0);break;case 3:var r=this._terminal.buffer.lines.length-this._terminal.rows;r>0&&(this._terminal.buffer.lines.trimStart(r),this._terminal.buffer.ybase=Math.max(this._terminal.buffer.ybase-r,0),this._terminal.buffer.ydisp=Math.max(this._terminal.buffer.ydisp-r,0),this._terminal.emit("scroll",0))}},t.prototype.eraseInLine=function(e){switch(e[0]){case 0:this._eraseInBufferLine(this._terminal.buffer.y,this._terminal.buffer.x,this._terminal.cols);break;case 1:this._eraseInBufferLine(this._terminal.buffer.y,0,this._terminal.buffer.x+1);break;case 2:this._eraseInBufferLine(this._terminal.buffer.y,0,this._terminal.cols)}this._terminal.updateRange(this._terminal.buffer.y)},t.prototype.insertLines=function(e){var t=e[0];t<1&&(t=1);for(var r=this._terminal.buffer,s=r.y+r.ybase,i=this._terminal.rows-1-r.scrollBottom,n=this._terminal.rows-1+r.ybase-i+1;t--;)r.lines.splice(n-1,1),r.lines.splice(s,0,BufferLine_1.BufferLine.blankLine(this._terminal.cols,this._terminal.eraseAttr()));this._terminal.updateRange(r.y),this._terminal.updateRange(r.scrollBottom)},t.prototype.deleteLines=function(e){var t=e[0];t<1&&(t=1);var r,s=this._terminal.buffer,i=s.y+s.ybase;for(r=this._terminal.rows-1-s.scrollBottom,r=this._terminal.rows-1+s.ybase-r;t--;)s.lines.splice(i,1),s.lines.splice(r,0,BufferLine_1.BufferLine.blankLine(this._terminal.cols,this._terminal.eraseAttr()));this._terminal.updateRange(s.y),this._terminal.updateRange(s.scrollBottom)},t.prototype.deleteChars=function(e){this._terminal.buffer.lines.get(this._terminal.buffer.y+this._terminal.buffer.ybase).deleteCells(this._terminal.buffer.x,e[0]||1,[this._terminal.eraseAttr(),Buffer_1.NULL_CELL_CHAR,Buffer_1.NULL_CELL_WIDTH,Buffer_1.NULL_CELL_CODE]),this._terminal.updateRange(this._terminal.buffer.y)},t.prototype.scrollUp=function(e){for(var t=e[0]||1,r=this._terminal.buffer;t--;)r.lines.splice(r.ybase+r.scrollTop,1),r.lines.splice(r.ybase+r.scrollBottom,0,BufferLine_1.BufferLine.blankLine(this._terminal.cols,Buffer_1.DEFAULT_ATTR));this._terminal.updateRange(r.scrollTop),this._terminal.updateRange(r.scrollBottom)},t.prototype.scrollDown=function(e,t){if(e.length<2&&!t){for(var r=e[0]||1,s=this._terminal.buffer;r--;)s.lines.splice(s.ybase+s.scrollBottom,1),s.lines.splice(s.ybase+s.scrollBottom,0,BufferLine_1.BufferLine.blankLine(this._terminal.cols,Buffer_1.DEFAULT_ATTR));this._terminal.updateRange(s.scrollTop),this._terminal.updateRange(s.scrollBottom)}},t.prototype.eraseChars=function(e){this._terminal.buffer.lines.get(this._terminal.buffer.y+this._terminal.buffer.ybase).replaceCells(this._terminal.buffer.x,this._terminal.buffer.x+(e[0]||1),[this._terminal.eraseAttr(),Buffer_1.NULL_CELL_CHAR,Buffer_1.NULL_CELL_WIDTH,Buffer_1.NULL_CELL_CODE])},t.prototype.cursorBackwardTab=function(e){for(var t=e[0]||1,r=this._terminal.buffer;t--;)r.x=r.prevStop()},t.prototype.charPosAbsolute=function(e){var t=e[0];t<1&&(t=1),this._terminal.buffer.x=t-1,this._terminal.buffer.x>=this._terminal.cols&&(this._terminal.buffer.x=this._terminal.cols-1)},t.prototype.hPositionRelative=function(e){var t=e[0];t<1&&(t=1),this._terminal.buffer.x+=t,this._terminal.buffer.x>=this._terminal.cols&&(this._terminal.buffer.x=this._terminal.cols-1)},t.prototype.repeatPrecedingCharacter=function(e){var t=this._terminal.buffer,r=t.lines.get(t.ybase+t.y);r.replaceCells(t.x,t.x+(e[0]||1),r.get(t.x-1)||[Buffer_1.DEFAULT_ATTR,Buffer_1.NULL_CELL_CHAR,Buffer_1.NULL_CELL_WIDTH,Buffer_1.NULL_CELL_CODE])},t.prototype.sendDeviceAttributes=function(e,t){e[0]>0||(t?">"===t&&(this._terminal.is("xterm")?this._terminal.handler(EscapeSequences_1.C0.ESC+"[>0;276;0c"):this._terminal.is("rxvt-unicode")?this._terminal.handler(EscapeSequences_1.C0.ESC+"[>85;95;0c"):this._terminal.is("linux")?this._terminal.handler(e[0]+"c"):this._terminal.is("screen")&&this._terminal.handler(EscapeSequences_1.C0.ESC+"[>83;40003;0c")):this._terminal.is("xterm")||this._terminal.is("rxvt-unicode")||this._terminal.is("screen")?this._terminal.handler(EscapeSequences_1.C0.ESC+"[?1;2c"):this._terminal.is("linux")&&this._terminal.handler(EscapeSequences_1.C0.ESC+"[?6c"))},t.prototype.linePosAbsolute=function(e){var t=e[0];t<1&&(t=1),this._terminal.buffer.y=t-1,this._terminal.buffer.y>=this._terminal.rows&&(this._terminal.buffer.y=this._terminal.rows-1)},t.prototype.vPositionRelative=function(e){var t=e[0];t<1&&(t=1),this._terminal.buffer.y+=t,this._terminal.buffer.y>=this._terminal.rows&&(this._terminal.buffer.y=this._terminal.rows-1),this._terminal.buffer.x>=this._terminal.cols&&this._terminal.buffer.x--},t.prototype.hVPosition=function(e){e[0]<1&&(e[0]=1),e[1]<1&&(e[1]=1),this._terminal.buffer.y=e[0]-1,this._terminal.buffer.y>=this._terminal.rows&&(this._terminal.buffer.y=this._terminal.rows-1),this._terminal.buffer.x=e[1]-1,this._terminal.buffer.x>=this._terminal.cols&&(this._terminal.buffer.x=this._terminal.cols-1)},t.prototype.tabClear=function(e){var t=e[0];t<=0?delete this._terminal.buffer.tabs[this._terminal.buffer.x]:3===t&&(this._terminal.buffer.tabs={})},t.prototype.setMode=function(e,t){if(e.length>1)for(var r=0;r<e.length;r++)this.setMode([e[r]]);else if(t){if("?"===t)switch(e[0]){case 1:this._terminal.applicationCursor=!0;break;case 2:this._terminal.setgCharset(0,Charsets_1.DEFAULT_CHARSET),this._terminal.setgCharset(1,Charsets_1.DEFAULT_CHARSET),this._terminal.setgCharset(2,Charsets_1.DEFAULT_CHARSET),this._terminal.setgCharset(3,Charsets_1.DEFAULT_CHARSET);break;case 3:this._terminal.savedCols=this._terminal.cols,this._terminal.resize(132,this._terminal.rows);break;case 6:this._terminal.originMode=!0;break;case 7:this._terminal.wraparoundMode=!0;break;case 12:break;case 66:this._terminal.log("Serial port requested application keypad."),this._terminal.applicationKeypad=!0,this._terminal.viewport.syncScrollArea();break;case 9:case 1e3:case 1002:case 1003:this._terminal.x10Mouse=9===e[0],this._terminal.vt200Mouse=1e3===e[0],this._terminal.normalMouse=e[0]>1e3,this._terminal.mouseEvents=!0,this._terminal.element.classList.add("enable-mouse-events"),this._terminal.selectionManager.disable(),this._terminal.log("Binding to mouse events.");break;case 1004:this._terminal.sendFocus=!0;break;case 1005:this._terminal.utfMouse=!0;break;case 1006:this._terminal.sgrMouse=!0;break;case 1015:this._terminal.urxvtMouse=!0;break;case 25:this._terminal.cursorHidden=!1;break;case 1049:case 47:case 1047:this._terminal.buffers.activateAltBuffer(),this._terminal.viewport.syncScrollArea(),this._terminal.showCursor();break;case 2004:this._terminal.bracketedPasteMode=!0}}else switch(e[0]){case 4:this._terminal.insertMode=!0}},t.prototype.resetMode=function(e,t){if(e.length>1)for(var r=0;r<e.length;r++)this.resetMode([e[r]]);else if(t){if("?"===t)switch(e[0]){case 1:this._terminal.applicationCursor=!1;break;case 3:132===this._terminal.cols&&this._terminal.savedCols&&this._terminal.resize(this._terminal.savedCols,this._terminal.rows),delete this._terminal.savedCols;break;case 6:this._terminal.originMode=!1;break;case 7:this._terminal.wraparoundMode=!1;break;case 12:break;case 66:this._terminal.log("Switching back to normal keypad."),this._terminal.applicationKeypad=!1,this._terminal.viewport.syncScrollArea();break;case 9:case 1e3:case 1002:case 1003:this._terminal.x10Mouse=!1,this._terminal.vt200Mouse=!1,this._terminal.normalMouse=!1,this._terminal.mouseEvents=!1,this._terminal.element.classList.remove("enable-mouse-events"),this._terminal.selectionManager.enable();break;case 1004:this._terminal.sendFocus=!1;break;case 1005:this._terminal.utfMouse=!1;break;case 1006:this._terminal.sgrMouse=!1;break;case 1015:this._terminal.urxvtMouse=!1;break;case 25:this._terminal.cursorHidden=!0;break;case 1049:case 47:case 1047:this._terminal.buffers.activateNormalBuffer(),this._terminal.refresh(0,this._terminal.rows-1),this._terminal.viewport.syncScrollArea(),this._terminal.showCursor();break;case 2004:this._terminal.bracketedPasteMode=!1}}else switch(e[0]){case 4:this._terminal.insertMode=!1}},t.prototype.charAttributes=function(e){if(1!==e.length||0!==e[0]){for(var t,r=e.length,s=this._terminal.curAttr>>18,i=this._terminal.curAttr>>9&511,n=511&this._terminal.curAttr,a=0;a<r;a++)(t=e[a])>=30&&t<=37?i=t-30:t>=40&&t<=47?n=t-40:t>=90&&t<=97?i=(t+=8)-90:t>=100&&t<=107?n=(t+=8)-100:0===t?(s=Buffer_1.DEFAULT_ATTR>>18,i=Buffer_1.DEFAULT_ATTR>>9&511,n=511&Buffer_1.DEFAULT_ATTR):1===t?s|=1:3===t?s|=64:4===t?s|=2:5===t?s|=4:7===t?s|=8:8===t?s|=16:2===t?s|=32:22===t?(s&=-2,s&=-33):23===t?s&=-65:24===t?s&=-3:25===t?s&=-5:27===t?s&=-9:28===t?s&=-17:39===t?i=Buffer_1.DEFAULT_ATTR>>9&511:49===t?n=511&Buffer_1.DEFAULT_ATTR:38===t?2===e[a+1]?(a+=2,-1===(i=this._terminal.matchColor(255&e[a],255&e[a+1],255&e[a+2]))&&(i=511),a+=2):5===e[a+1]&&(i=t=255&e[a+=2]):48===t?2===e[a+1]?(a+=2,-1===(n=this._terminal.matchColor(255&e[a],255&e[a+1],255&e[a+2]))&&(n=511),a+=2):5===e[a+1]&&(n=t=255&e[a+=2]):100===t?(i=Buffer_1.DEFAULT_ATTR>>9&511,n=511&Buffer_1.DEFAULT_ATTR):this._terminal.error("Unknown SGR attribute: %d.",t);this._terminal.curAttr=s<<18|i<<9|n}else this._terminal.curAttr=Buffer_1.DEFAULT_ATTR},t.prototype.deviceStatus=function(e,t){if(t){if("?"===t)switch(e[0]){case 6:r=this._terminal.buffer.y+1,s=this._terminal.buffer.x+1;this._terminal.emit("data",EscapeSequences_1.C0.ESC+"[?"+r+";"+s+"R")}}else switch(e[0]){case 5:this._terminal.emit("data",EscapeSequences_1.C0.ESC+"[0n");break;case 6:var r=this._terminal.buffer.y+1,s=this._terminal.buffer.x+1;this._terminal.emit("data",EscapeSequences_1.C0.ESC+"["+r+";"+s+"R")}},t.prototype.softReset=function(e,t){"!"===t&&(this._terminal.cursorHidden=!1,this._terminal.insertMode=!1,this._terminal.originMode=!1,this._terminal.wraparoundMode=!0,this._terminal.applicationKeypad=!1,this._terminal.viewport.syncScrollArea(),this._terminal.applicationCursor=!1,this._terminal.buffer.scrollTop=0,this._terminal.buffer.scrollBottom=this._terminal.rows-1,this._terminal.curAttr=Buffer_1.DEFAULT_ATTR,this._terminal.buffer.x=this._terminal.buffer.y=0,this._terminal.charset=null,this._terminal.glevel=0,this._terminal.charsets=[null])},t.prototype.setCursorStyle=function(e,t){if(" "===t){var r=e[0]<1?1:e[0];switch(r){case 1:case 2:this._terminal.setOption("cursorStyle","block");break;case 3:case 4:this._terminal.setOption("cursorStyle","underline");break;case 5:case 6:this._terminal.setOption("cursorStyle","bar")}var s=r%2==1;this._terminal.setOption("cursorBlink",s)}},t.prototype.setScrollRegion=function(e,t){t||(this._terminal.buffer.scrollTop=(e[0]||1)-1,this._terminal.buffer.scrollBottom=(e[1]&&e[1]<=this._terminal.rows?e[1]:this._terminal.rows)-1,this._terminal.buffer.x=0,this._terminal.buffer.y=0)},t.prototype.saveCursor=function(e){this._terminal.buffer.savedX=this._terminal.buffer.x,this._terminal.buffer.savedY=this._terminal.buffer.y,this._terminal.savedCurAttr=this._terminal.curAttr},t.prototype.restoreCursor=function(e){this._terminal.buffer.x=this._terminal.buffer.savedX||0,this._terminal.buffer.y=this._terminal.buffer.savedY||0,this._terminal.curAttr=this._terminal.savedCurAttr||Buffer_1.DEFAULT_ATTR},t.prototype.setTitle=function(e){this._terminal.handleTitle(e)},t.prototype.nextLine=function(){this._terminal.buffer.x=0,this.index()},t.prototype.keypadApplicationMode=function(){this._terminal.log("Serial port requested application keypad."),this._terminal.applicationKeypad=!0,this._terminal.viewport&&this._terminal.viewport.syncScrollArea()},t.prototype.keypadNumericMode=function(){this._terminal.log("Switching back to normal keypad."),this._terminal.applicationKeypad=!1,this._terminal.viewport&&this._terminal.viewport.syncScrollArea()},t.prototype.selectDefaultCharset=function(){this._terminal.setgLevel(0),this._terminal.setgCharset(0,Charsets_1.DEFAULT_CHARSET)},t.prototype.selectCharset=function(e){if(2!==e.length)return this.selectDefaultCharset();"/"!==e[0]&&this._terminal.setgCharset(GLEVEL[e[0]],Charsets_1.CHARSETS[e[1]]||Charsets_1.DEFAULT_CHARSET)},t.prototype.index=function(){this._terminal.index()},t.prototype.tabSet=function(){this._terminal.tabSet()},t.prototype.reverseIndex=function(){this._terminal.reverseIndex()},t.prototype.reset=function(){this._parser.reset(),this._terminal.reset()},t.prototype.setgLevel=function(e){this._terminal.setgLevel(e)},t}(Lifecycle_1.Disposable);exports.InputHandler=InputHandler;

},{"./Buffer":13,"./BufferLine":14,"./CharWidth":16,"./EscapeSequenceParser":18,"./common/Lifecycle":29,"./common/data/EscapeSequences":30,"./core/data/Charsets":31}],20:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function r(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var MouseZoneManager_1=require("./ui/MouseZoneManager"),EventEmitter_1=require("./common/EventEmitter"),Buffer_1=require("./Buffer"),CharWidth_1=require("./CharWidth"),Linkifier=function(t){function e(e){var i=t.call(this)||this;return i._terminal=e,i._linkMatchers=[],i._nextLinkMatcherId=0,i._rowsToLinkify={start:null,end:null},i}return __extends(e,t),e.prototype.attachToDom=function(t){this._mouseZoneManager=t},e.prototype.linkifyRows=function(t,i){var r=this;this._mouseZoneManager&&(null===this._rowsToLinkify.start?(this._rowsToLinkify.start=t,this._rowsToLinkify.end=i):(this._rowsToLinkify.start=Math.min(this._rowsToLinkify.start,t),this._rowsToLinkify.end=Math.max(this._rowsToLinkify.end,i)),this._mouseZoneManager.clearAll(t,i),this._rowsTimeoutId&&clearTimeout(this._rowsTimeoutId),this._rowsTimeoutId=setTimeout(function(){return r._linkifyRows()},e.TIME_BEFORE_LINKIFY))},e.prototype._linkifyRows=function(){this._rowsTimeoutId=null;var t=this._terminal.buffer,i=t.ydisp+this._rowsToLinkify.start;if(!(i>=t.lines.length)){for(var r=t.ydisp+Math.min(this._rowsToLinkify.end,this._terminal.rows)+1,n=Math.ceil(e.OVERSCAN_CHAR_LIMIT/this._terminal.cols),o=this._terminal.buffer.iterator(!1,i,r,n,n);o.hasNext();)for(var a=o.next(),s=0;s<this._linkMatchers.length;s++)this._doLinkifyRow(a.range.first,a.content,this._linkMatchers[s]);this._rowsToLinkify.start=null,this._rowsToLinkify.end=null}},e.prototype.registerLinkMatcher=function(t,e,i){if(void 0===i&&(i={}),!e)throw new Error("handler must be defined");var r={id:this._nextLinkMatcherId++,regex:t,handler:e,matchIndex:i.matchIndex,validationCallback:i.validationCallback,hoverTooltipCallback:i.tooltipCallback,hoverLeaveCallback:i.leaveCallback,willLinkActivate:i.willLinkActivate,priority:i.priority||0};return this._addLinkMatcherToList(r),r.id},e.prototype._addLinkMatcherToList=function(t){if(0!==this._linkMatchers.length){for(var e=this._linkMatchers.length-1;e>=0;e--)if(t.priority<=this._linkMatchers[e].priority)return void this._linkMatchers.splice(e+1,0,t);this._linkMatchers.splice(0,0,t)}else this._linkMatchers.push(t)},e.prototype.deregisterLinkMatcher=function(t){for(var e=0;e<this._linkMatchers.length;e++)if(this._linkMatchers[e].id===t)return this._linkMatchers.splice(e,1),!0;return!1},e.prototype._doLinkifyRow=function(t,e,i){for(var r,n=this,o=new RegExp(i.regex.source,i.regex.flags+"g"),a=-1,s=function(){var s=r["number"!=typeof i.matchIndex?0:i.matchIndex];if(!s){if(l._terminal.debug)throw console.log({match:r,matcher:i}),new Error("match found without corresponding matchIndex");return"break"}a=e.indexOf(s,a+1),o.lastIndex=a+s.length;var h,c=l._terminal.buffer.stringIndexToBufferIndex(t,a),_=l._terminal.buffer.lines.get(c[0]).get(c[1]);if(_){var f=_[Buffer_1.CHAR_DATA_ATTR_INDEX];h=f>>9&511}i.validationCallback?i.validationCallback(s,function(t){n._rowsTimeoutId||t&&n._addLink(c[1],c[0]-n._terminal.buffer.ydisp,s,i,h)}):l._addLink(c[1],c[0]-l._terminal.buffer.ydisp,s,i,h)},l=this;null!==(r=o.exec(e));){if("break"===s())break}},e.prototype._addLink=function(t,e,i,r,n){var o=this,a=CharWidth_1.getStringCellWidth(i),s=t%this._terminal.cols,l=e+Math.floor(t/this._terminal.cols),h=(s+a)%this._terminal.cols,c=l+Math.floor((s+a)/this._terminal.cols);0===h&&(h=this._terminal.cols,c--),this._mouseZoneManager.add(new MouseZoneManager_1.MouseZone(s+1,l+1,h+1,c+1,function(t){if(r.handler)return r.handler(t,i);window.open(i,"_blank")},function(t){o.emit("linkhover",o._createLinkHoverEvent(s,l,h,c,n)),o._terminal.element.classList.add("xterm-cursor-pointer")},function(t){o.emit("linktooltip",o._createLinkHoverEvent(s,l,h,c,n)),r.hoverTooltipCallback&&r.hoverTooltipCallback(t,i)},function(){o.emit("linkleave",o._createLinkHoverEvent(s,l,h,c,n)),o._terminal.element.classList.remove("xterm-cursor-pointer"),r.hoverLeaveCallback&&r.hoverLeaveCallback()},function(t){return!r.willLinkActivate||r.willLinkActivate(t,i)}))},e.prototype._createLinkHoverEvent=function(t,e,i,r,n){return{x1:t,y1:e,x2:i,y2:r,cols:this._terminal.cols,fg:n}},e.TIME_BEFORE_LINKIFY=200,e.OVERSCAN_CHAR_LIMIT=2e3,e}(EventEmitter_1.EventEmitter);exports.Linkifier=Linkifier;

},{"./Buffer":13,"./CharWidth":16,"./common/EventEmitter":28,"./ui/MouseZoneManager":60}],21:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var MouseHelper_1=require("./utils/MouseHelper"),Browser=require("./shared/utils/Browser"),EventEmitter_1=require("./common/EventEmitter"),SelectionModel_1=require("./SelectionModel"),Buffer_1=require("./Buffer"),AltClickHandler_1=require("./handlers/AltClickHandler"),DRAG_SCROLL_MAX_THRESHOLD=50,DRAG_SCROLL_MAX_SPEED=15,DRAG_SCROLL_INTERVAL=50,ALT_CLICK_MOVE_CURSOR_TIME=500,WORD_SEPARATORS=" ()[]{}'\"",NON_BREAKING_SPACE_CHAR=String.fromCharCode(160),ALL_NON_BREAKING_SPACE_REGEX=new RegExp(NON_BREAKING_SPACE_CHAR,"g"),SelectionManager=function(e){function t(t,i){var r=e.call(this)||this;return r._terminal=t,r._charMeasure=i,r._enabled=!0,r._initListeners(),r.enable(),r._model=new SelectionModel_1.SelectionModel(t),r._activeSelectionMode=0,r}return __extends(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this),this._removeMouseDownListeners()},Object.defineProperty(t.prototype,"_buffer",{get:function(){return this._terminal.buffers.active},enumerable:!0,configurable:!0}),t.prototype._initListeners=function(){var e=this;this._mouseMoveListener=function(t){return e._onMouseMove(t)},this._mouseUpListener=function(t){return e._onMouseUp(t)},this._trimListener=function(t){return e._onTrim(t)},this.initBuffersListeners()},t.prototype.initBuffersListeners=function(){var e=this;this._terminal.buffer.lines.on("trim",this._trimListener),this._terminal.buffers.on("activate",function(t){return e._onBufferActivate(t)})},t.prototype.disable=function(){this.clearSelection(),this._enabled=!1},t.prototype.enable=function(){this._enabled=!0},Object.defineProperty(t.prototype,"selectionStart",{get:function(){return this._model.finalSelectionStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selectionEnd",{get:function(){return this._model.finalSelectionEnd},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"hasSelection",{get:function(){var e=this._model.finalSelectionStart,t=this._model.finalSelectionEnd;return!(!e||!t)&&(e[0]!==t[0]||e[1]!==t[1])},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"selectionText",{get:function(){var e=this._model.finalSelectionStart,t=this._model.finalSelectionEnd;if(!e||!t)return"";var i=[];if(3===this._activeSelectionMode){if(e[0]===t[0])return"";for(var r=e[1];r<=t[1];r++){var n=this._buffer.translateBufferLineToString(r,!0,e[0],t[0]);i.push(n)}}else{var o=e[1]===t[1]?t[0]:null;i.push(this._buffer.translateBufferLineToString(e[1],!0,e[0],o));for(r=e[1]+1;r<=t[1]-1;r++){var s=this._buffer.lines.get(r);n=this._buffer.translateBufferLineToString(r,!0);s.isWrapped?i[i.length-1]+=n:i.push(n)}if(e[1]!==t[1]){s=this._buffer.lines.get(t[1]),n=this._buffer.translateBufferLineToString(t[1],!0,0,t[0]);s.isWrapped?i[i.length-1]+=n:i.push(n)}}return i.map(function(e){return e.replace(ALL_NON_BREAKING_SPACE_REGEX," ")}).join(Browser.isMSWindows?"\r\n":"\n")},enumerable:!0,configurable:!0}),t.prototype.clearSelection=function(){this._model.clearSelection(),this._removeMouseDownListeners(),this.refresh()},t.prototype.refresh=function(e){var t=this;(this._refreshAnimationFrame||(this._refreshAnimationFrame=window.requestAnimationFrame(function(){return t._refresh()})),Browser.isLinux&&e)&&(this.selectionText.length&&this.emit("newselection",this.selectionText))},t.prototype._refresh=function(){this._refreshAnimationFrame=null,this.emit("refresh",{start:this._model.finalSelectionStart,end:this._model.finalSelectionEnd,columnSelectMode:3===this._activeSelectionMode})},t.prototype.isClickInSelection=function(e){var t=this._getMouseBufferCoords(e),i=this._model.finalSelectionStart,r=this._model.finalSelectionEnd;return!(!i||!r)&&(t[1]>i[1]&&t[1]<r[1]||i[1]===r[1]&&t[1]===i[1]&&t[0]>i[0]&&t[0]<r[0]||i[1]<r[1]&&t[1]===r[1]&&t[0]<r[0])},t.prototype.selectWordAtCursor=function(e){var t=this._getMouseBufferCoords(e);t&&(this._selectWordAt(t,!1),this._model.selectionEnd=null,this.refresh(!0))},t.prototype.selectAll=function(){this._model.isSelectAllActive=!0,this.refresh(),this._terminal.emit("selection")},t.prototype.selectLines=function(e,t){this._model.clearSelection(),e=Math.max(e,0),t=Math.min(t,this._terminal.buffer.lines.length-1),this._model.selectionStart=[0,e],this._model.selectionEnd=[this._terminal.cols,t],this.refresh(),this._terminal.emit("selection")},t.prototype._onTrim=function(e){this._model.onTrim(e)&&this.refresh()},t.prototype._getMouseBufferCoords=function(e){var t=this._terminal.mouseHelper.getCoords(e,this._terminal.screenElement,this._charMeasure,this._terminal.options.lineHeight,this._terminal.cols,this._terminal.rows,!0);return t?(t[0]--,t[1]--,t[1]+=this._terminal.buffer.ydisp,t):null},t.prototype._getMouseEventScrollAmount=function(e){var t=MouseHelper_1.MouseHelper.getCoordsRelativeToElement(e,this._terminal.screenElement)[1],i=this._terminal.rows*Math.ceil(this._charMeasure.height*this._terminal.options.lineHeight);return t>=0&&t<=i?0:(t>i&&(t-=i),t=Math.min(Math.max(t,-DRAG_SCROLL_MAX_THRESHOLD),DRAG_SCROLL_MAX_THRESHOLD),(t/=DRAG_SCROLL_MAX_THRESHOLD)/Math.abs(t)+Math.round(t*(DRAG_SCROLL_MAX_SPEED-1)))},t.prototype.shouldForceSelection=function(e){return Browser.isMac?e.altKey&&this._terminal.options.macOptionClickForcesSelection:e.shiftKey},t.prototype.onMouseDown=function(e){if(this._mouseDownTimeStamp=e.timeStamp,(2!==e.button||!this.hasSelection)&&0===e.button){if(!this._enabled){if(!this.shouldForceSelection(e))return;e.stopPropagation()}e.preventDefault(),this._dragScrollAmount=0,this._enabled&&e.shiftKey?this._onIncrementalClick(e):1===e.detail?this._onSingleClick(e):2===e.detail?this._onDoubleClick(e):3===e.detail&&this._onTripleClick(e),this._addMouseDownListeners(),this.refresh(!0)}},t.prototype._addMouseDownListeners=function(){var e=this;this._terminal.element.ownerDocument.addEventListener("mousemove",this._mouseMoveListener),this._terminal.element.ownerDocument.addEventListener("mouseup",this._mouseUpListener),this._dragScrollIntervalTimer=setInterval(function(){return e._dragScroll()},DRAG_SCROLL_INTERVAL)},t.prototype._removeMouseDownListeners=function(){this._terminal.element.ownerDocument&&(this._terminal.element.ownerDocument.removeEventListener("mousemove",this._mouseMoveListener),this._terminal.element.ownerDocument.removeEventListener("mouseup",this._mouseUpListener)),clearInterval(this._dragScrollIntervalTimer),this._dragScrollIntervalTimer=null},t.prototype._onIncrementalClick=function(e){this._model.selectionStart&&(this._model.selectionEnd=this._getMouseBufferCoords(e))},t.prototype._onSingleClick=function(e){if(this._model.selectionStartLength=0,this._model.isSelectAllActive=!1,this._activeSelectionMode=this.shouldColumnSelect(e)?3:0,this._model.selectionStart=this._getMouseBufferCoords(e),this._model.selectionStart){this._model.selectionEnd=null;var t=this._buffer.lines.get(this._model.selectionStart[1]);if(t)if(!(t.length>=this._model.selectionStart[0]))0===t.get(this._model.selectionStart[0])[Buffer_1.CHAR_DATA_WIDTH_INDEX]&&this._model.selectionStart[0]++}},t.prototype._onDoubleClick=function(e){var t=this._getMouseBufferCoords(e);t&&(this._activeSelectionMode=1,this._selectWordAt(t,!0))},t.prototype._onTripleClick=function(e){var t=this._getMouseBufferCoords(e);t&&(this._activeSelectionMode=2,this._selectLineAt(t[1]))},t.prototype.shouldColumnSelect=function(e){return e.altKey&&!(Browser.isMac&&this._terminal.options.macOptionClickForcesSelection)},t.prototype._onMouseMove=function(e){e.stopImmediatePropagation();var t=this._model.selectionEnd?[this._model.selectionEnd[0],this._model.selectionEnd[1]]:null;if(this._model.selectionEnd=this._getMouseBufferCoords(e),this._model.selectionEnd){if(2===this._activeSelectionMode?this._model.selectionEnd[1]<this._model.selectionStart[1]?this._model.selectionEnd[0]=0:this._model.selectionEnd[0]=this._terminal.cols:1===this._activeSelectionMode&&this._selectToWordAt(this._model.selectionEnd),this._dragScrollAmount=this._getMouseEventScrollAmount(e),3!==this._activeSelectionMode&&(this._dragScrollAmount>0?this._model.selectionEnd[0]=this._terminal.cols:this._dragScrollAmount<0&&(this._model.selectionEnd[0]=0)),this._model.selectionEnd[1]<this._buffer.lines.length){var i=this._buffer.lines.get(this._model.selectionEnd[1]).get(this._model.selectionEnd[0]);i&&0===i[Buffer_1.CHAR_DATA_WIDTH_INDEX]&&this._model.selectionEnd[0]++}t&&t[0]===this._model.selectionEnd[0]&&t[1]===this._model.selectionEnd[1]||this.refresh(!0)}else this.refresh(!0)},t.prototype._dragScroll=function(){this._dragScrollAmount&&(this._terminal.scrollLines(this._dragScrollAmount,!1),this._dragScrollAmount>0?(3!==this._activeSelectionMode&&(this._model.selectionEnd[0]=this._terminal.cols),this._model.selectionEnd[1]=Math.min(this._terminal.buffer.ydisp+this._terminal.rows,this._terminal.buffer.lines.length-1)):(3!==this._activeSelectionMode&&(this._model.selectionEnd[0]=0),this._model.selectionEnd[1]=this._terminal.buffer.ydisp),this.refresh())},t.prototype._onMouseUp=function(e){var t=e.timeStamp-this._mouseDownTimeStamp;this._removeMouseDownListeners(),this.selectionText.length<=1&&t<ALT_CLICK_MOVE_CURSOR_TIME?new AltClickHandler_1.AltClickHandler(e,this._terminal).move():this.hasSelection&&this._terminal.emit("selection")},t.prototype._onBufferActivate=function(e){this.clearSelection(),e.inactiveBuffer.lines.off("trim",this._trimListener),e.activeBuffer.lines.on("trim",this._trimListener)},t.prototype._convertViewportColToCharacterIndex=function(e,t){for(var i=t[0],r=0;t[0]>=r;r++){var n=e.get(r);0===n[Buffer_1.CHAR_DATA_WIDTH_INDEX]?i--:n[Buffer_1.CHAR_DATA_CHAR_INDEX].length>1&&t[0]!==r&&(i+=n[Buffer_1.CHAR_DATA_CHAR_INDEX].length-1)}return i},t.prototype.setSelection=function(e,t,i){this._model.clearSelection(),this._removeMouseDownListeners(),this._model.selectionStart=[e,t],this._model.selectionStartLength=i,this.refresh()},t.prototype._getWordAt=function(e,t,i,r){if(void 0===i&&(i=!0),void 0===r&&(r=!0),e[0]>=this._terminal.cols)return null;var n=this._buffer.lines.get(e[1]);if(!n)return null;var o=this._buffer.translateBufferLineToString(e[1],!1),s=this._convertViewportColToCharacterIndex(n,e),l=s,_=e[0]-s,h=0,a=0,c=0,f=0;if(" "===o.charAt(s)){for(;s>0&&" "===o.charAt(s-1);)s--;for(;l<o.length&&" "===o.charAt(l+1);)l++}else{var u=e[0],m=e[0];for(0===n.get(u)[Buffer_1.CHAR_DATA_WIDTH_INDEX]&&(h++,u--),2===n.get(m)[Buffer_1.CHAR_DATA_WIDTH_INDEX]&&(a++,m++),n.get(m)[Buffer_1.CHAR_DATA_CHAR_INDEX].length>1&&(f+=n.get(m)[Buffer_1.CHAR_DATA_CHAR_INDEX].length-1,l+=n.get(m)[Buffer_1.CHAR_DATA_CHAR_INDEX].length-1);u>0&&s>0&&!this._isCharWordSeparator(n.get(u-1));){0===(d=n.get(u-1))[Buffer_1.CHAR_DATA_WIDTH_INDEX]?(h++,u--):d[Buffer_1.CHAR_DATA_CHAR_INDEX].length>1&&(c+=d[Buffer_1.CHAR_DATA_CHAR_INDEX].length-1,s-=d[Buffer_1.CHAR_DATA_CHAR_INDEX].length-1),s--,u--}for(;m<n.length&&l+1<o.length&&!this._isCharWordSeparator(n.get(m+1));){var d;2===(d=n.get(m+1))[Buffer_1.CHAR_DATA_WIDTH_INDEX]?(a++,m++):d[Buffer_1.CHAR_DATA_CHAR_INDEX].length>1&&(f+=d[Buffer_1.CHAR_DATA_CHAR_INDEX].length-1,l+=d[Buffer_1.CHAR_DATA_CHAR_INDEX].length-1),l++,m++}}l++;var A=s+_-h+c,p=Math.min(this._terminal.cols,l-s+h+a-c-f);if(!t&&""===o.slice(s,l).trim())return null;if(i&&0===A&&32!==n.get(0)[Buffer_1.CHAR_DATA_CODE_INDEX]){var S=this._buffer.lines.get(e[1]-1);if(S&&n.isWrapped&&32!==S.get(this._terminal.cols-1)[Buffer_1.CHAR_DATA_CODE_INDEX]){var g=this._getWordAt([this._terminal.cols-1,e[1]-1],!1,!0,!1);if(g){var E=this._terminal.cols-g.start;A-=E,p+=E}}}if(r&&A+p===this._terminal.cols&&32!==n.get(this._terminal.cols-1)[Buffer_1.CHAR_DATA_CODE_INDEX]){var v=this._buffer.lines.get(e[1]+1);if(v&&v.isWrapped&&32!==v.get(0)[Buffer_1.CHAR_DATA_CODE_INDEX]){var C=this._getWordAt([0,e[1]+1],!1,!1,!0);C&&(p+=C.length)}}return{start:A,length:p}},t.prototype._selectWordAt=function(e,t){var i=this._getWordAt(e,t);if(i){for(;i.start<0;)i.start+=this._terminal.cols,e[1]--;this._model.selectionStart=[i.start,e[1]],this._model.selectionStartLength=i.length}},t.prototype._selectToWordAt=function(e){var t=this._getWordAt(e,!0);if(t){for(var i=e[1];t.start<0;)t.start+=this._terminal.cols,i--;if(!this._model.areSelectionValuesReversed())for(;t.start+t.length>this._terminal.cols;)t.length-=this._terminal.cols,i++;this._model.selectionEnd=[this._model.areSelectionValuesReversed()?t.start:t.start+t.length,i]}},t.prototype._isCharWordSeparator=function(e){return 0!==e[Buffer_1.CHAR_DATA_WIDTH_INDEX]&&WORD_SEPARATORS.indexOf(e[Buffer_1.CHAR_DATA_CHAR_INDEX])>=0},t.prototype._selectLineAt=function(e){var t=this._buffer.getWrappedRangeForLine(e);this._model.selectionStart=[0,t.first],this._model.selectionEnd=[this._terminal.cols,t.last],this._model.selectionStartLength=0},t}(EventEmitter_1.EventEmitter);exports.SelectionManager=SelectionManager;

},{"./Buffer":13,"./SelectionModel":22,"./common/EventEmitter":28,"./handlers/AltClickHandler":33,"./shared/utils/Browser":57,"./utils/MouseHelper":64}],22:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var SelectionModel=function(){function t(t){this._terminal=t,this.clearSelection()}return t.prototype.clearSelection=function(){this.selectionStart=null,this.selectionEnd=null,this.isSelectAllActive=!1,this.selectionStartLength=0},Object.defineProperty(t.prototype,"finalSelectionStart",{get:function(){return this.isSelectAllActive?[0,0]:this.selectionEnd&&this.selectionStart&&this.areSelectionValuesReversed()?this.selectionEnd:this.selectionStart},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"finalSelectionEnd",{get:function(){if(this.isSelectAllActive)return[this._terminal.cols,this._terminal.buffer.ybase+this._terminal.rows-1];if(!this.selectionStart)return null;if(!this.selectionEnd||this.areSelectionValuesReversed()){var t=this.selectionStart[0]+this.selectionStartLength;return t>this._terminal.cols?[t%this._terminal.cols,this.selectionStart[1]+Math.floor(t/this._terminal.cols)]:[t,this.selectionStart[1]]}return this.selectionStartLength&&this.selectionEnd[1]===this.selectionStart[1]?[Math.max(this.selectionStart[0]+this.selectionStartLength,this.selectionEnd[0]),this.selectionEnd[1]]:this.selectionEnd},enumerable:!0,configurable:!0}),t.prototype.areSelectionValuesReversed=function(){var t=this.selectionStart,e=this.selectionEnd;return!(!t||!e)&&(t[1]>e[1]||t[1]===e[1]&&t[0]>e[0])},t.prototype.onTrim=function(t){return this.selectionStart&&(this.selectionStart[1]-=t),this.selectionEnd&&(this.selectionEnd[1]-=t),this.selectionEnd&&this.selectionEnd[1]<0?(this.clearSelection(),!0):(this.selectionStart&&this.selectionStart[1]<0&&(this.selectionStart[1]=0),!1)},t}();exports.SelectionModel=SelectionModel;

},{}],23:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.DEFAULT_BELL_SOUND="data:audio/wav;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQBAADpAFgCwAMlBZoG/wdmCcoKRAypDQ8PbRDBEQQTOxRtFYcWlBePGIUZXhoiG88bcBz7HHIdzh0WHlMeZx51HmkeUx4WHs8dah0AHXwc3hs9G4saxRnyGBIYGBcQFv8U4RPAEoYRQBACD70NWwwHC6gJOwjWBloF7gOBAhABkf8b/qv8R/ve+Xf4Ife79W/0JfPZ8Z/wde9N7ijtE+wU6xvqM+lb6H7nw+YX5mrlxuQz5Mzje+Ma49fioeKD4nXiYeJy4pHitOL04j/jn+MN5IPkFOWs5U3mDefM55/ogOl36m7rdOyE7abuyu8D8Unyj/Pg9D/2qfcb+Yn6/vuK/Qj/lAAlAg==";var SoundManager=function(){function e(e){this._terminal=e}return e.prototype.playBellSound=function(){var e=window.AudioContext||window.webkitAudioContext;if(!this._audioContext&&e&&(this._audioContext=new e),this._audioContext){var t=this._audioContext.createBufferSource(),o=this._audioContext;this._audioContext.decodeAudioData(this._base64ToArrayBuffer(this._removeMimeType(this._terminal.options.bellSound)),function(e){t.buffer=e,t.connect(o.destination),t.start(0)})}else console.warn("Sorry, but the Web Audio API is not supported by your browser. Please, consider upgrading to the latest version")},e.prototype._base64ToArrayBuffer=function(e){for(var t=window.atob(e),o=t.length,n=new Uint8Array(o),r=0;r<o;r++)n[r]=t.charCodeAt(r);return n.buffer},e.prototype._removeMimeType=function(e){return e.split(",")[1]},e}();exports.SoundManager=SoundManager;

},{}],24:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.blankLine="Blank line",exports.promptLabel="Terminal input",exports.tooMuchOutput="Too much output to announce, navigate to rows manually to read";

},{}],25:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var BufferSet_1=require("./BufferSet"),Buffer_1=require("./Buffer"),CompositionHelper_1=require("./CompositionHelper"),EventEmitter_1=require("./common/EventEmitter"),Viewport_1=require("./Viewport"),Clipboard_1=require("./handlers/Clipboard"),EscapeSequences_1=require("./common/data/EscapeSequences"),InputHandler_1=require("./InputHandler"),Renderer_1=require("./renderer/Renderer"),Linkifier_1=require("./Linkifier"),SelectionManager_1=require("./SelectionManager"),CharMeasure_1=require("./ui/CharMeasure"),Browser=require("./shared/utils/Browser"),Lifecycle_1=require("./ui/Lifecycle"),Strings=require("./Strings"),MouseHelper_1=require("./utils/MouseHelper"),Clone_1=require("./utils/Clone"),SoundManager_1=require("./SoundManager"),ColorManager_1=require("./renderer/ColorManager"),MouseZoneManager_1=require("./ui/MouseZoneManager"),AccessibilityManager_1=require("./AccessibilityManager"),ScreenDprMonitor_1=require("./ui/ScreenDprMonitor"),CharAtlasCache_1=require("./renderer/atlas/CharAtlasCache"),DomRenderer_1=require("./renderer/dom/DomRenderer"),Keyboard_1=require("./core/input/Keyboard"),BufferLine_1=require("./BufferLine"),document="undefined"!=typeof window?window.document:null,WRITE_BUFFER_PAUSE_THRESHOLD=5,WRITE_BATCH_SIZE=300,CONSTRUCTOR_ONLY_OPTIONS=["cols","rows"],DEFAULT_OPTIONS={cols:80,rows:24,convertEol:!1,termName:"xterm",cursorBlink:!1,cursorStyle:"block",bellSound:SoundManager_1.DEFAULT_BELL_SOUND,bellStyle:"none",drawBoldTextInBrightColors:!0,enableBold:!0,experimentalCharAtlas:"static",fontFamily:"courier-new, courier, monospace",fontSize:15,fontWeight:"normal",fontWeightBold:"bold",lineHeight:1,letterSpacing:0,scrollback:1e3,screenKeys:!1,screenReaderMode:!1,debug:!1,macOptionIsMeta:!1,macOptionClickForcesSelection:!1,cancelEvents:!1,disableStdin:!1,useFlowControl:!1,allowTransparency:!1,tabStopWidth:8,theme:null,rightClickSelectsWord:Browser.isMac,rendererType:"canvas"},Terminal=function(e){function t(t){void 0===t&&(t={});var r=e.call(this)||this;return r.browser=Browser,r.options=Clone_1.clone(t),r._setup(),r}return __extends(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this),this._customKeyEventHandler=null,CharAtlasCache_1.removeTerminalFromCache(this),this.handler=function(){},this.write=function(){},this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)},t.prototype.destroy=function(){this.dispose()},t.prototype._setup=function(){var e=this;Object.keys(DEFAULT_OPTIONS).forEach(function(t){null!==e.options[t]&&void 0!==e.options[t]||(e.options[t]=DEFAULT_OPTIONS[t])}),this._parent=document?document.body:null,this.cols=this.options.cols,this.rows=this.options.rows,this.options.handler&&this.on("data",this.options.handler),this.cursorState=0,this.cursorHidden=!1,this._customKeyEventHandler=null,this.applicationKeypad=!1,this.applicationCursor=!1,this.originMode=!1,this.insertMode=!1,this.wraparoundMode=!0,this.bracketedPasteMode=!1,this.charset=null,this.gcharset=null,this.glevel=0,this.charsets=[null],this.curAttr=Buffer_1.DEFAULT_ATTR,this.params=[],this.currentParam=0,this.writeBuffer=[],this._writeInProgress=!1,this._xoffSentToCatchUp=!1,this._userScrolling=!1,this._inputHandler=new InputHandler_1.InputHandler(this),this.register(this._inputHandler),this.renderer=this.renderer||null,this.selectionManager=this.selectionManager||null,this.linkifier=this.linkifier||new Linkifier_1.Linkifier(this),this._mouseZoneManager=this._mouseZoneManager||null,this.soundManager=this.soundManager||new SoundManager_1.SoundManager(this),this.buffers=new BufferSet_1.BufferSet(this),this.selectionManager&&(this.selectionManager.clearSelection(),this.selectionManager.initBuffersListeners())},Object.defineProperty(t.prototype,"buffer",{get:function(){return this.buffers.active},enumerable:!0,configurable:!0}),t.prototype.eraseAttr=function(){return-512&Buffer_1.DEFAULT_ATTR|511&this.curAttr},t.prototype.focus=function(){this.textarea&&this.textarea.focus()},Object.defineProperty(t.prototype,"isFocused",{get:function(){return document.activeElement===this.textarea},enumerable:!0,configurable:!0}),t.prototype.getOption=function(e){if(!(e in DEFAULT_OPTIONS))throw new Error('No option with key "'+e+'"');return this.options[e]},t.prototype.setOption=function(e,t){if(!(e in DEFAULT_OPTIONS))throw new Error('No option with key "'+e+'"');if(-1!==CONSTRUCTOR_ONLY_OPTIONS.indexOf(e)&&console.error('Option "'+e+'" can only be set in the constructor'),this.options[e]!==t){switch(e){case"bellStyle":t||(t="none");break;case"cursorStyle":t||(t="block");break;case"fontWeight":t||(t="normal");break;case"fontWeightBold":t||(t="bold");break;case"lineHeight":if(t<1)return void console.warn(e+" cannot be less than 1, value: "+t);case"rendererType":t||(t="canvas");break;case"tabStopWidth":if(t<1)return void console.warn(e+" cannot be less than 1, value: "+t);break;case"theme":if(this.renderer)return void this._setTheme(t);break;case"scrollback":if((t=Math.min(t,Buffer_1.MAX_BUFFER_SIZE))<0)return void console.warn(e+" cannot be less than 0, value: "+t);if(this.options[e]!==t){var r=this.rows+t;if(this.buffer.lines.length>r){var i=this.buffer.lines.length-r,s=this.buffer.ydisp-i<0;this.buffer.lines.trimStart(i),this.buffer.ybase=Math.max(this.buffer.ybase-i,0),this.buffer.ydisp=Math.max(this.buffer.ydisp-i,0),s&&this.refresh(0,this.rows-1)}}}switch(this.options[e]=t,e){case"fontFamily":case"fontSize":this.renderer&&(this.renderer.clear(),this.charMeasure.measure(this.options));break;case"drawBoldTextInBrightColors":case"experimentalCharAtlas":case"enableBold":case"letterSpacing":case"lineHeight":case"fontWeight":case"fontWeightBold":this.renderer&&(this.renderer.clear(),this.renderer.onResize(this.cols,this.rows),this.refresh(0,this.rows-1));case"rendererType":this.renderer&&(this.unregister(this.renderer),this.renderer.dispose(),this.renderer=null),this._setupRenderer(),this.renderer.onCharSizeChanged(),this._theme&&this.renderer.setTheme(this._theme);break;case"scrollback":this.buffers.resize(this.cols,this.rows),this.viewport&&this.viewport.syncScrollArea();break;case"screenReaderMode":t?this._accessibilityManager||(this._accessibilityManager=new AccessibilityManager_1.AccessibilityManager(this)):this._accessibilityManager&&(this._accessibilityManager.dispose(),this._accessibilityManager=null);break;case"tabStopWidth":this.buffers.setupTabStops()}this.renderer&&this.renderer.onOptionsChanged()}},t.prototype._onTextAreaFocus=function(e){this.sendFocus&&this.handler(EscapeSequences_1.C0.ESC+"[I"),this.updateCursorStyle(e),this.element.classList.add("focus"),this.showCursor(),this.emit("focus")},t.prototype.blur=function(){return this.textarea.blur()},t.prototype._onTextAreaBlur=function(){this.textarea.value="",this.refresh(this.buffer.y,this.buffer.y),this.sendFocus&&this.handler(EscapeSequences_1.C0.ESC+"[O"),this.element.classList.remove("focus"),this.emit("blur")},t.prototype._initGlobal=function(){var e=this;this._bindKeys(),this.register(Lifecycle_1.addDisposableDomListener(this.element,"copy",function(t){e.hasSelection()&&Clipboard_1.copyHandler(t,e,e.selectionManager)}));var t=function(t){return Clipboard_1.pasteHandler(t,e)};this.register(Lifecycle_1.addDisposableDomListener(this.textarea,"paste",t)),this.register(Lifecycle_1.addDisposableDomListener(this.element,"paste",t)),Browser.isFirefox?this.register(Lifecycle_1.addDisposableDomListener(this.element,"mousedown",function(t){2===t.button&&Clipboard_1.rightClickHandler(t,e.textarea,e.selectionManager,e.options.rightClickSelectsWord)})):this.register(Lifecycle_1.addDisposableDomListener(this.element,"contextmenu",function(t){Clipboard_1.rightClickHandler(t,e.textarea,e.selectionManager,e.options.rightClickSelectsWord)})),Browser.isLinux&&this.register(Lifecycle_1.addDisposableDomListener(this.element,"auxclick",function(t){1===t.button&&Clipboard_1.moveTextAreaUnderMouseCursor(t,e.textarea)}))},t.prototype._bindKeys=function(){var e=this,t=this;this.register(Lifecycle_1.addDisposableDomListener(this.element,"keydown",function(e){document.activeElement===this&&t._keyDown(e)},!0)),this.register(Lifecycle_1.addDisposableDomListener(this.element,"keypress",function(e){document.activeElement===this&&t._keyPress(e)},!0)),this.register(Lifecycle_1.addDisposableDomListener(this.element,"keyup",function(r){wasModifierKeyOnlyEvent(r)||e.focus(),t._keyUp(r)},!0)),this.register(Lifecycle_1.addDisposableDomListener(this.textarea,"keydown",function(t){return e._keyDown(t)},!0)),this.register(Lifecycle_1.addDisposableDomListener(this.textarea,"keypress",function(t){return e._keyPress(t)},!0)),this.register(Lifecycle_1.addDisposableDomListener(this.textarea,"compositionstart",function(){return e._compositionHelper.compositionstart()})),this.register(Lifecycle_1.addDisposableDomListener(this.textarea,"compositionupdate",function(t){return e._compositionHelper.compositionupdate(t)})),this.register(Lifecycle_1.addDisposableDomListener(this.textarea,"compositionend",function(){return e._compositionHelper.compositionend()})),this.register(this.addDisposableListener("refresh",function(){return e._compositionHelper.updateCompositionElements()})),this.register(this.addDisposableListener("refresh",function(t){return e._queueLinkification(t.start,t.end)}))},t.prototype.open=function(e){var t=this;if(this._parent=e||this._parent,!this._parent)throw new Error("Terminal requires a parent element.");this._context=this._parent.ownerDocument.defaultView,this._document=this._parent.ownerDocument,this._screenDprMonitor=new ScreenDprMonitor_1.ScreenDprMonitor,this._screenDprMonitor.setListener(function(){return t.emit("dprchange",window.devicePixelRatio)}),this.register(this._screenDprMonitor),this.element=this._document.createElement("div"),this.element.dir="ltr",this.element.classList.add("terminal"),this.element.classList.add("xterm"),this.element.setAttribute("tabindex","0"),this._parent.appendChild(this.element);var r=document.createDocumentFragment();this._viewportElement=document.createElement("div"),this._viewportElement.classList.add("xterm-viewport"),r.appendChild(this._viewportElement),this._viewportScrollArea=document.createElement("div"),this._viewportScrollArea.classList.add("xterm-scroll-area"),this._viewportElement.appendChild(this._viewportScrollArea),this.screenElement=document.createElement("div"),this.screenElement.classList.add("xterm-screen"),this._helperContainer=document.createElement("div"),this._helperContainer.classList.add("xterm-helpers"),this.screenElement.appendChild(this._helperContainer),r.appendChild(this.screenElement),this._mouseZoneManager=new MouseZoneManager_1.MouseZoneManager(this),this.register(this._mouseZoneManager),this.register(this.addDisposableListener("scroll",function(){return t._mouseZoneManager.clearAll()})),this.linkifier.attachToDom(this._mouseZoneManager),this.textarea=document.createElement("textarea"),this.textarea.classList.add("xterm-helper-textarea"),this.textarea.setAttribute("aria-label",Strings.promptLabel),this.textarea.setAttribute("aria-multiline","false"),this.textarea.setAttribute("autocorrect","off"),this.textarea.setAttribute("autocapitalize","off"),this.textarea.setAttribute("spellcheck","false"),this.textarea.tabIndex=0,this.register(Lifecycle_1.addDisposableDomListener(this.textarea,"focus",function(e){return t._onTextAreaFocus(e)})),this.register(Lifecycle_1.addDisposableDomListener(this.textarea,"blur",function(){return t._onTextAreaBlur()})),this._helperContainer.appendChild(this.textarea),this._compositionView=document.createElement("div"),this._compositionView.classList.add("composition-view"),this._compositionHelper=new CompositionHelper_1.CompositionHelper(this.textarea,this._compositionView,this),this._helperContainer.appendChild(this._compositionView),this.charMeasure=new CharMeasure_1.CharMeasure(document,this._helperContainer),this.element.appendChild(r),this._setupRenderer(),this._theme=this.options.theme,this.options.theme=null,this.viewport=new Viewport_1.Viewport(this,this._viewportElement,this._viewportScrollArea,this.charMeasure),this.viewport.onThemeChanged(this.renderer.colorManager.colors),this.register(this.viewport),this.register(this.addDisposableListener("cursormove",function(){return t.renderer.onCursorMove()})),this.register(this.addDisposableListener("resize",function(){return t.renderer.onResize(t.cols,t.rows)})),this.register(this.addDisposableListener("blur",function(){return t.renderer.onBlur()})),this.register(this.addDisposableListener("focus",function(){return t.renderer.onFocus()})),this.register(this.addDisposableListener("dprchange",function(){return t.renderer.onWindowResize(window.devicePixelRatio)})),this.register(Lifecycle_1.addDisposableDomListener(window,"resize",function(){return t.renderer.onWindowResize(window.devicePixelRatio)})),this.register(this.charMeasure.addDisposableListener("charsizechanged",function(){return t.renderer.onCharSizeChanged()})),this.register(this.renderer.addDisposableListener("resize",function(e){return t.viewport.syncScrollArea()})),this.selectionManager=new SelectionManager_1.SelectionManager(this,this.charMeasure),this.register(Lifecycle_1.addDisposableDomListener(this.element,"mousedown",function(e){return t.selectionManager.onMouseDown(e)})),this.register(this.selectionManager.addDisposableListener("refresh",function(e){return t.renderer.onSelectionChanged(e.start,e.end,e.columnSelectMode)})),this.register(this.selectionManager.addDisposableListener("newselection",function(e){t.textarea.value=e,t.textarea.focus(),t.textarea.select()})),this.register(this.addDisposableListener("scroll",function(){t.viewport.syncScrollArea(),t.selectionManager.refresh()})),this.register(Lifecycle_1.addDisposableDomListener(this._viewportElement,"scroll",function(){return t.selectionManager.refresh()})),this.mouseHelper=new MouseHelper_1.MouseHelper(this.renderer),this.options.screenReaderMode&&(this._accessibilityManager=new AccessibilityManager_1.AccessibilityManager(this)),this.charMeasure.measure(this.options),this.refresh(0,this.rows-1),this._initGlobal(),this.bindMouse()},t.prototype._setupRenderer=function(){switch(this.options.rendererType){case"canvas":this.renderer=new Renderer_1.Renderer(this,this.options.theme);break;case"dom":this.renderer=new DomRenderer_1.DomRenderer(this,this.options.theme);break;default:throw new Error('Unrecognized rendererType "'+this.options.rendererType+'"')}this.register(this.renderer)},t.prototype._setTheme=function(e){this._theme=e;var t=this.renderer.setTheme(e);this.viewport&&this.viewport.onThemeChanged(t)},t.prototype.bindMouse=function(){var e=this,t=this.element,r=this,i=32;function s(e){var t,s;if(t=function(e){var t,i,s,n,o;switch(e.overrideType||e.type){case"mousedown":t=null!==e.button&&void 0!==e.button?+e.button:null!==e.which&&void 0!==e.which?e.which-1:null,Browser.isMSIE&&(t=1===t?0:4===t?1:t);break;case"mouseup":t=3;break;case"DOMMouseScroll":t=e.detail<0?64:65;break;case"wheel":t=e.wheelDeltaY>0?64:65}i=e.shiftKey?4:0,s=e.metaKey?8:0,n=e.ctrlKey?16:0,o=i|s|n,r.vt200Mouse?o&=n:r.normalMouse||(o=0);return t=32+(o<<2)+t}(e),s=r.mouseHelper.getRawByteCoords(e,r.screenElement,r.charMeasure,r.options.lineHeight,r.cols,r.rows))switch(o(t,s),e.overrideType||e.type){case"mousedown":i=t;break;case"mouseup":i=32}}function n(e,t){if(r.utfMouse){if(2047===t)return void e.push(0);t<127?e.push(t):(t>2047&&(t=2047),e.push(192|t>>6),e.push(128|63&t))}else{if(255===t)return void e.push(0);t>127&&(t=127),e.push(t)}}function o(e,t){if(r._vt300Mouse){e&=3,t.x-=32,t.y-=32;var i=EscapeSequences_1.C0.ESC+"[24";if(0===e)i+="1";else if(1===e)i+="3";else if(2===e)i+="5";else{if(3===e)return;i+="0"}return i+="~["+t.x+","+t.y+"]\r",void r.handler(i)}if(r._decLocator)return e&=3,t.x-=32,t.y-=32,0===e?e=2:1===e?e=4:2===e?e=6:3===e&&(e=3),void r.handler(EscapeSequences_1.C0.ESC+"["+e+";"+(3===e?4:0)+";"+t.y+";"+t.x+";"+t.page||"0&w");if(r.urxvtMouse)return t.x-=32,t.y-=32,t.x++,t.y++,void r.handler(EscapeSequences_1.C0.ESC+"["+e+";"+t.x+";"+t.y+"M");if(r.sgrMouse)return t.x-=32,t.y-=32,void r.handler(EscapeSequences_1.C0.ESC+"[<"+((3==(3&e)?-4&e:e)-32)+";"+t.x+";"+t.y+(3==(3&e)?"m":"M"));var s=[];n(s,e),n(s,t.x),n(s,t.y),r.handler(EscapeSequences_1.C0.ESC+"[M"+String.fromCharCode.apply(String,s))}this.register(Lifecycle_1.addDisposableDomListener(t,"mousedown",function(t){if(t.preventDefault(),e.focus(),e.mouseEvents&&!e.selectionManager.shouldForceSelection(t)){if(s(t),e.vt200Mouse)return t.overrideType="mouseup",s(t),e.cancel(t);var n;e.normalMouse&&(n=function(t){var s,n,a;e.normalMouse&&(s=t,n=i,(a=r.mouseHelper.getRawByteCoords(s,r.screenElement,r.charMeasure,r.options.lineHeight,r.cols,r.rows))&&o(n+=32,a))},e._document.addEventListener("mousemove",n));var a=function(t){return e.normalMouse&&!e.x10Mouse&&s(t),n&&(e._document.removeEventListener("mousemove",n),n=null),e._document.removeEventListener("mouseup",a),e.cancel(t)};return e._document.addEventListener("mouseup",a),e.cancel(t)}})),this.register(Lifecycle_1.addDisposableDomListener(t,"wheel",function(t){if(e.mouseEvents)e.x10Mouse||e._vt300Mouse||e._decLocator||(s(t),t.preventDefault());else if(!e.buffer.hasScrollback){var r=e.viewport.getLinesScrolled(t);if(0===r)return;for(var i=EscapeSequences_1.C0.ESC+(e.applicationCursor?"O":"[")+(t.deltaY<0?"A":"B"),n="",o=0;o<Math.abs(r);o++)n+=i;e.handler(n)}})),this.register(Lifecycle_1.addDisposableDomListener(t,"wheel",function(t){if(!e.mouseEvents)return e.viewport.onWheel(t),e.cancel(t)})),this.register(Lifecycle_1.addDisposableDomListener(t,"touchstart",function(t){if(!e.mouseEvents)return e.viewport.onTouchStart(t),e.cancel(t)})),this.register(Lifecycle_1.addDisposableDomListener(t,"touchmove",function(t){if(!e.mouseEvents)return e.viewport.onTouchMove(t),e.cancel(t)}))},t.prototype.refresh=function(e,t){this.renderer&&this.renderer.refreshRows(e,t)},t.prototype._queueLinkification=function(e,t){this.linkifier&&this.linkifier.linkifyRows(e,t)},t.prototype.updateCursorStyle=function(e){this.selectionManager&&this.selectionManager.shouldColumnSelect(e)?this.element.classList.add("xterm-cursor-crosshair"):this.element.classList.remove("xterm-cursor-crosshair")},t.prototype.showCursor=function(){this.cursorState||(this.cursorState=1,this.refresh(this.buffer.y,this.buffer.y))},t.prototype.scroll=function(e){var t=BufferLine_1.BufferLine.blankLine(this.cols,Buffer_1.DEFAULT_ATTR,e),r=this.buffer.ybase+this.buffer.scrollTop,i=this.buffer.ybase+this.buffer.scrollBottom;if(0===this.buffer.scrollTop){var s=this.buffer.lines.length===this.buffer.lines.maxLength;i===this.buffer.lines.length-1?this.buffer.lines.push(t):this.buffer.lines.splice(i+1,0,t),s?this._userScrolling&&(this.buffer.ydisp=Math.max(this.buffer.ydisp-1,0)):(this.buffer.ybase++,this._userScrolling||this.buffer.ydisp++)}else{var n=i-r+1;this.buffer.lines.shiftElements(r+1,n-1,-1),this.buffer.lines.set(i,t)}this._userScrolling||(this.buffer.ydisp=this.buffer.ybase),this.updateRange(this.buffer.scrollTop),this.updateRange(this.buffer.scrollBottom),this.emit("scroll",this.buffer.ydisp)},t.prototype.scrollLines=function(e,t){if(e<0){if(0===this.buffer.ydisp)return;this._userScrolling=!0}else e+this.buffer.ydisp>=this.buffer.ybase&&(this._userScrolling=!1);var r=this.buffer.ydisp;this.buffer.ydisp=Math.max(Math.min(this.buffer.ydisp+e,this.buffer.ybase),0),r!==this.buffer.ydisp&&(t||this.emit("scroll",this.buffer.ydisp),this.refresh(0,this.rows-1))},t.prototype.scrollPages=function(e){this.scrollLines(e*(this.rows-1))},t.prototype.scrollToTop=function(){this.scrollLines(-this.buffer.ydisp)},t.prototype.scrollToBottom=function(){this.scrollLines(this.buffer.ybase-this.buffer.ydisp)},t.prototype.scrollToLine=function(e){var t=e-this.buffer.ydisp;0!==t&&this.scrollLines(t)},t.prototype.write=function(e){var t=this;this._isDisposed||e&&(this.writeBuffer.push(e),this.options.useFlowControl&&!this._xoffSentToCatchUp&&this.writeBuffer.length>=WRITE_BUFFER_PAUSE_THRESHOLD&&(this.handler(EscapeSequences_1.C0.DC3),this._xoffSentToCatchUp=!0),!this._writeInProgress&&this.writeBuffer.length>0&&(this._writeInProgress=!0,setTimeout(function(){t._innerWrite()})))},t.prototype._innerWrite=function(){var e=this;this._isDisposed&&(this.writeBuffer=[]);for(var t=this.writeBuffer.splice(0,WRITE_BATCH_SIZE);t.length>0;){var r=t.shift();this._xoffSentToCatchUp&&0===t.length&&0===this.writeBuffer.length&&(this.handler(EscapeSequences_1.C0.DC1),this._xoffSentToCatchUp=!1),this._refreshStart=this.buffer.y,this._refreshEnd=this.buffer.y,this._inputHandler.parse(r),this.updateRange(this.buffer.y),this.refresh(this._refreshStart,this._refreshEnd)}this.writeBuffer.length>0?setTimeout(function(){return e._innerWrite()},0):this._writeInProgress=!1},t.prototype.writeln=function(e){this.write(e+"\r\n")},t.prototype.attachCustomKeyEventHandler=function(e){this._customKeyEventHandler=e},t.prototype.registerLinkMatcher=function(e,t,r){var i=this.linkifier.registerLinkMatcher(e,t,r);return this.refresh(0,this.rows-1),i},t.prototype.deregisterLinkMatcher=function(e){this.linkifier.deregisterLinkMatcher(e)&&this.refresh(0,this.rows-1)},t.prototype.registerCharacterJoiner=function(e){var t=this.renderer.registerCharacterJoiner(e);return this.refresh(0,this.rows-1),t},t.prototype.deregisterCharacterJoiner=function(e){this.renderer.deregisterCharacterJoiner(e)&&this.refresh(0,this.rows-1)},Object.defineProperty(t.prototype,"markers",{get:function(){return this.buffer.markers},enumerable:!0,configurable:!0}),t.prototype.addMarker=function(e){if(this.buffer===this.buffers.normal)return this.buffer.addMarker(this.buffer.ybase+this.buffer.y+e)},t.prototype.hasSelection=function(){return!!this.selectionManager&&this.selectionManager.hasSelection},t.prototype.getSelection=function(){return this.selectionManager?this.selectionManager.selectionText:""},t.prototype.clearSelection=function(){this.selectionManager&&this.selectionManager.clearSelection()},t.prototype.selectAll=function(){this.selectionManager&&this.selectionManager.selectAll()},t.prototype.selectLines=function(e,t){this.selectionManager&&this.selectionManager.selectLines(e,t)},t.prototype._keyDown=function(e){if(this._customKeyEventHandler&&!1===this._customKeyEventHandler(e))return!1;if(!this._compositionHelper.keydown(e))return this.buffer.ybase!==this.buffer.ydisp&&this.scrollToBottom(),!1;var t=Keyboard_1.evaluateKeyboardEvent(e,this.applicationCursor,this.browser.isMac,this.options.macOptionIsMeta);if(this.updateCursorStyle(e),3===t.type||2===t.type){var r=this.rows-1;return this.scrollLines(2===t.type?-r:r),this.cancel(e,!0)}return 1===t.type&&this.selectAll(),!!this._isThirdLevelShift(this.browser,e)||(t.cancel&&this.cancel(e,!0),!t.key||(this.emit("keydown",e),this.emit("key",t.key,e),this.showCursor(),this.handler(t.key),this.cancel(e,!0)))},t.prototype._isThirdLevelShift=function(e,t){var r=e.isMac&&!this.options.macOptionIsMeta&&t.altKey&&!t.ctrlKey&&!t.metaKey||e.isMSWindows&&t.altKey&&t.ctrlKey&&!t.metaKey;return"keypress"===t.type?r:r&&(!t.keyCode||t.keyCode>47)},t.prototype.setgLevel=function(e){this.glevel=e,this.charset=this.charsets[e]},t.prototype.setgCharset=function(e,t){this.charsets[e]=t,this.glevel===e&&(this.charset=t)},t.prototype._keyUp=function(e){this.updateCursorStyle(e)},t.prototype._keyPress=function(e){var t;if(this._customKeyEventHandler&&!1===this._customKeyEventHandler(e))return!1;if(this.cancel(e),e.charCode)t=e.charCode;else if(null===e.which||void 0===e.which)t=e.keyCode;else{if(0===e.which||0===e.charCode)return!1;t=e.which}return!(!t||(e.altKey||e.ctrlKey||e.metaKey)&&!this._isThirdLevelShift(this.browser,e))&&(t=String.fromCharCode(t),this.emit("keypress",t,e),this.emit("key",t,e),this.showCursor(),this.handler(t),!0)},t.prototype.bell=function(){var e=this;this.emit("bell"),this._soundBell()&&this.soundManager.playBellSound(),this._visualBell()&&(this.element.classList.add("visual-bell-active"),clearTimeout(this._visualBellTimer),this._visualBellTimer=window.setTimeout(function(){e.element.classList.remove("visual-bell-active")},200))},t.prototype.log=function(e,t){this.options.debug&&this._context.console&&this._context.console.log&&this._context.console.log(e,t)},t.prototype.error=function(e,t){this.options.debug&&this._context.console&&this._context.console.error&&this._context.console.error(e,t)},t.prototype.resize=function(e,t){isNaN(e)||isNaN(t)||(e!==this.cols||t!==this.rows?(e<1&&(e=1),t<1&&(t=1),this.buffers.resize(e,t),this.cols=e,this.rows=t,this.buffers.setupTabStops(this.cols),this.charMeasure&&this.charMeasure.measure(this.options),this.refresh(0,this.rows-1),this.emit("resize",{cols:e,rows:t})):!this.charMeasure||this.charMeasure.width&&this.charMeasure.height||this.charMeasure.measure(this.options))},t.prototype.updateRange=function(e){e<this._refreshStart&&(this._refreshStart=e),e>this._refreshEnd&&(this._refreshEnd=e)},t.prototype.maxRange=function(){this._refreshStart=0,this._refreshEnd=this.rows-1},t.prototype.clear=function(){if(0!==this.buffer.ybase||0!==this.buffer.y){this.buffer.lines.set(0,this.buffer.lines.get(this.buffer.ybase+this.buffer.y)),this.buffer.lines.length=1,this.buffer.ydisp=0,this.buffer.ybase=0,this.buffer.y=0;for(var e=1;e<this.rows;e++)this.buffer.lines.push(BufferLine_1.BufferLine.blankLine(this.cols,Buffer_1.DEFAULT_ATTR));this.refresh(0,this.rows-1),this.emit("scroll",this.buffer.ydisp)}},t.prototype.ch=function(e){return e?[this.eraseAttr(),Buffer_1.NULL_CELL_CHAR,Buffer_1.NULL_CELL_WIDTH,Buffer_1.NULL_CELL_CODE]:[Buffer_1.DEFAULT_ATTR,Buffer_1.NULL_CELL_CHAR,Buffer_1.NULL_CELL_WIDTH,Buffer_1.NULL_CELL_CODE]},t.prototype.is=function(e){return 0===(this.options.termName+"").indexOf(e)},t.prototype.handler=function(e){this.options.disableStdin||(this.selectionManager&&this.selectionManager.hasSelection&&this.selectionManager.clearSelection(),this.buffer.ybase!==this.buffer.ydisp&&this.scrollToBottom(),this.emit("data",e))},t.prototype.handleTitle=function(e){this.emit("title",e)},t.prototype.index=function(){this.buffer.y++,this.buffer.y>this.buffer.scrollBottom&&(this.buffer.y--,this.scroll()),this.buffer.x>=this.cols&&this.buffer.x--},t.prototype.reverseIndex=function(){if(this.buffer.y===this.buffer.scrollTop){var e=this.buffer.scrollBottom-this.buffer.scrollTop;this.buffer.lines.shiftElements(this.buffer.y+this.buffer.ybase,e,1),this.buffer.lines.set(this.buffer.y+this.buffer.ybase,BufferLine_1.BufferLine.blankLine(this.cols,this.eraseAttr())),this.updateRange(this.buffer.scrollTop),this.updateRange(this.buffer.scrollBottom)}else this.buffer.y--},t.prototype.reset=function(){this.options.rows=this.rows,this.options.cols=this.cols;var e=this._customKeyEventHandler,t=this._inputHandler,r=this.cursorState;this._setup(),this._customKeyEventHandler=e,this._inputHandler=t,this.cursorState=r,this.refresh(0,this.rows-1),this.viewport&&this.viewport.syncScrollArea()},t.prototype.tabSet=function(){this.buffer.tabs[this.buffer.x]=!0},t.prototype.cancel=function(e,t){if(this.options.cancelEvents||t)return e.preventDefault(),e.stopPropagation(),!1},t.prototype.matchColor=function(e,t,r){var i=e<<16|t<<8|r;if(null!==matchColorCache[i]&&void 0!==matchColorCache[i])return matchColorCache[i];for(var s,n,o=1/0,a=-1,h=0;h<ColorManager_1.DEFAULT_ANSI_COLORS.length;h++){if(0===(n=matchColorDistance(e,t,r,(s=ColorManager_1.DEFAULT_ANSI_COLORS[h].rgba)>>>24,s>>>16&255,s>>>8&255))){a=h;break}n<o&&(o=n,a=h)}return matchColorCache[i]=a},t.prototype._visualBell=function(){return!1},t.prototype._soundBell=function(){return"sound"===this.options.bellStyle},t}(EventEmitter_1.EventEmitter);function wasModifierKeyOnlyEvent(e){return 16===e.keyCode||17===e.keyCode||18===e.keyCode}exports.Terminal=Terminal;var matchColorCache={};function matchColorDistance(e,t,r,i,s,n){return Math.pow(30*(e-i),2)+Math.pow(59*(t-s),2)+Math.pow(11*(r-n),2)}

},{"./AccessibilityManager":12,"./Buffer":13,"./BufferLine":14,"./BufferSet":15,"./CompositionHelper":17,"./InputHandler":19,"./Linkifier":20,"./SelectionManager":21,"./SoundManager":23,"./Strings":24,"./Viewport":26,"./common/EventEmitter":28,"./common/data/EscapeSequences":30,"./core/input/Keyboard":32,"./handlers/Clipboard":34,"./renderer/ColorManager":38,"./renderer/Renderer":42,"./renderer/atlas/CharAtlasCache":46,"./renderer/dom/DomRenderer":53,"./shared/utils/Browser":57,"./ui/CharMeasure":58,"./ui/Lifecycle":59,"./ui/MouseZoneManager":60,"./ui/ScreenDprMonitor":62,"./utils/Clone":63,"./utils/MouseHelper":64}],26:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(t,r){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(t,r)};return function(t,r){function i(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Lifecycle_1=require("./common/Lifecycle"),Lifecycle_2=require("./ui/Lifecycle"),FALLBACK_SCROLL_BAR_WIDTH=15,Viewport=function(e){function t(t,r,i,o){var l=e.call(this)||this;return l._terminal=t,l._viewportElement=r,l._scrollArea=i,l._charMeasure=o,l.scrollBarWidth=0,l._currentRowHeight=0,l._lastRecordedBufferLength=0,l._lastRecordedViewportHeight=0,l._lastRecordedBufferHeight=0,l._lastScrollTop=0,l._wheelPartialScroll=0,l._refreshAnimationFrame=null,l._ignoreNextScrollEvent=!1,l.scrollBarWidth=l._viewportElement.offsetWidth-l._scrollArea.offsetWidth||FALLBACK_SCROLL_BAR_WIDTH,l.register(Lifecycle_2.addDisposableDomListener(l._viewportElement,"scroll",l._onScroll.bind(l))),setTimeout(function(){return l.syncScrollArea()},0),l}return __extends(t,e),t.prototype.onThemeChanged=function(e){this._viewportElement.style.backgroundColor=e.background.css},t.prototype._refresh=function(){var e=this;null===this._refreshAnimationFrame&&(this._refreshAnimationFrame=requestAnimationFrame(function(){return e._innerRefresh()}))},t.prototype._innerRefresh=function(){if(this._charMeasure.height>0){this._currentRowHeight=this._terminal.renderer.dimensions.scaledCellHeight/window.devicePixelRatio,this._lastRecordedViewportHeight=this._viewportElement.offsetHeight;var e=Math.round(this._currentRowHeight*this._lastRecordedBufferLength)+(this._lastRecordedViewportHeight-this._terminal.renderer.dimensions.canvasHeight);this._lastRecordedBufferHeight!==e&&(this._lastRecordedBufferHeight=e,this._scrollArea.style.height=this._lastRecordedBufferHeight+"px")}var t=this._terminal.buffer.ydisp*this._currentRowHeight;this._viewportElement.scrollTop!==t&&(this._ignoreNextScrollEvent=!0,this._viewportElement.scrollTop=t),this._refreshAnimationFrame=null},t.prototype.syncScrollArea=function(){if(this._lastRecordedBufferLength!==this._terminal.buffer.lines.length)return this._lastRecordedBufferLength=this._terminal.buffer.lines.length,void this._refresh();if(this._lastRecordedViewportHeight===this._terminal.renderer.dimensions.canvasHeight){var e=this._terminal.buffer.ydisp*this._currentRowHeight;this._lastScrollTop===e&&this._lastScrollTop===this._viewportElement.scrollTop&&this._terminal.renderer.dimensions.scaledCellHeight/window.devicePixelRatio===this._currentRowHeight||this._refresh()}else this._refresh()},t.prototype._onScroll=function(e){if(this._lastScrollTop=this._viewportElement.scrollTop,this._viewportElement.offsetParent)if(this._ignoreNextScrollEvent)this._ignoreNextScrollEvent=!1;else{var t=Math.round(this._lastScrollTop/this._currentRowHeight)-this._terminal.buffer.ydisp;this._terminal.scrollLines(t,!0)}},t.prototype.onWheel=function(e){var t=this._getPixelsScrolled(e);0!==t&&(this._viewportElement.scrollTop+=t,e.preventDefault())},t.prototype._getPixelsScrolled=function(e){if(0===e.deltaY)return 0;var t=e.deltaY;return e.deltaMode===WheelEvent.DOM_DELTA_LINE?t*=this._currentRowHeight:e.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(t*=this._currentRowHeight*this._terminal.rows),t},t.prototype.getLinesScrolled=function(e){if(0===e.deltaY)return 0;var t=e.deltaY;return e.deltaMode===WheelEvent.DOM_DELTA_PIXEL?(t/=this._currentRowHeight+0,this._wheelPartialScroll+=t,t=Math.floor(Math.abs(this._wheelPartialScroll))*(this._wheelPartialScroll>0?1:-1),this._wheelPartialScroll%=1):e.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(t*=this._terminal.rows),t},t.prototype.onTouchStart=function(e){this._lastTouchY=e.touches[0].pageY},t.prototype.onTouchMove=function(e){var t=this._lastTouchY-e.touches[0].pageY;this._lastTouchY=e.touches[0].pageY,0!==t&&(this._viewportElement.scrollTop+=t,e.preventDefault())},t}(Lifecycle_1.Disposable);exports.Viewport=Viewport;

},{"./common/Lifecycle":29,"./ui/Lifecycle":59}],27:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var t=function(e,i){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(e,i)};return function(e,i){function n(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var EventEmitter_1=require("./EventEmitter"),CircularList=function(t){function e(e){var i=t.call(this)||this;return i._maxLength=e,i._array=new Array(i._maxLength),i._startIndex=0,i._length=0,i}return __extends(e,t),Object.defineProperty(e.prototype,"maxLength",{get:function(){return this._maxLength},set:function(t){if(this._maxLength!==t){for(var e=new Array(t),i=0;i<Math.min(t,this.length);i++)e[i]=this._array[this._getCyclicIndex(i)];this._array=e,this._maxLength=t,this._startIndex=0}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this._length},set:function(t){if(t>this._length)for(var e=this._length;e<t;e++)this._array[e]=void 0;this._length=t},enumerable:!0,configurable:!0}),e.prototype.get=function(t){return this._array[this._getCyclicIndex(t)]},e.prototype.set=function(t,e){this._array[this._getCyclicIndex(t)]=e},e.prototype.push=function(t){this._array[this._getCyclicIndex(this._length)]=t,this._length===this._maxLength?(this._startIndex++,this._startIndex===this._maxLength&&(this._startIndex=0),this.emit("trim",1)):this._length++},e.prototype.pop=function(){return this._array[this._getCyclicIndex(this._length---1)]},e.prototype.splice=function(t,e){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];if(e){for(var r=t;r<this._length-e;r++)this._array[this._getCyclicIndex(r)]=this._array[this._getCyclicIndex(r+e)];this._length-=e}if(i&&i.length){for(r=this._length-1;r>=t;r--)this._array[this._getCyclicIndex(r+i.length)]=this._array[this._getCyclicIndex(r)];for(r=0;r<i.length;r++)this._array[this._getCyclicIndex(t+r)]=i[r];if(this._length+i.length>this.maxLength){var h=this._length+i.length-this.maxLength;this._startIndex+=h,this._length=this.maxLength,this.emit("trim",h)}else this._length+=i.length}},e.prototype.trimStart=function(t){t>this._length&&(t=this._length),this._startIndex+=t,this._length-=t,this.emit("trim",t)},e.prototype.shiftElements=function(t,e,i){if(!(e<=0)){if(t<0||t>=this._length)throw new Error("start argument out of range");if(t+i<0)throw new Error("Cannot shift elements in list beyond index 0");if(i>0){for(var n=e-1;n>=0;n--)this.set(t+n+i,this.get(t+n));var r=t+e+i-this._length;if(r>0)for(this._length+=r;this._length>this.maxLength;)this._length--,this._startIndex++,this.emit("trim",1)}else for(n=0;n<e;n++)this.set(t+n+i,this.get(t+n))}},e.prototype._getCyclicIndex=function(t){return(this._startIndex+t)%this.maxLength},e}(EventEmitter_1.EventEmitter);exports.CircularList=CircularList;

},{"./EventEmitter":28}],28:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Lifecycle_1=require("./Lifecycle"),EventEmitter=function(t){function e(){var e=t.call(this)||this;return e._events=e._events||{},e}return __extends(e,t),e.prototype.on=function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},e.prototype.addDisposableListener=function(t,e){var n=this;this.on(t,e);var o=!1;return{dispose:function(){o||(n.off(t,e),o=!0)}}},e.prototype.off=function(t,e){if(this._events[t])for(var n=this._events[t],o=n.length;o--;)if(n[o]===e)return void n.splice(o,1)},e.prototype.removeAllListeners=function(t){this._events[t]&&delete this._events[t]},e.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(this._events[t])for(var o=this._events[t],r=0;r<o.length;r++)o[r].apply(this,e)},e.prototype.listeners=function(t){return this._events[t]||[]},e.prototype.dispose=function(){t.prototype.dispose.call(this),this._events={}},e}(Lifecycle_1.Disposable);exports.EventEmitter=EventEmitter;

},{"./Lifecycle":29}],29:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Disposable=function(){function s(){this._disposables=[],this._isDisposed=!1}return s.prototype.dispose=function(){this._isDisposed=!0,this._disposables.forEach(function(s){return s.dispose()}),this._disposables.length=0},s.prototype.register=function(s){this._disposables.push(s)},s.prototype.unregister=function(s){var e=this._disposables.indexOf(s);-1!==e&&this._disposables.splice(e,1)},s}();exports.Disposable=Disposable;

},{}],30:[function(require,module,exports){
"use strict";var C0,C1;Object.defineProperty(exports,"__esModule",{value:!0}),function(S){S.NUL="\0",S.SOH="",S.STX="",S.ETX="",S.EOT="",S.ENQ="",S.ACK="",S.BEL="",S.BS="\b",S.HT="\t",S.LF="\n",S.VT="\v",S.FF="\f",S.CR="\r",S.SO="",S.SI="",S.DLE="",S.DC1="",S.DC2="",S.DC3="",S.DC4="",S.NAK="",S.SYN="",S.ETB="",S.CAN="",S.EM="",S.SUB="",S.ESC="",S.FS="",S.GS="",S.RS="",S.US="",S.SP=" ",S.DEL=""}(C0=exports.C0||(exports.C0={})),function(S){S.PAD="Â€",S.HOP="Â",S.BPH="Â‚",S.NBH="Âƒ",S.IND="Â„",S.NEL="Â…",S.SSA="Â†",S.ESA="Â‡",S.HTS="Âˆ",S.HTJ="Â‰",S.VTS="ÂŠ",S.PLD="Â‹",S.PLU="ÂŒ",S.RI="Â",S.SS2="ÂŽ",S.SS3="Â",S.DCS="Â",S.PU1="Â‘",S.PU2="Â’",S.STS="Â“",S.CCH="Â”",S.MW="Â•",S.SPA="Â–",S.EPA="Â—",S.SOS="Â˜",S.SGCI="Â™",S.SCI="Âš",S.CSI="Â›",S.ST="Âœ",S.OSC="Â",S.PM="Âž",S.APC="ÂŸ"}(C1=exports.C1||(exports.C1={}));

},{}],31:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CHARSETS={},exports.DEFAULT_CHARSET=exports.CHARSETS.B,exports.CHARSETS[0]={"`":"â—†",a:"â–’",b:"\t",c:"\f",d:"\r",e:"\n",f:"Â°",g:"Â±",h:"â¤",i:"\v",j:"â”˜",k:"â”",l:"â”Œ",m:"â””",n:"â”¼",o:"âŽº",p:"âŽ»",q:"â”€",r:"âŽ¼",s:"âŽ½",t:"â”œ",u:"â”¤",v:"â”´",w:"â”¬",x:"â”‚",y:"â‰¤",z:"â‰¥","{":"Ï€","|":"â‰ ","}":"Â£","~":"Â·"},exports.CHARSETS.A={"#":"Â£"},exports.CHARSETS.B=null,exports.CHARSETS[4]={"#":"Â£","@":"Â¾","[":"ij","\\":"Â½","]":"|","{":"Â¨","|":"f","}":"Â¼","~":"Â´"},exports.CHARSETS.C=exports.CHARSETS[5]={"[":"Ã„","\\":"Ã–","]":"Ã…","^":"Ãœ","`":"Ã©","{":"Ã¤","|":"Ã¶","}":"Ã¥","~":"Ã¼"},exports.CHARSETS.R={"#":"Â£","@":"Ã ","[":"Â°","\\":"Ã§","]":"Â§","{":"Ã©","|":"Ã¹","}":"Ã¨","~":"Â¨"},exports.CHARSETS.Q={"@":"Ã ","[":"Ã¢","\\":"Ã§","]":"Ãª","^":"Ã®","`":"Ã´","{":"Ã©","|":"Ã¹","}":"Ã¨","~":"Ã»"},exports.CHARSETS.K={"@":"Â§","[":"Ã„","\\":"Ã–","]":"Ãœ","{":"Ã¤","|":"Ã¶","}":"Ã¼","~":"ÃŸ"},exports.CHARSETS.Y={"#":"Â£","@":"Â§","[":"Â°","\\":"Ã§","]":"Ã©","`":"Ã¹","{":"Ã ","|":"Ã²","}":"Ã¨","~":"Ã¬"},exports.CHARSETS.E=exports.CHARSETS[6]={"@":"Ã„","[":"Ã†","\\":"Ã˜","]":"Ã…","^":"Ãœ","`":"Ã¤","{":"Ã¦","|":"Ã¸","}":"Ã¥","~":"Ã¼"},exports.CHARSETS.Z={"#":"Â£","@":"Â§","[":"Â¡","\\":"Ã‘","]":"Â¿","{":"Â°","|":"Ã±","}":"Ã§"},exports.CHARSETS.H=exports.CHARSETS[7]={"@":"Ã‰","[":"Ã„","\\":"Ã–","]":"Ã…","^":"Ãœ","`":"Ã©","{":"Ã¤","|":"Ã¶","}":"Ã¥","~":"Ã¼"},exports.CHARSETS["="]={"#":"Ã¹","@":"Ã ","[":"Ã©","\\":"Ã§","]":"Ãª","^":"Ã®",_:"Ã¨","`":"Ã´","{":"Ã¤","|":"Ã¶","}":"Ã¼","~":"Ã»"};

},{}],32:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var EscapeSequences_1=require("../../common/data/EscapeSequences"),KEYCODE_KEY_MAPPINGS={48:["0",")"],49:["1","!"],50:["2","@"],51:["3","#"],52:["4","$"],53:["5","%"],54:["6","^"],55:["7","&"],56:["8","*"],57:["9","("],186:[";",":"],187:["=","+"],188:[",","<"],189:["-","_"],190:[".",">"],191:["/","?"],192:["`","~"],219:["[","{"],220:["\\","|"],221:["]","}"],222:["'",'"']};function evaluateKeyboardEvent(e,c,s,C){var a={type:0,cancel:!1,key:void 0},S=(e.shiftKey?1:0)|(e.altKey?2:0)|(e.ctrlKey?4:0)|(e.metaKey?8:0);switch(e.keyCode){case 0:"UIKeyInputUpArrow"===e.key?a.key=c?EscapeSequences_1.C0.ESC+"OA":EscapeSequences_1.C0.ESC+"[A":"UIKeyInputLeftArrow"===e.key?a.key=c?EscapeSequences_1.C0.ESC+"OD":EscapeSequences_1.C0.ESC+"[D":"UIKeyInputRightArrow"===e.key?a.key=c?EscapeSequences_1.C0.ESC+"OC":EscapeSequences_1.C0.ESC+"[C":"UIKeyInputDownArrow"===e.key&&(a.key=c?EscapeSequences_1.C0.ESC+"OB":EscapeSequences_1.C0.ESC+"[B");break;case 8:if(e.shiftKey){a.key=EscapeSequences_1.C0.BS;break}if(e.altKey){a.key=EscapeSequences_1.C0.ESC+EscapeSequences_1.C0.DEL;break}a.key=EscapeSequences_1.C0.DEL;break;case 9:if(e.shiftKey){a.key=EscapeSequences_1.C0.ESC+"[Z";break}a.key=EscapeSequences_1.C0.HT,a.cancel=!0;break;case 13:a.key=EscapeSequences_1.C0.CR,a.cancel=!0;break;case 27:a.key=EscapeSequences_1.C0.ESC,a.cancel=!0;break;case 37:S?(a.key=EscapeSequences_1.C0.ESC+"[1;"+(S+1)+"D",a.key===EscapeSequences_1.C0.ESC+"[1;3D"&&(a.key=s?EscapeSequences_1.C0.ESC+"b":EscapeSequences_1.C0.ESC+"[1;5D")):a.key=c?EscapeSequences_1.C0.ESC+"OD":EscapeSequences_1.C0.ESC+"[D";break;case 39:S?(a.key=EscapeSequences_1.C0.ESC+"[1;"+(S+1)+"C",a.key===EscapeSequences_1.C0.ESC+"[1;3C"&&(a.key=s?EscapeSequences_1.C0.ESC+"f":EscapeSequences_1.C0.ESC+"[1;5C")):a.key=c?EscapeSequences_1.C0.ESC+"OC":EscapeSequences_1.C0.ESC+"[C";break;case 38:S?(a.key=EscapeSequences_1.C0.ESC+"[1;"+(S+1)+"A",a.key===EscapeSequences_1.C0.ESC+"[1;3A"&&(a.key=EscapeSequences_1.C0.ESC+"[1;5A")):a.key=c?EscapeSequences_1.C0.ESC+"OA":EscapeSequences_1.C0.ESC+"[A";break;case 40:S?(a.key=EscapeSequences_1.C0.ESC+"[1;"+(S+1)+"B",a.key===EscapeSequences_1.C0.ESC+"[1;3B"&&(a.key=EscapeSequences_1.C0.ESC+"[1;5B")):a.key=c?EscapeSequences_1.C0.ESC+"OB":EscapeSequences_1.C0.ESC+"[B";break;case 45:e.shiftKey||e.ctrlKey||(a.key=EscapeSequences_1.C0.ESC+"[2~");break;case 46:a.key=S?EscapeSequences_1.C0.ESC+"[3;"+(S+1)+"~":EscapeSequences_1.C0.ESC+"[3~";break;case 36:a.key=S?EscapeSequences_1.C0.ESC+"[1;"+(S+1)+"H":c?EscapeSequences_1.C0.ESC+"OH":EscapeSequences_1.C0.ESC+"[H";break;case 35:a.key=S?EscapeSequences_1.C0.ESC+"[1;"+(S+1)+"F":c?EscapeSequences_1.C0.ESC+"OF":EscapeSequences_1.C0.ESC+"[F";break;case 33:e.shiftKey?a.type=2:a.key=EscapeSequences_1.C0.ESC+"[5~";break;case 34:e.shiftKey?a.type=3:a.key=EscapeSequences_1.C0.ESC+"[6~";break;case 112:a.key=S?EscapeSequences_1.C0.ESC+"[1;"+(S+1)+"P":EscapeSequences_1.C0.ESC+"OP";break;case 113:a.key=S?EscapeSequences_1.C0.ESC+"[1;"+(S+1)+"Q":EscapeSequences_1.C0.ESC+"OQ";break;case 114:a.key=S?EscapeSequences_1.C0.ESC+"[1;"+(S+1)+"R":EscapeSequences_1.C0.ESC+"OR";break;case 115:a.key=S?EscapeSequences_1.C0.ESC+"[1;"+(S+1)+"S":EscapeSequences_1.C0.ESC+"OS";break;case 116:a.key=S?EscapeSequences_1.C0.ESC+"[15;"+(S+1)+"~":EscapeSequences_1.C0.ESC+"[15~";break;case 117:a.key=S?EscapeSequences_1.C0.ESC+"[17;"+(S+1)+"~":EscapeSequences_1.C0.ESC+"[17~";break;case 118:a.key=S?EscapeSequences_1.C0.ESC+"[18;"+(S+1)+"~":EscapeSequences_1.C0.ESC+"[18~";break;case 119:a.key=S?EscapeSequences_1.C0.ESC+"[19;"+(S+1)+"~":EscapeSequences_1.C0.ESC+"[19~";break;case 120:a.key=S?EscapeSequences_1.C0.ESC+"[20;"+(S+1)+"~":EscapeSequences_1.C0.ESC+"[20~";break;case 121:a.key=S?EscapeSequences_1.C0.ESC+"[21;"+(S+1)+"~":EscapeSequences_1.C0.ESC+"[21~";break;case 122:a.key=S?EscapeSequences_1.C0.ESC+"[23;"+(S+1)+"~":EscapeSequences_1.C0.ESC+"[23~";break;case 123:a.key=S?EscapeSequences_1.C0.ESC+"[24;"+(S+1)+"~":EscapeSequences_1.C0.ESC+"[24~";break;default:if(!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey)if(s&&!C||!e.altKey||e.metaKey)s&&!e.altKey&&!e.ctrlKey&&e.metaKey&&65===e.keyCode&&(a.type=1);else{var E=KEYCODE_KEY_MAPPINGS[e.keyCode],y=E&&E[e.shiftKey?1:0];if(y)a.key=EscapeSequences_1.C0.ESC+y;else if(e.keyCode>=65&&e.keyCode<=90){var k=e.ctrlKey?e.keyCode-64:e.keyCode+32;a.key=EscapeSequences_1.C0.ESC+String.fromCharCode(k)}}else e.keyCode>=65&&e.keyCode<=90?a.key=String.fromCharCode(e.keyCode-64):32===e.keyCode?a.key=String.fromCharCode(0):e.keyCode>=51&&e.keyCode<=55?a.key=String.fromCharCode(e.keyCode-51+27):56===e.keyCode?a.key=String.fromCharCode(127):219===e.keyCode?a.key=String.fromCharCode(27):220===e.keyCode?a.key=String.fromCharCode(28):221===e.keyCode&&(a.key=String.fromCharCode(29))}return a}exports.evaluateKeyboardEvent=evaluateKeyboardEvent;

},{"../../common/data/EscapeSequences":30}],33:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var EscapeSequences_1=require("../common/data/EscapeSequences"),AltClickHandler=function(){function t(t,e){var o;this._mouseEvent=t,this._terminal=e,this._lines=this._terminal.buffer.lines,this._startCol=this._terminal.buffer.x,this._startRow=this._terminal.buffer.y;var r=this._terminal.mouseHelper.getCoords(this._mouseEvent,this._terminal.element,this._terminal.charMeasure,this._terminal.options.lineHeight,this._terminal.cols,this._terminal.rows,!1);r&&(o=r.map(function(t){return t-1}),this._endCol=o[0],this._endRow=o[1])}return t.prototype.move=function(){this._mouseEvent.altKey&&void 0!==this._endCol&&void 0!==this._endRow&&this._terminal.handler(this._arrowSequences())},t.prototype._arrowSequences=function(){return this._terminal.buffer.hasScrollback?this._moveHorizontallyOnly():this._resetStartingRow()+this._moveToRequestedRow()+this._moveToRequestedCol()},t.prototype._resetStartingRow=function(){return 0===this._moveToRequestedRow().length?"":repeat(this._bufferLine(this._startCol,this._startRow,this._startCol,this._startRow-this._wrappedRowsForRow(this._startRow),!1).length,this._sequence("D"))},t.prototype._moveToRequestedRow=function(){var t=this._startRow-this._wrappedRowsForRow(this._startRow),e=this._endRow-this._wrappedRowsForRow(this._endRow);return repeat(Math.abs(t-e)-this._wrappedRowsCount(),this._sequence(this._verticalDirection()))},t.prototype._moveToRequestedCol=function(){var t;t=this._moveToRequestedRow().length>0?this._endRow-this._wrappedRowsForRow(this._endRow):this._startRow;var e=this._endRow,o=this._horizontalDirection();return repeat(this._bufferLine(this._startCol,t,this._endCol,e,"C"===o).length,this._sequence(o))},t.prototype._moveHorizontallyOnly=function(){var t=this._horizontalDirection();return repeat(Math.abs(this._startCol-this._endCol),this._sequence(t))},t.prototype._wrappedRowsCount=function(){for(var t=0,e=this._startRow-this._wrappedRowsForRow(this._startRow),o=this._endRow-this._wrappedRowsForRow(this._endRow),r=0;r<Math.abs(e-o);r++){var i="A"===this._verticalDirection()?-1:1;this._lines.get(e+i*r).isWrapped&&t++}return t},t.prototype._wrappedRowsForRow=function(t){for(var e=0,o=this._lines.get(t).isWrapped;o&&t>=0&&t<this._terminal.rows;)e++,t--,o=this._lines.get(t).isWrapped;return e},t.prototype._horizontalDirection=function(){var t;return t=this._moveToRequestedRow().length>0?this._endRow-this._wrappedRowsForRow(this._endRow):this._startRow,this._startCol<this._endCol&&t<=this._endRow||this._startCol>=this._endCol&&t<this._endRow?"C":"D"},t.prototype._verticalDirection=function(){return this._startRow>this._endRow?"A":"B"},t.prototype._bufferLine=function(t,e,o,r,i){for(var s=t,n=e,a="";s!==o||n!==r;)s+=i?1:-1,i&&s>this._terminal.cols-1?(a+=this._terminal.buffer.translateBufferLineToString(n,!1,t,s),s=0,t=0,n++):!i&&s<0&&(a+=this._terminal.buffer.translateBufferLineToString(n,!1,0,t+1),t=s=this._terminal.cols-1,n--);return a+this._terminal.buffer.translateBufferLineToString(n,!1,t,s)},t.prototype._sequence=function(t){var e=this._terminal.applicationCursor?"O":"[";return EscapeSequences_1.C0.ESC+e+t},t}();function repeat(t,e){t=Math.floor(t);for(var o="",r=0;r<t;r++)o+=e;return o}exports.AltClickHandler=AltClickHandler;

},{"../common/data/EscapeSequences":30}],34:[function(require,module,exports){
"use strict";function prepareTextForTerminal(e){return e.replace(/\r?\n/g,"\r")}function bracketTextForPaste(e,t){return t?"[200~"+e+"[201~":e}function copyHandler(e,t,r){t.browser.isMSIE?window.clipboardData.setData("Text",r.selectionText):e.clipboardData.setData("text/plain",r.selectionText),e.preventDefault()}function pasteHandler(e,t){e.stopPropagation();var r=function(r){r=bracketTextForPaste(r=prepareTextForTerminal(r),t.bracketedPasteMode),t.handler(r),t.textarea.value="",t.emit("paste",r),t.cancel(e)};t.browser.isMSIE?window.clipboardData&&r(window.clipboardData.getData("Text")):e.clipboardData&&r(e.clipboardData.getData("text/plain"))}function moveTextAreaUnderMouseCursor(e,t){t.style.position="fixed",t.style.width="20px",t.style.height="20px",t.style.left=e.clientX-10+"px",t.style.top=e.clientY-10+"px",t.style.zIndex="1000",t.focus(),setTimeout(function(){t.style.position=null,t.style.width=null,t.style.height=null,t.style.left=null,t.style.top=null,t.style.zIndex=null},200)}function rightClickHandler(e,t,r,a){moveTextAreaUnderMouseCursor(e,t),a&&!r.isClickInSelection(e)&&r.selectWordAtCursor(e),t.value=r.selectionText,t.select()}Object.defineProperty(exports,"__esModule",{value:!0}),exports.prepareTextForTerminal=prepareTextForTerminal,exports.bracketTextForPaste=bracketTextForPaste,exports.copyHandler=copyHandler,exports.pasteHandler=pasteHandler,exports.moveTextAreaUnderMouseCursor=moveTextAreaUnderMouseCursor,exports.rightClickHandler=rightClickHandler;

},{}],35:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Terminal_1=require("../Terminal"),Strings=require("../Strings"),Terminal=function(){function e(e){this._core=new Terminal_1.Terminal(e)}return Object.defineProperty(e.prototype,"element",{get:function(){return this._core.element},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"textarea",{get:function(){return this._core.textarea},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rows",{get:function(){return this._core.rows},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"cols",{get:function(){return this._core.cols},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"markers",{get:function(){return this._core.markers},enumerable:!0,configurable:!0}),e.prototype.blur=function(){this._core.blur()},e.prototype.focus=function(){this._core.focus()},e.prototype.on=function(e,t){this._core.on(e,t)},e.prototype.off=function(e,t){this._core.off(e,t)},e.prototype.emit=function(e,t){this._core.emit(e,t)},e.prototype.addDisposableListener=function(e,t){return this._core.addDisposableListener(e,t)},e.prototype.resize=function(e,t){this._core.resize(e,t)},e.prototype.writeln=function(e){this._core.writeln(e)},e.prototype.open=function(e){this._core.open(e)},e.prototype.attachCustomKeyEventHandler=function(e){this._core.attachCustomKeyEventHandler(e)},e.prototype.registerLinkMatcher=function(e,t,o){return this._core.registerLinkMatcher(e,t,o)},e.prototype.deregisterLinkMatcher=function(e){this._core.deregisterLinkMatcher(e)},e.prototype.registerCharacterJoiner=function(e){return this._core.registerCharacterJoiner(e)},e.prototype.deregisterCharacterJoiner=function(e){this._core.deregisterCharacterJoiner(e)},e.prototype.addMarker=function(e){return this._core.addMarker(e)},e.prototype.hasSelection=function(){return this._core.hasSelection()},e.prototype.getSelection=function(){return this._core.getSelection()},e.prototype.clearSelection=function(){this._core.clearSelection()},e.prototype.selectAll=function(){this._core.selectAll()},e.prototype.selectLines=function(e,t){this._core.selectLines(e,t)},e.prototype.dispose=function(){this._core.dispose()},e.prototype.destroy=function(){this._core.destroy()},e.prototype.scrollLines=function(e){this._core.scrollLines(e)},e.prototype.scrollPages=function(e){this._core.scrollPages(e)},e.prototype.scrollToTop=function(){this._core.scrollToTop()},e.prototype.scrollToBottom=function(){this._core.scrollToBottom()},e.prototype.scrollToLine=function(e){this._core.scrollToLine(e)},e.prototype.clear=function(){this._core.clear()},e.prototype.write=function(e){this._core.write(e)},e.prototype.getOption=function(e){return this._core.getOption(e)},e.prototype.setOption=function(e,t){this._core.setOption(e,t)},e.prototype.refresh=function(e,t){this._core.refresh(e,t)},e.prototype.reset=function(){this._core.reset()},e.applyAddon=function(t){t.apply(e)},Object.defineProperty(e,"strings",{get:function(){return Strings},enumerable:!0,configurable:!0}),e}();exports.Terminal=Terminal;

},{"../Strings":24,"../Terminal":25}],36:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Types_1=require("./atlas/Types"),CharAtlasCache_1=require("./atlas/CharAtlasCache"),Buffer_1=require("../Buffer"),BaseRenderLayer=function(){function t(t,i,e,s,h){this._container=t,this._alpha=s,this._colors=h,this._scaledCharWidth=0,this._scaledCharHeight=0,this._scaledCellWidth=0,this._scaledCellHeight=0,this._scaledCharLeft=0,this._scaledCharTop=0,this._currentGlyphIdentifier={chars:"",code:0,bg:0,fg:0,bold:!1,dim:!1,italic:!1},this._canvas=document.createElement("canvas"),this._canvas.classList.add("xterm-"+i+"-layer"),this._canvas.style.zIndex=e.toString(),this._initCanvas(),this._container.appendChild(this._canvas)}return t.prototype.dispose=function(){this._container.removeChild(this._canvas),this._charAtlas&&this._charAtlas.dispose()},t.prototype._initCanvas=function(){this._ctx=this._canvas.getContext("2d",{alpha:this._alpha}),this._alpha||this.clearAll()},t.prototype.onOptionsChanged=function(t){},t.prototype.onBlur=function(t){},t.prototype.onFocus=function(t){},t.prototype.onCursorMove=function(t){},t.prototype.onGridChanged=function(t,i,e){},t.prototype.onSelectionChanged=function(t,i,e,s){void 0===s&&(s=!1)},t.prototype.onThemeChanged=function(t,i){this._refreshCharAtlas(t,i)},t.prototype.setTransparency=function(t,i){if(i!==this._alpha){var e=this._canvas;this._alpha=i,this._canvas=this._canvas.cloneNode(),this._initCanvas(),this._container.replaceChild(this._canvas,e),this._refreshCharAtlas(t,this._colors),this.onGridChanged(t,0,t.rows-1)}},t.prototype._refreshCharAtlas=function(t,i){this._scaledCharWidth<=0&&this._scaledCharHeight<=0||(this._charAtlas=CharAtlasCache_1.acquireCharAtlas(t,i,this._scaledCharWidth,this._scaledCharHeight),this._charAtlas.warmUp())},t.prototype.resize=function(t,i){this._scaledCellWidth=i.scaledCellWidth,this._scaledCellHeight=i.scaledCellHeight,this._scaledCharWidth=i.scaledCharWidth,this._scaledCharHeight=i.scaledCharHeight,this._scaledCharLeft=i.scaledCharLeft,this._scaledCharTop=i.scaledCharTop,this._canvas.width=i.scaledCanvasWidth,this._canvas.height=i.scaledCanvasHeight,this._canvas.style.width=i.canvasWidth+"px",this._canvas.style.height=i.canvasHeight+"px",this._alpha||this.clearAll(),this._refreshCharAtlas(t,this._colors)},t.prototype.fillCells=function(t,i,e,s){this._ctx.fillRect(t*this._scaledCellWidth,i*this._scaledCellHeight,e*this._scaledCellWidth,s*this._scaledCellHeight)},t.prototype.fillBottomLineAtCells=function(t,i,e){void 0===e&&(e=1),this._ctx.fillRect(t*this._scaledCellWidth,(i+1)*this._scaledCellHeight-window.devicePixelRatio-1,e*this._scaledCellWidth,window.devicePixelRatio)},t.prototype.fillLeftLineAtCell=function(t,i){this._ctx.fillRect(t*this._scaledCellWidth,i*this._scaledCellHeight,window.devicePixelRatio,this._scaledCellHeight)},t.prototype.strokeRectAtCell=function(t,i,e,s){this._ctx.lineWidth=window.devicePixelRatio,this._ctx.strokeRect(t*this._scaledCellWidth+window.devicePixelRatio/2,i*this._scaledCellHeight+window.devicePixelRatio/2,e*this._scaledCellWidth-window.devicePixelRatio,s*this._scaledCellHeight-window.devicePixelRatio)},t.prototype.clearAll=function(){this._alpha?this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height):(this._ctx.fillStyle=this._colors.background.css,this._ctx.fillRect(0,0,this._canvas.width,this._canvas.height))},t.prototype.clearCells=function(t,i,e,s){this._alpha?this._ctx.clearRect(t*this._scaledCellWidth,i*this._scaledCellHeight,e*this._scaledCellWidth,s*this._scaledCellHeight):(this._ctx.fillStyle=this._colors.background.css,this._ctx.fillRect(t*this._scaledCellWidth,i*this._scaledCellHeight,e*this._scaledCellWidth,s*this._scaledCellHeight))},t.prototype.fillCharTrueColor=function(t,i,e,s){this._ctx.font=this._getFont(t,!1,!1),this._ctx.textBaseline="top",this._clipRow(t,s),this._ctx.fillText(i[Buffer_1.CHAR_DATA_CHAR_INDEX],e*this._scaledCellWidth+this._scaledCharLeft,s*this._scaledCellHeight+this._scaledCharTop)},t.prototype.drawChars=function(t,i,e,s,h,l,a,c,o,r,n){a+=t.options.drawBoldTextInBrightColors&&o&&a<8&&a!==Types_1.INVERTED_DEFAULT_COLOR?8:0,this._currentGlyphIdentifier.chars=i,this._currentGlyphIdentifier.code=e,this._currentGlyphIdentifier.bg=c,this._currentGlyphIdentifier.fg=a,this._currentGlyphIdentifier.bold=o&&t.options.enableBold,this._currentGlyphIdentifier.dim=r,this._currentGlyphIdentifier.italic=n,this._charAtlas&&this._charAtlas.draw(this._ctx,this._currentGlyphIdentifier,h*this._scaledCellWidth+this._scaledCharLeft,l*this._scaledCellHeight+this._scaledCharTop)||this._drawUncachedChars(t,i,s,a,h,l,o&&t.options.enableBold,r,n)},t.prototype._drawUncachedChars=function(t,i,e,s,h,l,a,c,o){this._ctx.save(),this._ctx.font=this._getFont(t,a,o),this._ctx.textBaseline="top",s===Types_1.INVERTED_DEFAULT_COLOR?this._ctx.fillStyle=this._colors.background.css:this._ctx.fillStyle=s<256?this._colors.ansi[s].css:this._colors.foreground.css,this._clipRow(t,l),c&&(this._ctx.globalAlpha=Types_1.DIM_OPACITY),this._ctx.fillText(i,h*this._scaledCellWidth+this._scaledCharLeft,l*this._scaledCellHeight+this._scaledCharTop),this._ctx.restore()},t.prototype._clipRow=function(t,i){this._ctx.beginPath(),this._ctx.rect(0,i*this._scaledCellHeight,t.cols*this._scaledCellWidth,this._scaledCellHeight),this._ctx.clip()},t.prototype._getFont=function(t,i,e){return(e?"italic":"")+" "+(i?t.options.fontWeightBold:t.options.fontWeight)+" "+t.options.fontSize*window.devicePixelRatio+"px "+t.options.fontFamily},t}();exports.BaseRenderLayer=BaseRenderLayer;

},{"../Buffer":13,"./atlas/CharAtlasCache":46,"./atlas/Types":52}],37:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Buffer_1=require("../Buffer"),CharacterJoinerRegistry=function(){function r(r){this._terminal=r,this._characterJoiners=[],this._nextCharacterJoinerId=0}return r.prototype.registerCharacterJoiner=function(r){var e={id:this._nextCharacterJoinerId++,handler:r};return this._characterJoiners.push(e),e.id},r.prototype.deregisterCharacterJoiner=function(r){for(var e=0;e<this._characterJoiners.length;e++)if(this._characterJoiners[e].id===r)return this._characterJoiners.splice(e,1),!0;return!1},r.prototype.getJoinedCharacters=function(r){if(0===this._characterJoiners.length)return[];var e=this._terminal.buffer.lines.get(r);if(0===e.length)return[];for(var t=[],i=this._terminal.buffer.translateBufferLineToString(r,!0),n=0,a=0,s=0,h=e.get(0)[Buffer_1.CHAR_DATA_ATTR_INDEX]>>9,o=0;o<this._terminal.cols;o++){var f=e.get(o),_=f[Buffer_1.CHAR_DATA_CHAR_INDEX],c=f[Buffer_1.CHAR_DATA_WIDTH_INDEX],u=f[Buffer_1.CHAR_DATA_ATTR_INDEX]>>9;if(0!==c){if(u!==h){if(o-n>1)for(var g=this._getJoinedRanges(i,s,a,e,n),l=0;l<g.length;l++)t.push(g[l]);n=o,s=a,h=u}a+=_.length}}if(this._terminal.cols-n>1)for(g=this._getJoinedRanges(i,s,a,e,n),l=0;l<g.length;l++)t.push(g[l]);return t},r.prototype._getJoinedRanges=function(e,t,i,n,a){for(var s=e.substring(t,i),h=this._characterJoiners[0].handler(s),o=1;o<this._characterJoiners.length;o++)for(var f=this._characterJoiners[o].handler(s),_=0;_<f.length;_++)r._mergeRanges(h,f[_]);return this._stringRangesToCellRanges(h,n,a),h},r.prototype._stringRangesToCellRanges=function(r,e,t){var i=0,n=!1,a=0,s=r[i];if(s){for(var h=t;h<this._terminal.cols;h++){var o=e.get(h),f=o[Buffer_1.CHAR_DATA_WIDTH_INDEX],_=o[Buffer_1.CHAR_DATA_CHAR_INDEX].length;if(0!==f){if(!n&&s[0]<=a&&(s[0]=h,n=!0),s[1]<=a){if(s[1]=h,!(s=r[++i]))break;s[0]<=a?(s[0]=h,n=!0):n=!1}a+=_}}s&&(s[1]=this._terminal.cols)}},r._mergeRanges=function(r,e){for(var t=!1,i=0;i<r.length;i++){var n=r[i];if(t){if(e[1]<=n[0])return r[i-1][1]=e[1],r;if(e[1]<=n[1])return r[i-1][1]=Math.max(e[1],n[1]),r.splice(i,1),t=!1,r;r.splice(i,1),i--}else{if(e[1]<=n[0])return r.splice(i,0,e),r;if(e[1]<=n[1])return n[0]=Math.min(e[0],n[0]),r;e[0]<n[1]&&(n[0]=Math.min(e[0],n[0]),t=!0)}}return t?r[r.length-1][1]=e[1]:r.push(e),r},r}();exports.CharacterJoinerRegistry=CharacterJoinerRegistry;

},{"../Buffer":13}],38:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var DEFAULT_FOREGROUND=fromHex("#ffffff"),DEFAULT_BACKGROUND=fromHex("#000000"),DEFAULT_CURSOR=fromHex("#ffffff"),DEFAULT_CURSOR_ACCENT=fromHex("#000000"),DEFAULT_SELECTION={css:"rgba(255, 255, 255, 0.3)",rgba:4294967159};function fromHex(r){return{css:r,rgba:parseInt(r.slice(1),16)<<8|255}}function toPaddedHex(r){var o=r.toString(16);return o.length<2?"0"+o:o}exports.DEFAULT_ANSI_COLORS=function(){for(var r=[fromHex("#2e3436"),fromHex("#cc0000"),fromHex("#4e9a06"),fromHex("#c4a000"),fromHex("#3465a4"),fromHex("#75507b"),fromHex("#06989a"),fromHex("#d3d7cf"),fromHex("#555753"),fromHex("#ef2929"),fromHex("#8ae234"),fromHex("#fce94f"),fromHex("#729fcf"),fromHex("#ad7fa8"),fromHex("#34e2e2"),fromHex("#eeeeec")],o=[0,95,135,175,215,255],s=0;s<216;s++){var e=o[s/36%6|0],t=o[s/6%6|0],i=o[s%6];r.push({css:"#"+toPaddedHex(e)+toPaddedHex(t)+toPaddedHex(i),rgba:(e<<24|t<<16|i<<8|255)>>>0})}for(s=0;s<24;s++){var a=8+10*s,l=toPaddedHex(a);r.push({css:"#"+l+l+l,rgba:(a<<24|a<<16|a<<8|255)>>>0})}return r}();var ColorManager=function(){function r(r,o){this.allowTransparency=o;var s=r.createElement("canvas");s.width=1,s.height=1,this._ctx=s.getContext("2d"),this._ctx.globalCompositeOperation="copy",this._litmusColor=this._ctx.createLinearGradient(0,0,1,1),this.colors={foreground:DEFAULT_FOREGROUND,background:DEFAULT_BACKGROUND,cursor:DEFAULT_CURSOR,cursorAccent:DEFAULT_CURSOR_ACCENT,selection:DEFAULT_SELECTION,ansi:exports.DEFAULT_ANSI_COLORS.slice()}}return r.prototype.setTheme=function(r){this.colors.foreground=this._parseColor(r.foreground,DEFAULT_FOREGROUND),this.colors.background=this._parseColor(r.background,DEFAULT_BACKGROUND),this.colors.cursor=this._parseColor(r.cursor,DEFAULT_CURSOR,!0),this.colors.cursorAccent=this._parseColor(r.cursorAccent,DEFAULT_CURSOR_ACCENT,!0),this.colors.selection=this._parseColor(r.selection,DEFAULT_SELECTION,!0),this.colors.ansi[0]=this._parseColor(r.black,exports.DEFAULT_ANSI_COLORS[0]),this.colors.ansi[1]=this._parseColor(r.red,exports.DEFAULT_ANSI_COLORS[1]),this.colors.ansi[2]=this._parseColor(r.green,exports.DEFAULT_ANSI_COLORS[2]),this.colors.ansi[3]=this._parseColor(r.yellow,exports.DEFAULT_ANSI_COLORS[3]),this.colors.ansi[4]=this._parseColor(r.blue,exports.DEFAULT_ANSI_COLORS[4]),this.colors.ansi[5]=this._parseColor(r.magenta,exports.DEFAULT_ANSI_COLORS[5]),this.colors.ansi[6]=this._parseColor(r.cyan,exports.DEFAULT_ANSI_COLORS[6]),this.colors.ansi[7]=this._parseColor(r.white,exports.DEFAULT_ANSI_COLORS[7]),this.colors.ansi[8]=this._parseColor(r.brightBlack,exports.DEFAULT_ANSI_COLORS[8]),this.colors.ansi[9]=this._parseColor(r.brightRed,exports.DEFAULT_ANSI_COLORS[9]),this.colors.ansi[10]=this._parseColor(r.brightGreen,exports.DEFAULT_ANSI_COLORS[10]),this.colors.ansi[11]=this._parseColor(r.brightYellow,exports.DEFAULT_ANSI_COLORS[11]),this.colors.ansi[12]=this._parseColor(r.brightBlue,exports.DEFAULT_ANSI_COLORS[12]),this.colors.ansi[13]=this._parseColor(r.brightMagenta,exports.DEFAULT_ANSI_COLORS[13]),this.colors.ansi[14]=this._parseColor(r.brightCyan,exports.DEFAULT_ANSI_COLORS[14]),this.colors.ansi[15]=this._parseColor(r.brightWhite,exports.DEFAULT_ANSI_COLORS[15])},r.prototype._parseColor=function(r,o,s){if(void 0===s&&(s=this.allowTransparency),!r)return o;if(this._ctx.fillStyle=this._litmusColor,this._ctx.fillStyle=r,"string"!=typeof this._ctx.fillStyle)return console.warn("Color: "+r+" is invalid using fallback "+o.css),o;this._ctx.fillRect(0,0,1,1);var e=this._ctx.getImageData(0,0,1,1).data;return s||255===e[3]?{css:r,rgba:(e[0]<<24|e[1]<<16|e[2]<<8|e[3])>>>0}:(console.warn("Color: "+r+" is using transparency, but allowTransparency is false. Using fallback "+o.css+"."),o)},r}();exports.ColorManager=ColorManager;

},{}],39:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Buffer_1=require("../Buffer"),BaseRenderLayer_1=require("./BaseRenderLayer"),BLINK_INTERVAL=600,CursorRenderLayer=function(t){function e(e,r,i){var s=t.call(this,e,"cursor",r,!0,i)||this;return s._state={x:null,y:null,isFocused:null,style:null,width:null},s._cursorRenderers={bar:s._renderBarCursor.bind(s),block:s._renderBlockCursor.bind(s),underline:s._renderUnderlineCursor.bind(s)},s}return __extends(e,t),e.prototype.resize=function(e,r){t.prototype.resize.call(this,e,r),this._state={x:null,y:null,isFocused:null,style:null,width:null}},e.prototype.reset=function(t){this._clearCursor(),this._cursorBlinkStateManager&&(this._cursorBlinkStateManager.dispose(),this._cursorBlinkStateManager=null,this.onOptionsChanged(t))},e.prototype.onBlur=function(t){this._cursorBlinkStateManager&&this._cursorBlinkStateManager.pause(),t.refresh(t.buffer.y,t.buffer.y)},e.prototype.onFocus=function(t){this._cursorBlinkStateManager?this._cursorBlinkStateManager.resume(t):t.refresh(t.buffer.y,t.buffer.y)},e.prototype.onOptionsChanged=function(t){var e=this;t.options.cursorBlink?this._cursorBlinkStateManager||(this._cursorBlinkStateManager=new CursorBlinkStateManager(t,function(){e._render(t,!0)})):(this._cursorBlinkStateManager&&(this._cursorBlinkStateManager.dispose(),this._cursorBlinkStateManager=null),t.refresh(t.buffer.y,t.buffer.y))},e.prototype.onCursorMove=function(t){this._cursorBlinkStateManager&&this._cursorBlinkStateManager.restartBlinkAnimation(t)},e.prototype.onGridChanged=function(t,e,r){!this._cursorBlinkStateManager||this._cursorBlinkStateManager.isPaused?this._render(t,!1):this._cursorBlinkStateManager.restartBlinkAnimation(t)},e.prototype._render=function(t,e){if(t.cursorState&&!t.cursorHidden){var r=t.buffer.ybase+t.buffer.y,i=r-t.buffer.ydisp;if(i<0||i>=t.rows)this._clearCursor();else{var s=t.buffer.lines.get(r).get(t.buffer.x);if(s){if(!t.isFocused)return this._clearCursor(),this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this._renderBlurCursor(t,t.buffer.x,i,s),this._ctx.restore(),this._state.x=t.buffer.x,this._state.y=i,this._state.isFocused=!1,this._state.style=t.options.cursorStyle,void(this._state.width=s[Buffer_1.CHAR_DATA_WIDTH_INDEX]);if(!this._cursorBlinkStateManager||this._cursorBlinkStateManager.isCursorVisible){if(this._state){if(this._state.x===t.buffer.x&&this._state.y===i&&this._state.isFocused===t.isFocused&&this._state.style===t.options.cursorStyle&&this._state.width===s[Buffer_1.CHAR_DATA_WIDTH_INDEX])return;this._clearCursor()}this._ctx.save(),this._cursorRenderers[t.options.cursorStyle||"block"](t,t.buffer.x,i,s),this._ctx.restore(),this._state.x=t.buffer.x,this._state.y=i,this._state.isFocused=!1,this._state.style=t.options.cursorStyle,this._state.width=s[Buffer_1.CHAR_DATA_WIDTH_INDEX]}else this._clearCursor()}}}else this._clearCursor()},e.prototype._clearCursor=function(){this._state&&(this.clearCells(this._state.x,this._state.y,this._state.width,1),this._state={x:null,y:null,isFocused:null,style:null,width:null})},e.prototype._renderBarCursor=function(t,e,r,i){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this.fillLeftLineAtCell(e,r),this._ctx.restore()},e.prototype._renderBlockCursor=function(t,e,r,i){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this.fillCells(e,r,i[Buffer_1.CHAR_DATA_WIDTH_INDEX],1),this._ctx.fillStyle=this._colors.cursorAccent.css,this.fillCharTrueColor(t,i,e,r),this._ctx.restore()},e.prototype._renderUnderlineCursor=function(t,e,r,i){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this.fillBottomLineAtCells(e,r),this._ctx.restore()},e.prototype._renderBlurCursor=function(t,e,r,i){this._ctx.save(),this._ctx.strokeStyle=this._colors.cursor.css,this.strokeRectAtCell(e,r,i[Buffer_1.CHAR_DATA_WIDTH_INDEX],1),this._ctx.restore()},e}(BaseRenderLayer_1.BaseRenderLayer);exports.CursorRenderLayer=CursorRenderLayer;var CursorBlinkStateManager=function(){function t(t,e){this._renderCallback=e,this.isCursorVisible=!0,t.isFocused&&this._restartInterval()}return Object.defineProperty(t.prototype,"isPaused",{get:function(){return!(this._blinkStartTimeout||this._blinkInterval)},enumerable:!0,configurable:!0}),t.prototype.dispose=function(){this._blinkInterval&&(window.clearInterval(this._blinkInterval),this._blinkInterval=null),this._blinkStartTimeout&&(window.clearTimeout(this._blinkStartTimeout),this._blinkStartTimeout=null),this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=null)},t.prototype.restartBlinkAnimation=function(t){var e=this;this.isPaused||(this._animationTimeRestarted=Date.now(),this.isCursorVisible=!0,this._animationFrame||(this._animationFrame=window.requestAnimationFrame(function(){e._renderCallback(),e._animationFrame=null})))},t.prototype._restartInterval=function(t){var e=this;void 0===t&&(t=BLINK_INTERVAL),this._blinkInterval&&window.clearInterval(this._blinkInterval),this._blinkStartTimeout=setTimeout(function(){if(e._animationTimeRestarted){var t=BLINK_INTERVAL-(Date.now()-e._animationTimeRestarted);if(e._animationTimeRestarted=null,t>0)return void e._restartInterval(t)}e.isCursorVisible=!1,e._animationFrame=window.requestAnimationFrame(function(){e._renderCallback(),e._animationFrame=null}),e._blinkInterval=setInterval(function(){if(e._animationTimeRestarted){var t=BLINK_INTERVAL-(Date.now()-e._animationTimeRestarted);return e._animationTimeRestarted=null,void e._restartInterval(t)}e.isCursorVisible=!e.isCursorVisible,e._animationFrame=window.requestAnimationFrame(function(){e._renderCallback(),e._animationFrame=null})},BLINK_INTERVAL)},t)},t.prototype.pause=function(){this.isCursorVisible=!0,this._blinkInterval&&(window.clearInterval(this._blinkInterval),this._blinkInterval=null),this._blinkStartTimeout&&(window.clearTimeout(this._blinkStartTimeout),this._blinkStartTimeout=null),this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=null)},t.prototype.resume=function(t){this._animationTimeRestarted=null,this._restartInterval(),this.restartBlinkAnimation(t)},t}();

},{"../Buffer":13,"./BaseRenderLayer":36}],40:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var GridCache=function(){function e(){this.cache=[]}return e.prototype.resize=function(e,h){for(var t=0;t<e;t++){this.cache.length<=t&&this.cache.push([]);for(var c=this.cache[t].length;c<h;c++)this.cache[t].push(null);this.cache[t].length=h}this.cache.length=e},e.prototype.clear=function(){for(var e=0;e<this.cache.length;e++)for(var h=0;h<this.cache[e].length;h++)this.cache[e][h]=null},e}();exports.GridCache=GridCache;

},{}],41:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var t=function(e,s){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s])})(e,s)};return function(e,s){function i(){this.constructor=e}t(e,s),e.prototype=null===s?Object.create(s):(i.prototype=s.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var BaseRenderLayer_1=require("./BaseRenderLayer"),Types_1=require("./atlas/Types"),LinkRenderLayer=function(t){function e(e,s,i,r){var n=t.call(this,e,"link",s,!0,i)||this;return n._state=null,r.linkifier.on("linkhover",function(t){return n._onLinkHover(t)}),r.linkifier.on("linkleave",function(t){return n._onLinkLeave(t)}),n}return __extends(e,t),e.prototype.resize=function(e,s){t.prototype.resize.call(this,e,s),this._state=null},e.prototype.reset=function(t){this._clearCurrentLink()},e.prototype._clearCurrentLink=function(){if(this._state){this.clearCells(this._state.x1,this._state.y1,this._state.cols-this._state.x1,1);var t=this._state.y2-this._state.y1-1;t>0&&this.clearCells(0,this._state.y1+1,this._state.cols,t),this.clearCells(0,this._state.y2,this._state.x2,1),this._state=null}},e.prototype._onLinkHover=function(t){if(t.fg===Types_1.INVERTED_DEFAULT_COLOR?this._ctx.fillStyle=this._colors.background.css:t.fg<256?this._ctx.fillStyle=this._colors.ansi[t.fg].css:this._ctx.fillStyle=this._colors.foreground.css,t.y1===t.y2)this.fillBottomLineAtCells(t.x1,t.y1,t.x2-t.x1);else{this.fillBottomLineAtCells(t.x1,t.y1,t.cols-t.x1);for(var e=t.y1+1;e<t.y2;e++)this.fillBottomLineAtCells(0,e,t.cols);this.fillBottomLineAtCells(0,t.y2,t.x2)}this._state=t},e.prototype._onLinkLeave=function(t){this._clearCurrentLink()},e}(BaseRenderLayer_1.BaseRenderLayer);exports.LinkRenderLayer=LinkRenderLayer;

},{"./BaseRenderLayer":36,"./atlas/Types":52}],42:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(r,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var n in r)r.hasOwnProperty(n)&&(e[n]=r[n])})(r,n)};return function(r,n){function t(){this.constructor=r}e(r,n),r.prototype=null===n?Object.create(n):(t.prototype=n.prototype,new t)}}();Object.defineProperty(exports,"__esModule",{value:!0});var TextRenderLayer_1=require("./TextRenderLayer"),SelectionRenderLayer_1=require("./SelectionRenderLayer"),CursorRenderLayer_1=require("./CursorRenderLayer"),ColorManager_1=require("./ColorManager"),LinkRenderLayer_1=require("./LinkRenderLayer"),EventEmitter_1=require("../common/EventEmitter"),RenderDebouncer_1=require("../ui/RenderDebouncer"),ScreenDprMonitor_1=require("../ui/ScreenDprMonitor"),CharacterJoinerRegistry_1=require("../renderer/CharacterJoinerRegistry"),Renderer=function(e){function r(r,n){var t=e.call(this)||this;t._terminal=r,t._isPaused=!1,t._needsFullRefresh=!1;var i=t._terminal.options.allowTransparency;if(t.colorManager=new ColorManager_1.ColorManager(document,i),t._characterJoinerRegistry=new CharacterJoinerRegistry_1.CharacterJoinerRegistry(r),n&&t.colorManager.setTheme(n),t._renderLayers=[new TextRenderLayer_1.TextRenderLayer(t._terminal.screenElement,0,t.colorManager.colors,t._characterJoinerRegistry,i),new SelectionRenderLayer_1.SelectionRenderLayer(t._terminal.screenElement,1,t.colorManager.colors),new LinkRenderLayer_1.LinkRenderLayer(t._terminal.screenElement,2,t.colorManager.colors,t._terminal),new CursorRenderLayer_1.CursorRenderLayer(t._terminal.screenElement,3,t.colorManager.colors)],t.dimensions={scaledCharWidth:null,scaledCharHeight:null,scaledCellWidth:null,scaledCellHeight:null,scaledCharLeft:null,scaledCharTop:null,scaledCanvasWidth:null,scaledCanvasHeight:null,canvasWidth:null,canvasHeight:null,actualCellWidth:null,actualCellHeight:null},t._devicePixelRatio=window.devicePixelRatio,t._updateDimensions(),t.onOptionsChanged(),t._renderDebouncer=new RenderDebouncer_1.RenderDebouncer(t._terminal,t._renderRows.bind(t)),t._screenDprMonitor=new ScreenDprMonitor_1.ScreenDprMonitor,t._screenDprMonitor.setListener(function(){return t.onWindowResize(window.devicePixelRatio)}),t.register(t._screenDprMonitor),"IntersectionObserver"in window){var s=new IntersectionObserver(function(e){return t.onIntersectionChange(e[0])},{threshold:0});s.observe(t._terminal.element),t.register({dispose:function(){return s.disconnect()}})}return t}return __extends(r,e),r.prototype.dispose=function(){e.prototype.dispose.call(this),this._renderLayers.forEach(function(e){return e.dispose()})},r.prototype.onIntersectionChange=function(e){this._isPaused=0===e.intersectionRatio,!this._isPaused&&this._needsFullRefresh&&this._terminal.refresh(0,this._terminal.rows-1)},r.prototype.onWindowResize=function(e){this._devicePixelRatio!==e&&(this._devicePixelRatio=e,this.onResize(this._terminal.cols,this._terminal.rows))},r.prototype.setTheme=function(e){var r=this;return this.colorManager.setTheme(e),this._renderLayers.forEach(function(e){e.onThemeChanged(r._terminal,r.colorManager.colors),e.reset(r._terminal)}),this._isPaused?this._needsFullRefresh=!0:this._terminal.refresh(0,this._terminal.rows-1),this.colorManager.colors},r.prototype.onResize=function(e,r){var n=this;this._updateDimensions(),this._renderLayers.forEach(function(e){return e.resize(n._terminal,n.dimensions)}),this._isPaused?this._needsFullRefresh=!0:this._terminal.refresh(0,this._terminal.rows-1),this._terminal.screenElement.style.width=this.dimensions.canvasWidth+"px",this._terminal.screenElement.style.height=this.dimensions.canvasHeight+"px",this.emit("resize",{width:this.dimensions.canvasWidth,height:this.dimensions.canvasHeight})},r.prototype.onCharSizeChanged=function(){this.onResize(this._terminal.cols,this._terminal.rows)},r.prototype.onBlur=function(){var e=this;this._runOperation(function(r){return r.onBlur(e._terminal)})},r.prototype.onFocus=function(){var e=this;this._runOperation(function(r){return r.onFocus(e._terminal)})},r.prototype.onSelectionChanged=function(e,r,n){var t=this;void 0===n&&(n=!1),this._runOperation(function(i){return i.onSelectionChanged(t._terminal,e,r,n)})},r.prototype.onCursorMove=function(){var e=this;this._runOperation(function(r){return r.onCursorMove(e._terminal)})},r.prototype.onOptionsChanged=function(){var e=this;this.colorManager.allowTransparency=this._terminal.options.allowTransparency,this._runOperation(function(r){return r.onOptionsChanged(e._terminal)})},r.prototype.clear=function(){var e=this;this._runOperation(function(r){return r.reset(e._terminal)})},r.prototype._runOperation=function(e){this._isPaused?this._needsFullRefresh=!0:this._renderLayers.forEach(function(r){return e(r)})},r.prototype.refreshRows=function(e,r){this._isPaused?this._needsFullRefresh=!0:this._renderDebouncer.refresh(e,r)},r.prototype._renderRows=function(e,r){var n=this;this._renderLayers.forEach(function(t){return t.onGridChanged(n._terminal,e,r)}),this._terminal.emit("refresh",{start:e,end:r})},r.prototype._updateDimensions=function(){this._terminal.charMeasure.width&&this._terminal.charMeasure.height&&(this.dimensions.scaledCharWidth=Math.floor(this._terminal.charMeasure.width*window.devicePixelRatio),this.dimensions.scaledCharHeight=Math.ceil(this._terminal.charMeasure.height*window.devicePixelRatio),this.dimensions.scaledCellHeight=Math.floor(this.dimensions.scaledCharHeight*this._terminal.options.lineHeight),this.dimensions.scaledCharTop=1===this._terminal.options.lineHeight?0:Math.round((this.dimensions.scaledCellHeight-this.dimensions.scaledCharHeight)/2),this.dimensions.scaledCellWidth=this.dimensions.scaledCharWidth+Math.round(this._terminal.options.letterSpacing),this.dimensions.scaledCharLeft=Math.floor(this._terminal.options.letterSpacing/2),this.dimensions.scaledCanvasHeight=this._terminal.rows*this.dimensions.scaledCellHeight,this.dimensions.scaledCanvasWidth=this._terminal.cols*this.dimensions.scaledCellWidth,this.dimensions.canvasHeight=Math.round(this.dimensions.scaledCanvasHeight/window.devicePixelRatio),this.dimensions.canvasWidth=Math.round(this.dimensions.scaledCanvasWidth/window.devicePixelRatio),this.dimensions.actualCellHeight=this.dimensions.canvasHeight/this._terminal.rows,this.dimensions.actualCellWidth=this.dimensions.canvasWidth/this._terminal.cols)},r.prototype.registerCharacterJoiner=function(e){return this._characterJoinerRegistry.registerCharacterJoiner(e)},r.prototype.deregisterCharacterJoiner=function(e){return this._characterJoinerRegistry.deregisterCharacterJoiner(e)},r}(EventEmitter_1.EventEmitter);exports.Renderer=Renderer;

},{"../common/EventEmitter":28,"../renderer/CharacterJoinerRegistry":37,"../ui/RenderDebouncer":61,"../ui/ScreenDprMonitor":62,"./ColorManager":38,"./CursorRenderLayer":39,"./LinkRenderLayer":41,"./SelectionRenderLayer":43,"./TextRenderLayer":44}],43:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function s(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(s.prototype=r.prototype,new s)}}();Object.defineProperty(exports,"__esModule",{value:!0});var BaseRenderLayer_1=require("./BaseRenderLayer"),SelectionRenderLayer=function(t){function e(e,r,s){var i=t.call(this,e,"selection",r,!0,s)||this;return i._clearState(),i}return __extends(e,t),e.prototype._clearState=function(){this._state={start:null,end:null,columnSelectMode:null,ydisp:null}},e.prototype.resize=function(e,r){t.prototype.resize.call(this,e,r),this._clearState()},e.prototype.reset=function(t){this._state.start&&this._state.end&&(this._clearState(),this.clearAll())},e.prototype.onSelectionChanged=function(t,e,r,s){if(this._didStateChange(e,r,s,t.buffer.ydisp)&&(this.clearAll(),e&&r)){var i=e[1]-t.buffer.ydisp,n=r[1]-t.buffer.ydisp,o=Math.max(i,0),a=Math.min(n,t.rows-1);if(!(o>=t.rows||a<0)){if(this._ctx.fillStyle=this._colors.selection.css,s){var l=e[0],c=r[0]-l,u=a-o+1;this.fillCells(l,o,c,u)}else{l=i===o?e[0]:0;var _=o===a?r[0]:t.cols;this.fillCells(l,o,_-l,1);var h=Math.max(a-o-1,0);if(this.fillCells(0,o+1,t.cols,h),o!==a){var f=n===a?r[0]:t.cols;this.fillCells(0,a,f,1)}}this._state.start=[e[0],e[1]],this._state.end=[r[0],r[1]],this._state.columnSelectMode=s,this._state.ydisp=t.buffer.ydisp}}},e.prototype._didStateChange=function(t,e,r,s){return!this._areCoordinatesEqual(t,this._state.start)||!this._areCoordinatesEqual(e,this._state.end)||r!==this._state.columnSelectMode||s!==this._state.ydisp},e.prototype._areCoordinatesEqual=function(t,e){return!(!t||!e)&&(t[0]===e[0]&&t[1]===e[1])},e}(BaseRenderLayer_1.BaseRenderLayer);exports.SelectionRenderLayer=SelectionRenderLayer;

},{"./BaseRenderLayer":36}],44:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(r,t){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)r.hasOwnProperty(t)&&(e[t]=r[t])})(r,t)};return function(r,t){function a(){this.constructor=r}e(r,t),r.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Buffer_1=require("../Buffer"),Types_1=require("./atlas/Types"),GridCache_1=require("./GridCache"),BaseRenderLayer_1=require("./BaseRenderLayer"),TextRenderLayer=function(e){function r(r,t,a,s,i){var _=e.call(this,r,"text",t,i,a)||this;return _._characterOverlapCache={},_._state=new GridCache_1.GridCache,_._characterJoinerRegistry=s,_}return __extends(r,e),r.prototype.resize=function(r,t){e.prototype.resize.call(this,r,t);var a=this._getFont(r,!1,!1);this._characterWidth===t.scaledCharWidth&&this._characterFont===a||(this._characterWidth=t.scaledCharWidth,this._characterFont=a,this._characterOverlapCache={}),this._state.clear(),this._state.resize(r.cols,r.rows)},r.prototype.reset=function(e){this._state.clear(),this.clearAll()},r.prototype._forEachCell=function(e,r,t,a,s){for(var i=r;i<=t;i++)for(var _=i+e.buffer.ydisp,o=e.buffer.lines.get(_),n=a?a.getJoinedCharacters(_):[],c=0;c<e.cols;c++){var l=o.get(c),h=l[Buffer_1.CHAR_DATA_CODE_INDEX],f=l[Buffer_1.CHAR_DATA_CHAR_INDEX],u=l[Buffer_1.CHAR_DATA_ATTR_INDEX],p=l[Buffer_1.CHAR_DATA_WIDTH_INDEX],C=!1,d=c;if(0!==p){if(n.length>0&&c===n[0][0]){C=!0;var y=n.shift();f=e.buffer.translateBufferLineToString(_,!0,y[0],y[1]),p=y[1]-y[0],h=1/0,d=y[1]-1}!C&&this._isOverlapping(l)&&d<o.length-1&&o.get(d+1)[Buffer_1.CHAR_DATA_CODE_INDEX]===Buffer_1.NULL_CELL_CODE&&(p=2);var A=u>>18,T=511&u,D=u>>9&511;if(8&A){var v=T;T=D,256===(D=v)&&(D=Types_1.INVERTED_DEFAULT_COLOR),257===T&&(T=Types_1.INVERTED_DEFAULT_COLOR)}s(h,f,p,c,i,D,T,A),c=d}}},r.prototype._drawBackground=function(e,r,t){var a=this,s=this._ctx,i=e.cols,_=0,o=0,n=null;s.save(),this._forEachCell(e,r,t,null,function(e,r,t,c,l,h,f,u){var p=null;f===Types_1.INVERTED_DEFAULT_COLOR?p=a._colors.foreground.css:f<256&&(p=a._colors.ansi[f].css),null===n&&(_=c,o=l),l!==o?(s.fillStyle=n,a.fillCells(_,o,i-_,1),_=c,o=l):n!==p&&(s.fillStyle=n,a.fillCells(_,o,c-_,1),_=c,o=l),n=p}),null!==n&&(s.fillStyle=n,this.fillCells(_,o,i-_,1)),s.restore()},r.prototype._drawForeground=function(e,r,t){var a=this;this._forEachCell(e,r,t,this._characterJoinerRegistry,function(r,t,s,i,_,o,n,c){16&c||(2&c&&(a._ctx.save(),o===Types_1.INVERTED_DEFAULT_COLOR?a._ctx.fillStyle=a._colors.background.css:a._ctx.fillStyle=o<256?a._colors.ansi[o].css:a._colors.foreground.css,a.fillBottomLineAtCells(i,_,s),a._ctx.restore()),a.drawChars(e,t,r,s,i,_,o,n,!!(1&c),!!(32&c),!!(64&c)))})},r.prototype.onGridChanged=function(e,r,t){0!==this._state.cache.length&&(this._charAtlas&&this._charAtlas.beginFrame(),this.clearCells(0,r,e.cols,t-r+1),this._drawBackground(e,r,t),this._drawForeground(e,r,t))},r.prototype.onOptionsChanged=function(e){this.setTransparency(e,e.options.allowTransparency)},r.prototype._isOverlapping=function(e){if(1!==e[Buffer_1.CHAR_DATA_WIDTH_INDEX])return!1;if(e[Buffer_1.CHAR_DATA_CODE_INDEX]<256)return!1;var r=e[Buffer_1.CHAR_DATA_CHAR_INDEX];if(this._characterOverlapCache.hasOwnProperty(r))return this._characterOverlapCache[r];this._ctx.save(),this._ctx.font=this._characterFont;var t=Math.floor(this._ctx.measureText(r).width)>this._characterWidth;return this._ctx.restore(),this._characterOverlapCache[r]=t,t},r}(BaseRenderLayer_1.BaseRenderLayer);exports.TextRenderLayer=TextRenderLayer;

},{"../Buffer":13,"./BaseRenderLayer":36,"./GridCache":40,"./atlas/Types":52}],45:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var BaseCharAtlas=function(){function t(){this._didWarmUp=!1}return t.prototype.dispose=function(){},t.prototype.warmUp=function(){this._didWarmUp||(this._doWarmUp(),this._didWarmUp=!0)},t.prototype._doWarmUp=function(){},t.prototype.beginFrame=function(){},t}();exports.default=BaseCharAtlas;

},{}],46:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var CharAtlasUtils_1=require("./CharAtlasUtils"),DynamicCharAtlas_1=require("./DynamicCharAtlas"),NoneCharAtlas_1=require("./NoneCharAtlas"),StaticCharAtlas_1=require("./StaticCharAtlas"),charAtlasImplementations={none:NoneCharAtlas_1.default,static:StaticCharAtlas_1.default,dynamic:DynamicCharAtlas_1.default},charAtlasCache=[];function acquireCharAtlas(a,e,r,t){for(var l=CharAtlasUtils_1.generateConfig(r,t,a,e),s=0;s<charAtlasCache.length;s++){var c=(h=charAtlasCache[s]).ownedBy.indexOf(a);if(c>=0){if(CharAtlasUtils_1.configEquals(h.config,l))return h.atlas;1===h.ownedBy.length?charAtlasCache.splice(s,1):h.ownedBy.splice(c,1);break}}for(s=0;s<charAtlasCache.length;s++){var h=charAtlasCache[s];if(CharAtlasUtils_1.configEquals(h.config,l))return h.ownedBy.push(a),h.atlas}var n={atlas:new charAtlasImplementations[a.options.experimentalCharAtlas](document,l),config:l,ownedBy:[a]};return charAtlasCache.push(n),n.atlas}function removeTerminalFromCache(a){for(var e=0;e<charAtlasCache.length;e++){var r=charAtlasCache[e].ownedBy.indexOf(a);if(-1!==r){1===charAtlasCache[e].ownedBy.length?charAtlasCache.splice(e,1):charAtlasCache[e].ownedBy.splice(r,1);break}}}exports.acquireCharAtlas=acquireCharAtlas,exports.removeTerminalFromCache=removeTerminalFromCache;

},{"./CharAtlasUtils":47,"./DynamicCharAtlas":48,"./NoneCharAtlas":50,"./StaticCharAtlas":51}],47:[function(require,module,exports){
"use strict";function generateConfig(o,e,n,t){var i={foreground:t.foreground,background:t.background,cursor:null,cursorAccent:null,selection:null,ansi:t.ansi.slice(0,16)};return{type:n.options.experimentalCharAtlas,devicePixelRatio:window.devicePixelRatio,scaledCharWidth:o,scaledCharHeight:e,fontFamily:n.options.fontFamily,fontSize:n.options.fontSize,fontWeight:n.options.fontWeight,fontWeightBold:n.options.fontWeightBold,allowTransparency:n.options.allowTransparency,colors:i}}function configEquals(o,e){for(var n=0;n<o.colors.ansi.length;n++)if(o.colors.ansi[n].rgba!==e.colors.ansi[n].rgba)return!1;return o.type===e.type&&o.devicePixelRatio===e.devicePixelRatio&&o.fontFamily===e.fontFamily&&o.fontSize===e.fontSize&&o.fontWeight===e.fontWeight&&o.fontWeightBold===e.fontWeightBold&&o.allowTransparency===e.allowTransparency&&o.scaledCharWidth===e.scaledCharWidth&&o.scaledCharHeight===e.scaledCharHeight&&o.colors.foreground===e.colors.foreground&&o.colors.background===e.colors.background}Object.defineProperty(exports,"__esModule",{value:!0}),exports.generateConfig=generateConfig,exports.configEquals=configEquals;

},{}],48:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var t=function(i,e){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])})(i,e)};return function(i,e){function a(){this.constructor=i}t(i,e),i.prototype=null===e?Object.create(e):(a.prototype=e.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Types_1=require("./Types"),BaseCharAtlas_1=require("./BaseCharAtlas"),ColorManager_1=require("../ColorManager"),CharAtlasGenerator_1=require("../../shared/atlas/CharAtlasGenerator"),LRUMap_1=require("./LRUMap"),Browser_1=require("../../shared/utils/Browser"),TEXTURE_WIDTH=1024,TEXTURE_HEIGHT=1024,TRANSPARENT_COLOR={css:"rgba(0, 0, 0, 0)",rgba:0},FRAME_CACHE_DRAW_LIMIT=100,GLYPH_BITMAP_COMMIT_DELAY=100;function getGlyphCacheKey(t){return t.code<<21|t.bg<<12|t.fg<<3|(t.bold?0:4)+(t.dim?0:2)+(t.italic?0:1)}var DynamicCharAtlas=function(t){function i(i,e){var a=t.call(this)||this;a._config=e,a._drawToCacheCount=0,a._glyphsWaitingOnBitmap=[],a._bitmapCommitTimeout=null,a._bitmap=null,a._cacheCanvas=i.createElement("canvas"),a._cacheCanvas.width=TEXTURE_WIDTH,a._cacheCanvas.height=TEXTURE_HEIGHT,a._cacheCtx=a._cacheCanvas.getContext("2d",{alpha:!0});var o=i.createElement("canvas");o.width=a._config.scaledCharWidth,o.height=a._config.scaledCharHeight,a._tmpCtx=o.getContext("2d",{alpha:a._config.allowTransparency}),a._width=Math.floor(TEXTURE_WIDTH/a._config.scaledCharWidth),a._height=Math.floor(TEXTURE_HEIGHT/a._config.scaledCharHeight);var r=a._width*a._height;return a._cacheMap=new LRUMap_1.default(r),a._cacheMap.prealloc(r),a}return __extends(i,t),i.prototype.dispose=function(){null!==this._bitmapCommitTimeout&&(window.clearTimeout(this._bitmapCommitTimeout),this._bitmapCommitTimeout=null)},i.prototype.beginFrame=function(){this._drawToCacheCount=0},i.prototype.draw=function(t,i,e,a){if(32===i.code)return!0;var o=getGlyphCacheKey(i),r=this._cacheMap.get(o);if(null!=r)return this._drawFromCache(t,r,e,a),!0;if(this._canCache(i)&&this._drawToCacheCount<FRAME_CACHE_DRAW_LIMIT){var n=void 0;n=this._cacheMap.size<this._cacheMap.capacity?this._cacheMap.size:this._cacheMap.peek().index;var h=this._drawToCache(i,n);return this._cacheMap.set(o,h),this._drawFromCache(t,h,e,a),!0}return!1},i.prototype._canCache=function(t){return t.code<256},i.prototype._toCoordinateX=function(t){return t%this._width*this._config.scaledCharWidth},i.prototype._toCoordinateY=function(t){return Math.floor(t/this._width)*this._config.scaledCharHeight},i.prototype._drawFromCache=function(t,i,e,a){if(!i.isEmpty){var o=this._toCoordinateX(i.index),r=this._toCoordinateY(i.index);t.drawImage(i.inBitmap?this._bitmap:this._cacheCanvas,o,r,this._config.scaledCharWidth,this._config.scaledCharHeight,e,a,this._config.scaledCharWidth,this._config.scaledCharHeight)}},i.prototype._getColorFromAnsiIndex=function(t){return t<this._config.colors.ansi.length?this._config.colors.ansi[t]:ColorManager_1.DEFAULT_ANSI_COLORS[t]},i.prototype._getBackgroundColor=function(t){return this._config.allowTransparency?TRANSPARENT_COLOR:t.bg===Types_1.INVERTED_DEFAULT_COLOR?this._config.colors.foreground:t.bg<256?this._getColorFromAnsiIndex(t.bg):this._config.colors.background},i.prototype._getForegroundColor=function(t){return t.fg===Types_1.INVERTED_DEFAULT_COLOR?this._config.colors.background:t.fg<256?this._getColorFromAnsiIndex(t.fg):this._config.colors.foreground},i.prototype._drawToCache=function(t,i){this._drawToCacheCount++,this._tmpCtx.save();var e=this._getBackgroundColor(t);this._tmpCtx.globalCompositeOperation="copy",this._tmpCtx.fillStyle=e.css,this._tmpCtx.fillRect(0,0,this._config.scaledCharWidth,this._config.scaledCharHeight),this._tmpCtx.globalCompositeOperation="source-over";var a=t.bold?this._config.fontWeightBold:this._config.fontWeight,o=t.italic?"italic":"";this._tmpCtx.font=o+" "+a+" "+this._config.fontSize*this._config.devicePixelRatio+"px "+this._config.fontFamily,this._tmpCtx.textBaseline="top",this._tmpCtx.fillStyle=this._getForegroundColor(t).css,t.dim&&(this._tmpCtx.globalAlpha=Types_1.DIM_OPACITY),this._tmpCtx.fillText(t.chars,0,0),this._tmpCtx.restore();var r=this._tmpCtx.getImageData(0,0,this._config.scaledCharWidth,this._config.scaledCharHeight),n=!1;this._config.allowTransparency||(n=CharAtlasGenerator_1.clearColor(r,e));var h=this._toCoordinateX(i),s=this._toCoordinateY(i);this._cacheCtx.putImageData(r,h,s);var _={index:i,isEmpty:n,inBitmap:!1};return this._addGlyphToBitmap(_),_},i.prototype._addGlyphToBitmap=function(t){var i=this;"createImageBitmap"in window&&!Browser_1.isFirefox&&!Browser_1.isSafari&&(this._glyphsWaitingOnBitmap.push(t),null===this._bitmapCommitTimeout&&(this._bitmapCommitTimeout=window.setTimeout(function(){return i._generateBitmap()},GLYPH_BITMAP_COMMIT_DELAY)))},i.prototype._generateBitmap=function(){var t=this,i=this._glyphsWaitingOnBitmap;this._glyphsWaitingOnBitmap=[],window.createImageBitmap(this._cacheCanvas).then(function(e){t._bitmap=e;for(var a=0;a<i.length;a++){i[a].inBitmap=!0}}),this._bitmapCommitTimeout=null},i}(BaseCharAtlas_1.default);exports.default=DynamicCharAtlas;

},{"../../shared/atlas/CharAtlasGenerator":55,"../../shared/utils/Browser":57,"../ColorManager":38,"./BaseCharAtlas":45,"./LRUMap":49,"./Types":52}],49:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var LRUMap=function(){function e(e){this.capacity=e,this._map={},this._head=null,this._tail=null,this._nodePool=[],this.size=0}return e.prototype._unlinkNode=function(e){var t=e.prev,l=e.next;e===this._head&&(this._head=l),e===this._tail&&(this._tail=t),null!==t&&(t.next=l),null!==l&&(l.prev=t)},e.prototype._appendNode=function(e){var t=this._tail;null!==t&&(t.next=e),e.prev=t,e.next=null,this._tail=e,null===this._head&&(this._head=e)},e.prototype.prealloc=function(e){for(var t=this._nodePool,l=0;l<e;l++)t.push({prev:null,next:null,key:null,value:null})},e.prototype.get=function(e){var t=this._map[e];return void 0!==t?(this._unlinkNode(t),this._appendNode(t),t.value):null},e.prototype.peekValue=function(e){var t=this._map[e];return void 0!==t?t.value:null},e.prototype.peek=function(){var e=this._head;return null===e?null:e.value},e.prototype.set=function(e,t){var l=this._map[e];if(void 0!==l)l=this._map[e],this._unlinkNode(l),l.value=t;else if(this.size>=this.capacity)l=this._head,this._unlinkNode(l),delete this._map[l.key],l.key=e,l.value=t,this._map[e]=l;else{var i=this._nodePool;i.length>0?((l=i.pop()).key=e,l.value=t):l={prev:null,next:null,key:e,value:t},this._map[e]=l,this.size++}this._appendNode(l)},e}();exports.default=LRUMap;

},{}],50:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var BaseCharAtlas_1=require("./BaseCharAtlas"),NoneCharAtlas=function(t){function e(e,r){return t.call(this)||this}return __extends(e,t),e.prototype.draw=function(t,e,r,n){return!1},e}(BaseCharAtlas_1.default);exports.default=NoneCharAtlas;

},{"./BaseCharAtlas":45}],51:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var t=function(e,r){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(e,r)};return function(e,r){function a(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(a.prototype=r.prototype,new a)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Types_1=require("./Types"),Types_2=require("../../shared/atlas/Types"),CharAtlasGenerator_1=require("../../shared/atlas/CharAtlasGenerator"),BaseCharAtlas_1=require("./BaseCharAtlas"),StaticCharAtlas=function(t){function e(e,r){var a=t.call(this)||this;return a._document=e,a._config=r,a._canvasFactory=function(t,e){var r=a._document.createElement("canvas");return r.width=t,r.height=e,r},a}return __extends(e,t),e.prototype._doWarmUp=function(){var t=this,e=CharAtlasGenerator_1.generateStaticCharAtlasTexture(window,this._canvasFactory,this._config);e instanceof HTMLCanvasElement?this._texture=e:e.then(function(e){t._texture=e})},e.prototype._isCached=function(t,e){var r=t.code<256,a=t.fg<16,n=t.fg>=256,s=t.bg>=256;return r&&(a||n)&&s&&!t.italic},e.prototype.draw=function(t,e,r,a){if(null===this._texture||void 0===this._texture)return!1;var n=0;if(e.fg<256?n=2+e.fg+(e.bold?16:0):e.bold&&(n=1),!this._isCached(e,n))return!1;t.save();var s=this._config.scaledCharWidth+Types_2.CHAR_ATLAS_CELL_SPACING,i=this._config.scaledCharHeight+Types_2.CHAR_ATLAS_CELL_SPACING;return e.dim&&(t.globalAlpha=Types_1.DIM_OPACITY),t.drawImage(this._texture,e.code*s,n*i,s,this._config.scaledCharHeight,r,a,s,this._config.scaledCharHeight),t.restore(),!0},e}(BaseCharAtlas_1.default);exports.default=StaticCharAtlas;

},{"../../shared/atlas/CharAtlasGenerator":55,"../../shared/atlas/Types":56,"./BaseCharAtlas":45,"./Types":52}],52:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.INVERTED_DEFAULT_COLOR=-1,exports.DIM_OPACITY=.5;

},{}],53:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function i(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}();Object.defineProperty(exports,"__esModule",{value:!0});var EventEmitter_1=require("../../common/EventEmitter"),ColorManager_1=require("../ColorManager"),RenderDebouncer_1=require("../../ui/RenderDebouncer"),DomRendererRowFactory_1=require("./DomRendererRowFactory"),TERMINAL_CLASS_PREFIX="xterm-dom-renderer-owner-",ROW_CONTAINER_CLASS="xterm-rows",FG_CLASS_PREFIX="xterm-fg-",BG_CLASS_PREFIX="xterm-bg-",FOCUS_CLASS="xterm-focus",SELECTION_CLASS="xterm-selection",nextTerminalId=1,DomRenderer=function(e){function t(t,n){var i=e.call(this)||this;i._terminal=t,i._terminalClass=nextTerminalId++,i._rowElements=[];var r=i._terminal.options.allowTransparency;return i.colorManager=new ColorManager_1.ColorManager(document,r),i.setTheme(n),i._rowContainer=document.createElement("div"),i._rowContainer.classList.add(ROW_CONTAINER_CLASS),i._rowContainer.style.lineHeight="normal",i._rowContainer.setAttribute("aria-hidden","true"),i._refreshRowElements(i._terminal.cols,i._terminal.rows),i._selectionContainer=document.createElement("div"),i._selectionContainer.classList.add(SELECTION_CLASS),i._selectionContainer.setAttribute("aria-hidden","true"),i.dimensions={scaledCharWidth:null,scaledCharHeight:null,scaledCellWidth:null,scaledCellHeight:null,scaledCharLeft:null,scaledCharTop:null,scaledCanvasWidth:null,scaledCanvasHeight:null,canvasWidth:null,canvasHeight:null,actualCellWidth:null,actualCellHeight:null},i._updateDimensions(),i._renderDebouncer=new RenderDebouncer_1.RenderDebouncer(i._terminal,i._renderRows.bind(i)),i._rowFactory=new DomRendererRowFactory_1.DomRendererRowFactory(document),i._terminal.element.classList.add(TERMINAL_CLASS_PREFIX+i._terminalClass),i._terminal.screenElement.appendChild(i._rowContainer),i._terminal.screenElement.appendChild(i._selectionContainer),i._terminal.linkifier.on("linkhover",function(e){return i._onLinkHover(e)}),i._terminal.linkifier.on("linkleave",function(e){return i._onLinkLeave(e)}),i}return __extends(t,e),t.prototype.dispose=function(){this._terminal.element.classList.remove(TERMINAL_CLASS_PREFIX+this._terminalClass),this._terminal.screenElement.removeChild(this._rowContainer),this._terminal.screenElement.removeChild(this._selectionContainer),this._terminal.screenElement.removeChild(this._themeStyleElement),this._terminal.screenElement.removeChild(this._dimensionsStyleElement),e.prototype.dispose.call(this)},t.prototype._updateDimensions=function(){var e=this;this.dimensions.scaledCharWidth=this._terminal.charMeasure.width*window.devicePixelRatio,this.dimensions.scaledCharHeight=this._terminal.charMeasure.height*window.devicePixelRatio,this.dimensions.scaledCellWidth=this.dimensions.scaledCharWidth,this.dimensions.scaledCellHeight=this.dimensions.scaledCharHeight,this.dimensions.scaledCharLeft=0,this.dimensions.scaledCharTop=0,this.dimensions.scaledCanvasWidth=this.dimensions.scaledCellWidth*this._terminal.cols,this.dimensions.scaledCanvasHeight=this.dimensions.scaledCellHeight*this._terminal.rows,this.dimensions.canvasWidth=this._terminal.charMeasure.width*this._terminal.cols,this.dimensions.canvasHeight=this._terminal.charMeasure.height*this._terminal.rows,this.dimensions.actualCellWidth=this._terminal.charMeasure.width,this.dimensions.actualCellHeight=this._terminal.charMeasure.height,this._rowElements.forEach(function(t){t.style.width=e.dimensions.canvasWidth+"px",t.style.height=e._terminal.charMeasure.height+"px"}),this._dimensionsStyleElement||(this._dimensionsStyleElement=document.createElement("style"),this._terminal.screenElement.appendChild(this._dimensionsStyleElement));var t=this._terminalSelector+" ."+ROW_CONTAINER_CLASS+" span { display: inline-block; height: 100%; vertical-align: top; width: "+this._terminal.charMeasure.width+"px}";this._dimensionsStyleElement.innerHTML=t,this._selectionContainer.style.height=this._terminal._viewportElement.style.height,this._rowContainer.style.width=this.dimensions.canvasWidth+"px",this._rowContainer.style.height=this.dimensions.canvasHeight+"px"},t.prototype.setTheme=function(e){var t=this;e&&this.colorManager.setTheme(e),this._themeStyleElement||(this._themeStyleElement=document.createElement("style"),this._terminal.screenElement.appendChild(this._themeStyleElement));var n=this._terminalSelector+" ."+ROW_CONTAINER_CLASS+" { color: "+this.colorManager.colors.foreground.css+"; background-color: "+this.colorManager.colors.background.css+"; font-family: "+this._terminal.getOption("fontFamily")+"; font-size: "+this._terminal.getOption("fontSize")+"px;}";return n+=this._terminalSelector+" span:not(."+DomRendererRowFactory_1.BOLD_CLASS+") { font-weight: "+this._terminal.options.fontWeight+";}"+this._terminalSelector+" span."+DomRendererRowFactory_1.BOLD_CLASS+" { font-weight: "+this._terminal.options.fontWeightBold+";}"+this._terminalSelector+" span."+DomRendererRowFactory_1.ITALIC_CLASS+" { font-style: italic;}",n+=this._terminalSelector+" ."+ROW_CONTAINER_CLASS+":not(."+FOCUS_CLASS+") ."+DomRendererRowFactory_1.CURSOR_CLASS+" { outline: 1px solid "+this.colorManager.colors.cursor.css+"; outline-offset: -1px;}"+this._terminalSelector+" ."+ROW_CONTAINER_CLASS+"."+FOCUS_CLASS+" ."+DomRendererRowFactory_1.CURSOR_CLASS+"."+DomRendererRowFactory_1.CURSOR_STYLE_BLOCK_CLASS+" { background-color: "+this.colorManager.colors.cursor.css+"; color: "+this.colorManager.colors.cursorAccent.css+";}"+this._terminalSelector+" ."+ROW_CONTAINER_CLASS+"."+FOCUS_CLASS+" ."+DomRendererRowFactory_1.CURSOR_CLASS+"."+DomRendererRowFactory_1.CURSOR_STYLE_BAR_CLASS+" { box-shadow: 1px 0 0 "+this.colorManager.colors.cursor.css+" inset;}"+this._terminalSelector+" ."+ROW_CONTAINER_CLASS+"."+FOCUS_CLASS+" ."+DomRendererRowFactory_1.CURSOR_CLASS+"."+DomRendererRowFactory_1.CURSOR_STYLE_UNDERLINE_CLASS+" { box-shadow: 0 -1px 0 "+this.colorManager.colors.cursor.css+" inset;}",n+=this._terminalSelector+" ."+SELECTION_CLASS+" { position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none;}"+this._terminalSelector+" ."+SELECTION_CLASS+" div { position: absolute; background-color: "+this.colorManager.colors.selection.css+";}",this.colorManager.colors.ansi.forEach(function(e,i){n+=t._terminalSelector+" ."+FG_CLASS_PREFIX+i+" { color: "+e.css+"; }"+t._terminalSelector+" ."+BG_CLASS_PREFIX+i+" { background-color: "+e.css+"; }"}),this._themeStyleElement.innerHTML=n,this.colorManager.colors},t.prototype.onWindowResize=function(e){this._updateDimensions()},t.prototype._refreshRowElements=function(e,t){for(var n=this._rowElements.length;n<=t;n++){var i=document.createElement("div");this._rowContainer.appendChild(i),this._rowElements.push(i)}for(;this._rowElements.length>t;)this._rowContainer.removeChild(this._rowElements.pop())},t.prototype.onResize=function(e,t){this._refreshRowElements(e,t),this._updateDimensions()},t.prototype.onCharSizeChanged=function(){this._updateDimensions()},t.prototype.onBlur=function(){this._rowContainer.classList.remove(FOCUS_CLASS)},t.prototype.onFocus=function(){this._rowContainer.classList.add(FOCUS_CLASS)},t.prototype.onSelectionChanged=function(e,t,n){for(;this._selectionContainer.children.length;)this._selectionContainer.removeChild(this._selectionContainer.children[0]);if(e&&t){var i=e[1]-this._terminal.buffer.ydisp,r=t[1]-this._terminal.buffer.ydisp,o=Math.max(i,0),s=Math.min(r,this._terminal.rows-1);if(!(o>=this._terminal.rows||s<0)){var l=document.createDocumentFragment();if(n)l.appendChild(this._createSelectionElement(o,e[0],t[0],s-o+1));else{var a=i===o?e[0]:0,h=o===s?t[0]:this._terminal.cols;l.appendChild(this._createSelectionElement(o,a,h));var c=s-o-1;if(l.appendChild(this._createSelectionElement(o+1,0,this._terminal.cols,c)),o!==s){var _=r===s?t[0]:this._terminal.cols;l.appendChild(this._createSelectionElement(s,0,_))}}this._selectionContainer.appendChild(l)}}},t.prototype._createSelectionElement=function(e,t,n,i){void 0===i&&(i=1);var r=document.createElement("div");return r.style.height=i*this._terminal.charMeasure.height+"px",r.style.top=e*this._terminal.charMeasure.height+"px",r.style.left=t*this._terminal.charMeasure.width+"px",r.style.width=this._terminal.charMeasure.width*(n-t)+"px",r},t.prototype.onCursorMove=function(){},t.prototype.onOptionsChanged=function(){this._updateDimensions(),this.setTheme(void 0),this._terminal.refresh(0,this._terminal.rows-1)},t.prototype.clear=function(){this._rowElements.forEach(function(e){return e.innerHTML=""})},t.prototype.refreshRows=function(e,t){this._renderDebouncer.refresh(e,t)},t.prototype._renderRows=function(e,t){for(var n=this._terminal,i=n.buffer.ybase+n.buffer.y,r=this._terminal.buffer.x,o=e;o<=t;o++){var s=this._rowElements[o];s.innerHTML="";var l=o+n.buffer.ydisp,a=n.buffer.lines.get(l),h=n.options.cursorStyle;s.appendChild(this._rowFactory.createRow(a,l===i,h,r,n.charMeasure.width,n.cols))}this._terminal.emit("refresh",{start:e,end:t})},Object.defineProperty(t.prototype,"_terminalSelector",{get:function(){return"."+TERMINAL_CLASS_PREFIX+this._terminalClass},enumerable:!0,configurable:!0}),t.prototype.registerCharacterJoiner=function(e){return-1},t.prototype.deregisterCharacterJoiner=function(e){return!1},t.prototype._onLinkHover=function(e){this._setCellUnderline(e.x1,e.x2,e.y1,e.y2,e.cols,!0)},t.prototype._onLinkLeave=function(e){this._setCellUnderline(e.x1,e.x2,e.y1,e.y2,e.cols,!1)},t.prototype._setCellUnderline=function(e,t,n,i,r,o){for(;e!==t||n!==i;){this._rowElements[n].children[e].style.textDecoration=o?"underline":"none",0===(e=(e+1)%r)&&n++}},t}(EventEmitter_1.EventEmitter);exports.DomRenderer=DomRenderer;

},{"../../common/EventEmitter":28,"../../ui/RenderDebouncer":61,"../ColorManager":38,"./DomRendererRowFactory":54}],54:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Buffer_1=require("../../Buffer");exports.BOLD_CLASS="xterm-bold",exports.ITALIC_CLASS="xterm-italic",exports.CURSOR_CLASS="xterm-cursor",exports.CURSOR_STYLE_BLOCK_CLASS="xterm-cursor-block",exports.CURSOR_STYLE_BAR_CLASS="xterm-cursor-bar",exports.CURSOR_STYLE_UNDERLINE_CLASS="xterm-cursor-underline";var DomRendererRowFactory=function(){function e(e){this._document=e}return e.prototype.createRow=function(e,r,t,s,o,_){for(var a=this._document.createDocumentFragment(),S=0,L=0;L<e.length;L++)if(!(S>=_)){var c=e.get(L),R=c[Buffer_1.CHAR_DATA_CHAR_INDEX],d=c[Buffer_1.CHAR_DATA_ATTR_INDEX],C=c[Buffer_1.CHAR_DATA_WIDTH_INDEX];if(0!==C){var i=this._document.createElement("span");C>1&&(i.style.width=o*C+"px");var n=d>>18,A=511&d,u=d>>9&511;if(r&&L===s)switch(i.classList.add(exports.CURSOR_CLASS),t){case"bar":i.classList.add(exports.CURSOR_STYLE_BAR_CLASS);break;case"underline":i.classList.add(exports.CURSOR_STYLE_UNDERLINE_CLASS);break;default:i.classList.add(exports.CURSOR_STYLE_BLOCK_CLASS)}if(8&n){var x=A;A=u,256===(u=x)&&(u=0),257===A&&(A=15)}1&n&&(u<8&&(u+=8),i.classList.add(exports.BOLD_CLASS)),64&n&&i.classList.add(exports.ITALIC_CLASS),i.textContent=R,257!==u&&i.classList.add("xterm-fg-"+u),256!==A&&i.classList.add("xterm-bg-"+A),a.appendChild(i),S+=C}}return a},e}();exports.DomRendererRowFactory=DomRendererRowFactory;

},{"../../Buffer":13}],55:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var Types_1=require("./Types"),Browser_1=require("../utils/Browser");function generateStaticCharAtlasTexture(e,t,r){var a=r.scaledCharWidth+Types_1.CHAR_ATLAS_CELL_SPACING,o=r.scaledCharHeight+Types_1.CHAR_ATLAS_CELL_SPACING,i=t(255*a,34*o),l=i.getContext("2d",{alpha:r.allowTransparency});l.fillStyle=r.colors.background.css,l.fillRect(0,0,i.width,i.height),l.save(),l.fillStyle=r.colors.foreground.css,l.font=getFont(r.fontWeight,r),l.textBaseline="top";for(var n=0;n<256;n++)l.save(),l.beginPath(),l.rect(n*a,0,a,o),l.clip(),l.fillText(String.fromCharCode(n),n*a,0),l.restore();l.save(),l.font=getFont(r.fontWeightBold,r);for(n=0;n<256;n++)l.save(),l.beginPath(),l.rect(n*a,o,a,o),l.clip(),l.fillText(String.fromCharCode(n),n*a,o),l.restore();l.restore(),l.font=getFont(r.fontWeight,r);for(var s=0;s<16;s++){var f=(s+2)*o;for(n=0;n<256;n++)l.save(),l.beginPath(),l.rect(n*a,f,a,o),l.clip(),l.fillStyle=r.colors.ansi[s].css,l.fillText(String.fromCharCode(n),n*a,f),l.restore()}l.font=getFont(r.fontWeightBold,r);for(s=0;s<16;s++)for(f=(s+2+16)*o,n=0;n<256;n++)l.save(),l.beginPath(),l.rect(n*a,f,a,o),l.clip(),l.fillStyle=r.colors.ansi[s].css,l.fillText(String.fromCharCode(n),n*a,f),l.restore();if(l.restore(),!("createImageBitmap"in e)||Browser_1.isFirefox||Browser_1.isSafari)return i instanceof HTMLCanvasElement?i:new Promise(function(e){return e(i.transferToImageBitmap())});var c=l.getImageData(0,0,i.width,i.height);return clearColor(c,r.colors.background),e.createImageBitmap(c)}function clearColor(e,t){for(var r=!0,a=t.rgba>>>24,o=t.rgba>>>16&255,i=t.rgba>>>8&255,l=0;l<e.data.length;l+=4)e.data[l]===a&&e.data[l+1]===o&&e.data[l+2]===i?e.data[l+3]=0:r=!1;return r}function getFont(e,t){return e+" "+t.fontSize*t.devicePixelRatio+"px "+t.fontFamily}exports.generateStaticCharAtlasTexture=generateStaticCharAtlasTexture,exports.clearColor=clearColor;

},{"../utils/Browser":57,"./Types":56}],56:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CHAR_ATLAS_CELL_SPACING=1;

},{}],57:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var isNode="undefined"==typeof navigator,userAgent=isNode?"node":navigator.userAgent,platform=isNode?"node":navigator.platform;function contains(e,i){return e.indexOf(i)>=0}exports.isFirefox=!!~userAgent.indexOf("Firefox"),exports.isSafari=/^((?!chrome|android).)*safari/i.test(userAgent),exports.isMSIE=!!~userAgent.indexOf("MSIE")||!!~userAgent.indexOf("Trident"),exports.isMac=contains(["Macintosh","MacIntel","MacPPC","Mac68K"],platform),exports.isIpad="iPad"===platform,exports.isIphone="iPhone"===platform,exports.isMSWindows=contains(["Windows","Win16","Win32","WinCE"],platform),exports.isLinux=platform.indexOf("Linux")>=0;

},{}],58:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var EventEmitter_1=require("../common/EventEmitter"),CharMeasure=function(e){function t(t,n){var r=e.call(this)||this;return r._document=t,r._parentElement=n,r._measureElement=r._document.createElement("span"),r._measureElement.classList.add("xterm-char-measure-element"),r._measureElement.textContent="W",r._measureElement.setAttribute("aria-hidden","true"),r._parentElement.appendChild(r._measureElement),r}return __extends(t,e),Object.defineProperty(t.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),t.prototype.measure=function(e){this._measureElement.style.fontFamily=e.fontFamily,this._measureElement.style.fontSize=e.fontSize+"px";var t=this._measureElement.getBoundingClientRect();0!==t.width&&0!==t.height&&(this._width===t.width&&this._height===t.height||(this._width=t.width,this._height=Math.ceil(t.height),this.emit("charsizechanged")))},t}(EventEmitter_1.EventEmitter);exports.CharMeasure=CharMeasure;

},{"../common/EventEmitter":28}],59:[function(require,module,exports){
"use strict";function addDisposableDomListener(e,s,t,n){return e.addEventListener(s,t,n),{dispose:function(){t&&(e.removeEventListener(s,t,n),e=null,t=null)}}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.addDisposableDomListener=addDisposableDomListener;

},{}],60:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(t,o){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(t,o)};return function(t,o){function n(){this.constructor=t}e(t,o),t.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Lifecycle_1=require("../common/Lifecycle"),Lifecycle_2=require("./Lifecycle"),HOVER_DURATION=500,MouseZoneManager=function(e){function t(t){var o=e.call(this)||this;return o._terminal=t,o._zones=[],o._areZonesActive=!1,o._tooltipTimeout=null,o._currentZone=null,o._lastHoverCoords=[null,null],o.register(Lifecycle_2.addDisposableDomListener(o._terminal.element,"mousedown",function(e){return o._onMouseDown(e)})),o._mouseMoveListener=function(e){return o._onMouseMove(e)},o._clickListener=function(e){return o._onClick(e)},o}return __extends(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this),this._deactivate()},t.prototype.add=function(e){this._zones.push(e),1===this._zones.length&&this._activate()},t.prototype.clearAll=function(e,t){if(0!==this._zones.length){t||(e=0,t=this._terminal.rows-1);for(var o=0;o<this._zones.length;o++){var n=this._zones[o];(n.y1>e&&n.y1<=t+1||n.y2>e&&n.y2<=t+1||n.y1<e&&n.y2>t+1)&&(this._currentZone&&this._currentZone===n&&(this._currentZone.leaveCallback(),this._currentZone=null),this._zones.splice(o--,1))}0===this._zones.length&&this._deactivate()}},t.prototype._activate=function(){this._areZonesActive||(this._areZonesActive=!0,this._terminal.element.addEventListener("mousemove",this._mouseMoveListener),this._terminal.element.addEventListener("click",this._clickListener))},t.prototype._deactivate=function(){this._areZonesActive&&(this._areZonesActive=!1,this._terminal.element.removeEventListener("mousemove",this._mouseMoveListener),this._terminal.element.removeEventListener("click",this._clickListener))},t.prototype._onMouseMove=function(e){this._lastHoverCoords[0]===e.pageX&&this._lastHoverCoords[1]===e.pageY||(this._onHover(e),this._lastHoverCoords=[e.pageX,e.pageY])},t.prototype._onHover=function(e){var t=this,o=this._findZoneEventAt(e);o!==this._currentZone&&(this._currentZone&&(this._currentZone.leaveCallback(),this._currentZone=null,this._tooltipTimeout&&clearTimeout(this._tooltipTimeout)),o&&(this._currentZone=o,o.hoverCallback&&o.hoverCallback(e),this._tooltipTimeout=setTimeout(function(){return t._onTooltip(e)},HOVER_DURATION)))},t.prototype._onTooltip=function(e){this._tooltipTimeout=null;var t=this._findZoneEventAt(e);t&&t.tooltipCallback&&t.tooltipCallback(e)},t.prototype._onMouseDown=function(e){if(this._areZonesActive){var t=this._findZoneEventAt(e);t&&t.willLinkActivate(e)&&(e.preventDefault(),e.stopImmediatePropagation())}},t.prototype._onClick=function(e){var t=this._findZoneEventAt(e);t&&(t.clickCallback(e),e.preventDefault(),e.stopImmediatePropagation())},t.prototype._findZoneEventAt=function(e){var t=this._terminal.mouseHelper.getCoords(e,this._terminal.screenElement,this._terminal.charMeasure,this._terminal.options.lineHeight,this._terminal.cols,this._terminal.rows);if(!t)return null;for(var o=t[0],n=t[1],i=0;i<this._zones.length;i++){var r=this._zones[i];if(r.y1===r.y2){if(n===r.y1&&o>=r.x1&&o<r.x2)return r}else if(n===r.y1&&o>=r.x1||n===r.y2&&o<r.x2||n>r.y1&&n<r.y2)return r}return null},t}(Lifecycle_1.Disposable);exports.MouseZoneManager=MouseZoneManager;var MouseZone=function(){return function(e,t,o,n,i,r,s,l,a){this.x1=e,this.y1=t,this.x2=o,this.y2=n,this.clickCallback=i,this.hoverCallback=r,this.tooltipCallback=s,this.leaveCallback=l,this.willLinkActivate=a}}();exports.MouseZone=MouseZone;

},{"../common/Lifecycle":29,"./Lifecycle":59}],61:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var RenderDebouncer=function(){function t(t,n){this._terminal=t,this._callback=n,this._animationFrame=null}return t.prototype.dispose=function(){this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=null)},t.prototype.refresh=function(t,n){var i=this;t=null!=t?t:0,n=null!=n?n:this._terminal.rows-1;var r=void 0!==this._rowStart&&null!==this._rowStart,a=void 0!==this._rowEnd&&null!==this._rowEnd;this._rowStart=r?Math.min(this._rowStart,t):t,this._rowEnd=a?Math.max(this._rowEnd,n):n,this._animationFrame||(this._animationFrame=window.requestAnimationFrame(function(){return i._innerRefresh()}))},t.prototype._innerRefresh=function(){this._rowStart=Math.max(this._rowStart,0),this._rowEnd=Math.min(this._rowEnd,this._terminal.rows-1),this._callback(this._rowStart,this._rowEnd),this._rowStart=null,this._rowEnd=null,this._animationFrame=null},t}();exports.RenderDebouncer=RenderDebouncer;

},{}],62:[function(require,module,exports){
"use strict";var __extends=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function r(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(r.prototype=i.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0});var Lifecycle_1=require("../common/Lifecycle"),ScreenDprMonitor=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.setListener=function(e){var t=this;this._listener&&this.clearListener(),this._listener=e,this._outerListener=function(){t._listener(window.devicePixelRatio,t._currentDevicePixelRatio),t._updateDpr()},this._updateDpr()},t.prototype.dispose=function(){e.prototype.dispose.call(this),this.clearListener()},t.prototype._updateDpr=function(){this._resolutionMediaMatchList&&this._resolutionMediaMatchList.removeListener(this._outerListener),this._currentDevicePixelRatio=window.devicePixelRatio,this._resolutionMediaMatchList=window.matchMedia("screen and (resolution: "+window.devicePixelRatio+"dppx)"),this._resolutionMediaMatchList.addListener(this._outerListener)},t.prototype.clearListener=function(){this._listener&&(this._resolutionMediaMatchList.removeListener(this._outerListener),this._listener=null,this._outerListener=null)},t}(Lifecycle_1.Disposable);exports.ScreenDprMonitor=ScreenDprMonitor;

},{"../common/Lifecycle":29}],63:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.clone=function(r,e){if(void 0===e&&(e=5),"object"!=typeof r)return r;if(null===r)return null;var t=Array.isArray(r)?[]:{};for(var o in r)t[o]=e<=1?r[o]:exports.clone(r[o],e-1);return t};

},{}],64:[function(require,module,exports){
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var MouseHelper=function(){function e(e){this._renderer=e}return e.getCoordsRelativeToElement=function(e,t){if(null===e.pageX||void 0===e.pageX)return null;for(var r=t,o=e.pageX,n=e.pageY;t;)o-=t.offsetLeft,n-=t.offsetTop,t=t.offsetParent;for(t=r;t&&t!==t.ownerDocument.body;)o+=t.scrollLeft,n+=t.scrollTop,t=t.parentElement;return[o,n]},e.prototype.getCoords=function(t,r,o,n,l,i,s){if(!o.width||!o.height)return null;var a=e.getCoordsRelativeToElement(t,r);return a?(a[0]=Math.ceil((a[0]+(s?this._renderer.dimensions.actualCellWidth/2:0))/this._renderer.dimensions.actualCellWidth),a[1]=Math.ceil(a[1]/this._renderer.dimensions.actualCellHeight),a[0]=Math.min(Math.max(a[0],1),l+(s?1:0)),a[1]=Math.min(Math.max(a[1],1),i),a):null},e.prototype.getRawByteCoords=function(e,t,r,o,n,l){var i=this.getCoords(e,t,r,o,n,l),s=i[0],a=i[1];return{x:s+=32,y:a+=32}},e}();exports.MouseHelper=MouseHelper;

},{}],65:[function(require,module,exports){
require("vm.js");const util=require("util.js");function Assembler_Impl(e){this.vm=e,this.calls=[],this.labels=new Map,this._ip=0}Assembler_Impl.prototype.call_op=function(e,t,r){if("times"==t)for(var s=0;s<r[0];s++)r[1](e,s);else switch(this.calls.push([t].concat(r)),t){case"float32":case"int32":case"uint32":case"addr":this._ip+=VM.CPU.REGISTER_SIZE;break;case"bytes":var n=r[0].length;this._ip+=Math.ceil(n/VM.CPU.INSTRUCTION_SIZE)*VM.CPU.INSTRUCTION_SIZE;break;default:this._ip+=VM.CPU.INSTRUCTION_SIZE}return this},Assembler_Impl.prototype.assemble_to_array=function(){for(var e=[],t=0;t<this.calls.length;t++){var r=this.encode_call_args(this.vm,this.calls[t],t,e.length*VM.CPU.INSTRUCTION_SIZE);e=e.concat(r)}return e},Assembler_Impl.prototype.assemble=function(){for(var e=Uint16Array.from(this.assemble_to_array()),t=new DataView(e.buffer,e.byteOffset),r=0;r<e.length;r++)t.setUint16(2*r,e[r],!0);return new Uint8Array(e.buffer,e.byteOffset)},Assembler_Impl.prototype.encode_call_args=function(e,t,r,s){if("int32"==t[0]||"uint32"==t[0]||"addr"==t[0]){if("string"==typeof t[1]){var n=this.resolve(t[1]);return t[2]&&(n-=s),"function"==typeof t[3]&&(n=t[3](n)),[65535&n,n>>16]}return[65535&t[1],t[1]>>16]}if("float32"==t[0]){var l=new Uint16Array(VM.TYPES.FLOAT.byte_size/VM.TYPES.SHORT.byte_size),i=new DataView(l.buffer);return VM.TYPES.FLOAT.set(i,0,t[1]),Array.from(l)}if("bytes"==t[0]){var o=t[1],a=new Uint16Array(Math.ceil(o.length/VM.CPU.INSTRUCTION_SIZE)),f=new Uint8Array(a.buffer);if("string"==typeof o)for(var p=0;p<o.length;p++)f[p]=o.charCodeAt(p);else for(p=0;p<o.length;p++)f[p]=o[p];return Array.from(a)}var u=VM.CPU.INS[t[0].toUpperCase()],c=VM.CPU.INS_INST[u];if(!c)throw"Unknown op code "+t;var h=this;t=util.map_each_n(t.slice(1),function(e,t){return"string"==typeof e?h.resolve(e)||register_index(e):e});var m=c.encoder_list(t);return VM.CPU.encode(m)},Assembler_Impl.prototype.label=function(e,t){return null==t&&(t=this.ip()),this.labels[e]=t,this},Assembler_Impl.UnknownKeyError=function(e){this.msg="Unknown key",this.label=e},Assembler_Impl.UnknownKeyError.prototype.toString=function(){return this.msg+": "+this.label},Assembler_Impl.prototype.resolve=function(e,t){if(null==this.labels[e])throw new Assembler_Impl.UnknownKeyError(e);return 1==t?this.labels[e]-this.ip():this.labels[e]},Assembler_Impl.prototype.ip=function(){return this._ip};var Assembler_Proxy={get:function(e,t){return"function"==typeof e[t]?function(){var r=e[t].apply(e,arguments);return r==e?this:r}:"labels"==t?e.labels:"calls"==t?e.calls:"_target"==t?e:function(){return e.call_op(this,t,Array.from(arguments)),this}}};function Assembler(e){e||"undefined"==typeof window||(e=window.vm);var t=new Assembler_Impl(e);return new Proxy(t,Assembler_Proxy)}"undefined"!=typeof module&&(module.exports=Assembler);

},{"util.js":77,"vm.js":80}],66:[function(require,module,exports){
const util=require("util.js");function assert(t,e){if("function"==typeof t&&(t=t()),!t)throw e}function assert_eq(t,e,s){"function"==typeof t&&(t=t()),"function"==typeof e&&(e=e()),assert(t==e,s+": '"+t+"' == '"+e+"'")}function assert_equal(t,e,s){"function"==typeof t&&(t=t()),"function"==typeof e&&(e=e()),assert(util.equals(t,e),s+": '"+t+"' equals '"+e+"'")}function assert_not_equal(t,e,s){"function"==typeof t&&(t=t()),"function"==typeof e&&(e=e()),assert(!util.equals(t,e),s+": '"+t+"' not equal to '"+e+"'")}function assert_throws(t,e,s){try{t.call(this),assert(!1,s)}catch(t){e&&assert_equal(t,e,s)}}"undefined"!=typeof module&&(module.exports={assert:assert,eq:assert_eq,equal:assert_equal,not_equal:assert_not_equal,is_thrown:assert_throws});

},{"util.js":77}],67:[function(require,module,exports){
"use strict";const util=require("util.js");function DataStruct(t,e,i){this.fields=new Map,this.num_fields=0,this.endianess=e||!0,this.alignment=i||1;var r=0;for(var s in t){var n=new DataStruct.Field(t[s],s,r);r+=n.byte_size,r=this.align(r),this.fields[n.name]=n,this.fields[s]=n,this.num_fields++}this.byte_size=r}DataStruct.prototype.align=function(t){return Math.ceil(t/this.alignment)*this.alignment},DataStruct.prototype.field_at_offset=function(t){for(var e=0;e<this.num_fields;e++){var i=this.fields[e];if(t>=i.offset&&t<i.offset+i.byte_size)return i}return null},DataStruct.prototype.fields_spanning=function(t,e){for(var i=[],r=0;r<this.num_fields;r++){var s=this.fields[r];if(s.offset>=t&&s.offset<t+e)i.push(s);else if(s.offset>=t+e)break}return i},DataStruct.prototype.allocate=function(t){if(null==t){var e=new ArrayBuffer(this.byte_size);t=new DataView(e)}return this.proxy(t)},DataStruct.prototype.get=function(t,e){return t=new DataView(t.buffer,t.byteOffset+e),this.allocate(t)},DataStruct.prototype[Symbol.iterator]=function*(){for(var t=0;t<this.num_fields;t++)yield this.fields[t].name},DataStruct.Field=function(t,e,i){this.name=t[0],this.id=parseInt(e),"number"==typeof t[1]?(this.elements=t[1],this.type=t[2],this.default_value=t[3],VM.TYPES[this.type.name]!=this.type&&(this.struct=!0)):(this.elements=null,this.type=t[1],this.default_value=t[2]),this.offset=i,this.byte_size=this.type.byte_size*(this.elements||1)},DataStruct.View=function(t,e){this.ds=t,this.dv=e,this._proxies=[]},DataStruct.View.prototype.get_array=function(t){if(t.struct){if(!this._proxies[t.id]){var e=this;this._proxies[t.id]=util.n_times(t.elements,function(i){return t.type.proxy(new DataView(e.dv.buffer,e.dv.byteOffset+t.offset+t.type.byte_size*i))})}return this._proxies[t.id]}return t.type.proxy(this.dv.buffer,this.dv.byteOffset+t.offset,t.elements)},DataStruct.View.prototype.get=function(t){var e=this.ds.fields[t];if(e){if(null!=e.elements)return this.get_array(e);if(null!=e.type)return e.type.get(this.dv,e.offset,this.ds.endianess)}return null},DataStruct.View.prototype.set=function(t,e){var i=this.ds.fields[t];return i.type.set(this.dv,i.offset,e,this.ds.endianess)},DataStruct.View.prototype.read=function(t,e,i){var r=new Uint8Array(this.dv.buffer,this.dv.byteOffset);if(i){var s;for(s=0;s<e&&!(t+s>=r.length);s++)i[s]=r[t+s];return s}return r.subarray(t,t+e)},DataStruct.View.prototype.write=function(t,e){var i,r=new Uint8Array(this.dv.buffer,this.dv.byteOffset);for(i=0;i<e.length&&!(t+i>=r.length);i++)r[t+i]=e[i];return i},DataStruct.View.prototype.update_from=function(t){for(var e of this)t[e]&&this.set(e,t[e]);return this},DataStruct.View.prototype[Symbol.iterator]=function*(){for(var t of this.ds)yield t},DataStruct.View.prototype.to_object=function(){var t={};for(var e of this)t[e]=this.get(e);return t},DataStruct.View.prototype.toString=function(){var t=[];for(var e of this.ds)t.push(e);return"[DataStruct: "+t.join(", ")+"]"},DataStruct.View.Proxy={get:function(t,e){return e==Symbol.iterator||e.match&&null!=e.match(/^(read|write|toString|to_object|update_from)$/g)?function(){var i=t[e].apply(t,arguments);return i===t?this:i}:"view"==e?t:e.match&&null!=e.match(/^(ds|dv)$/g)?t[e]:t.get(e)},set:function(t,e,i){return t.set(e,i),this}},DataStruct.prototype.view=function(t){return new DataStruct.View(this,t)},DataStruct.prototype.proxy=function(t){var e=this.view(t);return new Proxy(e,DataStruct.View.Proxy)},"undefined"!=typeof module&&(module.exports=DataStruct);

},{"util.js":77}],68:[function(require,module,exports){
function Enum(t){if(this._keys=[],t instanceof Array)for(var s=0,e=0;e<t.length;e++)t[e]instanceof Array?(this[s=t[e][1]]=t[e][0],this[t[e][0]]=s):(this[s]=t[e],this[t[e]]=s),this._keys.push(this[s]),s+=1;else for(var e in t)this[e]=t[e],this[t[e]]=e,this._keys.push(this[e])}Enum.prototype.keys=function(){return this._keys},Enum.prototype.values=function(){var t=[];for(var s of this.keys())t.push(this[s]);return t},Enum.prototype[Symbol.iterator]=function*(){for(var t of this._keys)yield t},"undefined"!=typeof module&&(module.exports=Enum);

},{}],69:[function(require,module,exports){
module.exports={Storage:require("key_value/storage"),IDB:require("key_value/indexdb"),IPFS:require("key_value/ipfs"),HTTP:require("key_value/http"),Table:require("key_value/table")};

},{"key_value/http":70,"key_value/indexdb":71,"key_value/ipfs":72,"key_value/storage":73,"key_value/table":74}],70:[function(require,module,exports){
(function (global){
const TextDecoder=require("util/text_decoder"),TextEncoder=require("util/text_encoder");function KV(e){this._fetch=e||global.fetch}KV.prototype.enable=function(e){return e(!1),this},KV.prototype.disable=function(e){return e(!1),this},KV.prototype.unpack_key=function(e){return"string"==typeof e?e:(new TextDecoder).decode(e).replace(/[\x00]+$/,"")},KV.prototype.pack_key=function(e){return"string"==typeof e?(new TextEncoder).encode(e):e},KV.prototype.fetch=function(e,t){return this._fetch.call(global,this.unpack_key(e),t)},KV.prototype.send_request=function(e,t,n){return this.fetch(e,t).then(t=>{t.ok?t.arrayBuffer().then(e=>{n(this.pack_key(t.url),new Uint8Array(e))}):n(e,null)}).catch(t=>{console.log("HTTP exception",t),n(e,null)})},KV.prototype.getValue=function(e,t,n,o){var r={};return t&&(n||(n=""),r.Range="bytes="+t+"-"+n),this.send_request(e,{method:"GET",headers:r},o),this},KV.prototype.setItem=function(e,t,n){return this.send_request(e,{method:"POST"},n),this},KV.prototype.getSize=function(e,t){return this.fetch(e,{method:"HEAD"}).then(e=>{t(this.pack_key(e.url),e.headers["Content-Length"])}).catch(n=>{console.log("HTTP exception",n),t(e,null)}),this},KV.prototype.removeItem=function(e,t){return this.fetch(e,{method:"DELETE"}).then(n=>{t(e,n.ok)}).catch(n=>{console.log("HTTP exception",n),t(e,null)}),this},"undefined"!=typeof module&&(module.exports=KV),"undefined"!=typeof window&&(window.KeyValue||(window.KeyValue={}),window.KeyValue.HTTP=KV);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"util/text_decoder":78,"util/text_encoder":79}],71:[function(require,module,exports){
const VERSION=4;function DBStore(e,t,n){this.db_name=e,this.version=n||VERSION,this.enable(t)}DBStore.prototype.upgrade=function(e){if(this.db.objectStoreNames.contains(this.db_name))e(!1);else{var t=this.db.createObjectStore(this.db_name,{keyPath:"key"});t.onsuccess=(()=>{e(!1)}),t.onerror=(()=>{e(!0)}),t.createIndex("key","key",{unique:!0})}return this},DBStore.prototype.transaction=function(e,t,n){var o=this.db.transaction([this.db_name],e||"readonly");return o.oncomplete=t||(e=>console.log("txn complete",e)),o.onerror=n||(e=>console.log("txn error",e)),o.onabort=n||(e=>console.log("txn abort",e)),o.objectStore(this.db_name)},DBStore.prototype.enable=function(e){if(this.db)e(!1);else{if("undefined"==typeof indexedDB)return e(!0),!1;var t=indexedDB.open(this.db_name,this.version);t.onerror=(t=>{this.db=null,e(!0)}),t.onsuccess=(n=>{this.db=t.result,e(!1)}),t.onupgradeneeded=(n=>{this.db=t.result,this.upgrade(e)})}return this},DBStore.prototype.disable=function(e){return this.db&&(this.db.close(),this.db=null),e(!1),this},DBStore.prototype.getItem=function(e,t){var n=this.transaction("readonly",o=>{t(e,n.result)},n=>{t(e,null)}).get(e);return this},DBStore.prototype.getValue=function(e,t,n,o){return this.getItem(e,(e,r)=>{var i=r?r.value:null;if(i&&(t||n)){var s=Math.min(i.length,n);i=i.slice(t,t+s)}o(e,i)})},DBStore.prototype.getSize=function(e,t){return this.getItem(e,(e,n)=>{t(e,n?n.size:null)})},DBStore.prototype.setItem=function(e,t,n){this.transaction("readwrite",t=>{n(e,!0)},t=>{n(e,null)}).put({key:e,value:t,size:t.length});return this},DBStore.prototype.removeItem=function(e,t){this.transaction("readwrite",()=>{t(e,!0)},()=>{t(e,!1)}).delete(e);return this},"undefined"!=typeof module&&(module.exports=DBStore),"undefined"!=typeof window&&(window.KeyValueDB=DBStore);

},{}],72:[function(require,module,exports){
(function (global){
const TextDecoder=require("util/text_decoder"),TextEncoder=require("util/text_encoder"),more_util=require("more_util");function KV(e,t,n){this.ipfs=e||global.IPFS,this.options={repo:t||"ipfs",pass:n}}KV.prototype.enable=function(e){return this.node?(e(!1),this):(this.node=new this.ipfs(this.options),this.node.once("error",()=>{this.ready=!1,e(!0)}),this.node.once("ready",()=>{this.ready=!0,console.log("IPFS ready"),e(!1)}),this)},KV.prototype.disable=function(e){return null==this.node?(e(!1),this):(this.node.shutdown().then(()=>{this.node=null,this.ready=null,e(!1)}).catch(()=>{this.node=null,this.ready=null,e(!0)}),this)},KV.prototype.unpack_key=function(e){return"string"==typeof e?e:(new TextDecoder).decode(e).replace(/[\x00]+$/,"")},KV.prototype.pad_key=function(e){return"string"==typeof e?(new TextEncoder).encode(e):e},KV.prototype.split_key=function(e){return e.split(":")},KV.prototype.getValue=function(e,t,n,i){var o=this.unpack_key(e),s=this.split_key(o);return"config"==s[0]?i(e,this.options[s[1]]):"key"==s[0]?"list"==s[1]?this.node.key.list().then(t=>{t.length>0?i(e,this.pad_key(t.map(e=>`${e.name}\t${e.id}`).join("\n"))):i(e,null)}):this.node.key.export(s[1],s[2],(t,n)=>{i(e,t?null:this.pad_key(n))}):"publish"==s[0]?this.node.name.resolve(s[1],(t,n)=>{i(e,t?null:this.pad_key(n.path))}):this.node.cat(o,{offset:t,length:n},(t,n)=>{i(e,t?null:n)}),this},KV.prototype.setItem=function(e,t,n){var i=this.unpack_key(e),o=this.split_key(i);"config"==o[0]?(this.options[o[1]]=this.unpack_key(t),n(e,!0)):"key"==o[0]?this.node.key.import(o[1],t,o[2],(t,i)=>{n(e,!0)}):"publish"==o[0]?this.node.name.publish(this.unpack_key(t),{key:o[1]},(t,i)=>{n(e,!(null==t))}):this.node.add(this.ipfs.Buffer.from(t),(t,i)=>{t||!i?n(e,null):n(this.pad_key(i[0].hash),!0)})},KV.prototype.getSize=function(e,t){return this.getValue(e,(e,n)=>{t(e,n?n.length:null)}),this},KV.prototype.removeItem=function(e,t){var n=this.unpack_key(e),i=this.split_key(n);return"config"==i[0]?(delete this.options[i[1]],t(e,null)):"key"==i[0]?this.node.key.rm(i[1],(e,n)=>{t(n,!(null==e))}):t(e,null),this},"undefined"!=typeof module&&(module.exports=KV),"undefined"!=typeof window&&(window.KeyValue||(window.KeyValue={}),window.KeyValue.IPFS=KV);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"more_util":75,"util/text_decoder":78,"util/text_encoder":79}],73:[function(require,module,exports){
const TextEncoder=require("util/text_encoder"),TextDecoder=require("util/text_decoder"),more_util=require("more_util");function KV(t){this.storage=t}KV.prototype.enable=function(t){return t(null==this.storage),this},KV.prototype.disable=function(t){return t(!1),this},KV.prototype.getItem=function(t,e,r){return r(t,this.storage.getItem(this.from_bytes(t)+"/"+e)),this},KV.prototype.getValue=function(t,e,r,o){return this.getItem(t,"value",(t,i)=>{var n=i?this.to_bytes(i):null;if(n&&(e||r)){var s=Math.min(n.length,r);n=n.slice(e,e+s)}o(t,n)})},KV.prototype.getSize=function(t,e){return this.getItem(t,"size",(t,r)=>{e(t,r?parseInt(size):null)})},KV.prototype.setItem=function(t,e,r){var o=this.from_bytes(t);return this.storage.setItem(o+"/value",this.from_bytes(e)),this.storage.setItem(o+"/size",e.length),r(t,!0),this},KV.prototype.removeItem=function(t,e){var r=this.from_bytes(t);return this.storage.removeItem(r+"/value"),this.storage.removeItem(r+"/size"),e(t,!0),this},KV.prototype.to_bytes=function(t){return new Uint8Array(more_util.from_hexdump(t))},KV.prototype.from_bytes=function(t){return more_util.to_hexdump(t)},"undefined"!=typeof module&&(module.exports=KV),"undefined"!=typeof window&&(window.KeyValueDB=KV);

},{"more_util":75,"util/text_decoder":78,"util/text_encoder":79}],74:[function(require,module,exports){
const TextDecoder=require("util/text_decoder"),TextEncoder=require("util/text_encoder");function KV(e){this.data=e||new Object}KV.prototype.enable=function(e){return e(!1),this},KV.prototype.disable=function(e){return e(!1),this},KV.prototype.pack_key=function(e){return"string"==typeof e?e:(new TextDecoder).decode(e).replace(/[\x00]+$/,"")},KV.prototype.unpack_key=function(e){return"string"==typeof e?(new TextEncoder).encode(e):e},KV.prototype.getValue=function(e,t,n,o){var r=this.data[this.pack_key(e)];return r&&(r=r.slice(t,t+n)),o(e,r),this},KV.prototype.setItem=function(e,t,n){return this.data[this.pack_key(e)]=t,n(e,!0),this},KV.prototype.getSize=function(e,t){var n=null,o=this.data[this.pack_key(e)];return o&&(n=o.length),t(e,n),this},KV.prototype.removeItem=function(e,t){return delete this.data[this.pack_key(e)],t(e,!0),this},"undefined"!=typeof module&&(module.exports=KV),"undefined"!=typeof window&&(window.KeyValue||(window.KeyValue={}),window.KeyValue.Table=KV);

},{"util/text_decoder":78,"util/text_encoder":79}],75:[function(require,module,exports){
(function (global){
"use strict";var REQUIRED_SCRIPTS=[];if("undefined"==typeof global){function require(r){REQUIRED_SCRIPTS.push(r)}}function equals(r,e){if(typeof r!=typeof e)return!1;if(null!=r&&"object"==typeof r||null!=e&&"object"==typeof e){if(r instanceof Array&&e instanceof Array){if(r.length!=e.length)return!1;for(var t=0;t<r.length;t++)if(!equals(r[t],e[t]))return!1;return!0}if(r[Symbol.iterator]&&e[Symbol.iterator]){for(var t of r)if(!equals(r[t],e[t]))return!1;for(var t of e)if(!equals(r[t],e[t]))return!1;return!0}if("object"==typeof r&&"object"==typeof e){for(var t in r)if(!equals(r[t],e[t]))return!1;for(var t in e)if(!equals(r[t],e[t]))return!1;return!0}return null==r&&null==e}return r==e}function to_method(r){var e;return"string"==typeof r&&(e=r,r=function(r){return r[e]()}),r}function to_kv_method(r){var e;return"string"==typeof r&&(e=r,r=function(r,t){return t[e]()}),r}function merge_options(r,e){var t={};for(var n in r)t[n]=r[n];for(var n in e)t[n]=e[n];return t}function map_each(r,e){var t={};for(var n in e=to_kv_method(e),r)t[n]=e(n,r[n]);return t}function map_each_n(r,e){var t=[];e=to_kv_method(e);for(var n=0;n<r.length;n++)t[n]=e(r[n],n);return t}function map_each_key(r,e){var t={};for(var n in e=to_kv_method(e),r)t[e(n,r[n])]=r[n];return t}function reject_if(r,e){var t=[];for(var n in e=to_kv_method(e),r)0==e(r[n],n)&&(t[n]=r[n]);return t}function reject_n_if(r,e){var t=[];e=to_kv_method(e);for(var n=0;n<r.length;n++)0==e(r[n],n)&&t.push(r[n]);return t}function remove_value(r,e){var t=r.indexOf(e);return remove_n(r,t)}function remove_n(r,e){return r.splice(0,e-1).concat(r.splice(e+1))}function flatten(r,e){null==e&&(e=[]);for(var t=0;t<r.length;t++)"object"==typeof r[t]?flatten(r[t],e):e.push(r[t]);return e}function flattenDeep(r){return r.reduce((r,e)=>Array.isArray(e)?r.concat(flattenDeep(e)):r.concat(e),[])}function n_times(r,e){var t=new Array(r);e=to_method(e);for(var n=0;n<r;n++)t[n]=e(n);return t}function uniques(r){var e={};for(var t in r)e[r[t]]=r[t];var n=[];for(var t in e)n.push(e[t]);return n}function to_hexdump(r){return flattenDeep(map_each_n(r,function(r,e){return r.toString(16).padStart(2,"0")})).join(" ")}function from_hexdump(r){return r.split(/\s+/).map(r=>parseInt(r,16))}function string_to_hexdump(r){return to_hexdump(r.split("").map(r=>r.charCodeAt(0)))}function string_from_hexdump(r){return from_hexdump(r).reduce((r,e)=>r+=String.fromCharCode(e),"")}const Exports={map_each:map_each,map_each_n:map_each_n,n_times:n_times,equals:equals,merge_options:merge_options,flattenDeep:flattenDeep,to_hexdump:to_hexdump,from_hexdump:from_hexdump,string_to_hexdump:string_to_hexdump,string_from_hexdump:string_from_hexdump};"undefined"!=typeof module&&(module.exports=Exports),"undefined"!=typeof window&&(window.util=Exports);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],76:[function(require,module,exports){
function PagedHash(){this.page_table=new Array(PagedHash.PageCount*PagedHash.PageSize),this.ranges=new Array}function page_count(e,a){return null==a&&(a=PagedHash.PageSize),Math.ceil(e/a)}PagedHash.NotMappedError=function(e){this.msg="Not mapped error: "+e,this.address=e},PagedHash.AlreadyMappedError=function(e){this.msg="Already mapped error: "+e,this.address=e},PagedHash.PageCount=1024,PagedHash.PageSize=4096,PagedHash.Range=function(e,a,t,r){this.id=e,this.addr=a,this.size=t,this.page_count=page_count(t),this.value=r},PagedHash.prototype.add=function(e,a,t){if(this.get(e))throw new PagedHash.AlreadyMappedError(e);var r=new PagedHash.Range(this.ranges.length,e,a,t);return this.ranges.push(r),this.add_page_table_entries(r),this},PagedHash.prototype.remove=function(e){var a=this.get(e);if(!a)throw new PagedHash.NotMappedError(e);return this.remove_page_table_entries(a),delete this.ranges[a.id],this},PagedHash.prototype.get=function(e){return this.page_table[this.page_for_address(e)]},PagedHash.prototype.get_value=function(e){var a=this.get(e);if(a)return a.value;throw new PagedHash.NotMapppedError(e)},PagedHash.prototype.set_value=function(e){this.get(e).value=value},PagedHash.prototype.range_for=function(e){for(var a in this.ranges)if(this.ranges[a].value==e)return this.ranges[a];return null},PagedHash.prototype.add_page_table_entries=function(e){for(var a=this.page_for_address(e.addr),t=0;t<e.page_count;t++)this.page_table[a+t]=e},PagedHash.prototype.remove_page_table_entries=function(e){for(var a=this.page_for_address(e.addr),t=0;t<e.page_count;t++)this.page_table[a+t]=null},PagedHash.prototype.page_for_address=function(e){return Math.floor(e/PagedHash.PageSize)},PagedHash.prototype.map=function(e){return this.ranges.map(e)},"undefined"!=typeof module&&(module.exports=PagedHash);

},{}],77:[function(require,module,exports){
const more_util=require("more_util");module.exports=more_util;

},{"more_util":75}],78:[function(require,module,exports){
(function (global){
const node_util=require("util");function TD(e){}TD.prototype.decode=function(e,o){return String.fromCharCode.apply(null,e)};var TextDecoder=TD;null!=node_util&&node_util.TextDecoder&&(TextDecoder=node_util.TextDecoder),global.TextDecoder&&(TextDecoder=global.TextDecoder),"undefined"!=typeof module&&(module.exports=TextDecoder);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"util":120}],79:[function(require,module,exports){
(function (global){
const node_util=require("util");function TE(e){}TE.prototype.encode=function(e,n){for(var o=new Uint8Array(e.length),t=0;t<e.length;t++)o[t]=e.charCodeAt(t);return o};var TextEncoder=TE;null!=node_util&&node_util.TextEncoder&&(TextEncoder=node_util.TextEncoder),global.TextEncoder&&(TextEncoder=global.TextEncoder),"undefined"!=typeof module&&(module.exports=TextEncoder);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"util":120}],80:[function(require,module,exports){
(function (global){
const util=require("util.js");("undefined"!=typeof window&&!window.VM||"undefined"!=typeof global&&!global.VM)&&(VM={}),require("vm/types.js"),require("vm/cpu.js"),require("vm/vm-doc.js"),require("vm/vm-c.js"),require("vm/container.js"),require("vm/devices.js"),VM.Assembler=require("assembler"),VM.run_tests=function(){for(let e in this)this[e].test_suite&&(console.log("Running tests for "+e),this[e].test_suite())},"undefined"!=typeof module&&(module.exports=VM);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"assembler":65,"util.js":77,"vm/container.js":81,"vm/cpu.js":82,"vm/devices.js":83,"vm/types.js":109,"vm/vm-c.js":110,"vm/vm-doc.js":111}],81:[function(require,module,exports){
(function (global){
"use strict";("undefined"!=typeof window&&!window.VM||"undefined"!=typeof global&&!global.VM)&&(VM={}),require("vm/cpu.js");const Console=require("vm/devices/console"),InterruptHandle=require("vm/interrupt_handle");VM.Container=function(t){this.devices=[],this.cpu=null,this.mem=null,this.mmu=null,this.stopping=!1,this.window=null,this.timer=null,this.cycles=0,this.max_cycles=1e4,this.callbacks=t||{}},VM.Container.prototype.add_device=function(t){return this.devices.push(t),null==this.cpu&&t instanceof VM.CPU&&(this.cpu=t),null==this.mem&&t instanceof VM.MemoryBus&&(this.mem=t),null==this.mmu&&t instanceof VM.MMU&&(this.mmu=t),null==this.devcon&&t instanceof Console&&(this.devcon=t),this.do_callback("add_device",t),this},VM.Container.prototype.remove_device=function(t){return this.devices=remove_value(this.device,t),this.do_callback("remove_device"),this},VM.Container.prototype.each_device=function(t){for(var e=0;e<this.devices.length;e++)t(this.devices[e],e)},VM.Container.prototype.run=function(t,e){this.running=!0,this.do_callback("run"),null==t&&(t=this.max_cycles);var i=this.step_loop(t);return this.schedule(i,t),this},VM.Container.prototype.schedule=function(t,e){if(this.stopping)this.stopping=!1,this.running=!1,this.timer&&clearTimeout(this.timer),this.do_callback("stopped");else if(null==this.timer){var i=this;t?this.debug&&console.log("All asleep."):(this.debug&&console.log("set Timeout."),this.timer=setTimeout(function(){i.timer=null,i.run(e)},1))}else this.debug&&(console.log("Timer exists"),this.debug_dump())},VM.Container.prototype.step_loop=function(t){for(var e=0;e<t;e++){if(this.step()==this.devices.length)return!0}return!1},VM.Container.prototype.stop=function(){return this.stopping=!0,this.do_callback("stopping"),this.each_device(function(t){t.stop&&t.stop()}),this},VM.Container.prototype.reset=function(){return this.each_device(function(t){t.reset&&t.reset()}),this.do_callback("reset"),this},VM.Container.prototype.step=function(){this.cycles++,this.cpu&&this.cpu.halted&&(this.cpu.halted=!1),this.do_callback("step");var t=0;return this.each_device(function(e){null!=e.step&&e.step()||t++}),2==this.debug&&this.debug_dump(),t},VM.Container.prototype.dbstep=function(t){null==t&&(t=1);for(var e=0;e<t&&(this.debug_dump(),1!=this.step());e++);return this.debug_dump(),this},VM.Container.prototype.debug_dump=function(){return this.each_device(function(t){t.debug_dump&&t.debug_dump()}),this},VM.Container.prototype.interrupt=function(t){return this.do_callback("interrupt"),this.cpu&&this.cpu.interrupt(t),this.running&&this.schedule(),this},VM.Container.prototype.interrupt_handle=function(t){return new InterruptHandle(this,t)},VM.Container.prototype.do_callback=function(t,e){null!=this.callbacks&&null!=this.callbacks[t]&&this.callbacks[t](this,e)};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"vm/cpu.js":82,"vm/devices/console":84,"vm/interrupt_handle":103}],82:[function(require,module,exports){
(function (global){
"use strict";("undefined"!=typeof window&&!window.VM||"undefined"!=typeof global&&!global.VM)&&(VM={});const util=require("util.js");require("vm/types.js");const PagedHash=require("paged_hash.js"),RangedHash=require("vm/ranged_hash.js"),DispatchTable=require("vm/dispatch_table.js"),assert=require("asserts.js");VM.CPU=function(e,r,t){this.name="CPU",this.stack_start=r||65536,this.mem=e,this._reg=new Uint32Array(VM.CPU.REGISTER_COUNT),this._reg_view=new DataView(this._reg.buffer),this.cycles=0,this._pending_interrupts=[],this.keep_running=!1,this.halted=!1,this.stepping=!1,this.running=!1,this.max_cycles=t,this.reset()},VM.CPU.STATUS={NONE:0,ZERO:1,NEGATIVE:2,CARRY:4,ERROR:8,INT_ENABLED:16,SLEEP:32,INT_FLAG:64},VM.CPU.STATUS.NUMERICS=VM.CPU.STATUS.ZERO|VM.CPU.STATUS.NEGATIVE|VM.CPU.STATUS.CARRY|VM.CPU.STATUS.ERROR,VM.CPU.REGISTER_SIZE=Uint32Array.BYTES_PER_ELEMENT,VM.CPU.INSTRUCTION_SIZE=Uint16Array.BYTES_PER_ELEMENT,VM.CPU.REGISTER_COUNT=16;for(var REGISTERS={INS:VM.CPU.REGISTER_COUNT-1,STATUS:VM.CPU.REGISTER_COUNT-2,ISR:VM.CPU.REGISTER_COUNT-3,IP:VM.CPU.REGISTER_COUNT-4,SP:VM.CPU.REGISTER_COUNT-5,GP_COUNT:VM.CPU.REGISTER_COUNT-5,CS:VM.CPU.REGISTER_COUNT-6,DS:VM.CPU.REGISTER_COUNT-7,CARRY:1,ACCUM:0},i=0;i<VM.CPU.REGISTER_COUNT;i++)REGISTERS["R"+i]=i;for(var i in VM.CPU.REGISTER_NAMES={},REGISTERS){var number=REGISTERS[i];VM.CPU.REGISTER_NAMES[number]&&(i.match(/^R\d+/)||i.match(/_COUNT/))||(VM.CPU.REGISTER_NAMES[number]=i)}for(var i in VM.CPU.REGISTERS=REGISTERS,VM.CPU.REGISTER_PARAMS=VM.CPU.REGISTERS.STATUS,VM.CPU.INTERRUPTS={reset:0,brk:1,exception:2,unknown_op:3,divide_by_zero:4,mem_fault:5,mem_access:6,memset_done:7,memcpy_done:8,user:9,max:128},VM.CPU.INTERRUPTS){var n=VM.CPU.INTERRUPTS[i];VM.CPU.INTERRUPTS[n]=i}VM.CPU.INTERRUPTS.ISR_BYTE_SIZE=2*VM.CPU.REGISTER_SIZE,VM.CPU.INTERRUPTS.ISR_TOTAL_SIZE=VM.CPU.INTERRUPTS.max*VM.CPU.INTERRUPTS.ISR_BYTE_SIZE;for(i=0;i<256;i++)VM.CPU.INTERRUPTS["irq"+i]=VM.CPU.INTERRUPTS.user+i;function binary_op_type(e,r){var t;return"number"==typeof e?(t=(4&e)>>2,r=1&e||r):(t=e.type,r=e.unsigned||r),1==t?VM.TYPES.FLOAT:r?VM.TYPES.ULONG:VM.TYPES.LONG}function binary_op_inner(e,r,t,s){var S=binary_op_type(r),i=e.regread(REGISTERS.ACCUM,S),a=e.regread(this.un.x(r),S),T=e.regread(this.un.carry_in(r),S);this.un.carry_in(r)==VM.CPU.REGISTERS.STATUS&&(T&=VM.CPU.STATUS.CARRY);var E=t(i,a,T);if(e.regwrite(REGISTERS.ACCUM,E,S),e.clear_status(VM.CPU.STATUS.NUMERICS),s){var n=s(S,E,i,a,T);e.set_status(n)}}function binary_op(e,r){return function(t,s){return binary_op_inner.call(this,t,s,e,r)}}function math_ops(e){return[["CMP"+e,"Compares X and Y and sets the status bits. Zero for when X and Y are equal, Negative if X < Y and they're signed integers, Carry if X < Y for unsigned integers. Both Negative and Carry get set when comparing floats. When X or Y is the INS register, zero is used for that value.",[["x",[3840,8,"Register with the first value."]],["y",[61440,12,"Register with the second value."]],["type",[4,2,"The data type the registers contain."]]],function(e,r){var t=binary_op_type(r),s=0;this.un.x(r)!=VM.CPU.REGISTERS.INS&&(s=e.regread(this.un.x(r),t));var S=0;this.un.y(r)!=VM.CPU.REGISTERS.INS&&(S=e.regread(this.un.y(r),t));var i=e.regread(REGISTERS.STATUS);if(s==S||t==VM.TYPES.FLOAT&&isNaN(s)&&isNaN(S)?i|=VM.CPU.STATUS.ZERO:i&=~VM.CPU.STATUS.ZERO,s<S?(i|=VM.CPU.STATUS.NEGATIVE,t==VM.TYPES.FLOAT&&(i|=VM.CPU.STATUS.CARRY)):(i&=~VM.CPU.STATUS.NEGATIVE,t==VM.TYPES.FLOAT&&(i&=~VM.CPU.STATUS.CARRY)),t==VM.TYPES.ULONG||t==VM.TYPES.LONG){var a=0;this.un.x(r)!=VM.CPU.REGISTERS.INS&&(a=e.regread(this.un.x(r),VM.TYPES.ULONG));var T=0;this.un.y(r)!=VM.CPU.REGISTERS.INS&&(T=e.regread(this.un.y(r),VM.TYPES.ULONG)),a<T?i|=VM.CPU.STATUS.CARRY:i&=~VM.CPU.STATUS.CARRY}else t==VM.TYPES.FLOAT&&(isNaN(s)||isNaN(S)?i|=VM.CPU.STATUS.ERROR:i&=~VM.CPU.STATUS.ERROR);e.regwrite(REGISTERS.STATUS,i)},[function(e,r){r==VM.CPU.INS.CMPI&&(e.regwrite(2,123),e.regwrite(1,123),e.memwritel(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ZERO,"sets the zero status flag"),e.reset(),e.regwrite(2,123),e.regwrite(1,12),e.memwrite(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.CARRY,"sets the carry status flag"),e.reset(),e.regwrite(1,123),e.regwrite(2,12),e.memwrite(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.equal(e.regread(REGISTERS.STATUS)&(VM.CPU.STATUS.CARRY|VM.CPU.STATUS.ZERO),0,"sets no flags"),e.reset(),e.regwrite(1,0),e.memwrite(0,e.encode({op:r,x:1,y:VM.CPU.REGISTERS.INS})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ZERO,"sets zero flag since 0 == 0"),e.reset(),e.regwrite(1,0),e.memwrite(0,e.encode({op:r,x:VM.CPU.REGISTERS.INS,y:1})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ZERO,"sets zero flag since 0 == 0"))},function(e,r){r==VM.CPU.INS.CMPI&&(e.regwrite(2,-123),e.regwrite(1,-123),e.memwritel(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ZERO,"sets the zero status flag"),e.reset(),e.regwrite(1,-123),e.regwrite(2,12),e.memwrite(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.NEGATIVE,"sets the negative status flag"),e.reset(),e.regwrite(1,123),e.regwrite(2,-12),e.memwrite(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.equal(e.regread(REGISTERS.STATUS)&(VM.CPU.STATUS.NEGATIVE|VM.CPU.STATUS.ZERO),0,"sets no status flag"))},function(e,r){r==VM.CPU.INS.CMPF&&(e.regwritef(2,123.45),e.regwritef(1,123.45),e.memwritel(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ZERO,"sets the zero status flag"),e.reset(),e.regwrite(2,123.45),e.regwrite(1,12.45),e.memwrite(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&(VM.CPU.STATUS.NEGATIVE|VM.CPU.STATUS.CARRY),"sets the negative and carry status flags"),e.reset(),e.regwrite(2,12.45),e.regwrite(1,123.45),e.memwrite(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.equal(e.regread(REGISTERS.STATUS),0,"clears the flags"),e.regwritef(2,123.34),e.regwritef(1,123.44),e.memwritel(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.equal(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ZERO,0,"does not set the zero status flag"),e.regwritef(2,123.34),e.regwritef(1,NaN),e.memwritel(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR,"sets the error status flag"),e.regwritef(1,123.34),e.regwritef(2,NaN),e.memwritel(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR,"sets the error status flag"),e.regwritef(1,NaN),e.regwritef(2,NaN),e.memwritel(0,e.encode({op:r,x:1,y:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR,"sets the error status flag"),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ZERO,"sets the zero status flag"))}]],["ADD"+e,"Adds X and Y storing the result in ACCUM.",VM.CPU.INS_MOP_MASK,binary_op(function(e,r,t){return t+e+r},function(e,r,t,s,S){var i=0;if(e!=VM.TYPES.FLOAT){var a=1<<8*VM.CPU.REGISTER_SIZE-1;(0!=(r&a)&&(t&a)==(s&a)||0==(r&a)&&(t&a)!=(s&a))&&(i|=VM.CPU.STATUS.CARRY),(0==(t&a)&&0==(s&a)&&0!=(r&a)||0!=(t&a)&&0!=(s&a)&&0==(r&a))&&(i|=VM.CPU.STATUS.ERROR)}else Math.abs(r)==1/0&&(i|=VM.CPU.STATUS.ERROR);return r<0&&(i|=VM.CPU.STATUS.NEGATIVE),0==r&&(i|=VM.CPU.STATUS.ZERO),i}),[function(e,r){if(r==VM.CPU.INS.ADDI)for(var t=1;t<VM.CPU.REGISTERS.GP_COUNT;t++)e.reset(),e.memwritel(0,e.encode({op:r,x:t,carry_in:VM.CPU.REGISTERS.STATUS})),e.regwrite(t,3),e.regwrite(REGISTERS.ACCUM,2),e.step(),assert.assert(5==e.regread(REGISTERS.ACCUM),"R0 has 2+3 stored in it "+e.regread(REGISTERS.ACCUM)+" "+t),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit"),e.reset(),e.memwritel(0,e.encode({op:r,x:t,carry_in:VM.CPU.REGISTERS.STATUS})),e.regwrite(t,2),e.regwrite(REGISTERS.ACCUM,4294967295),e.step(),assert.assert(1==e.regread(REGISTERS.ACCUM),"R0 is incremented by 2 "+e.regread(REGISTERS.ACCUM)),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.CARRY,"sets the carry bit"),e.reset(),e.memwritel(0,e.encode({op:r,x:t,carry_in:VM.CPU.REGISTERS.STATUS})),e.regwrite(t,-2147483647),e.regwrite(REGISTERS.ACCUM,-2147483647),e.step(),assert.equal(e.regread(REGISTERS.ACCUM,VM.TYPES.LONG),2,"R0 is incremented by -0x7FFFFFFF "+e.regread(REGISTERS.ACCUM,VM.TYPES.LONG).toString(16)),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR,"sets the error bit"),e.reset(),e.memwritel(0,e.encode({op:r,x:t,carry_in:VM.CPU.REGISTERS.STATUS})),e.regwrite(t,4),e.regwrite(REGISTERS.ACCUM,2147483647),e.step(),assert.assert(-2147483645==e.regread(REGISTERS.ACCUM,VM.TYPES.LONG),"R0 is incremented by 4 "+e.regread(REGISTERS.ACCUM,VM.TYPES.LONG)),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR,"sets the error bit")},function(e,r){if(r==VM.CPU.INS.ADDF)for(var t=1;t<VM.CPU.REGISTERS.GP_COUNT;t++)e.reset(),e.memwritel(0,e.encode({op:r,x:t,carry_in:VM.CPU.REGISTERS.STATUS})),e.regwrite(REGISTERS.ACCUM,2.2,VM.TYPE_IDS.FLOAT),e.regwrite(t,3.3,VM.TYPE_IDS.FLOAT),e.step(),assert.assert(5.5==e.regread(REGISTERS.ACCUM,VM.TYPE_IDS.FLOAT),"R0 has 2.2+3.3 stored in it "+e.regreadf(t)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit")}]],["MUL"+e,"Multiplies X and Y storing the result into ACCUM.",VM.CPU.INS_MOP_MASK,binary_op(function(e,r){return e*r},function(e,r,t,s,S){var i=0;return r>e.max?i|=VM.CPU.STATUS.ERROR:r<e.min&&(i=i|VM.CPU.STATUS.ERROR|VM.CPU.STATUS.NEGATIVE),i}),[function(e,r){if(r==VM.CPU.INS.MULI)for(var t=1;t<VM.CPU.REGISTERS.GP_COUNT;t++)e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwrite(REGISTERS.ACCUM,2),e.regwrite(t,3),e.step(),assert.assert(6==e.regread(REGISTERS.ACCUM),"R0 has 2*3 stored in it "+e.regread(REGISTERS.ACCUM)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit"),e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwrite(REGISTERS.ACCUM,2147483648),e.regwrite(t,2),e.step(),assert.assert(0==e.regread(REGISTERS.ACCUM),"R0 is multiplied by 2 and overflown: "+e.regread(REGISTERS.ACCUM)),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR,"sets the error bit")},function(e,r){if(r==VM.CPU.INS.MULF)for(var t=1;t<VM.CPU.REGISTERS.GP_COUNT;t++)e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwritef(REGISTERS.ACCUM,2.2),e.regwritef(t,3.3),e.step(),assert.assert(Math.abs(e.regreadf(REGISTERS.ACCUM)-7.26)<1e-4,"R0 has 2.2*3.3 stored in it"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit"),e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwritef(REGISTERS.ACCUM,VM.TYPES.FLOAT.max),e.regwritef(t,VM.TYPES.FLOAT.max),e.step(),assert.assert(e.regreadf(REGISTERS.ACCUM)==1/0,"R0 is multiplied by itself and overflown to infinity: "+e.regread(REGISTERS.ACCUM)),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR,"sets the error bit")}]],[],["POW"+e,"Exponentiate X by Y.",VM.CPU.INS_MOP_MASK,binary_op(function(e,r){return Math.pow(e,r)},function(e,r,t,s,S){var i=0;return(r>e.max||r<e.min)&&(i|=VM.CPU.STATUS.ERROR),i}),function(e,r){for(var t=binary_op_type(r),s=1;s<VM.CPU.REGISTERS.GP_COUNT;s++)e.reset(),e.memwritel(0,e.encode({op:r,x:s})),e.regwrite(REGISTERS.ACCUM,2,t),e.regwrite(s,3,t),e.step(),assert.assert(8==e.regread(REGISTERS.ACCUM,t),"R0 has 2**3 stored in it "+e.regread(REGISTERS.ACCUM,t)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit"),e.reset(),e.memwritel(0,e.encode({op:r,x:s})),e.regwrite(REGISTERS.ACCUM,134217728,t),e.regwrite(s,2,t),e.step(),t==VM.TYPES.LONG||t==VM.TYPES.ULONG?(assert.assert(e.regread(REGISTERS.ACCUM,t)==Math.pow(134217728,2)%4294967296,"R0 is squared and overflown "+e.regread(REGISTERS.ACCUM,t)),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR,"sets the error bit")):t==VM.TYPES.FLOAT&&assert.assert(e.regread(REGISTERS.ACCUM,t)==Math.pow(134217728,2),"R0 is squared "+e.regread(REGISTERS.ACCUM,t))}],["FFS"+e,"Finds the first one in X.",VM.CPU.INS_MOP_MASK,function(e,r){var t=binary_op_type(r),s=e.regread(this.un.x(r),VM.TYPES.ULONG);if(t==VM.TYPES.FLOAT)e.interrupt(VM.CPU.INTERRUPTS.unknown_op);else if(0==s)e.regwrite(REGISTERS.ACCUM,32,t);else{var S=0;0==(4294901760&s)&&(S+=16,s<<=16),0==(4278190080&s)&&(S+=8,s<<=8),0==(4026531840&s)&&(S+=4,s<<=4),0==(3221225472&s)&&(S+=2,s<<=2),0==(2147483648&s)&&(S+=1),e.regwrite(REGISTERS.ACCUM,S,VM.TYPES.ULONG)}},function(e,r){var t=binary_op_type(r);if(t==VM.TYPES.FLOAT)assert.equal(e._pending_interrupts.length,0,"has a no pending interrupt"),e._pending_interrupts=[],e.keep_running=!0,e.memwritel(0,e.encode({op:r,x:1})),e.memwritel(VM.CPU.REGISTER_SIZE,e.encode({op:VM.CPU.INS.NOP})),e.regwrite(REGISTERS.IP,0),e.regwrite(REGISTERS.SP,16),e.regwrite(REGISTERS.ISR,256),e.enable_interrupts(),e.step(),e.step(),assert.assert(8==e.regread(REGISTERS.SP),"pushed IP: "+e.memreadl(e.regread(REGISTERS.SP))),assert.assert(e.regread(REGISTERS.IP)==256+VM.CPU.INTERRUPTS.unknown_op*VM.CPU.INTERRUPTS.ISR_BYTE_SIZE,"sets IP to 0x100 + 12*ISR_BYTE_SIZE: "+e.regread(REGISTERS.IP).toString(16));else for(var s=1;s<VM.CPU.REGISTERS.GP_COUNT;s++)e.reset(),e.memwritel(0,e.encode({op:r,x:s})),e.regwrite(REGISTERS.ACCUM,2,t),e.regwrite(s,0,t),e.step(),assert.assert(32==e.regread(REGISTERS.ACCUM,t),"R0 has number of leading zeros in 0 "+e.regread(REGISTERS.ACCUM,t)),e.reset(),e.memwritel(0,e.encode({op:r,x:s})),e.regwrite(REGISTERS.ACCUM,2,t),e.regwrite(s,3,t),e.step(),assert.assert(30==e.regread(REGISTERS.ACCUM,t),"R0 has number of leading zeros in 0x3 "+e.regread(REGISTERS.ACCUM,t)),e.reset(),e.memwritel(0,e.encode({op:r,x:s})),e.regwrite(REGISTERS.ACCUM,2,t),e.regwrite(s,134217728,t),e.step(),assert.assert(4==e.regread(REGISTERS.ACCUM,t),"R0 has the number of leading zeros in 0x80000000 "+e.regread(REGISTERS.ACCUM,t)),e.reset(),e.memwritel(0,e.encode({op:r,x:s})),e.regwrite(REGISTERS.ACCUM,2,t),e.regwrite(s,4294967295,t),e.step(),assert.assert(0==e.regread(REGISTERS.ACCUM,t),"R0 has the number of leading zeros in 0xFFFFFFFF "+e.regread(REGISTERS.ACCUM,t))}],["CEIL","Round Y up to the nearest integer and store it in X.",[["src",[3840,8]],["dest",[61440,12]]],function(e,r){e.regwrite(this.un.dest(r),Math.ceil(e.regread(this.un.src(r),VM.TYPES.FLOAT)),VM.TYPES.FLOAT)},function(e,r){e.memwritel(0,e.encode({op:r,src:1,dest:2})),e.regwrite(1,1234.56,VM.TYPES.FLOAT),e.regwrite(2,128),e.step(),assert.equal(e.regread(2,VM.TYPES.FLOAT),1235,"has no decimal"),e.regwrite(REGISTERS.IP,0),e.regwrite(1,-1234.56,VM.TYPES.FLOAT),e.regwrite(2,128),e.step(),assert.equal(e.regread(2,VM.TYPES.FLOAT),-1234,"has no decimal")}],["ROUND","Round Y to the nearest integer and store it in X.",[["src",[3840,8]],["dest",[61440,12]]],function(e,r){e.regwrite(this.un.dest(r),Math.round(e.regread(this.un.src(r),VM.TYPES.FLOAT)),VM.TYPES.FLOAT)},function(e,r){e.memwritel(0,e.encode({op:r,src:1,dest:2})),e.regwrite(1,1234.56,VM.TYPES.FLOAT),e.regwrite(2,128),e.step(),assert.equal(e.regread(2,VM.TYPES.FLOAT),1235,"rounds up"),e.regwrite(REGISTERS.IP,0),e.regwrite(1,-1234.56,VM.TYPES.FLOAT),e.regwrite(2,128),e.step(),assert.equal(e.regread(2,VM.TYPES.FLOAT),-1235,"rounds negatives down"),e.regwrite(REGISTERS.IP,0),e.regwrite(1,-1234.36,VM.TYPES.FLOAT),e.regwrite(2,128),e.step(),assert.equal(e.regread(2,VM.TYPES.FLOAT),-1234,"rounds down")}],["MOD"+e,"Take the modulus of X by Y.",VM.CPU.INS_MOP_MASK,function(e,r){var t=e.regread(this.un.x(r)),s=binary_op_type(r);t>0||s==VM.TYPES.FLOAT?(binary_op_inner.call(this,e,r,function(e,r){return e%r}),e.clear_status(VM.CPU.STATUS.ERROR)):e.set_status(VM.CPU.STATUS.ERROR)},[function(e,r){if(r==VM.CPU.INS.MODI)for(var t=1;t<VM.CPU.REGISTERS.GP_COUNT;t++)e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwrite(REGISTERS.ACCUM,16),e.regwrite(t,3),e.step(),assert.assert(1==e.regread(REGISTERS.ACCUM),"R0 has 10%3 stored in it "+e.regread(REGISTERS.ACCUM)),e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwrite(REGISTERS.ACCUM,32768),e.regwrite(t,0),e.step(),assert.equal(e.regread(REGISTERS.ACCUM),32768,"left R0 untouched"),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR,"sets the error bit")},function(e,r){if(r==VM.CPU.INS.MODU)for(var t=1;t<VM.CPU.REGISTERS.GP_COUNT;t++)e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwrite(REGISTERS.ACCUM,16),e.regwrite(t,3),e.step(),assert.assert(1==e.regread(REGISTERS.ACCUM),"R0 has 10%3 stored in it "+e.regread(REGISTERS.ACCUM)),e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwrite(REGISTERS.ACCUM,32768),e.regwrite(t,0),e.step(),assert.equal(e.regread(REGISTERS.ACCUM),32768,"left R0 untouched"),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR,"sets the error bit"),e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwrite(REGISTERS.ACCUM,65535),e.regwrite(t,4),e.step(),assert.equal(e.regread(REGISTERS.ACCUM),3,"stores 0xFFFF % 0x4 into R0"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit")},function(e,r){if(r==VM.CPU.INS.MODF)for(var t=1;t<VM.CPU.REGISTERS.GP_COUNT;t++)e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwritef(REGISTERS.ACCUM,123.45),e.regwritef(t,3.3),e.step(),assert.assert(Math.abs(e.regreadf(REGISTERS.ACCUM)-123.45%3.3)<1e-4,"R0 has 123.45 % 3.3 stored in it "+e.regreadf(REGISTERS.ACCUM)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit")}]],["SUB"+e,"Subtract X and Y storing the result into ACCUM.",VM.CPU.INS_MOP_MASK,binary_op(function(e,r){return e-r},function(e,r,t,s,S){var i=0;if(e!=VM.TYPES.FLOAT){(r>e.max||r<e.min)&&(i|=VM.CPU.STATUS.CARRY);var a=1<<8*VM.CPU.REGISTER_SIZE-1;(0==(t&a)&&0!=(s&a)&&0!=(r&a)||0!=(t&a)&&0==(s&a)&&0==(r&a))&&(i|=VM.CPU.STATUS.ERROR)}return r<0&&(i|=VM.CPU.STATUS.NEGATIVE),0==r&&(i|=VM.CPU.STATUS.ZERO),i}),function(e,r){for(var t=1;t<VM.CPU.REGISTERS.GP_COUNT;t++)e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwrite(REGISTERS.ACCUM,5),e.regwrite(t,3),e.step(),assert.assert(2==e.regread(REGISTERS.ACCUM),"R0 has 5-3 stored in it "+e.regread(REGISTERS.ACCUM)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.NEGATIVE),"clears the negative bit"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ZERO),"clears the zero bit"),e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwrite(REGISTERS.ACCUM,2),e.regwrite(t,5),e.step(),assert.assert(toString(e.regread(REGISTERS.ACCUM))==toString(4294967277),"R0 is 2 - 5 "+e.regread(REGISTERS.ACCUM)),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.NEGATIVE,"sets the negative bit"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ZERO),"clears the zero bit"),e.reset(),e.regwrite(REGISTERS.IP,16),e.memwritel(16,e.encode({op:r,x:t})),e.regwrite(REGISTERS.ACCUM,5),e.regwrite(t,5),e.step(),assert.assert(0==e.regread(REGISTERS.ACCUM),"R0 is 0 "+e.regread(REGISTERS.ACCUM)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.NEGATIVE),"clears the negative bit"),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ZERO,"sets the zero bit")}],["DIV"+e,"Divide X by Y storing the result into ACCUM.",VM.CPU.INS_MOP_MASK,function(e,r){var t=e.regread(this.un.x(r)),s=binary_op_type(r);0!=t||s==VM.TYPES.FLOAT?(binary_op_inner.call(this,e,r,function(e,r){return e/r}),e.clear_status(VM.CPU.STATUS.ERROR)):e.set_status(VM.CPU.STATUS.ERROR)},function(e,r){for(var t=binary_op_type(r),s=1;s<VM.CPU.REGISTERS.GP_COUNT;s++){e.reset(),e.memwritel(0,e.encode({op:r,x:s})),e.regwrite(REGISTERS.ACCUM,10,t),e.regwrite(s,4,t),e.step();var S=2.5;t!=VM.TYPES.FLOAT&&(S=2),assert.assert(e.regread(REGISTERS.ACCUM,t)==S,"R0 has int(10/4) stored in it "+e.regread(REGISTERS.ACCUM,t)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit"),t!=VM.TYPES.FLOAT?(e.reset(),e.memwritel(0,e.encode({op:r,x:s})),e.regwrite(REGISTERS.ACCUM,32768,t),e.regwrite(s,0,t),e.step(),assert.assert(32768==e.regread(REGISTERS.ACCUM,t),"left R0 untouched"),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"sets the error bit")):t==VM.TYPES.ULONG?(e.reset(),e.memwritel(0,e.encode({op:r,x:s})),e.regwrite(REGISTERS.ACCUM,61440,t),e.regwrite(s,4,t),e.step(),assert.assert(15360==e.regread(REGISTERS.ACCUM,t),"can divide unsigned numbers")):t==VM.TYPES.FLOAT&&(e.reset(),e.memwritel(0,e.encode({op:r,x:s})),e.regwrite(REGISTERS.ACCUM,-10,t),e.regwrite(s,2,t),e.step(),assert.assert(-5==e.regread(REGISTERS.ACCUM,t),"can divide negative numbers"))}}],["CONV"+e,"Convert between floats and integers.",[["reg",[3840,8]],["type_out",[61440,12]],["type",[4,2]]],function(e,r){var t=VM.TYPES[this.un.type_out(r)],s=binary_op_type(r),S=e.regread(this.un.reg(r),s),i=0;S>t.max?i|=VM.CPU.STATUS.ERROR:S<t.min?i=i|VM.CPU.STATUS.ERROR|VM.CPU.STATUS.NEGATIVE:e.regwrite(this.un.reg(r),S,t),e.set_status(i)},[function(e,r){r==VM.CPU.INS.CONVI&&(e.reset(),e.memwritel(0,e.encode({op:r,reg:1,type_out:VM.TYPE_IDS.FLOAT})),e.regwrite(1,-1234),e.step(),assert.not_equal(e.regread(1,VM.TYPES.ULONG),-1234,"no longer a long"),assert.equal(e.regread(1,VM.TYPES.FLOAT),-1234,"converts to a float"))},function(e,r){r==VM.CPU.INS.CONVU&&(e.memwritel(0,e.encode({op:r,reg:1,type_out:VM.TYPE_IDS.FLOAT})),e.regwrite(1,1234),e.step(),assert.not_equal(e.regread(1,VM.TYPES.ULONG),1234,"no longer a ulong"),assert.equal(e.regread(1,VM.TYPES.FLOAT),1234,"converts to a float"))},function(e,r){r==VM.CPU.INS.CONVF&&(e.memwriteS(0,e.encode({op:r,reg:1,type_out:VM.TYPE_IDS.LONG,unsigned:0})),e.regwritef(1,-1234.45),e.step(),assert.not_equal(e.regread(1,VM.TYPES.FLOAT),-1234.45,"no longer a float"),assert.equal(e.regread(1,VM.TYPES.LONG),-1234,"no longer a float"),e.reset(),e.memwriteS(0,e.encode({op:r,reg:1,type_out:VM.TYPE_IDS.ULONG,unsigned:1})),e.regwritef(1,-1234.45),e.step(),assert.assert(Math.abs(e.regread(1,VM.TYPES.FLOAT)- -1234.45)<.001,"stays the same"),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"sets the error bit"))}]],["ROOT"+e,"Take the X root of Y and store it in DEST.",VM.CPU.INS_MOP_MASK,binary_op(function(e,r){return Math.pow(e,1/r)}),function(e,r){for(var t=binary_op_type(r),s=1;s<VM.CPU.REGISTERS.GP_COUNT;s++)e.reset(),e.memwritel(0,e.encode({op:r,x:s,type:t.id})),e.regwrite(REGISTERS.ACCUM,27,t),e.regwrite(s,3,t),e.step(),assert.assert(3==e.regread(REGISTERS.ACCUM,t),"R0 has 27**(1/3) stored in it "+e.regread(REGISTERS.ACCUM,t)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit")}],["LOG"+e,"Take the base 2 logarithm of X.",VM.CPU.INS_MOP_MASK,binary_op(function(e,r){return Math.log2(r)}),[function(e,r){if(r==VM.CPU.INS.LOGI)for(var t=1;t<VM.CPU.REGISTERS.GP_COUNT;t++)e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwrite(t,123),e.step(),assert.assert(e.regread(REGISTERS.ACCUM)==Math.floor(Math.log2(123)),"R0 has Math.log2(123) stored in it "+e.regread(REGISTERS.ACCUM)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit")},function(e,r){if(r==VM.CPU.INS.LOGF)for(var t=1;t<VM.CPU.REGISTERS.GP_COUNT;t++)e.reset(),e.memwritel(0,e.encode({op:r,x:t})),e.regwritef(t,123.45),e.step(),assert.assert(Math.abs(e.regreadf(0)-Math.log2(123.45))<.001,"R0 has Math.log2(123.45) stored in it "+e.regreadf(0)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit")}]],["FLOOR","Round Y down to the nearest integer and store it in X.",[["src",[3840,8]],["dest",[61440,12]]],function(e,r){e.regwrite(this.un.dest(r),Math.floor(e.regread(this.un.src(r),VM.TYPES.FLOAT)),VM.TYPES.FLOAT)},function(e,r){e.memwritel(0,e.encode({op:r,src:1,dest:2})),e.regwrite(1,1234.56,VM.TYPES.FLOAT),e.regwrite(2,128),e.step(),assert.equal(e.regread(2,VM.TYPES.FLOAT),1234,"has no decimal"),e.regwrite(REGISTERS.IP,0),e.regwrite(1,-1234.56,VM.TYPES.FLOAT),e.regwrite(2,128),e.step(),assert.equal(e.regread(2,VM.TYPES.FLOAT),-1235,"has no decimal")}],[],[]]}function add_ins_to_tables(e,r,t){var s=VM.CPU.INS_INST[e];if(!s){var S={},i=!1;util.map_each_n(t,function(e){S[e.name]=e}),util.map_each(r[2],function(e,r){if("data"==e||"data"==r[0])if("number"==typeof r[1])i=VM.TYPES[r[1]];else{if(!(r[1]instanceof VM.Type))throw"Unknown type: "+r[1];i=r[1]}else S[e]=r}),(s=VM.CPU.INS_INST[VM.CPU.INS[r[0]]])||(s=new VM.CPU.Instruction(e,r[0],r[1],S,i,r[3],r[4])),VM.CPU.INS_INST[e]=s}return VM.CPU.INS[r[0]]||(VM.CPU.INS[r[0]]=e),s}function build_ins_tables(e,r,t,s,S,i){S||(S=0),s||(s=0),t||(t=15),i||(i=[]);var a=new DispatchTable(t,s);a.arg_mask=new VM.CPU.ArgMask(r,t,s);for(var T=0;T<e.length;T++){var E=e[T];if(null!=E){var n=S|T<<s;if(null!=E.mask&&null!=E.ops){var R=build_ins_tables(E.ops,E.name,E.mask,E.shift,n,i.concat([a.arg_mask]));a.set(T,R)}else if("string"!=typeof E[0]||"function"!=typeof E[3]&&null!=E[3]){if(E.length>0&&E.constructor==Array){R=build_ins_tables(E,"highop",15<<s+4,s+4,n,i.concat([a.arg_mask]));a.set(T,R)}}else{var I=add_ins_to_tables(n,E,i.concat([a.arg_mask]));a.set(T,I)}}}return a}function register_index(e){if("number"==typeof e)return e;var r=VM.CPU.REGISTERS[e.toUpperCase()];if(null==r)throw VM.InvalidRegisterError;return r}function vm_run_dispatch_table_tests(e,r,t){var s=0,S=e.mask>>e.shift;t||(t=0);for(var i=0;i<=S;i++){var a=i<<e.shift|t;if(e.has(a)){var T=e.get(a);if(T.run_tests)s+=T.run_tests(r,a);else if(T.get){s+=vm_run_dispatch_table_tests(T,r,a)}}}return s}VM.CPU.INS_BITOP_MASK=[["x",[3840,8,"Register with the value to use to operate on ACCUM."]],["carry_in",[61440,12,"Register with the value's carry in."]]],VM.CPU.INS_MOP_MASK=[["x",[3840,8,"Register with the value."]],["carry_in",[61440,12,"Register with the value's carry in."]],["type",[4,2,"Flags if the values are integers or floats."]],["unsigned",[1,0,"Flags if the values are signed or unsigned integers."]]],VM.CPU.INS_DEFS=[[["NOP","Nothing operation does nothing.",[["comment",[65280,8]]],function(e,r){},function(e,r){e.memwrite(0,[VM.CPU.INS.NOP,0,0,0]),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.IP)==VM.CPU.INSTRUCTION_SIZE,"ip advances")}],["NOT","Store the negated bits of Y into X.",[["x",[3840,8]],["y",[61440,12]]],function(e,r){e.regwrite(this.un.x(r),~e.regread(this.un.y(r)))},function(e,r){e.memwrite(0,[VM.CPU.INS.NOT,1,0,0]),e.regwrite(REGISTERS.ACCUM,4042322160),e.regwrite(1,128),e.step(),assert.assert(252645135==e.regread(1),"R1 is negated R0: "+e.regread(1))}],["OR","Place a bitwise inclusive disjunction of X and Y into DEST.",VM.CPU.INS_BITOP_MASK,function(e,r){e.regwrite(REGISTERS.ACCUM,e.regread(REGISTERS.ACCUM)|e.regread(this.un.x(r)))},function(e,r){e.memwritel(0,e.encode({op:VM.CPU.INS.OR,x:1})),e.regwrite(REGISTERS.ACCUM,4042322160),e.regwrite(1,15),e.step(),assert.assert(4042322175==e.regread(REGISTERS.ACCUM),"R0 is R0 OR R1: "+e.regread(REGISTERS.ACCUM))}],["XOR","Place a bitwise exclusive disjunction of X and Y into DEST.",VM.CPU.INS_BITOP_MASK,function(e,r){e.regwrite(REGISTERS.ACCUM,e.regread(REGISTERS.ACCUM)^e.regread(this.un.x(r)))},function(e,r){e.memwritel(0,e.encode({op:VM.CPU.INS.XOR,x:1})),e.regwrite(REGISTERS.ACCUM,4042322160),e.regwrite(1,255),e.step(),assert.assert(4042321935==e.regread(REGISTERS.ACCUM),"R0 is R0 XOR R1: "+e.regread(REGISTERS.ACCUM))}],["AND","Place a bitwise conjunction of X and Y into DEST.",VM.CPU.INS_BITOP_MASK,function(e,r){var t=e.regread(REGISTERS.ACCUM)&e.regread(this.un.x(r));e.regwrite(REGISTERS.ACCUM,t);var s=0;0==t&&(s|=VM.CPU.STATUS.ZERO),t<0&&(s|=VM.CPU.STATUS.NEGATIVE),e.set_status(s)},function(e,r){e.memwritel(0,e.encode({op:VM.CPU.INS.AND,x:1})),e.regwrite(REGISTERS.ACCUM,4042322160),e.regwrite(1,255),e.step(),assert.assert(240==e.regread(REGISTERS.ACCUM),"R0 is R0 AND R1: "+e.regread(REGISTERS.ACCUM)),e.reset(),e.memwritel(0,e.encode({op:VM.CPU.INS.AND,x:1})),e.regwrite(REGISTERS.ACCUM,4042321920),e.regwrite(1,255),e.step(),assert.assert(0==e.regread(REGISTERS.ACCUM),"R0 is R0 AND R1: "+e.regread(REGISTERS.ACCUM)),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ZERO),"updates the status bits")}],["BSL","Shift the bits in ACCUM left by X.",VM.CPU.INS_BITOP_MASK,function(e,r){var t=e.regread(this.un.x(r));if(t>0){var s=e.regread(REGISTERS.ACCUM),S=s<<t;this.un.carry_in(r)!=VM.CPU.REGISTERS.STATUS&&(S|=e.regread(this.un.carry_in(r))>>32-t),2147483648&s&&e.set_status(VM.CPU.STATUS.CARRY),e.regwrite(REGISTERS.ACCUM,4294967295&S),e.regwrite(REGISTERS.CARRY,s>>32-t&4294967295)}},function(e,r){e.memwritel(0,e.encode({op:VM.CPU.INS.BSL,x:1,carry_in:VM.CPU.REGISTERS.STATUS})),e.regwrite(REGISTERS.ACCUM,2184468088),e.regwrite(1,8),e.step(),assert.assert(878082048==e.regread(REGISTERS.ACCUM),"R0 is R0 << R1: "+e.regread(REGISTERS.ACCUM)),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.CARRY,"sets the carry flag"),e.reset(),e.memwritel(0,e.encode({op:VM.CPU.INS.BSL,x:1,carry_in:VM.CPU.REGISTERS.STATUS})),e.regwrite(REGISTERS.ACCUM,3430008),e.regwrite(1,8),e.step(),assert.assert(878082048==e.regread(REGISTERS.ACCUM),"R0 is R0 << R1: "+e.regread(REGISTERS.ACCUM)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.CARRY),"does not set the carry bit"),e.reset(),e.memwritel(0,e.encode({op:VM.CPU.INS.BSL,x:1,carry_in:2})),e.regwrite(REGISTERS.ACCUM,305419896),e.regwrite(1,8),e.regwrite(2,602992880),e.step(),assert.equal(e.regread(REGISTERS.CARRY),18,"R1 has the bits shifted off"),assert.equal(e.regread(REGISTERS.ACCUM),878082083,"R0 is R0 << R1 "+e.regread(REGISTERS.ACCUM).toString(16)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.CARRY),"does not set the carry bit")}],[],["INT","Cause an interrupt.",[["x",[65280,8]]],function(e,r){e.interrupt(this.un.x(r))},function(e,r){assert.equal(e._pending_interrupts.length,0,"has no pending interrupts"),e._pending_interrupts=[],e.keep_running=!0,e.memwritel(0,e.encode({op:VM.CPU.INS.INT,x:12})),e.memwritel(VM.CPU.REGISTER_SIZE,e.encode({op:VM.CPU.INS.NOP})),e.regwrite(REGISTERS.IP,0),e.regwrite(REGISTERS.SP,16),e.regwrite(REGISTERS.ISR,256),e.step(),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"has yet to set the INT_ENABLED status flag"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_FLAG),"has yet to set the INT_FLAG status flag"),assert.assert(4!=e.memreadl(e.regread(REGISTERS.SP)),"has yet to push IP"),assert.assert(e.regread(REGISTERS.IP)==VM.CPU.INSTRUCTION_SIZE,"has yet to change IP"),e.step(),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"interrupts disabled"),assert.equal(e._pending_interrupts.length,0,"is not pending"),assert.assert(16==e.regread(REGISTERS.SP),"did not push IP: "+e.memreadl(e.regread(REGISTERS.SP))),e.enable_interrupts(),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"interrupts enabled"),assert.equal(e._pending_interrupts.length,1,"is pending"),e.step(),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"disables interrupts"),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_FLAG),"sets interrupt flag"),assert.assert(8==e.regread(REGISTERS.SP),"pushed IP: "+e.memreadl(e.regread(REGISTERS.SP))),assert.assert(e.regread(REGISTERS.IP)==256+12*VM.CPU.INTERRUPTS.ISR_BYTE_SIZE,"sets IP to 0x100 + 12*ISR_BYTE_SIZE: "+e.regread(REGISTERS.IP).toString(16)),assert.equal(e._pending_interrupts.length,0,"is no longer pending")}],["HALT","Halts the CPU.",[],function(e,r){return e.halted=!0,!0},function(e,r){e.memwritel(0,e.encode({op:r})),assert.equal(e.step(),!1,"causes step to return false")}],["NEG","Convert REG's value to a negative and store it in ACCUM taking TYPE into account.",{reg:[3840,8],type:[61440,12]},function(e,r){e.regwrite(VM.CPU.REGISTERS.ACCUM,-e.regread(this.un.reg(r),this.un.type(r)),this.un.type(r))},[function(e,r){e.memwritel(0,e.encode({op:r,reg:3,type:0})),e.regwrite(3,4042322160),e.regwrite(0,128),e.step(),assert.assert(252645136==e.regread(REGISTERS.ACCUM),"ACCUM is negative R3: "+e.regread(REGISTERS.ACCUM).toString(16))},function(e,r){e.memwritel(0,e.encode({op:r,type:VM.TYPE_IDS.FLOAT,reg:2})),e.regwritef(2,123.45),e.regwrite(0,128),e.step(),assert.assert(Math.abs(e.regreadf(REGISTERS.ACCUM)+123.45)<.001,"ACCUM is negative R3: "+e.regreadf(REGISTERS.ACCUM))}]],[],[],["RTI","Pop STATUS and IP returning from an interrupt.",{},function(e,r){var t=0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.SLEEP);e.pop(REGISTERS.STATUS);var s=0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.SLEEP);return!t&&s&&e.clear_status(VM.CPU.STATUS.SLEEP),e.pop(REGISTERS.IP),t},[function(e,r){e.memwritel(0,e.encode({op:r})),e.regwrite(REGISTERS.SP,256),e.push_value(48),e.push_value(VM.CPU.STATUS.NEGATIVE),e.step(),assert.equal(e.regread(REGISTERS.SP),256,"popped values from the stack"),assert.equal(e.regread(REGISTERS.STATUS),VM.CPU.STATUS.NEGATIVE,"sets STATUS to the first value on the stack"),assert.equal(e.regread(REGISTERS.IP),48,"sets IP to second value on the stack"),e.set_status(VM.CPU.STATUS.SLEEP),e.regwrite(REGISTERS.IP,0),e.push_value(48),e.push_value(VM.CPU.STATUS.NEGATIVE|VM.CPU.STATUS.SLEEP),e.step(),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.SLEEP,"stays sleeping")},function(e,r){e.clear_status(VM.CPU.STATUS.INT_ENABLED),e.set_status(VM.CPU.STATUS.SLEEP|VM.CPU.STATUS.INT_FLAG),e.memwritel(0,e.encode({op:VM.CPU.INS.LOAD,dest:VM.CPU.REGISTERS.R0})),e.memwriteL(VM.CPU.INSTRUCTION_SIZE,0),e.memwriteL(VM.CPU.INSTRUCTION_SIZE+VM.TYPES.ULONG.byte_size,e.encode({op:VM.CPU.INS.MOVE,src:VM.CPU.REGISTERS.R0,dest:VM.CPU.REGISTERS.STATUS})),e.memwritel(2*VM.CPU.INSTRUCTION_SIZE+VM.TYPES.ULONG.byte_size,e.encode({op:r})),e.regwrite(REGISTERS.SP,256),e.push_value(48),e.push_value(VM.CPU.STATUS.NEGATIVE|VM.CPU.STATUS.INT_ENABLED),e.step(),e.step(),e.step(),assert.equal(e.regread(REGISTERS.SP),256,"popped values from the stack"),assert.equal(e.regread(REGISTERS.IP),48,"sets IP to second value on the stack"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.SLEEEP),"keeps sleep bit clear"),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.NEGATIVE),"kept other bits"),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"kept other bits"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_FLAG),"clears interrupt flag")}]],["BSR","Shift the bits in ACCUM right by X.",VM.CPU.INS_BITOP_MASK,function(e,r){var t=e.regread(this.un.x(r));if(t>0){var s=e.regread(REGISTERS.ACCUM),S=s>>>t;this.un.carry_in(r)!=VM.CPU.REGISTERS.STATUS&&(S|=(e.regread(this.un.carry_in(r))&(1<<t)-1)<<32-t),e.regwrite(REGISTERS.ACCUM,4294967295&S),e.regwrite(REGISTERS.CARRY,s&(1<<t)-1)}},function(e){e.memwritel(0,e.encode({op:VM.CPU.INS.BSR,x:1,carry_in:VM.CPU.REGISTERS.STATUS})),e.regwrite(REGISTERS.ACCUM,305419896),e.regwrite(1,8),e.step(),assert.assert(1193046==e.regread(REGISTERS.ACCUM),"R0 is R0 >> R1: "+e.regread(REGISTERS.ACCUM)),assert.equal(e.regread(REGISTERS.CARRY),120,"carries out the bits"),e.reset(),e.memwritel(0,e.encode({op:VM.CPU.INS.BSR,x:1,carry_in:2})),e.regwrite(REGISTERS.ACCUM,305419896),e.regwrite(1,8),e.regwrite(2,16702650),e.step(),assert.assert(3121755222==e.regread(REGISTERS.ACCUM),"R0 is R0 >> R1: "+e.regread(REGISTERS.ACCUM).toString(16)),assert.equal(e.regread(REGISTERS.CARRY),120,"carries out the bits")}],["CLS","Clear the status register's compare bits.",[["bits",[65280,8]]],function(e,r){e.clear_status(this.un.bits(r))},function(e,r){e.set_status(VM.CPU.STATUS.CARRY|VM.CPU.STATUS.NEGATIVE),e.memwritel(0,e.encode({op:r,bits:VM.CPU.STATUS.CARRY})),e.step(),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.CARRY),"clears the bit"),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.NEGATIVE),"leaves the bit"),e.reset(),e.set_status(VM.CPU.STATUS.INT_ENABLED|VM.CPU.STATUS.SLEEP),e.memwritel(0,e.encode({op:r,bits:VM.CPU.STATUS.SLEEP})),e.step(),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.SLEEP),"clears the sleep bit")}],["INTR","Cause an interrupt with the register providing the interrupt number.",[["x",[3840,8]]],function(e,r){e.interrupt(e.regread(this.un.x(r)))},function(e,r){assert.equal(e._pending_interrupts.length,0,"has no pending interrupts"),e._pending_interrupts=[],e.keep_running=!0,e.memwritel(0,e.encode({op:VM.CPU.INS.INTR,x:3})),e.memwritel(VM.CPU.REGISTER_SIZE,e.encode({op:VM.CPU.INS.NOP})),e.regwrite(3,12),e.regwrite(REGISTERS.IP,0),e.regwrite(REGISTERS.SP,16),e.regwrite(REGISTERS.ISR,256),e.step(),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"has yet to set the INT_ENABLED status flag"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_FLAG),"has yet to set the INT_FLAG status flag"),assert.assert(4!=e.memreadl(e.regread(REGISTERS.SP)),"has yet to push IP"),assert.assert(e.regread(REGISTERS.IP)==VM.CPU.INSTRUCTION_SIZE,"has yet to change IP"),e.step(),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"interrupts disabled"),assert.equal(e._pending_interrupts.length,0,"is not pending"),assert.assert(16==e.regread(REGISTERS.SP),"did not push IP: "+e.memreadl(e.regread(REGISTERS.SP))),e.enable_interrupts(),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"interrupts enabled"),assert.equal(e._pending_interrupts.length,1,"is pending"),e.step(),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"disables interrupts"),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_FLAG),"sets the interrupt flag"),assert.assert(8==e.regread(REGISTERS.SP),"pushed IP: "+e.memreadl(e.regread(REGISTERS.SP))),assert.assert(e.regread(REGISTERS.IP)==256+12*VM.CPU.INTERRUPTS.ISR_BYTE_SIZE,"sets IP to 0x100 + 12*ISR_BYTE_SIZE: "+e.regread(REGISTERS.IP).toString(16)),assert.equal(e._pending_interrupts.length,0,"is no longer pending")}]],["INC","Increment X by OFFSET which is the 32 bits following the instruction. OFFSET is treated as a literal value (kind=0), relative address (kind=3), or an indirect relative address (kind=6). IP is advanced past OFFSET.",[["x",[240,4]],["condition",[3840,8]],["kind",[61440,12]],["data",VM.TYPES.ULONG]],function(e,r){var t=e.regread(REGISTERS.IP);if(e.check_condition(this.un.condition(r))){var s=e.memreadl(t);0!=this.un.kind(r)&&7!=this.un.kind(r)&&(s=e.memreadl(e.regread(REGISTERS.IP)+s)),6==this.un.kind(r)&&(s=e.memreadl(s));var S=e.regread(this.un.x(r))+s;e.regwrite(this.un.x(r),S),S>4294967295?(e.set_status(VM.CPU.STATUS.ERROR),e.set_status(VM.CPU.STATUS.CARRY)):(e.clear_status(VM.CPU.STATUS.ERROR),e.clear_status(VM.CPU.STATUS.CARRY)),this.un.x(r)!=VM.CPU.REGISTERS.IP&&e.regwrite(REGISTERS.IP,t+VM.CPU.REGISTER_SIZE)}else e.regwrite(REGISTERS.IP,t+VM.CPU.REGISTER_SIZE)},function(e,r){var t=(240&r)>>4;t>=VM.CPU.REGISTER_PARAMS||(e.memwritel(0,e.encode({op:r})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,2),e.regwrite(t,305419896),e.step(),assert.assert(305419898==e.regread(t),"R"+t+" is incremented by 2 "+e.regread(t)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.CARRY),"clears the carry bit"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP by a REGISTER_SIZE"),e.reset(),e.memwritel(0,e.encode({op:r})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,2),e.regwrite(t,4294967295),e.step(),assert.assert(1==e.regread(t),"R"+t+" is incremented by 2 "+e.regread(t)),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR,"sets the error bit"),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.CARRY,"sets the carry bit"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP by a REGISTER_SIZE"),e.reset(),e.memwritel(0,e.encode({op:r,kind:3})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,128-VM.CPU.INSTRUCTION_SIZE),e.memwritel(128,2),e.regwrite(t,305419896),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(305419898==e.regread(t),"R"+t+" is incremented by 2 "+e.regread(t)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.CARRY),"clears the carry bit"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP by a REGISTER_SIZE"),e.reset(),e.memwritel(0,e.encode({op:r,kind:6})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,128-VM.CPU.INSTRUCTION_SIZE),e.memwritel(128,112),e.memwritel(112,2),e.regwrite(t,305419896),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(305419898==e.regread(t),"R"+t+" is incremented by 2 "+e.regread(t)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.ERROR),"clears the error bit"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.CARRY),"clears the carry bit"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP by a REGISTER_SIZE"),e.reset(),e.memwritel(0,e.encode({op:r,kind:3,condition:VM.CPU.STATUS.NEGATIVE})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,128-VM.CPU.INSTRUCTION_SIZE),e.clear_status(VM.CPU.STATUS.OVERFLOW|VM.CPU.STATUS.NEGATIVE),e.memwritel(128,2),e.regwrite(t,305419896),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(305419898!=e.regread(t),"R"+t+" is not incremented by 2 "+e.regread(t)),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP by a REGISTER_SIZE"),e.set_status(VM.CPU.STATUS.NEGATIVE),e.regwrite(REGISTERS.IP,0),e.step(),assert.equal(e.regread(t),305419898,"R"+t+" is incremented by 2 "),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP by a REGISTER_SIZE"))}],math_ops("I"),math_ops("U"),math_ops("F"),["LOAD","Load the whole register DEST with data from memory at the address found in REG + OFFSET, the following "+VM.CPU.REGISTER_SIZE+" bytes. If REG is STATUS then OFFSET is used directly. When REG is INS, then the value is used as is. Except when IP is loaded, IP is always advanced past the OFFSET.",[["dest",[240,4]],["condition",[3840,8]],["reg",[61440,12]],["data",VM.TYPES.ULONG]],function(e,r){let t=e.regread(REGISTERS.IP);if(e.check_condition(this.un.condition(r))){let s=0;this.un.reg(r)!=VM.CPU.REGISTERS.STATUS&&this.un.reg(r)!=VM.CPU.REGISTERS.INS?(s=e.regread(this.un.reg(r)),s+=e.memreadl(t)):s+=e.memreadL(t);let S=0;S=this.un.reg(r)==VM.CPU.REGISTERS.INS?s:e.memreadL(s),e.regwrite(this.un.dest(r),S),this.un.dest(r)!=VM.CPU.REGISTERS.IP&&e.regwrite(REGISTERS.IP,t+VM.CPU.REGISTER_SIZE)}else e.regwrite(REGISTERS.IP,t+VM.CPU.REGISTER_SIZE)},[function(e,r){var t=(240&r)>>4;e.memwritel(0,e.encode({op:r,reg:2})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,48),e.memwrite(128,[68,34]),e.regwrite(t,999),e.regwrite(2,80),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(8772==e.regread(t),"loads a value from memory into the register"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP")},function(e,r){var t=(240&r)>>4;e.memwriteS(0,e.encode({op:r,reg:VM.CPU.REGISTERS.STATUS})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,48),e.memwrite(128,[68,34,0,0]),e.memwrite(48,[136,153,0,0]),e.regwrite(t,999),e.regwrite(2,80),e.regwrite(REGISTERS.IP,0),e.step(),assert.equal(e.regread(t),39304,"loads into the register a value from memory with offseting from the status register"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP")},function(e,r){var t=(240&r)>>4;e.memwritel(0,e.encode({op:r,reg:VM.CPU.REGISTERS.INS})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,48),e.memwrite(128,[68,34]),e.memwrite(48,[136,153]),e.regwrite(t,999),e.regwrite(2,80),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(48==e.regread(t),"loads into the register the value"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP")},function(e,r){var t=(240&r)>>4;e.memwritel(0,e.encode({op:r,condition:VM.CPU.STATUS.NEGATIVE,reg:2})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,48),e.memwrite(128,[68,34]),e.clear_status(VM.CPU.STATUS.NEGATIVE),e.regwrite(t,999),e.regwrite(2,80),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(8772!=e.regread(t),"does not load a value from memory into the register"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP"),e.regwrite(REGISTERS.IP,0),e.set_status(VM.CPU.STATUS.NEGATIVE),e.step(),assert.assert(8772==e.regread(t),"loads a value from memory into the register"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP")}]],["POP","Pop a value from the stack into the register.",[["dest",[240,4]]],function(e,r){e.pop(this.un.dest(r))},function(e,r){var t=(240&r)>>4;e.regwrite(0,4660),e.regwrite(REGISTERS.SP,e.stack_start-1),e.memwritel(0,e.encode({op:VM.CPU.INS.PUSH,src:0})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,e.encode({op:r,dest:t})),e.regwrite(REGISTERS.IP,0),e.step(),e.regwrite(0,0),e.step(),t==VM.CPU.REGISTERS.SP?assert.assert(4660==e.regread(t),"stores the values from memory to R"+t+" "+e.regread(t).toString(16)):(assert.equal(e.regread(REGISTERS.SP),e.stack_start-1,"increments the stack pointer"),assert.equal(e.regread(t),4660,"stores the values from memory to R"+t+" "+e.regread(t).toString(16)))}],[["CIE","Clear interrupt enable bit.",{},function(e,r){e.disable_interrupts()},function(e,r){e.enable_interrupts(),e.memwritel(0,e.encode({op:r})),e.step(),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"clears the interrupt enable bit")}],["RESET","Reinitialize the CPU.",{},function(e,r){e.reset()},function(e,r){e.memwritel(0,e.encode({op:r})),e.set_status(VM.CPU.STATUS.ERROR),e.step(),assert.equal(e.regread(REGISTERS.STATUS),0,"clears the status register");for(var t=0;t<VM.CPU.REGISTERS.GP_COUNT;t++)assert.equal(e.regread(t),0,"clears register "+t)}],["BRK","Cause a Break interrupt.",{},function(e,r){e.interrupt(VM.CPU.INTERRUPTS.brk)},[function(e,r){e.keep_running=!0,e.memwritel(0,e.encode({op:r})),e.regwrite(REGISTERS.ISR,256),e.step(),assert.equal(e.interrupts_pending(),0,"does not queue an interrupt")},function(e,r){var t=256+VM.CPU.INTERRUPTS.brk*VM.CPU.INTERRUPTS.ISR_BYTE_SIZE;e.keep_running=!1,e._pending_interrupts=[],e.memwritel(0,e.encode({op:r})),e.memwritel(t,e.encode({op:VM.CPU.INS.HALT})),e.enable_interrupts(),e.regwrite(REGISTERS.ISR,256),e.step(),assert.equal(e.interrupts_pending(),1,"queues the interrupt"),e.step(),assert.equal(e.interrupts_pending(),0,"processed the interrupt"),assert.equal(e.regread(REGISTERS.IP),t,"jumps to the break interrupt")}]],[],[],[],["MEMSET","Sets count bytes from the address in X to the value in Y."],["CALL","Push IP + "+VM.CPU.REGISTER_SIZE+", and then set IP to the OFFSET following the instruction. When REG is not STATUS or INS, that register's value is added to OFFSET.",[["condition",[3840,8]],["reg",[61440,12]],["data",VM.TYPES.ULONG]],function(e,r){let t=e.regread(REGISTERS.IP);if(e.regwrite(REGISTERS.IP,t+VM.CPU.REGISTER_SIZE),e.check_condition(this.un.condition(r))){let s=e.memreadl(t);this.un.reg(r)!=VM.CPU.REGISTERS.STATUS&&this.un.reg(r)!=VM.CPU.REGISTERS.INS&&(s=e.regread(this.un.reg(r))+s),e.push_register(REGISTERS.IP),e.regwrite(REGISTERS.IP,s)}},[function(e,r){e.regwrite(REGISTERS.SP,256),e.memwrite(144,new Array(32)),e.set_status(VM.CPU.STATUS.NEGATIVE),e.memwritel(0,e.encode({op:r,reg:VM.CPU.REGISTERS.STATUS})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,128),e.step(),assert.equal(e.regread(REGISTERS.IP),128,"sets IP to offset"),assert.equal(e.memreadL(e.regread(REGISTERS.SP)+0),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"pushed IP")},function(e,r){e.regwrite(REGISTERS.SP,256),e.memwrite(144,new Array(32)),e.set_status(VM.CPU.STATUS.ZERO),e.memwritel(0,e.encode({op:r,reg:VM.CPU.REGISTERS.STATUS,condition:VM.CPU.STATUS.NEGATIVE})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,128),e.clear_status(VM.CPU.STATUS.NEGATIVE),e.step(),assert.not_equal(e.regread(REGISTERS.IP),128,"sets IP to offset"),assert.not_equal(e.memreadL(e.regread(REGISTERS.SP)+4),8,"pushed IP"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP"),e.set_status(VM.CPU.STATUS.NEGATIVE),e.regwrite(REGISTERS.IP,0),e.step(),assert.equal(e.regread(REGISTERS.IP),128,"sets IP to offset"),assert.equal(e.memreadL(e.regread(REGISTERS.SP)+0),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"pushed IP")}]],["SIE","Set the interrupt enable bit.",{},function(e,r){e.enable_interrupts()},function(e,r){e.disable_interrupts(),e.memwritel(0,e.encode({op:r})),e.step(),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"sets the interrupt enable bit")}],["SLEEP","Sleeps the CPU.",[],function(e,r){return e.debug&&console.log("SLEEP",e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.SLEEP,e.cycles),e.set_status(VM.CPU.STATUS.SLEEP|VM.CPU.STATUS.INT_ENABLED),e.clear_status(VM.CPU.STATUS.INT_FLAG),!0},function(e,r){e.memwritel(0,e.encode({op:r})),assert.equal(e.step(),!1,"causes step to return false"),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.SLEEP),"sets the sleep status bit"),assert.assert(0!=(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED),"sets the interrupt enable bit"),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_FLAG),"clears the INT_FLAG bit")}],[],[],["RET","Pop IP returning from a CALL.",{},function(e,r){e.pop(REGISTERS.IP)},function(e,r){e.memwritel(0,e.encode({op:r})),e.regwrite(REGISTERS.SP,256),e.push_value(VM.CPU.STATUS.NEGATIVE),e.push_value(48),e.step(),assert.equal(e.regread(REGISTERS.SP),256-VM.CPU.REGISTER_SIZE,"popped value from the stack"),assert.equal(e.regread(REGISTERS.IP),48,"sets IP to value on the stack")}],[],["MEMCPY","Copies count bytes starting from X to Y."],["CALLR","Push IP + "+VM.CPU.REGISTER_SIZE+", and then set IP to the register REG + value of the OFFSET register. When REG is not STATUS or INS, that register's value is added to OFFSET. STATUS and INS are treated as zeros.",[["offset",[61440,12]],["reg",[3840,8]]],function(e,r){e.regread(REGISTERS.IP);let t=e.regread(this.un.offset(r));this.un.reg(r)!=VM.CPU.REGISTERS.STATUS&&this.un.reg(r)!=VM.CPU.REGISTERS.INS&&(t=e.regread(this.un.reg(r))+t),e.push_register(REGISTERS.IP),e.regwrite(REGISTERS.IP,t)},[function(e,r){e.regwrite(REGISTERS.SP,256),e.memwrite(144,new Array(32)),e.set_status(VM.CPU.STATUS.NEGATIVE),e.memwritel(0,e.encode({op:r,reg:VM.CPU.REGISTERS.STATUS,offset:0})),e.regwrite(0,128),e.memwritel(128,64),e.step(),assert.equal(e.regread(REGISTERS.IP),128,"sets IP to offset"),assert.equal(e.memreadL(e.regread(REGISTERS.SP)+0),VM.CPU.INSTRUCTION_SIZE,"pushed IP")},function(e,r){e.regwrite(REGISTERS.SP,256),e.memwrite(144,new Array(32)),e.set_status(VM.CPU.STATUS.NEGATIVE),e.memwritel(0,e.encode({op:r,reg:1,offset:2})),e.regwrite(1,128),e.regwrite(2,16),e.memwritel(16,64),e.step(),assert.equal(e.regread(REGISTERS.IP),144,"sets IP to reg + offset"),assert.equal(e.memreadL(e.regread(REGISTERS.SP)+0),VM.CPU.INSTRUCTION_SIZE,"pushed IP")}]]],["MOV","Transfer the value in X to DEST.",[["dest",[240,4]],["src",[3840,8]]],function(e,r){e.regwrite(this.un.dest(r),e.regread(this.un.src(r)))},function(e,r){var t=(240&r)>>4;t!=VM.CPU.REGISTERS.IP&&(e.regwrite(2==t?1:2,123),e.regwrite(t,456),e.memwritel(0,e.encode({op:r,dest:t,src:2==t?1:2})),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(123==e.regread(t),"assigns the dest register R"+t+" : "+e.regread(t)))}],["DEC","Decrement X by OFFSET which is the 32 bits following the instruction. OFFSET is treated as a literal value (kind=0), relative address (kind=3), or an indirect relative address (kind=6). IP is advanced past OFFSET.",[["x",[240,4]],["condition",[3840,8]],["kind",[61440,12]],["data",VM.TYPES.ULONG]],function(e,r){var t=e.regread(REGISTERS.IP);if(e.check_condition(this.un.condition(r))){var s=e.memreadl(t);0!=this.un.kind(r)&&7!=this.un.kind(r)&&(s=e.memreadl(e.regread(REGISTERS.IP)+s)),6==this.un.kind(r)&&(s=e.memreadl(s));var S=e.regread(this.un.x(r))-s;e.regwrite(this.un.x(r),S),S<0?e.set_status(VM.CPU.STATUS.NEGATIVE):e.clear_status(VM.CPU.STATUS.NEGATIVE),this.un.x(r)!=VM.CPU.REGISTERS.IP&&e.regwrite(REGISTERS.IP,t+VM.CPU.REGISTER_SIZE)}else e.regwrite(REGISTERS.IP,t+VM.CPU.REGISTER_SIZE)},function(e,r){var t=(240&r)>>4;t>=VM.CPU.REGISTER_PARAMS||(e.memwritel(0,e.encode({op:r,kind:0})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,2),e.regwrite(t,305419896),e.step(),assert.assert(305419894==e.regread(t),"R"+t+" is decremented by 2 "+e.regread(t)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.NEGATIVE),"clears the negative bit"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP"),e.reset(),e.memwritel(0,e.encode({op:r,kind:0})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,2),e.regwrite(t,1),e.regwrite(1==t?2:1,2),e.step(),assert.assert(4294967295==e.regread(t),"R"+t+" is decremented by 2 "+e.regread(t)),assert.assert(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.NEGATIVE,"sets the negative bit"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP"),e.reset(),e.memwritel(0,e.encode({op:r,kind:3})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,128-VM.CPU.INSTRUCTION_SIZE),e.memwritel(128,2),e.regwrite(t,305419896),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(305419894==e.regread(t),"R"+t+" is decremented by 2 "+e.regread(t)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.NEGATIVE),"clears the negative bit"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP"),e.reset(),e.memwritel(0,e.encode({op:r,kind:6})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,128-VM.CPU.INSTRUCTION_SIZE),e.memwritel(128,112),e.memwritel(112,2),e.regwrite(t,305419896),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(305419894==e.regread(t),"R"+t+" is decremented by 2 "+e.regread(t)),assert.assert(0==(e.regread(REGISTERS.STATUS)&VM.CPU.STATUS.NEGATIVE),"clears the negative bit"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP"),e.reset(),e.memwritel(0,e.encode({op:r,kind:3,condition:VM.CPU.STATUS.NEGATIVE})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,128-VM.CPU.INSTRUCTION_SIZE),e.clear_status(VM.CPU.STATUS.NEGATIVE),e.memwritel(128,2),e.regwrite(t,305419896),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(305419894!=e.regread(t),"R"+t+" is not decremented by 2 "+e.regread(t)),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP"),e.set_status(VM.CPU.STATUS.NEGATIVE),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(305419894==e.regread(t),"R"+t+" is decremented by 2 "+e.regread(t)),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP"))}],[[],[],[],[],[],[],[],[],[],[],[],[]],[],[],["STORE","Store the whole register SRC at the address REG + OFFSET. If REG is STATUS or INS then REG is not added. OFFSET is the "+VM.CPU.REGISTER_SIZE+" bytes following the instruction. IP is always advanced past this.",[["src",[240,4]],["condition",[3840,8]],["reg",[61440,12]],["data",VM.TYPES.ULONG]],function(e,r){let t=e.regread(REGISTERS.IP);if(e.check_condition(this.un.condition(r))){let s=0;this.un.reg(r)!=VM.CPU.REGISTERS.STATUS&&this.un.reg(r)!=VM.CPU.REGISTERS.INS?(s=e.regread(this.un.reg(r)),s+=e.memreadl(t)):s=e.memreadL(t),e.memwritel(s,e.regread(this.un.src(r)))}e.regwrite(REGISTERS.IP,t+VM.CPU.REGISTER_SIZE)},[function(e,r){var t=(240&r)>>4;e.memwritel(0,e.encode({op:r,src:t,reg:1==t?3:1})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,48),e.memwrite(128,[68,34]),e.regwrite(t,999),e.regwrite(1==t?3:1,80),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(999==e.memreadl(128),"stores the registers value to memory"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP")},function(e,r){var t=(240&r)>>4;e.memwritel(0,e.encode({op:r,src:t,reg:1==t?3:1,condition:VM.CPU.STATUS.NEGATIVE})),e.memwritel(VM.CPU.INSTRUCTION_SIZE,48),e.memwrite(128,[68,34]),e.regwrite(t,999),e.regwrite(1==t?3:1,80),e.regwrite(REGISTERS.IP,0),e.clear_status(VM.CPU.STATUS.NEGATIVE),e.step(),assert.assert(999!=e.memreadl(128),"does not store the registers value to memory"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP"),e.regwrite(REGISTERS.IP,0),e.set_status(VM.CPU.STATUS.NEGATIVE),e.step(),assert.assert(999==e.memreadl(128),"stores the registers value to memory"),assert.equal(e.regread(REGISTERS.IP),VM.CPU.INSTRUCTION_SIZE+VM.CPU.REGISTER_SIZE,"increased IP")}]],["PUSH","Pushes the specified register onto the stack.",[["src",[240,4]]],function(e,r){e.push_register(this.un.src(r))},function(e,r){var t=(240&r)>>4;e.memwritel(0,e.encode({op:r,src:t})),e.regwrite(t,123),e.regwrite(REGISTERS.IP,0),e.step(),assert.assert(e.regread(REGISTERS.SP)==e.stack_start-4,"decrements the stack pointer"),assert.assert(123==e.memreadl(e.stack_start-4,4),"writes to memory at SP")}],[]],VM.CPU.ArgMask=function(e,r,t){if(this.name=e,this.mask=r,!r)throw"Mask required: "+e;this.shiftr=t||0},VM.CPU.ArgMask.prototype.get=function(e){return(e&this.mask)>>this.shiftr},VM.CPU.ArgMask.prototype.shift=function(e){return e<<this.shiftr&this.mask},VM.CPU.Instruction=function(e,r,t,s,S,i,a){this.op=e,this.name=r,this.doc=t,this.arg_masks=this.populate_argmasks(s),this.un=util.map_each(this.arg_masks,function(e,r){return function(e){return r.get(e)}}),this.has_literal=S,this.byte_size=VM.TYPES.SHORT.byte_size+this.has_literal.byte_size,this.impl=i,this.tests=a},VM.CPU.Instruction.prototype.populate_argmasks=function(e){var r=new Map;return util.map_each(e,function(e,t){t.constructor!=VM.CPU.ArgMask&&(e.match(/\d+/)&&(e=t[0],t=t[1]),t=new VM.CPU.ArgMask(e,t[0],t[1],t[2])),r[e.toLowerCase()]=t}),util.map_each(e,function(e,t){t.constructor==VM.CPU.ArgMask&&(r[e.toLowerCase()]=t)}),r},VM.CPU.Instruction.prototype.call=function(e,r){return this.impl(e,r)},VM.CPU.Instruction.prototype.unmask=function(e){var r=util.map_each(this.arg_masks,function(r,t){return t.get(e)});return r[0]=e,r},VM.CPU.Instruction.prototype.mask=function(e){var r=0|e.op;return util.map_each(this.arg_masks,function(t,s){r|=s.shift(e[t]||0)}),r},VM.CPU.Instruction.prototype.encoder_list=function(e){e.constructor!=Array&&(e=Array.from(arguments));var r={op:this.op},t=0;for(var s in this.arg_masks)if("highop"!=s&&"lowop"!=s){var S=e[t++];S&&(r[s]=S)}return r},VM.CPU.Instruction.prototype.run_tests=function(e,r){if("function"==typeof this.tests)return e.reset(),this.tests(e,r),1;if(this.tests){for(var t=0;t<this.tests.length;t++)e.reset(),this.tests[t](e,r);return t}return 0},VM.CPU.INS=[],VM.CPU.INS_INST=[],VM.CPU.INS_DISPATCH=new DispatchTable(15,0),VM.CPU.INS_DISPATCH=build_ins_tables(VM.CPU.INS_DEFS,"lowop",15,0),VM.UnknownInstructionError="Unknown instruction",VM.InvalidRegisterError="Invalid register error",VM.MemoryFaultError="Memory fault error",VM.CPU.prototype.run=function(e){this.debug&&console.log("CPU run",e);var r=0;this.halted=!1,this.keep_running=!0,this.running=!0;do{this.keep_running=this.step(),r++}while((null==e||r<e)&&0!=this.keep_running&&0==this.halted||this.interrupts_pending()&&(this.check_condition(VM.CPU.STATUS.INT_ENABLED)||this.check_condition(VM.CPU.STATUS.INT_FLAG)));return this},VM.CPU.prototype.stop=function(){this.halted=!0,this.running=!1},VM.CPU.prototype.encode=function(e){return VM.CPU.encode(e)},VM.CPU.prototype.decode=function(e,r){return VM.CPU.decode(e,r)},VM.CPU.encode=function(e){return this.decode(e.op).mask(e)},VM.CPU.decode=function(e,r){r||(r=VM.CPU.INS_DISPATCH);var t=r.get(e);return t.constructor==DispatchTable?this.decode(e,t):t},VM.CPU.prototype.unknown_op=function(e,r){if(this.exceptional)throw VM.UnknownInstructionError;this.interrupt(VM.CPU.INTERRUPTS.unknown_op)},VM.CPU.prototype.do_step=function(){if((this.halted||0!=(this.regread(REGISTERS.STATUS)&VM.CPU.STATUS.SLEEP))&&!this.check_condition(VM.CPU.STATUS.INT_ENABLED|VM.CPU.STATUS.INT_FLAG))return!1;if(this.running=!0,this.stepping=!0,this.cycles++,!this.do_interrupt()){let e=this.regread(REGISTERS.IP),r=this.memreadS(e);this.regwrite("ins",r),this.regwrite(REGISTERS.IP,e+VM.CPU.INSTRUCTION_SIZE);let t=this.decode(r);if(t){if(1==t.call(this,r)&&0==this.interrupts_pending())return this.stepping=!1,!1}else this.unknown_op(r,e)}return this.stepping=!1,this},VM.CPU.prototype.step=function(){try{return this.do_step()}catch(e){if(this.stepping=!1,e==DispatchTable.UnknownKeyError)this.unknown_op(this.regread("ins"),this.regread(REGISTERS.IP));else if(e instanceof VM.MemoryBus.NotMappedError)this.interrupt(VM.CPU.INTERRUPTS.mem_fault);else if(e instanceof RangedHash.InvalidAddressError)this.interrupt(VM.CPU.INTERRUPTS.mem_fault);else if(e instanceof PagedHash.NotMappedError)this.interrupt(VM.CPU.INTERRUPTS.mem_fault);else if(console.log("Ignoring exception",e),this.exceptional)throw e;return this}},VM.CPU.prototype.dbstep=function(e){this.regread(REGISTERS.IP);e||(e=1);for(var r=0;r<e;r++)this.step();return this.debug_dump()},VM.CPU.prototype.debug_dump=function(e){console.log("Cycle",this.cycles);var r=this.regread(REGISTERS.IP);e&&(r+=e);try{var t=this.memreadS(r),s=this.decode(t);console.log("Instruction","@0x"+r.toString(16),"0x"+t.toString(16),"0x"+this.memreadL(r+VM.CPU.INSTRUCTION_SIZE).toString(16)),console.log("           ","@"+r,t,this.memreadL(r+VM.CPU.INSTRUCTION_SIZE)),console.log("  ",s?s.name:"unknown",s.unmask(t))}catch(e){console.log("Error decoding INS",r)}var S=this,i=util.n_times(Math.min(this.debug_stack_size||16,this.stack_start,this.regread(REGISTERS.SP)),function(e){try{return S.memreadL(S.regread(REGISTERS.SP)+e*VM.CPU.REGISTER_SIZE)}catch(e){return 0}});return console.log("Registers"),console.log("0x",util.map_each_n(this._reg,function(e,r){return e.toString(16)}).join(", ")),console.log("  ",this._reg.join(", ")),console.log("Stack",this.regread(REGISTERS.SP),"0x"+this.regread(REGISTERS.SP).toString(16)),console.log("0x",util.map_each_n(i,function(e,r){return e.toString(16)}).join(", ")),console.log("  ",i.join(", ")),console.log(),this},VM.CPU.prototype.push_register=function(e){let r=this.regread(e),t=this.regread(REGISTERS.SP)-4;return this.memwritel(t,r),this.regwrite(REGISTERS.SP,t),this},VM.CPU.prototype.push_value=function(e){"string"==typeof e&&(e=this.regread(e));let r=this.regread(REGISTERS.SP)-4;return this.memwritel(r,e),this.regwrite(REGISTERS.SP,r),this},VM.CPU.prototype.pop=function(e){return this.regwrite(e,this.memreadL(this.regread(REGISTERS.SP))),register_index(e)!=register_index(REGISTERS.SP)&&this.regwrite(REGISTERS.SP,this.regread(REGISTERS.SP)+4),this},VM.CPU.prototype.reset=function(){for(var e=0;e<16;e++)this.regwrite(e,0);return this.regwrite(REGISTERS.STATUS,0),this.regwrite(REGISTERS.SP,this.stack_start),this.halted=!1,this._pending_interrupts=[],this.interrupt(VM.CPU.INTERRUPTS.reset),this},VM.CPU.prototype.map_memory=function(e,r,t){return this.mem.map_memory(e,r,t),this},VM.CPU.prototype.memread=function(e,r){return this.mem.memread(e,r)},VM.CPU.prototype.memreadl=function(e){return this.mem.memreadl(e)},VM.CPU.prototype.memreadL=function(e){return this.mem.memreadL(e)},VM.CPU.prototype.memreadS=function(e){return this.mem.memreadS(e)},VM.CPU.prototype.memwrite=function(e,r,t){return this.mem.memwrite(e,r,t)},VM.CPU.prototype.memwritel=function(e,r){return this.mem.memwritel(e,r)},VM.CPU.prototype.memwriteL=function(e,r){return this.mem.memwriteL(e,r)},VM.CPU.prototype.memwrites=function(e,r){return this.mem.memwrite(e,r)},VM.CPU.prototype.memwriteS=function(e,r){return this.mem.memwriteS(e,r)},VM.CPU.prototype.regread=function(e,r){var t=register_index(e);if(r==VM.TYPES.ULONG||null==r)return this._reg[t];var s=t*VM.CPU.REGISTER_SIZE;return"number"!=typeof r&&"string"!=typeof r||(r=VM.TYPES[r]),r||(r=VM.TYPES.ULONG),r.get(this._reg_view,s,!0)},VM.CPU.prototype.regreadf=function(e){return this.regread(e,VM.TYPES.FLOAT)},VM.CPU.prototype.regwrite=function(e,r,t){var s=register_index(e);if(t==VM.TYPES.ULONG||null==t)this._reg[s]=r;else{var S=s*VM.CPU.REGISTER_SIZE;"number"!=typeof t&&"string"!=typeof t||(t=VM.TYPES[t]),t||(t=VM.TYPES.ULONG),t.set(this._reg_view,S,r,!0)}return this},VM.CPU.prototype.regwritef=function(e,r){return this.regwrite(e,r,VM.TYPES.FLOAT)},VM.CPU.prototype.set_status=function(e){return this.regwrite(REGISTERS.STATUS,this.regread(REGISTERS.STATUS)|e),this},VM.CPU.prototype.clear_status=function(e){this.regwrite(REGISTERS.STATUS,this.regread(REGISTERS.STATUS)&~e)},VM.CPU.prototype.check_condition=function(e){return 0==e||0!=(this.regread(REGISTERS.STATUS)&e)},VM.CPU.prototype.interrupt=function(e){return this.debug&&(console.log("Interrupt",e,VM.CPU.INTERRUPTS[e],this.regread(REGISTERS.STATUS)&VM.CPU.STATUS.SLEEP,this.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED,this.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_FLAG,this.regread(REGISTERS.IP),this.regread(REGISTERS.SP),Date.now()),this.debug_dump()),0!=(this.regread(REGISTERS.STATUS)&(VM.CPU.STATUS.INT_ENABLED|VM.CPU.STATUS.INT_FLAG))&&this._pending_interrupts.push(e),this},VM.CPU.prototype.interrupts_pending=function(){return this._pending_interrupts.length},VM.CPU.prototype.do_interrupt=function(){if(this.regread(REGISTERS.STATUS)&VM.CPU.STATUS.INT_ENABLED&&this._pending_interrupts.length>0){this.push_register(REGISTERS.IP),this.push_register(REGISTERS.STATUS),this.set_status(VM.CPU.STATUS.INT_FLAG),this.disable_interrupts();var e=this._pending_interrupts.shift();return this.regwrite(REGISTERS.IP,this.regread(REGISTERS.ISR)+e*VM.CPU.INTERRUPTS.ISR_BYTE_SIZE),this.debug&&console.log("Doing interrupt",e,this.regread(REGISTERS.IP)),!0}return!1},VM.CPU.prototype.disable_interrupts=function(){return this.clear_status(VM.CPU.STATUS.INT_ENABLED),this},VM.CPU.prototype.enable_interrupts=function(){return this.set_status(VM.CPU.STATUS.INT_ENABLED),this.debug&&console.log("Pending interrupts",this._pending_interrupts),this},VM.CPU.prototype.save_state=function(){var e=this;return{registers:util.n_times(VM.CPU.REGISTER_COUNT,function(r){return e.regread(r)})}},VM.CPU.prototype.restore_state=function(e){if(e.registers)for(var r=0;r<VM.CPU.REGISTER_COUNT;r++)this.regwrite(r,e.registers[r])};const RAM=require("vm/devices/ram.js");VM.CPU.test_suite=function(){var e=0,r=new VM.MemoryBus,t=new VM.CPU(r,65536);t.exceptional=!0;var s=PagedHash.PageSize;r.map_memory(0,s,new RAM(s)),r.map_memory(s,65536-s,new RAM(65536-s));var S=util.n_times(128,function(e){return e});return t.memwrite(0,S),assert.equal(Array.from(t.memread(0,S.length)),S,"reads what was written"),e+=vm_run_dispatch_table_tests(VM.CPU.INS_DISPATCH,t),t.reset(),t.memwrite(0,[255,255,255,255]),assert.is_thrown(function(){t.step()},VM.UnknownInstructionError,"because it is exceptional"),t.reset(),t.enable_interrupts(),t.exceptional=!1,assert.assert(t.step()==t,"wants to keep running"),assert.assert(t.interrupts_pending(),"has an interrupt"),console.log(e+" tests ran."),t};

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"asserts.js":66,"paged_hash.js":76,"util.js":77,"vm/devices/ram.js":93,"vm/dispatch_table.js":102,"vm/ranged_hash.js":106,"vm/types.js":109}],83:[function(require,module,exports){
(function (global){
("undefined"!=typeof window&&!window.VM||"undefined"!=typeof global&&!global.VM)&&(VM={}),require("vm/devices/ram.js"),require("vm/devices/memory_bus.js"),require("vm/devices/mmu.js"),require("vm/devices/console.js"),require("vm/devices/gfx.js"),require("vm/devices/keyboard.js"),require("vm/devices/timer.js"),require("vm/devices/keystore.js"),require("vm/devices/sound.js");

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"vm/devices/console.js":84,"vm/devices/gfx.js":85,"vm/devices/keyboard.js":89,"vm/devices/keystore.js":90,"vm/devices/memory_bus.js":91,"vm/devices/mmu.js":92,"vm/devices/ram.js":93,"vm/devices/sound.js":95,"vm/devices/timer.js":101}],84:[function(require,module,exports){
const DataStruct=require("data_struct.js"),RAM=require("vm/devices/ram.js");function Console(t){t=t||1024,this.name="Console",this.data_struct=new DataStruct([["buffer",t,VM.TYPES.UBYTE],["flush",VM.TYPES.ULONG]]),this.ram=new RAM(this.data_struct.byte_size),this.data=this.data_struct.proxy(this.ram.data_view()),this.callbacks=[function(t){console.log(t)}]}require("vm/types.js"),Console.prototype.ram_size=function(){return this.ram.length},Console.prototype.add_callback=function(t){return this.callbacks.push(t),this},Console.prototype.flush=function(){var t=String.fromCharCode.apply(null,this.data.buffer.slice(0,this.data.flush)).trim();for(var s in this.callbacks)this.callbacks[s](t);this.ram.set(0,this.ram.length,0)},Console.prototype.read=function(t,s,e,o){return this.ram.read(t,s,e,o)},Console.prototype.write=function(t,s){this.ram.write(t,s),t==this.data.ds.fields.flush.offset&&this.flush()},Console.prototype.step=function(t){return!1},"undefined"!=typeof module&&(module.exports=Console);

},{"data_struct.js":67,"vm/devices/ram.js":93,"vm/types.js":109}],85:[function(require,module,exports){
(function (global){
"use strict";const Enum=require("enum.js"),DataStruct=require("data_struct.js"),RangedHash=require("vm/ranged_hash.js"),RAM=require("vm/devices/ram.js"),util=require("util.js"),PixelBuffer=require("vm/devices/gfx/pixel_buffer"),Layer=require("vm/devices/gfx/layer"),Command=require("vm/devices/gfx/command");function GFX(t,e,i,a,r,s,n,_){this.name="GFX",this.mem_size=r,this.input_ram=new RAM(r),this.input_struct=GFX.InputMemory(e.length,r),this.input_data=this.input_struct.proxy(this.input_ram.data_view());var o=this;this.layers=util.map_each_n(e,function(t,e){return new GFX.Layer(e,t,o.input_data.layers[e].view,i,a)}),this.images=_,this.input_data.current_layer=0,this.input_data.flags=GFX.Flags.SYNC,this.irq=t,this.next_output_addr=0,this.timer=null,this.pixel_buffer=new GFX.PixelBuffer(s||i,n||a),this.pixel_offset=this.input_struct.byte_size}const SIZEOF_FLOAT=Float32Array.BYTES_PER_ELEMENT,SIZEOF_SHORT=Uint16Array.BYTES_PER_ELEMENT,SIZEOF_LONG=Uint32Array.BYTES_PER_ELEMENT;GFX.PixelBuffer=PixelBuffer,GFX.Layer=Layer,GFX.Command=Command,GFX.MAX_LAYERS=16,GFX.UnknownCommandError="Unknown command error",GFX.Flags=new Enum({NONE:0,SYNC:1,RESYNC:2}),GFX.LayerMemory=new DataStruct([["id",VM.TYPES.BYTE],["visible",VM.TYPES.UBYTE],["width",VM.TYPES.ULONG],["height",VM.TYPES.ULONG],["x",VM.TYPES.FLOAT,0],["y",VM.TYPES.FLOAT,0],["z",VM.TYPES.LONG,0],["alpha",VM.TYPES.FLOAT,0]],!0,SIZEOF_LONG),GFX.InputMemory=function(t,e,i){return i=i||16,new DataStruct([["flags",VM.TYPES.ULONG],["last_error",VM.TYPES.ULONG],["error_offset",VM.TYPES.ULONG],["result",VM.TYPES.ULONG],["result_values",8,VM.TYPES.FLOAT],["current_layer",VM.TYPES.ULONG],["layers",t,GFX.LayerMemory],["swapping",VM.TYPES.ULONG],["ip",VM.TYPES.ULONG],["sp",VM.TYPES.ULONG],["call_stack",i,VM.TYPES.ULONG],["input",e-t*GFX.LayerMemory.byte_size-(17+i)*VM.TYPES.ULONG.byte_size,VM.TYPES.UBYTE],["swap",VM.TYPES.ULONG]],!0,SIZEOF_LONG)};const GFX_COMMANDS=[["NOP",""],["COMPOSITE",""],["RESET",""],["CLEAR",""],["SET_FILL","BBBB"],["SET_LINE","BBBB"],["SET_LINE_CAP","B"],["SET_LINE_JOIN","B"],["SET_STROKE","BBBB"],["SET_STROKE_WIDTH","f"],["SET_LINE_WIDTH","f"],["SAVE",""],["RESTORE",""],["SET_LAYER","B"],["CALL","L"],["RET",""],["BEGIN",""],["END",""],["SCALE","ff"],["ROTATE","f"],["TRANSLATE","ff"],["RECT","ffff"],["FILL_RECT","ffff"],["MOVE","ff"],["LINE","ff"],["CURVE","ffffff"],["STROKE",""],["FILL",""],["GET_PIXELS","LLLLLL"],["PUT_PIXELS","LLLLLL"],["COPY_PIXELS","LLLLLL"],["PUT_IMAGE","LLLLLLL"]];for(var i in GFX.LINE_CAPS=new Enum(["BUTT","ROUND","SQUARE"]),GFX.LINE_JOINS=new Enum(["BEVEL","ROUND","MITER"]),GFX.commands={},GFX.commands_by_name={},GFX_COMMANDS){var def=GFX_COMMANDS[i],op=parseInt(i),cmd=new GFX.Command(def[0],def[1]);GFX.commands[op]=cmd,GFX.commands_by_name[cmd.name]=cmd,GFX["CMD_"+cmd.name]=op}function gfx_test_cmds(t,e,i){return[GFX.CMD_SET_LAYER,0,GFX.CMD_CLEAR,GFX.CMD_SET_LINE_CAP,GFX.LINE_CAPS.ROUND,GFX.CMD_SET_FILL,t,e,i,255,GFX.CMD_FILL_RECT,0,0,640,480,GFX.CMD_SET_STROKE,0,255,0,255,GFX.CMD_SET_LINE,255,0,0,255,GFX.CMD_SET_LINE_WIDTH,5,GFX.CMD_BEGIN,GFX.CMD_MOVE,0,0,GFX.CMD_LINE,320,240,GFX.CMD_LINE,320,0,GFX.CMD_STROKE,GFX.CMD_BEGIN,GFX.CMD_MOVE,100,0,GFX.CMD_SET_STROKE,0,0,255,128,GFX.CMD_SET_LINE_WIDTH,10,GFX.CMD_LINE,480,320,GFX.CMD_CURVE,0,480,0,0,640,480,GFX.CMD_STROKE,GFX.CMD_RET]}GFX.StackOverflowError="Stack overflow",GFX.ERRORS={},GFX.ERRORS[GFX.UnknownCommandError]=1,GFX.ERRORS[GFX.Command.ArgumentError]=2,GFX.ERRORS[RangedHash.InvalidAddressError]=3,GFX.ERRORS[GFX.StackOverflowError]=4,GFX.prototype.process_drawing_cmd=function(){var t=this.input_data.ip,e=1,i=this.input_data.ds.fields.input.offset,a=this.input_data.input[t];if(t>=this.input_data.input.byteLength)return!1;switch(2==this.debug&&console.log("ip",t,"cmd",a,GFX.commands[a],"RAM",this.input_ram.read(t+i,16),"SP",this.input_data.sp,"swap",this.input_data.swap,this.input_data.swapping),null==this.context&&(this.context=this.get_context("2d")),a){case GFX.CMD_NOP:break;case GFX.CMD_CLEAR:this.context.clearRect(0,0,this.get_current_layer().width,this.get_current_layer().height);break;case GFX.CMD_SET_LAYER:this.set_layer(this.input_data.input[t+1]),this.context=this.get_context("2d"),e+=1;break;case GFX.CMD_SET_LINE_CAP:this.context.lineCap=GFX.LINE_CAPS[this.input_ram.read(t+i+1,1)[0]].toLowerCase(),e+=1;break;case GFX.CMD_SET_LINE_JOIN:this.context.lineJoin=GFX.LINE_JOINS[this.input_ram.read(t+i+1,1)[0]].toLowerCase(),e+=1;break;case GFX.CMD_SET_FILL:(r=Array.from(this.input_ram.read(t+i+1,4)))[3]=r[3]/255,this.context.fillStyle="rgba("+r.join(",")+")",e+=4;break;case GFX.CMD_SET_STROKE:(r=Array.from(this.input_ram.read(t+i+1,4)))[3]=r[3]/255,this.context.strokeStyle="rgba("+r.join(",")+")",e+=4;break;case GFX.CMD_SET_LINE:(r=Array.from(this.input_ram.read(t+i+1,4)))[3]=r[3]/255,this.context.lineStyle="rgba("+r.join(",")+")",e+=4;break;case GFX.CMD_SET_LINE_WIDTH:var r=this.input_ram.readf(t+i+1,1);this.context.lineWidth=r[0],e+=VM.TYPES.FLOAT.byte_size;break;case GFX.CMD_SET_STROKE_WIDTH:r=this.input_ram.readf(t+i+1,1);this.context.strokeWidth=r[0],e+=VM.TYPES.FLOAT.byte_size;break;case GFX.CMD_SAVE:this.context.save();break;case GFX.CMD_RESTORE:this.context.restore();break;case GFX.CMD_BEGIN:this.context.beginPath();break;case GFX.CMD_END:this.context.closePath();break;case GFX.CMD_SCALE:var s=this.input_ram.readf(t+i+1,2);this.context.scale(s[0],s[1]),e+=2*VM.TYPES.FLOAT.byte_size;break;case GFX.CMD_TRANSLATE:var n=this.input_ram.readf(t+i+1,2);this.context.translate(n[0],n[1]),e+=2*VM.TYPES.FLOAT.byte_size;break;case GFX.CMD_ROTATE:n=this.input_ram.readf(t+i+1,1);this.context.rotate(n[0]),e+=VM.TYPES.FLOAT.byte_size;break;case GFX.CMD_FILL_RECT:var _=this.input_ram.readf(t+i+1,4);this.context.fillRect(_[0],_[1],_[2],_[3]),e+=4*VM.TYPES.FLOAT.byte_size;break;case GFX.CMD_RECT:_=this.input_ram.readf(t+i+1,4);this.context.rect(_[0],_[1],_[2],_[3]),e+=4*VM.TYPES.FLOAT.byte_size;break;case GFX.CMD_MOVE:_=this.input_ram.readf(t+i+1,2);this.context.moveTo(_[0],_[1]),e+=2*VM.TYPES.FLOAT.byte_size;break;case GFX.CMD_LINE:_=this.input_ram.readf(t+i+1,2);this.context.lineTo(_[0],_[1]),e+=2*VM.TYPES.FLOAT.byte_size;break;case GFX.CMD_CURVE:_=this.input_ram.readf(t+i+1,6);this.context.bezierCurveTo(_[0],_[1],_[2],_[3],_[4],_[5]),e+=6*VM.TYPES.FLOAT.byte_size;break;case GFX.CMD_STROKE:this.context.stroke();break;case GFX.CMD_FILL:this.context.fill();break;case GFX.CMD_CALL:e+=VM.TYPES.LONG.byte_size,this.input_data.ip+=e,this.call(this.input_ram.readL(t+i+1,1)[0]);break;case GFX.CMD_RET:if(!this.call_return())return!1;break;case GFX.CMD_GET_PIXELS:e+=6*VM.TYPES.ULONG.byte_size;_=this.input_ram.readL(t+i+1,6);var o=this.context.getImageData(_[0],_[1],_[2],_[3]);this.pixel_buffer.copy_image(o,0,0,_[4],_[5],_[2],_[3]);break;case GFX.CMD_PUT_PIXELS:e+=6*VM.TYPES.ULONG.byte_size;_=this.input_ram.readl(t+i+1,6);this.pixel_buffer.put_pixels(this.context,_[0],_[1],_[2],_[3],_[4],_[5]);break;case GFX.CMD_COPY_PIXELS:e+=6*VM.TYPES.ULONG.byte_size;var u=this.input_ram.readl(t+i+1,6);this.pixel_buffer.copy_pixels(u[0],u[1],u[2],u[3],u[4],u[5]);break;case GFX.CMD_PUT_IMAGE:e+=7*VM.TYPES.ULONG.byte_size;var p=(_=this.input_ram.readl(t+i+1,7)).shift();this.images[p]&&this.context.drawImage(this.images[p],_[2],_[3],_[4],_[5],_[0]+_[2],_[1]+_[3],_[4],_[5]);break;default:this.write_error(GFX.UnknownCommandError,a)}return a!=GFX.CMD_CALL&&a!=GFX.CMD_RET&&(2==this.debug&&console.log("IP += "+e),this.input_data.ip+=e),!0},GFX.prototype.call=function(t){this.input_data.sp<this.input_data.call_stack.length?(this.input_data.call_stack[this.input_data.sp++]=this.input_data.ip,this.input_data.ip=t):this.write_error(GFX.StackOverflowError,this.input_data.ip)},GFX.prototype.call_return=function(){return this.input_data.sp>0&&(this.input_data.ip=this.input_data.call_stack[--this.input_data.sp],!0)},GFX.prototype.swap_buffers=function(){return this.debug&&console.log("Swapping buffers",this.input_data.swapping,this.input_data.swap,this.timer),0==this.input_data.swapping&&0!=this.input_data.swap?(this.debug&&console.log("Commence swap"),this.input_data.ip=this.input_data.swap-1,this.input_data.swapping=this.input_data.swap,!1):this},GFX.prototype.request_animation=function(){this.debug&&console.log("GFX request animation",this.timer,this.raf)},GFX.prototype.stop=function(){this.timer&&(window.cancelAnimationFrame(this.timer),this.timer=null,this.raf=null)},GFX.prototype.stop_exec=function(){return this.input_data.ip=0,this.input_data.swapping=0,this.input_data.swap=0,this.trigger_interrupt(),this},GFX.prototype.run_anim=function(t){var e;this.debug&&console.log("GFX run_anim",t,this.timer,this.raf,this.input_data.ip),this.timer=null;do{e=this.step_anim()}while(0!=e);this.debug&&console.log("GFX run_anim done",this.input_data.ip,this.input_data.last_error)},GFX.prototype.step=function(){return this.step_anim()},GFX.prototype.trigger_interrupt=function(){this.debug&&console.log("GFX trigger interrupt"),this.irq.trigger()},GFX.prototype.step_anim=function(){if(0!=this.input_data.swapping){try{if(0!=this.process_drawing_cmd())return this}catch(t){this.write_error(t,i)}this.stop_exec()}return!1},GFX.prototype.debug_dump=function(){return console.log("GFX","layer",this.input_data.current_layer,"IP",this.input_data.ip,"SP",this.input_data.sp,"Swap",this.input_data.swap,this.input_data.swapping),this},GFX.BadLayerError="Bad Layer",GFX.prototype.set_layer=function(t){if(t<0||t>=this.layers.length)throw GFX.BadLayerError;return this.input_data.current_layer=t,this},GFX.prototype.get_context=function(t){return this.layers[this.input_data.current_layer].get_context(t)},GFX.prototype.get_current_layer=function(){return this.layers[this.input_data.current_layer]},GFX.prototype.ram_size=function(){return this.input_struct.byte_size+this.pixel_buffer.length},GFX.prototype.read=function(t,e,i,a){return t<this.input_ram.length?this.input_ram.read(t,e,i,a):this.pixel_buffer.read(t-this.input_ram.length,e,i,a)},GFX.prototype.write=function(t,e){var i;return t<this.input_ram.length?(i=this.input_ram.write(t,e),t==this.input_struct.fields.swap.offset&&this.swap_buffers()):i=this.pixel_buffer.write(t-this.input_ram.length,e),i},GFX.prototype.write_error=function(t,e){if(!GFX.ERRORS[t])throw t;this.input_data.last_error=t,this.input_data.error_offset=e},GFX.prototype.writef=function(t,e){var i=new Uint8Array(Float32Array.BYTES_PER_ELEMENT),a=new DataView(i.buffer,i.byteOffset);return VM.TYPES.FLOAT.set(a,0,e),this.write(t,i),this},GFX.prototype.write_resultf=function(t,e,i,a){return this.input_data.result=t,this.input_data.result_values[0]=e,this.input_data.result_values[1]=i,this.input_data.result_values[2]=a,this},GFX.prototype.write_resultb=function(t,e,i,a){return this.input_data.result=t,this.input_data.result_values[0]=e,this.input_data.result_values[1]=i,this.input_data.result_values[2]=a,this},GFX.prototype.write_array=function(t,e){return this.write(t,GFX.encode_array(e))},GFX.encode_array=function(t,e){e||(e=new Uint8Array(t.length*VM.TYPES.LONG.byte_size));for(var i=0,a=0;a<t.length;a++){var r=GFX.commands[t[a]];if(null==r)throw"Undefined: "+t+" "+a;e[i]=t[a],i+=1,i+=r.encode_array(t.slice(a+1,a+1+r.arity),new DataView(e.buffer,e.byteOffset+i)),a+=r.arity}return e.subarray(0,i)},GFX.video_test_layers=function(t,e,i){var a=[GFX.CMD_CLEAR,GFX.CMD_SET_LAYER,e,GFX.CMD_SCALE,.5,.5];t.input_data.layers[e].z=1,t.input_data.layers[e].x=160,t.input_data.layers[e].y=120,t.input_data.layers[e].width=320,t.input_data.layers[e].height=240,t.input_data.layers[e].alpha=.5,t.write_array(t.input_data.ds.fields.input.offset,a.concat(gfx_test_cmds(255,0,0))),t.write(t.input_data.ds.fields.swap.offset,[1,0,0,0]),i||(i=100),util.n_times(i,function(e){t.step()})},GFX.video_test_pixels=function(t,e){for(var i=t.pixel_buffer.width,a=t.pixel_buffer.height,r=[GFX.CMD_SET_LAYER,0,GFX.CMD_CLEAR,GFX.CMD_PUT_PIXELS,64,64,0,0,64,64,GFX.CMD_PUT_PIXELS,320,32,0,0,64,64,GFX.CMD_RET],s=[GFX.CMD_SAVE,GFX.CMD_GET_PIXELS,0,0,i,a,0,0,GFX.CMD_CLEAR,GFX.CMD_PUT_PIXELS,320,32,0,0,i/2,a/2,GFX.CMD_RESTORE,GFX.CMD_RET],n=[],_=0;_<256;_+=4)n[_]=255,n[_+1]=0,n[_+2]=0,n[_+3]=128;for(var o=0;o<64;o++){var u=t.input_struct.byte_size+o*i*4;console.log("Writing pixels to "+u),t.write(u,n)}var p=t.input_data.ds.fields.input.offset,h=t.write_array(p,r);p+=h,p+=t.write_array(p,s),console.log("Swapping"),t.write(t.input_data.ds.fields.swap.offset,[1,0,0,0]),setTimeout(function(){0==t.input_data.swapping&&(console.log("Step",h),t.write(t.input_data.ds.fields.swap.offset,[1+h,0,0,0]))},1e3)},GFX.video_test=function(t,e){t.constructor!=Array&&(t=[t]);var i=new GFX(null,8,t,640,480,4096),a=GFX.encode_array(gfx_test_cmds(0,0,128));return i.write(i.input_data.ds.fields.input.offset,a),console.log("Command byte length",a.byteLength),console.log("Setting swap to 1"),i.write(i.input_data.ds.fields.swap.offset,[1,0,0,0]),i},GFX.video_test_call=function(t){var e=[GFX.CMD_SAVE,GFX.CMD_TRANSLATE,10,0,GFX.CMD_CALL,27,GFX.CMD_ROTATE,Math.PI/8,GFX.CMD_CALL,27,GFX.CMD_ROTATE,Math.PI/8,GFX.CMD_CALL,27,GFX.CMD_RESTORE,GFX.CMD_RET],i=GFX.encode_array(gfx_test_cmds(0,128,128)),a=t.input_data.ds.fields.input.offset;return t.write(a,i),a+=i.byteLength,t.write(a,GFX.encode_array(e)),t.input_data.swap=i.byteLength+1,t.write(t.input_data.ds.fields.swap.offset,i.byteLength+1),t},("undefined"!=typeof window&&!window.VM||"undefined"!=typeof global&&!global.VM)&&(VM={}),void 0===VM.Devices&&(VM.Devices={}),VM.Devices.GFX=GFX,"undefined"!=typeof module&&(module.exports=GFX);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"data_struct.js":67,"enum.js":68,"util.js":77,"vm/devices/gfx/command":86,"vm/devices/gfx/layer":87,"vm/devices/gfx/pixel_buffer":88,"vm/devices/ram.js":93,"vm/ranged_hash.js":106}],86:[function(require,module,exports){
Command=function(r,t){this.name=r,this.arglist=t,this.arity=t.length},Command.ArgumentError="ArgumentError",Command.prototype.encode_array=function(r,t){if(r.length!=this.arity)throw Command.ArgumentError;for(var e=0,a=0;a<this.arity;a++)switch(this.arglist[a]){case"b":t.setInt8(e,r[a]),e+=Int8Array.BYTES_PER_ELEMENT;break;case"B":t.setUint8(e,r[a]),e+=Uint8Array.BYTES_PER_ELEMENT;break;case"f":t.setFloat32(e,r[a],!0),e+=Float32Array.BYTES_PER_ELEMENT;break;case"l":t.setInt32(e,r[a],!0),e+=Int32Array.BYTES_PER_ELEMENT;break;case"L":t.setUint32(e,r[a],!0),e+=Uint32Array.BYTES_PER_ELEMENT;break;default:throw"Unkown arglist specifier"}return e},"undefined"!=typeof module&&(module.exports=Command);

},{}],87:[function(require,module,exports){
function Layer(t,i,n,a,s,e,h,c,o){this.canvas=i,this.data=n;this.id(t),this.width(a),this.height(s),this.x(e||0),this.y(h||0),this.z(c||0),this.alpha(o||0)}for(var f in Layer.FIELDS={id:function(t){},visible:function(t){this.canvas.style.visibility=t>0?"visible":"hidden"},width:function(t){this.canvas.style.width=this.canvas.width=t},height:function(t){this.canvas.style.height=this.canvas.height=t},x:function(t){this.canvas.style.left=t},y:function(t){this.canvas.style.top=t},z:function(t){this.canvas.style.zIndex=t},alpha:function(t){this.canvas.style.opacity=t}},Layer.add_attr=function(t,i){Layer.prototype[t]=function(i){return i&&(this.data[t]=i),this.data[t]}},Layer.FIELDS)Layer.add_attr(f,Layer.FIELDS[f]);Layer.prototype.get_context=function(t){return null==this.context&&(this.context=this.canvas.getContext(t||"2d")),this.context},"undefined"!=typeof module&&(module.exports=Layer);

},{}],88:[function(require,module,exports){
const RAM=require("vm/devices/ram.js");PixelBuffer=function(t,e){this.width=t||w,this.height=e||h,this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.context=this.canvas.getContext("2d"),this.buffer=this.context.createImageData(this.width,this.height),this.ram=new RAM(this.buffer.data),this.length=this.ram.length},PixelBuffer.prototype.put_pixels=function(t,e,i,h,a,r,s){this.context.putImageData(this.buffer,0,0,h,a,r,s),t.drawImage(this.canvas,h,a,r,s,e+h,i+a,r,s)},PixelBuffer.prototype.copy_pixels=function(t,e,i,h,a,r){this.copy_image(this.buffer,t,e,i,h,a,r)},PixelBuffer.prototype.copy_image=function(t,e,i,h,a,r,s){null==r&&(r=t.width),null==s&&(s=t.height);for(var f=0;f<s;f++){var n=(a+f)*this.buffer.width*4+4*h;if(n>=this.buffer.data.length)break;this.buffer.data.set(t.data.subarray((i+f)*t.width*4+4*e,(i+f)*t.width*4+4*(e+r)),n)}},PixelBuffer.prototype.read=function(t,e,i,h){return this.ram.read(t,e,i,h)},PixelBuffer.prototype.write=function(t,e){return this.ram.write(t,e)},"undefined"!=typeof module&&(module.exports=PixelBuffer);

},{"vm/devices/ram.js":93}],89:[function(require,module,exports){
require("vm/types.js");const DataStruct=require("data_struct.js"),Enum=require("enum.js"),RingBuffer=require("vm/ring_buffer.js"),RAM=require("vm/devices/ram.js");function Keyboard(e,t){this.name="Keyboard",this.running=!1,this.focused=!1,this.element=e,this.irq=t,this.ram=new RAM(Keyboard.MemoryStruct_16.byte_size),this.mem=Keyboard.MemoryStruct_16.proxy(this.ram.data_view()),this.buffer=new RingBuffer(Keyboard.MemoryStruct_16.fields.events.type,this.mem.events),this.install_keyhandlers(),this.reset()}Keyboard.Modifiers=new Enum([["NONE",0],["SHIFT",1],["CTRL",2],["ALT",4],["META",8],["REPEAT",16],["PRESSED",32768]]),Keyboard.EventStruct=new DataStruct([["char_code",VM.TYPES.USHORT],["key_code",VM.TYPES.USHORT],["modifiers",VM.TYPES.USHORT],["padding",VM.TYPES.USHORT]]),Keyboard.MemoryStruct=function(e){return new DataStruct([["events",RingBuffer.DataStruct(e,Keyboard.EventStruct)]])},Keyboard.MemoryStruct_16=Keyboard.MemoryStruct(16),Keyboard.prototype.reset=function(){this.buffer.clear()},Keyboard.prototype.step=function(){return this.running=!0,!1},Keyboard.prototype.stop=function(){this.running=!1},Keyboard.prototype.install_keyhandlers=function(){var e=this;this.element.addEventListener("click",function(t){0==e.element.classList.contains("focused")&&(e.debug&&console.log("Keyboard device focused"),e.element.classList.add("focused"),e.focused=!0)}),document.body.addEventListener("click",function(t){t.target!=e.element&&(e.debug&&console.log("Keyboard device lost focus"),e.element.classList.remove("focused"),e.focused=!1)}),window.onkeyup=function(t){if(e.focused)return e.on_key(!1,t)},window.onkeydown=function(t){if(e.focused)return e.on_key(!0,t)}},Keyboard.prototype.encode_modifiers=function(e,t){var r=0;return e&&(r|=Keyboard.Modifiers.PRESSED),t.altKey&&(r|=Keyboard.Modifiers.ALT),t.ctrlKey&&(r|=Keyboard.Modifiers.CTRL),t.metaKey&&(r|=Keyboard.Modifiers.META),t.shiftKey&&(r|=Keyboard.Modifiers.SHIFT),t.repeat&&(r|=Keyboard.Modifiers.REPEAT),r},Keyboard.prototype.buffer_size=function(){return this.buffer.length()},Keyboard.prototype.buffer_full=function(){return this.buffer.full()},Keyboard.prototype.on_key=function(e,t){if("INPUT"!=t.target.tagName){if(1==this.running&&!("r"==t.key&&t.ctrlKey||(t.preventDefault(),t.repeat))){var r={char_code:t.charCode,modifiers:this.encode_modifiers(e,t),key_code:t.keyCode};this.debug&&console.log("on_key "+e,t,t.code,this.mem.events.read_offset,this.mem.events.write_offset,this.buffer.empty(),this.buffer.length(),r),this.buffer.push(r),this.irq.trigger()}}else this.debug&&console.log(t)},Keyboard.prototype.read=function(e,t,r,o){return this.ram.read(e,t,r,o)},Keyboard.prototype.write=function(e,t){return this.ram.write(e,t)},Keyboard.prototype.ram_size=function(){return this.ram.length},"undefined"!=typeof module&&(module.exports=Keyboard);

},{"data_struct.js":67,"enum.js":68,"vm/devices/ram.js":93,"vm/ring_buffer.js":107,"vm/types.js":109}],90:[function(require,module,exports){
require("vm/types.js");const DataStruct=require("data_struct.js"),Enum=require("enum.js"),RAM=require("vm/devices/ram.js");function KeyStore(t,e,s,a){this.name=a||"KeyStore",this.storage=t,this.memory=e,this.irq=s,this.ram=new RAM(KeyStore.Struct.byte_size),this.state=KeyStore.Struct.proxy(this.ram.data_view()),this.reset()}function in_range(t,e,s){return t>=e&&t<s}KeyStore.Status=new Enum([["NONE",0],["OK",1],["NOT_FOUND",2],["BUSY",4],["ERROR",128],["BAD_COMMAND",130]]),KeyStore.Command=new Enum([["NONE",0],["ENABLE",1],["DISABLE",2],["RESET",3],["STAT",4],["READ",5],["WRITE",6],["DELETE",7],["NUMBER",8]]),KeyStore.Struct=new DataStruct([["status",VM.TYPES.ULONG],["command",VM.TYPES.ULONG],["offset",VM.TYPES.ULONG],["key",VM.TYPES.ULONG],["key_size",VM.TYPES.ULONG],["data_pointer",VM.TYPES.ULONG],["data_size",VM.TYPES.ULONG],["data_out_pointer",VM.TYPES.ULONG],["data_out_size",VM.TYPES.ULONG]]),KeyStore.prototype.ram_size=function(){return this.ram.length},KeyStore.prototype.reset=function(){this.ram.set(0,this.ram.length,0),this.state.status=KeyStore.Status.BUSY,this.storage.disable(t=>{this.state.status=t?KeyStore.Status.ERROR:KeyStore.Status.NONE})},KeyStore.prototype.read=function(t,e,s,a){return this.ram.read(t,e,s,a)},KeyStore.prototype.read_key=function(){return this.memory.memread(this.state.key,this.state.key_size)},KeyStore.prototype.process_command=function(){this.debug&&console.log("KeyStore command",this.state.command,KeyStore.Command[this.state.command],this.state.status);var t=KeyStore.Commands[this.state.command];return null==t&&(t=KeyStore.Commands[KeyStore.Command.NUMBER]),t.call(this)},KeyStore.Commands={},KeyStore.Commands[KeyStore.Command.NONE]=function(){return this.state.status==KeyStore.Status.BUSY?this:(this.state.status=KeyStore.Status.OK,this.state.command=0,this)},KeyStore.Commands[KeyStore.Command.NUMBER]=function(){return this.state.status==KeyStore.Status.BUSY?this:(this.state.status=KeyStore.Status.BAD_COMMAND,this.state.command=0,this)},KeyStore.Commands[KeyStore.Command.DELETE]=function(){if(this.state.status==KeyStore.Status.BUSY)return this;this.state.status=KeyStore.Status.BUSY;var t=this.read_key();return this.storage.removeItem(t,(t,e)=>{this.state.status=e?KeyStore.Status.OK:KeyStore.Status.ERROR,this.state.command=0,this.irq.trigger()}),this},KeyStore.Commands[KeyStore.Command.WRITE]=function(){if(this.state.data_out_size>0){if(this.state.status==KeyStore.Status.BUSY)return this;this.state.status=KeyStore.Status.BUSY;var t=this.read_key(),e=this.memory.memread(this.state.data_out_pointer,this.state.data_out_size);this.debug&&console.log("Write",t,e),this.storage.setItem(t,e,(t,e)=>{if(this.state.status=e?KeyStore.Status.OK:KeyStore.Status.ERROR,this.state.command=0,e){var s=Math.min(t.length,this.state.data_size);this.debug&&console.log("Wrote",t,e,s,this.state.status,this.irq),this.memory.memwrite(this.state.data_pointer,t.slice(0,s)),this.state.data_size=s}this.irq.trigger()})}else KeyStore.Commands[KeyStore.Command.DELETE].call(this);return this},KeyStore.Commands[KeyStore.Command.READ]=function(){if(this.state.status==KeyStore.Status.BUSY)return this;this.state.status=KeyStore.Status.BUSY;var t=this.read_key();this.storage.getValue(t,this.state.offset,this.state.data_size,(e,s)=>{if(this.debug&&console.log("Read",t,e,s?s.length:0,this.state.offset,this.state.data_size,s),this.state.command=0,null!=s){var a=Math.min(s.length,this.state.data_size);this.memory.memwrite(this.state.data_pointer,s.slice(0,a)),this.state.data_size=a,this.state.status=KeyStore.Status.OK}else this.state.data_size=0,this.state.status=KeyStore.Status.NOT_FOUND|KeyStore.Status.ERROR;this.irq.trigger()});return this},KeyStore.Commands[KeyStore.Command.STAT]=function(){if(this.state.status==KeyStore.Status.BUSY)return this;this.state.status=KeyStore.Status.BUSY;var t=this.read_key();this.storage.getSize(t,(t,e)=>{this.state.command=0,null!=e?(this.state.data_size=e,this.state.status=KeyStore.Status.OK):(this.state.data_size=0,this.state.status=KeyStore.Status.NOT_FOUND|KeyStore.Status.ERROR),this.irq.trigger()});return this},KeyStore.Commands[KeyStore.Command.ENABLE]=function(){return this.state.status==KeyStore.Status.BUSY?this:(this.state.status=KeyStore.Status.BUSY,this.storage.enable(t=>{this.state.command=0,this.state.status=t?KeyStore.Status.ERROR:KeyStore.Status.OK,this.irq.trigger()}),this)},KeyStore.Commands[KeyStore.Commands.DISABLE]=function(){return this.state.status==KeyStore.Status.NONE?this:(this.state.status=KeyStore.Status.BUSY,this.storage.disable(t=>{this.state.command=0,this.state.status=t?KeyStore.Status.ERROR:KeyStore.Status.NONE,this.irq.trigger()}),this)},KeyStore.prototype.write=function(t,e){var s=this.ram.write(t,e);return in_range(this.state.ds.fields.command.offset,t,t+e.length)&&this.process_command(),s},"undefined"!=typeof module&&(module.exports=KeyStore),"undefined"!=typeof VM&&(VM.LocalKeyStore=KeyStore);

},{"data_struct.js":67,"enum.js":68,"vm/devices/ram.js":93,"vm/types.js":109}],91:[function(require,module,exports){
(function (global){
"use strict";const RangedHash=require("vm/ranged_hash.js"),PagedHash=require("paged_hash.js");("undefined"!=typeof window&&!window.VM||"undefined"!=typeof global&&!global.VM)&&(VM={}),VM.MemoryBus=function(){this.name="MemoryBus",this.memory_map=new PagedHash},VM.MemoryBus.NotMappedError=function(e){this.msg="Address not mapped: "+e,this.addr=e},VM.MemoryBus.prototype.step=function(){return!1},VM.MemoryBus.prototype.map_memory=function(e,r,t){return this.memory_map.add(e,r,t),this},VM.MemoryBus.prototype.start_address_for=function(e){var r=this.memory_map.range_for(e);if(r)return r.addr},VM.MemoryBus.prototype.memread=function(e,r){if(this.debug&&console.log("MemoryBus read",e,"number"==typeof r,r),"number"==typeof r){for(var t,m=new Uint8Array(r),o=0;o<r;o++){t=e+o;var s=this.memory_map.get(t);if(null==s||null==s.value)throw new VM.MemoryBus.NotMappedError(e);var a=s.value.read(t-s.addr,r,m,o);if(0==a)break;o+=a-1}return m}var n=r;null==n?n=VM.TYPES.ULONG:"string"==typeof n&&(n=VM.TYPES[r]);var i=this.memread(e,n.byte_size),u=new DataView(i.buffer,i.byteOffset);return n.get(u,0,!0)},VM.MemoryBus.prototype.memread1=function(e,r){if(null==this.memory_map.get(e))throw new VM.MemoryBus.NotMappedError(e);var t=this.memread(e,r.byte_size),m=new DataView(t.buffer,t.byteOffset);return r.get(m,0,!0)},VM.MemoryBus.prototype.memreadl=function(e){return this.memread1(e,VM.TYPES.LONG)},VM.MemoryBus.prototype.memreadL=function(e){return this.memread1(e,VM.TYPES.ULONG)},VM.MemoryBus.prototype.memreadS=function(e){return this.memread1(e,VM.TYPES.USHORT)},VM.MemoryBus.prototype.memreadf=function(e){return this.memread1(e,VM.TYPES.FLOAT)},VM.MemoryBus.prototype.memwrite=function(e,r,t){if(t){var m=new Uint8Array(t.byte_size),o=new DataView(m.buffer,m.byteOffset);return t.set(o,0,r,!0),this.memwrite(e,m)}var s,a;for(a=0;a<r.length;a++){s=e+a;var n=this.memory_map.get(s);if(null==n)throw new VM.MemoryBus.NotMappedError(e);var i=n.value.write(s-n.addr,r.slice(a));if(0==i)break;a+=i-1}return a},VM.MemoryBus.prototype.memwrite1=function(e,r,t){if(null==this.memory_map.get(e))throw new VM.MemoryBus.NotMappedError(e);var m=new Uint8Array(t.byte_size),o=new DataView(m.buffer);return t.set(o,0,r,!0),this.memwrite(e,m)},VM.MemoryBus.prototype.memwritel=function(e,r){return this.memwrite1(e,r,VM.TYPES.LONG)},VM.MemoryBus.prototype.memwriteL=function(e,r){return this.memwrite1(e,r,VM.TYPES.ULONG)},VM.MemoryBus.prototype.memwrites=function(e,r){return this.memwrite1(e,r,VM.TYPES.SHORT)},VM.MemoryBus.prototype.memwriteS=function(e,r){return this.memwrite1(e,r,VM.TYPES.USHORT)},VM.MemoryBus.prototype.memwritef=function(e,r){return this.memwrite1(e,r,VM.TYPES.FLOAT)},VM.MemoryBus.prototype.save_state=function(){var e=[];return this.memory_map.map(function(r,t){e[r.id]={addr:r.addr,size:r.size,value:r.value.save_state?r.value.save_state():null}}),{memories:e}},VM.MemoryBus.prototype.restore_state=function(e){if(e.memories)for(var r=0;r<e.memories.length;r++){var t=e.memories[r],m=this.memory_map.get(t.addr);t.value&&m.size==t.size&&m.value&&m.value.restore_state&&m.value.restore_state(t.value)}},VM.MemoryBus.test_suite=function(){const e=require("vm/devices/ram"),r=require("asserts.js");var t=new VM.MemoryBus,m=PagedHash.PageSize;t.map_memory(0,m,new e(m)),t.map_memory(m,m,new e(m)),r.assert(4==t.memwrite(0,[1,2,3,4]),"returns number bytes writen"),r.assert(t.memread(0,4).toString()==[1,2,3,4].toString(),"reads the bytes that were writen"),r.assert(4==t.memwrite(m-2,[1,2,3,4]),"returns number of bytes writen"),r.assert(t.memread(m-2,4).toString()==[1,2,3,4].toString(),"reads the bytes that were writen");for(var o=0;o<4;o++)t.memwriteL(m-o,305419896),r.assert(305419896==t.memreadL(m-o),"reads the integer that was writen offset by "+o),r.assert(13398==t.memreadS(m-o+1),"reads shorts");return t},"undefined"!=typeof module&&(module.exports=VM.MemoryBus);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"asserts.js":66,"paged_hash.js":76,"vm/devices/ram":93,"vm/ranged_hash.js":106}],92:[function(require,module,exports){
(function (global){
"use strict";("undefined"!=typeof window&&!window.VM||"undefined"!=typeof global&&!global.VM)&&(VM={}),VM.MMU=function(e){},VM.MMU.prototype.step=function(){return!1},"undefined"!=typeof module&&(module.exports=VM.MMU);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],93:[function(require,module,exports){
(function (global){
function RAM(t){"number"==typeof t?this.set_data(new Uint8Array(t)):this.set_data(t)}RAM.prototype.set_data=function(t){this._data=t,this.length=t.length,this._view=this.data_view()},RAM.prototype.data_view=function(t){return new DataView(this._data.buffer,this._data.byteOffset+(t||0))},RAM.prototype.read=function(t,e,a,r){if(a){var n;for(n=0;n<e&&!(t+n>=this._data.length);n++)a[r+n]=this._data[t+n];return n}return this._data.subarray(t,t+e)},RAM.prototype.write=function(t,e){var a;for(null==e.length&&(e=[e]),a=0;a<e.length&&!(t+a>=this._data.length);a++)this._data[t+a]=e[a];return a},RAM.prototype.set=function(t,e,a){for(var r=0;r<e;r++)this.write(t+r,a)},RAM.prototype.step=function(){return!1},RAM.prototype.save_state=function(){return{length:this.length,memory:this.read(0,this.length)}},RAM.prototype.restore_state=function(t){t.memory?this.set_data(new Uint8Array(t.memory)):t.length&&this.set_data(new Uint8Array(t.length))};for(var RAM_TYPE_ACCESSORS=[["f","Float32"],["l","Int32"],["L","Uint32"],["s","Int16"],["S","Uint16"]],i=0;i<RAM_TYPE_ACCESSORS.length;i++){var a=RAM_TYPE_ACCESSORS[i],x=function(sym,type){var type_array=eval(type+"Array");RAM.prototype["read"+sym]=function(t,e,a){for(var r=this.read(t,type_array.BYTES_PER_ELEMENT*e),n=new DataView(r.buffer,r.byteOffset),i=[],o=0;o<e;o++)i[o]=n["get"+type](o*type_array.BYTES_PER_ELEMENT,a||!0);return i},RAM.prototype["write"+sym]=function(t,e,a){new Uint8Array(e.length*type_array.BYTES_PER_ELEMENT);for(var r=new DataView(this._data.buffer,this._data.byteOffset+t),n=0;n<e.length;n++)r["set"+type](n*type_array.BYTES_PER_ELEMENT,e[n],a||!0);return this}};x(a[0],a[1])}("undefined"!=typeof window&&!window.VM||"undefined"!=typeof global&&!global.VM)&&(VM={}),void 0===VM.Devices&&(VM.Devices={}),VM.Devices.RAM=RAM,"undefined"!=typeof module&&(module.exports=RAM);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{}],94:[function(require,module,exports){
"use strict";const DataStruct=require("data_struct.js"),VMJS=require("vm.js"),RAM=require("vm/devices/ram.js");var now,start_time;if("undefined"!=typeof performance)now=function(){return performance.now()},start_time=function(){return performance.timing.navigationStart};else{var start=(now=function(){return Date.now()})();start_time=function(){return start}}function RTC(){this.name="RTC",this.input_ram=new RAM(RTC.InputMemory.byte_size),this.input_data=RTC.InputMemory.proxy(this.input_ram.data_view()),this.input_data.on_time=start_time()}RTC.InputMemory=new DataStruct([["calendar_ms",VM.TYPES.ULONG],["on_time",VM.TYPES.FLOAT],["runtime_usec",VM.TYPES.ULONG],["runtime_ms",VM.TYPES.FLOAT],["runtime_sec",VM.TYPES.ULONG]]),RTC.prototype.ram_size=function(){return this.input_ram.length},RTC.prototype.read=function(t,e,n,r){return this.update(),this.input_ram.read(t,e,n,r)},RTC.prototype.update=function(){var t=now();this.input_data.runtime_ms=t,this.input_data.runtime_usec=1e3*t|0,this.input_data.runtime_sec=t/1e3|0,this.input_data.calendar_ms=Date.now()},"undefined"!=typeof module&&(module.exports=RTC);

},{"data_struct.js":67,"vm.js":80,"vm/devices/ram.js":93}],95:[function(require,module,exports){
(function (global){
require("vm/types.js");const DataStruct=require("data_struct.js"),Enum=require("enum.js"),RAM=require("vm/devices/ram.js"),more_util=require("more_util"),Channel=require("vm/devices/sound/channel"),DecodedSample=require("vm/devices/sound/decoded_sample"),RawSample=require("vm/devices/sound/raw_sample");function Sound(t,e,s,n){this.name=n||"Sound",this.mem=e,this.irq=s,this.num_channels=t,this.channels=more_util.n_times(t,t=>new Channel({onended:()=>{this.state.status&Sound.Status.irq_enabled&&this.irq.trigger()}})),this.struct=Sound.DeviceStruct(t),this.ram=new RAM(this.struct.byte_size),this.state=this.struct.proxy(this.ram.data_view()),this.samples={},this.next_sample=0,this.disable()}Sound.ChannelModes=Channel.Modes,Sound.BootSound={URI:"sounds/startup.mp3",mode:Sound.ChannelModes.sine,range:{min:220,max:880},duration:250,time_step:62.5},Sound.ChannelStruct=new DataStruct([["mode",VM.TYPES.UBYTE],["param",VM.TYPES.UBYTE],["gain",VM.TYPES.UBYTE],["pan",VM.TYPES.BYTE],["rate",VM.TYPES.ULONG],["start_at",VM.TYPES.ULONG],["stop_at",VM.TYPES.ULONG],["loop_start",VM.TYPES.ULONG],["loop_end",VM.TYPES.ULONG],["data1",VM.TYPES.ULONG]]),Sound.SampleFormat=require("vm/devices/sound/sample_format"),Sound.Sampler=new DataStruct([["id",VM.TYPES.ULONG],["address",VM.TYPES.ULONG],["length",VM.TYPES.ULONG],["format",VM.TYPES.ULONG],["num_channels",VM.TYPES.ULONG],["byte_rate",VM.TYPES.ULONG]]),Sound.DeviceStruct=function(t){return new DataStruct([["status",VM.TYPES.UBYTE],["gain",VM.TYPES.UBYTE],["current_time",VM.TYPES.ULONG],["sampler",Sound.Sampler],["num_channels",VM.TYPES.ULONG],["channels",t,Sound.ChannelStruct]])},Sound.Status=new Enum([["none",0],["enabled",1],["playing",2],["demo",4],["irq_enabled",8][128]]),Sound.prototype.disable=function(){this.context&&(this.context.close(),delete this.context),this.ram.set(0,this.ram.length,0),this.state.status=Sound.Status.none,this.state.num_channels=this.num_channels},Sound.prototype.enable=function(){null==this.context&&(this.context=new AudioContext),null==this.gainer&&(this.gainer=this.context.createGain(),this.gainer.connect(this.context.destination),this.gainer.gain.value=0,this.gain=0),this.state.status=this.state.status|Sound.Status.enabled,this.dirty=!0},Sound.prototype.push_sample=function(t){var e=++this.next_sample;return this.samples[e]=t,e},Sound.prototype.boot_sound=function(t){null==t&&(t=Sound.BootSound);for(var e=this.num_channels-2,s=0;s<e;s++){this.state.channels[s].mode=t.mode,this.state.channels[s].gain=255,this.state.channels[s].pan=s/e*256-128,this.state.channels[s].data1=t.range.min+s/e*(t.range.max-t.range.min);var n=1+s*t.time_step;this.state.channels[s].start_at=n,this.state.channels[s].stop_at=n+t.duration,this.state.channels[s].loop_start=0,this.state.channels[s].loop_end=0}var a=this.push_sample(new RawSample(Sound.SampleFormat.raw_long,this.context,this.mem,0,88200,11025,1)),i=this.state.channels[this.num_channels-1];i.gain=255,i.pan=0,i.param=1,i.data1=a,i.loop_start=0,i.loop_end=8e3,i.start_at=1+this.num_channels*t.time_step,i.stop_at=1+this.num_channels*t.time_step+1e4,i.mode=Sound.ChannelModes.sample,global.fetch(Sound.BootSound.URI).then(e=>{e.arrayBuffer().then(e=>{var s=this.push_sample(new DecodedSample(Sound.SampleFormat.sample,this.context,e,e=>{e||this.play_sample(this.num_channels-2,s,1+this.num_channels*t.time_step)}))})})},Sound.prototype.play_sample=function(t,e,s){var n=this.state.channels[t];n.gain=255,n.pan=0,n.param=1,n.data1=e,n.loop_start=0,n.loop_end=0,n.start_at=s,n.mode=Sound.ChannelModes.sample},Sound.prototype.reset=function(){this.disable()},Sound.prototype.ram_size=function(){return this.ram.length},Sound.prototype.read=function(t,e,s,n){return this.ram.read(t,e,s,n)},Sound.prototype.write=function(t,e){return this.dirty=!0,this.ram.write(t,e)},Sound.prototype.step_channel=function(t){this.channels[t].step(this.mem,this.context,this.gainer,this.state.channels[t],this.samples)},Sound.prototype.create_sample=function(){switch(this.state.sampler.format){case Sound.SampleFormat.raw_byte:case Sound.SampleFormat.raw_short:case Sound.SampleFormat.raw_long:case Sound.SampleFormat.raw_float:return new RawSample(this.state.format,this.context,this.mem,this.state.sampler.address,this.state.sampler.length,this.state.sampler.byte_rate,this.state.sampler.num_channels);case Sound.SampleFormat.sample:return new DecodedSample(this.state.format,this.context,this.mem.memread(this.state.sampler.address,this.state.sampler.length));default:return null}},Sound.prototype.update_sampler=function(){this.samples[this.state.sampler.id];this.state.sampler.format!=Sound.SampleFormat.none&&(this.samples[this.state.sampler.id]=this.create_sample(),this.state.sampler.format=Sound.SampleFormat.none)},Sound.prototype.update_status=function(){var t=this.state.status;return this.last_status!=t&&(t&Sound.Status.enabled?this.enable():this.disable(),this.context&&(t&Sound.Status.playing?this.context.resume():this.context.suspend(),t&Sound.Status.demo&&(this.boot_sound(),this.state.status=this.state.status&~Sound.Status.demo)),this.last_status=this.state.status,!0)},Sound.prototype.update_gain=function(){this.gain!=this.state.gain&&(this.gainer.gain.value=this.state.gain/255,this.gain=this.state.gain)},Sound.prototype.step=function(){return this.context&&(this.state.current_time=Math.floor(1e3*this.context.currentTime)),!!this.dirty&&(this.update_status(),null!=this.context&&(this.update_gain(),this.update_sampler(),more_util.n_times(this.num_channels,t=>this.step_channel(t)),this.dirty=!1,!1))},"undefined"!=typeof module&&(module.exports=Sound),"undefined"!=typeof VM&&(null==VM.Devices&&(VM.Devices={}),VM.Devices.Sound=Sound);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"data_struct.js":67,"enum.js":68,"more_util":75,"vm/devices/ram.js":93,"vm/devices/sound/channel":96,"vm/devices/sound/decoded_sample":97,"vm/devices/sound/raw_sample":98,"vm/devices/sound/sample_format":99,"vm/types.js":109}],96:[function(require,module,exports){
require("vm/types.js");const Enum=require("enum.js");function Channel(e){this.mode=null,this.onended=e.onended}Channel.Modes=new Enum(["off","sine","square","triangle","sawtooth","noise","raw","sample"]);const ModeKind={};[[Channel.Modes.sine,"sine"],[Channel.Modes.square,"square"],[Channel.Modes.triangle,"triangle"],[Channel.Modes.sawtooth,"sawtooth"]].map(e=>ModeKind[e[0]]=e[1]),Channel.prototype.create_oscillator=function(e,t){var n=ModeKind[t];if(n){var a=e.createOscillator();return a.type=n,a}throw{name:"UnknownMode",value:t}},Channel.prototype.create_sampler=function(e){return e.createBufferSource()},Channel.prototype.wire_node=function(e,t){null==this.gainer&&(this.gainer=e.createGain(),this.gainer.connect(t)),null==this.panner&&(this.panner=e.createStereoPanner(),this.panner.connect(this.gainer)),this.node.onended=(e=>{this.ended()}),this.node.connect(this.panner)},Channel.prototype.ended=function(){this.stop(),this.onended&&this.onended()},Channel.prototype.stop=function(e){if(this.node){try{this.node.stop(e)}catch(e){if("InvalidStateError"!=e.name)throw e}delete this.node}this.gainer&&delete this.gainer,this.panner&&delete this.panner,this.started_at=null,this.stop_at=null,this.mode=null,this.rate=null,this.pan=null,this.gain=null},Channel.prototype.set_mode=function(e){this.stop(),this.mode=e},Channel.prototype.update_state=function(e,t,n,a,o){var s=t.currentTime+a.start_at/1e3;switch(this.mode){case Channel.Modes.sine:case Channel.Modes.square:case Channel.Modes.triangle:case Channel.Modes.sawtooth:null==this.node&&(this.node=this.create_oscillator(t,a.mode),this.wire_node(t,n)),this.rate!=a.data1&&(this.rate=a.data1,this.node.frequency.setValueAtTime(a.data1,s));break;case Channel.Modes.sample:if(null==this.node&&a.data1>0){var i=o[a.data1];i&&(this.node=this.create_sampler(t),this.node.buffer=i.buffer,this.wire_node(t,n),a.data1=0)}null!=this.node&&(0!=a.loop_end?(this.node.loop=!0,this.node.loopStart=a.loop_start/1e3,this.node.loopEnd=a.loop_end/1e3):(this.node.loop=!1,this.node.loopStart=0,this.node.loopEnd=0))}this.gainer&&this.gain!=a.gain&&this.gainer.gain.setValueAtTime(a.gain/255,s),this.panner&&this.pan!=a.pan&&this.panner.pan.setValueAtTime(a.pan/128,s),this.node&&(a.start_at>0&&null==this.started_at&&(this.node.start(s),this.started_at=a.start_at,a.start_at=0),a.stop_at>0&&(this.stop(t.currentTime+a.stop_at/1e3),a.stop_at=0))},Channel.prototype.update_mode=function(e){this.mode!=e&&this.set_mode(e)},Channel.prototype.step=function(e,t,n,a,o){this.update_mode(a.mode),this.update_state(e,t,n,a,o)},module.exports=Channel;

},{"enum.js":68,"vm/types.js":109}],97:[function(require,module,exports){
require("vm/types.js"),DecodedSample=function(e,o,t,d){this.format=e,this.buffer=null,o.decodeAudioData(t,e=>{this.buffer=e,d&&d(!1)},e=>{if(!d)throw e;d(e)})},module.exports=DecodedSample;

},{"vm/types.js":109}],98:[function(require,module,exports){
require("vm/types.js");const Format=require("vm/devices/sound/sample_format");function RawSample(a,t,r,e,o,m,p){this.format=a,this.buffer=t.createBuffer(p,o,m),this.copy_sample(r,e,o)}RawSample.prototype.copy_sample=function(a,t,r){for(var e=this.buffer.getChannelData(0),o=this.format_type(),m=0;m<r/o.byte_size;m++)e[m]=a.memread1(t+m*o.byte_size,o)/o.max};const FormatTypeMap={};[[Format.raw_long&Format.unsigned,VM.TYPES.ULONG],[Format.raw_long,VM.TYPES.LONG],[Format.raw_short&Format.unsigned,VM.TYPES.USHORT],[Format.raw_short,VM.TYPES.SHORT],[Format.raw_byte&Format.unsigned,VM.TYPES.UBYTE],[Format.raw_byte,VM.TYPES.BYTE],[Format.raw_float,VM.TYPES.FLOAT]].map(a=>FormatTypeMap[a[0]]=a[1]),RawSample.prototype.format_type=function(){return FormatTypeMap[this.format]||VM.TYPES.ULONG},module.exports=RawSample;

},{"vm/devices/sound/sample_format":99,"vm/types.js":109}],99:[function(require,module,exports){
const Enum=require("enum");module.exports=new Enum(["none","ready","raw_byte","raw_short","raw_long","raw_float","sample",["unsigned",128]]);

},{"enum":68}],100:[function(require,module,exports){
const VM=require("vm.js"),Xterm=require("xterm"),Colors=require("colors/safe"),util=require("more_util"),InputStream=require("vm/node/devices/input_stream"),OutputStream=require("vm/node/devices/output_stream"),TextDecoder=require("util/text_decoder"),TextEncoder=require("util/text_encoder");function Terminal(e,t){Colors.enabled=!0,t=util.merge_options({cursorBlink:!0,local_echo:!0},t),this.term=new Xterm.Terminal(t),this.local_echo=t.local_echo,this.buffer="";var r=this;this.on_terminal("data",function(e){r.push_byte(e),"\r"==e&&r.push_byte("\n")}),this.term.open(e)}Terminal.prototype.on_terminal=function(e,t){return this.term.on(e,t)},Terminal.prototype.push_byte=function(e){return this.debug&&console.log("Terminal push",e,e.charCodeAt(0)),""==e||"\b"==e?this.buffer=this.buffer.slice(0,this.buffer.length-1):this.buffer+=e,this.local_echo&&(""!=e&&"\b"!=e||(e="\b \b"),this.write(e)),this},Terminal.prototype.read=function(e){null==e&&(e=this.buffer.length);var t=this.buffer.substring(0,e);return this.debug&&console.log("Terminal",e,t,this.buffer),this.buffer=this.buffer.substring(e),t},Terminal.prototype.readableLength=function(){return this.buffer.length},Terminal.prototype.write=function(e){return this.debug&&console.log("Terminal write:",e,e.split("")),this.term.write(e),this},Terminal.Readable=function(e){this.terminal=e,this.encoder=new TextEncoder,this.callbacks=[];var t=this;this.terminal.on_terminal("data",function(e){e.charCodeAt(0)<32&&t.on_data()})},Terminal.Readable.prototype.pause=function(){return this.is_paused=!0,this},Terminal.Readable.prototype.resume=function(){return this.is_paused=!1,this},Terminal.Readable.prototype.on=function(e,t){return this.callbacks[e]=t,"readable"==e&&(this.debug&&console.log("Terminal calling readable",this.terminal.buffer),t()),this},Terminal.Readable.prototype.on_data=function(){if(!this.is_paused){var e=this.read(),t=this.callbacks.data;t&&t(e)}},Terminal.Readable.prototype.read=function(e){var t=this.terminal.read(e);return this.encoder.encode(t)},Terminal.Readable.prototype.readableLength=function(){return this.terminal.readableLength()},Terminal.Writable=function(e){this.decoder=new TextDecoder,this.terminal=e,this.callbacks=[]},Terminal.Writable.prototype.on=function(e,t){return this.callbacks[e]=t,this},Terminal.Writable.prototype.write=function(e,t,r){return"string"!=typeof e&&(e=this.decoder.decode(e,{stream:0!=e.length})),this.terminal.write(e),r&&setTimeout(r,1),this},Terminal.Writable.prototype.end=function(){return this.write(""),this},Terminal.prototype.get_readable=function(){return new Terminal.Readable(this)},Terminal.prototype.get_input_device=function(e,t){return new InputStream(this.get_readable(),e,t)},Terminal.prototype.get_writable=function(){return new Terminal.Writable(this)},Terminal.prototype.get_output_device=function(e,t){return new OutputStream(this.get_writable(),e,t)},Terminal.prototype.clear=function(){this.term.clear()},"undefined"!=typeof module&&(module.exports=Terminal),void 0!==VM&&(VM.Terminal=Terminal);

},{"colors/safe":11,"more_util":75,"util/text_decoder":78,"util/text_encoder":79,"vm.js":80,"vm/node/devices/input_stream":104,"vm/node/devices/output_stream":105,"xterm":35}],101:[function(require,module,exports){
const Enum=require("enum.js"),DataStruct=require("data_struct.js"),VMJS=require("vm.js"),RAM=require("vm/devices/ram.js");function Timer(t,i){this.name="Timer",this.irq=t,this.frequency=i,null==this.frequency&&(this.frequency=1<<20),this.ram=new RAM(Timer.MemoryStruct.byte_size),this.data=Timer.MemoryStruct.proxy(this.ram.data_view()),this.timers=new Array(4),this.reset()}Timer.Flags=new Enum(["NONE","ZERO"]),Timer.TimerStruct=new DataStruct([["flags",VM.TYPES.ULONG],["counter",VM.TYPES.ULONG],["divider",VM.TYPES.ULONG],["maximum",VM.TYPES.ULONG]]),Timer.MemoryStruct=new DataStruct([["last_timer",VM.TYPES.ULONG],["timers",4,Timer.TimerStruct]]),Timer.prototype.stop=function(){for(var t=0;t<this.timers.length;t++)this.cancel_timer(t)},Timer.prototype.reset=function(){this.stop();for(var t=0;t<this.timers.length;t++)this.data.timers[t].flags=0,this.data.timers[t].counter=0,this.data.timers[t].divider=VM.TYPES.ULONG.max,this.data.timers[t].maximum=VM.TYPES.ULONG.max},Timer.prototype.read=function(t,i,e,r){return this.ram.read(t,i,e,r)},Timer.prototype.write=function(t,i){var e=this.ram.write(t,i);return this.step(),e},Timer.prototype.tick_timers=function(){for(var t=0;t<this.timers.length;t++)this.update_timer(t)},Timer.prototype.step=function(){return!1},Timer.prototype.update_timer=function(t){t>=0&&t<this.timers.length&&(this.data.timers[t].divider==VM.TYPES.ULONG.max||0==this.data.timers[t].maximum?this.cancel_timer(t):(this.timers[t]&&this.timers[t][1]!=this.timer_interval(t)&&this.cancel_timer(t),null==this.timers[t]&&this.start_timer(t)))},Timer.prototype.cancel_timer=function(t){this.timers[t]&&(window.clearInterval(this.timers[t][0]),this.timers[t]=null)},Timer.timer_interval=function(t,i,e){return(t>>i)*e},Timer.timer_max=function(t,i,e){return e/(t>>i)},Timer.prototype.timer_interval=function(t){return t>=0&&t<this.timers.length?Timer.timer_interval(this.frequency,this.data.timers[t].divider,this.data.timers[t].maximum):0},Timer.prototype.start_timer=function(t){if(!(t>=0&&t<this.timers.length))return!1;if(null==this.timers[t]){var i=this.timer_interval(t),e=this;this.timers[t]=[window.setInterval(function(){e.tick(t),e.step()},1e3*i),i]}},Timer.prototype.tick=function(t){t>=0&&t<this.timers.length&&(this.data.timers[t].counter+=1,this.data.last_timer=t,this.irq.trigger())},Timer.prototype.ram_size=function(){return this.ram.length},"undefined"!=typeof module&&(module.exports=Timer);

},{"data_struct.js":67,"enum.js":68,"vm.js":80,"vm/devices/ram.js":93}],102:[function(require,module,exports){
function DispatchTable(t,e,r){this.mask=t,this.shift=e,this.max=this.mask>>this.shift,this.ops=r||{}}function DispatchTableProxy(t,e,r){return new Proxy(new DispatchTable(t,e,r),{has:function(t,e){return t.has(parseInt(e))},ownKeys:function(t){return t.keys()},getOwnPropertyDescriptor:function(t,e){return{enumerable:!0,configurable:!0}},get:function(t,e){return"target"==e?t:t.get(e)},set:function(t,e,r){return t.set(e,r)}})}DispatchTable.UnknownKeyError="Unknown Key",DispatchTable.prototype.unmask_op=function(t){return(t&this.mask)>>this.shift},DispatchTable.prototype.mask_op=function(t){return t<<this.shift&this.mask},DispatchTable.prototype.set=function(t,e){return this.ops[t]=e,this},DispatchTable.prototype.get=function(t){var e=this.ops[this.unmask_op(t)];if(e)return e;throw DispatchTable.UnknownKeyError},DispatchTable.prototype.find=function(t){try{return this.get(t)}catch(t){if(t!=DispatchTable.UnknownKeyError)throw t;return null}},DispatchTable.prototype.has=function(t){try{return this.get(t),!0}catch(t){return!1}},DispatchTable.prototype.keys=function(){var t=[];for(var e in this.ops)e=this.mask_op(parseInt(e)),this.has(e)&&t.push(e.toString());return t},DispatchTable.prototype.each=function(t){return this.each_with_index((e=t,function(t,r){return e(r)}));var e},DispatchTable.prototype.each_with_index=function(t){var e=[];for(var r in this.ops){var s=this.mask_op(r),o=this.get(s);o&&e.push(t(s,o))}return e},DispatchTable.test=function(){var t=new DispatchTable(65280,8,{15:"hello",32:"world"});t.set(43,"boo"),assert("hello"==t.get(3840),"gets the correct value"),assert("world"==t.get(8192),"gets the correct value"),assert("boo"==t.get(11008),"gets the correct value"),assert_throws(function(){t.get(15)},DispatchTable.UnknownKeyError,"throws an error for a bad opcode"),assert_throws(function(){t.get(7936)},DispatchTable.UnknownKeyError,"throws an error for a bad opcode");var e=[];e=t.each_with_index(function(t,e){return e}),assert("boohelloworld"==e.sort().join(""),"has an each_with_index with values: "+e.sort().join("")),e=t.each_with_index(function(t,e){return t}),assert_equal(e.sort(),[3840,8192,11008].sort(),"has an each_with_index with keys");e=[];return e=t.each(function(t){return t}),assert("boohelloworld"==e.sort().join(""),"has an each"),!0},DispatchTableProxy.test=function(){var t=DispatchTableProxy(240,4,{3:1234,4:4567});assert(1234==t[48],"looks up array accesses"),t[10]="hello",assert("hello"==t[160],"sets array accesses unshifted");var e=[];for(var r in t)e.push(r);return assert(48==e[0]),assert(64==e[1]),assert(160==e[2]),!0},"undefined"!=typeof module&&(module.exports=DispatchTable);

},{}],103:[function(require,module,exports){
function InterruptHandle(t,r){this.container=t,this.irq=r}InterruptHandle.prototype.trigger=function(){return this.container.interrupt(this.irq),this},InterruptHandle.prototype.toInt=function(){return this.irq},InterruptHandle.prototype.toString=function(t){return this.irq.toString(t)},"undefined"!=typeof module&&(module.exports=InterruptHandle);

},{}],104:[function(require,module,exports){
"use strict";const DataStruct=require("data_struct.js"),RAM=require("vm/devices/ram.js"),RingBuffer=require("vm/ring_buffer.js");require("vm/types.js");const TextEncoder=require("util/text_encoder");function InputStream(t,e,r){if(e=e||1024,this.name="InputStream",this.stream=t,this.irq=r,this.data_struct=new DataStruct([["ready",VM.TYPES.ULONG],["eos",VM.TYPES.ULONG],["buffer",e,VM.TYPES.UBYTE],["terminator",VM.TYPES.ULONG]]),this.ram=new RAM(this.data_struct.byte_size),this.data=this.data_struct.proxy(this.ram.data_view()),this.reset(),this.stream){var a=this;this.stream.on("close",function(){a.data.eos=1,a.trigger_interrupt()}),this.stream.on("readable",function(){a.data.eos=0,a.trigger_interrupt()}),this.stream.on("data",function(t){a.read_more(t)})}}InputStream.prototype.trigger_interrupt=function(){this.irq.trigger()},InputStream.prototype.encode=function(t){return null==this.encoder&&(this.encoder=new TextEncoder),this.encoder.encode(t,{stream:!0})},InputStream.prototype.set_data=function(t){if(t&&t.length>0){var e=t.length;if("string"==typeof t){var r=this.encode(t);this.data.buffer.set(r),e=r.length}else this.data.buffer.set(t);this.data.buffer.fill(0,e),this.data.ready=e,this.data.eos=0}else this.data.buffer.fill(0),this.data.ready=0},InputStream.prototype.read_more=function(t){return this.stream.pause(),this.debug&&console.log("InputStream",t&&t.length,this.data.eos,this.data.ready,"Read ",t,this.encode(t)),this.set_data(t),null!=t&&0!=t.length&&(this.trigger_interrupt(),this)},InputStream.prototype.ram_size=function(){return this.ram.length},InputStream.prototype.reset=function(){this.data.ready=0,this.data.eos=0,this.data.terminator=0,this.ram.set(0,this.ram.length,0)},InputStream.prototype.read=function(t,e,r,a){return this.ram.read(t,e,r,a)},InputStream.prototype.write=function(t,e){this.ram.write(t,e),t==this.data.ds.fields.ready.offset&&0==this.data.ready&&this.stream.resume()},InputStream.prototype.step=function(){return!1},"undefined"!=typeof module&&(module.exports=InputStream);

},{"data_struct.js":67,"util/text_encoder":79,"vm/devices/ram.js":93,"vm/ring_buffer.js":107,"vm/types.js":109}],105:[function(require,module,exports){
(function (Buffer){
"use strict";const Enum=require("enum.js"),DataStruct=require("data_struct.js"),RAM=require("vm/devices/ram.js");require("vm/types.js");const TextDecoder=require("util/text_decoder");function OutputStream(t,e,r){if(e=e||1024,this.name="OutputStream",this.stream=t,this.irq=r,this.data_struct=new DataStruct([["eos",VM.TYPES.ULONG],["cmd",VM.TYPES.ULONG],["buffer",e,VM.TYPES.UBYTE],["flush",VM.TYPES.ULONG]]),this.ram=new RAM(this.data_struct.byte_size),this.data=this.data_struct.proxy(this.ram.data_view()),this.stream){var s=this;this.stream.on("close",function(){s.set_eos(OutputStream.EOSStates.CLOSED)}),this.stream.on("error",function(){s.set_eos(OutputStream.EOSStates.ERROR)}),this.stream.on("drain",function(){s.set_eos(OutputStream.EOSStates.OK)})}}OutputStream.EOSStates=new Enum(["OK","CLOSED","ERROR","FULL"]),OutputStream.prototype.trigger_interrupt=function(){this.irq.trigger()},OutputStream.prototype.set_eos=function(t){this.debug&&console.log("OutputStream set EOS",t),this.data.eos=t,this.trigger_interrupt()},OutputStream.prototype.ram_size=function(){return this.ram.length},OutputStream.prototype.decode=function(t){return null==this.decoder&&(this.decoder=new TextDecoder),this.decoder.decode(t,{stream:!0})},OutputStream.prototype.flush=function(){var t=this,e=this.data.buffer.slice(0,this.data.flush);"undefined"!=typeof Buffer&&(e=Buffer.from(e)),0==this.stream.write(e,null,function(){t.data.flush>0&&(t.debug&&console.log("OutputStream flushed",e),t.data.eos=OutputStream.EOSStates.OK,t.ram.set(0,t.ram.length,0),t.trigger_interrupt())})&&(this.debug&&console.log("OutputStream write returned false"),this.data.eos=OutputStream.EOSStates.FULL,this.trigger_interrupt())},OutputStream.prototype.read=function(t,e,r,s){return this.ram.read(t,e,r,s)},OutputStream.prototype.write=function(t,e){var r=this.ram.write(t,e);return t==this.data.ds.fields.flush.offset&&this.data.flush>0?this.flush():t==this.data.ds.fields.cmd.offset&&this.process_cmd(),r},OutputStream.prototype.process_cmd=function(){switch(this.data.cmd){case 1:this.stream.end()}return this.data.cmd=0,this},OutputStream.prototype.step=function(){return!1},"undefined"!=typeof module&&(module.exports=OutputStream);

}).call(this,require("buffer").Buffer)
},{"buffer":114,"data_struct.js":67,"enum.js":68,"util/text_decoder":78,"vm/devices/ram.js":93,"vm/types.js":109}],106:[function(require,module,exports){
function RangedHashImp(){this._items=[]}var ranged_hash_proxy={get:function(t,n){return t[n]?t[n]:t.get(n)}};function RangedHash(){var t=new RangedHashImp;return new Proxy(t,ranged_hash_proxy)}function RangeElement(t,n,e){if(n<=t)throw RangedHash.InvalidRangeError;this.start=t,this.ending=n,this.value=e,this.length=this.ending-this.start}RangedHash.AddressUsedError=function(t,n){this.msg="Address ranged is already mapped",this.starting=t,this.ending=n},RangedHash.AddressUsedError.prototype.toString=function(){var t="null";return null!=this.starting&&(t=this.starting.toString(10)+" 0x"+this.starting.toString(16),null!=this.ending&&(t+=" to ",t+=this.ending.toString(10)+" 0x"+this.ending.toString(16))),this.msg+": "+t},RangedHash.InvalidAddressError=function(t){this.msg="Invalid address",this.addr=t},RangedHash.InvalidAddressError.prototype.toString=function(){var t="null";return null!=this.addr&&(t=this.addr.toString(10)+" 0x"+this.addr.toString(16)),this.msg+": "+t},RangedHash.InvalidRangeError="Invalid range",RangedHashImp.prototype.add=function(t,n,e){try{if(this.get(t))throw new RangedHash.AddressUsedError(t,n)}catch(r){if(!(r instanceof RangedHash.InvalidAddressError))throw r;this._items.push(new RangeElement(t,n,e))}},RangedHashImp.prototype.remove=function(t){var n=this.getn(t);delete this._items[n]},RangedHashImp.prototype.getn=function(t){for(var n in this._items){var e=this._items[n];if(t>=e.start&&t<e.ending)return n}throw new RangedHash.InvalidAddressError(t)},RangedHashImp.prototype.gete=function(t){return this._items[this.getn(t)]},RangedHashImp.prototype.get=function(t){return this.gete(t).value},RangedHashImp.prototype.each=function(t){for(var n in this._items)t(this._items[n],n);return this},RangedHashImp.prototype.collect=function(t){var n=[];for(var e in this._items)n.push(t(this._items[e],e));return n},"undefined"!=typeof module&&(module.exports=RangedHash),"undefined"!=typeof window&&(window.RangedHash=RangedHash);

},{}],107:[function(require,module,exports){
(function (global){
("undefined"!=typeof window&&!window.VM||"undefined"!=typeof global&&!global.VM)&&(VM={});const DataStruct=require("data_struct.js");VM.RingBuffer=function(e,t){"number"==typeof e?(this.ds=VM.RingBuffer.DataStruct(e,t),this.buffer=this.ds.allocate()):(this.ds=e,this.buffer=t||this.ds.allocate())},VM.RingBuffer.DataStruct=function(e,t){return new DataStruct([["read_offset",VM.TYPES.ULONG],["write_offset",VM.TYPES.ULONG],["buffer",e,t||VM.TYPES.ULONG]])},VM.RingBuffer.prototype.length=function(){var e=this.buffer.write_offset-this.buffer.read_offset;return e<0&&(e=this.capacity()+e),e},VM.RingBuffer.prototype.freed=function(){return this.capacity()-this.length()},VM.RingBuffer.prototype.full=function(){return this.length()==this.buffer.buffer.length-1},VM.RingBuffer.prototype.empty=function(){return this.buffer.read_offset==this.buffer.write_offset},VM.RingBuffer.prototype.clear=function(){return this.buffer.read_offset=this.buffer.write_offset=0,this},VM.RingBuffer.prototype.push=function(e){return this.full()?null:("object"==typeof e?this.buffer.buffer[this.buffer.write_offset].update_from(e):this.buffer.buffer[this.buffer.write_offset]=e,this.buffer.write_offset=(this.buffer.write_offset+1)%this.buffer.buffer.length,this)},VM.RingBuffer.prototype.shift=function(){if(this.empty())return null;var e=this.buffer.buffer[this.buffer.read_offset];return this.buffer.read_offset=(this.buffer.read_offset+1)%this.buffer.buffer.length,e},VM.RingBuffer.prototype.pop=function(){},VM.RingBuffer.prototype.unshift=function(){},VM.RingBuffer.prototype.capacity=function(){return this.buffer.buffer.length},VM.RingBuffer.test_suite=function(){var e=require("asserts"),t=32,f=VM.RingBuffer.DataStruct(t),u=new VM.RingBuffer(f);e.equal(u.length(),0,"no items"),e.equal(u.capacity(),t,"correct limit"),e.equal(u.freed(),t,"no items, so full limit"),e.equal(u.full(),!1,"is empty"),e.equal(u.empty(),!0,"is empty"),u.push(123),e.equal(u.length(),1,"has an item"),e.equal(u.freed(),u.capacity()-1,"less a free slot"),e.equal(u.shift(),123,"shifts off the pushed item"),e.equal(u.length(),0,"back to empty"),e.equal(u.empty(),!0,"back to empty"),e.equal(u.freed(),t,"no items, so full limit");for(var r=0;r<31;r++)e.assert(u.push(r),"returns null on fail "+r),e.equal(u.length(),r+1,"one for one increases");e.equal(u.full(),!0,"is full"),e.equal(u.push(123),null,"adds no more");for(r=0;r<31;r++)e.equal(u.shift(),r,"shifts off the order the were pushed"),e.equal(u.length(),31-(r+1),"size decreases");e.equal(u.empty(),!0,"is empty"),e.equal(u.full(),!1,"not full"),e.equal(u.shift(),null,"shifts null when empty"),u.push(123).push(456),e.equal(u.length(),2,"length matches"),u.clear(),e.equal(u.empty(),!0,"now empty"),e.equal(u.length(),0,"length is 0");f=new DataStruct([["a",VM.TYPES.ULONG],["b",VM.TYPES.BYTE]]);var i=VM.RingBuffer.DataStruct(4,f),s=new VM.RingBuffer(i),n=f.allocate().update_from({a:123,b:45});return e.assert(s.push(n),"pushes structs"),e.equal(s.shift(),n,"shifts structs"),u},"undefined"!=typeof module&&(module.exports=VM.RingBuffer);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"asserts":66,"data_struct.js":67}],108:[function(require,module,exports){
function Worker(){}function dirname(r){var e=r.split("/");return e.slice(0,e.length-1).join("/")}function pathjoin(r,e){return r+"/"+e}Worker.register=function(r,e){var o=dirname(e.pathname);return navigator.serviceWorker.register(pathjoin(o,r),{scope:o+"/"}).then(r=>{console.log("Worker registered"),this.registration=r}).catch(r=>{console.log("Worker register error",r),this.error=r,this.registration=null})},"undefined"!=typeof module&&(module.exports=Worker);

},{}],109:[function(require,module,exports){
(function (global){
"use strict";const util=require("util.js");("undefined"!=typeof window&&!window.VM||"undefined"!=typeof global&&!global.VM)&&(VM={}),VM.Type=function(name,id,js_name,min,max){this.name=name,this.id=id,this.js_name=js_name,this.array=eval(this.js_name+"Array"),this.byte_size=this.array.BYTES_PER_ELEMENT,this.array_getter="get"+this.js_name,this.array_setter="set"+this.js_name,this.min=min,this.max=max},VM.Type.prototype.get=function(t,e,n){return null==n&&(n=!0),t[this.array_getter](e,n)},VM.Type.prototype.set=function(t,e,n,E){return null==E&&(E=!0),t[this.array_setter](e,n,!0)},VM.Type.prototype.proxy=function(t,e,n){return new this.array(t,e,n)},VM.TYPE_SIGNED=8;const FLOAT32_MAX=3.402823e38,FLOAT64_MAX=3.402823e307;for(var name in VM.TYPE_DEFS={LONG:[0|VM.TYPE_SIGNED,"Int32",-2147483647,2147483647],BYTE:[1|VM.TYPE_SIGNED,"Int8",-127,127],SHORT:[2|VM.TYPE_SIGNED,"Int16",-32767,32767],FLOAT:[4,"Float32",-FLOAT32_MAX,FLOAT32_MAX],DOUBLE:[5,"Float64",-FLOAT64_MAX,FLOAT64_MAX],ULONG:[0,"Uint32",0,4294967295],UBYTE:[1,"Uint8",0,255],USHORT:[2,"Uint16",0,65535],POINTER:[6,"Uint32",0,4294967295]},VM.TYPES=util.map_each(VM.TYPE_DEFS,function(t,e){return new VM.Type(t,e[0],e[1],e[2],e[3])}),VM.TYPES){var t=VM.TYPES[name];VM.TYPES[t.id]=t}VM.TYPE_IDS=util.map_each(VM.TYPES,function(t,e){return e.id}),VM.TYPE_IDS[VM.TYPE_IDS.FLOAT|VM.TYPE_SIGNED]=VM.TYPE_IDS.FLOAT,VM.TYPES[VM.TYPE_IDS.FLOAT|VM.TYPE_SIGNED]=VM.TYPES.FLOAT,VM.TYPE_IDS[VM.TYPE_IDS.DOUBLE|VM.TYPE_SIGNED]=VM.TYPE_IDS.DOUBLE,VM.TYPES[VM.TYPE_IDS.DOUBLE|VM.TYPE_SIGNED]=VM.TYPES.DOUBLE;

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"util.js":77}],110:[function(require,module,exports){
function vm_generate_c_register_classes(){for(var e=[],n=0;n<VM.CPU.REGISTERS.SP;n++){var r="RC_INT | RC_FLOAT | RC_R"+n;n%2==1&&(r+=" | RC_INT_BSIDE"),e.push(r)}for(n=VM.CPU.REGISTERS.SP;n<VM.CPU.REGISTER_COUNT;n++)e.push("RC_R"+n);return"ST_DATA const int reg_classes[NB_REGS] = {\n"+e.join(",\n")+"\n};"}function vm_generate_c_register_class_names(){var e=[];for(var n in VM.CPU.REGISTERS){var r=VM.CPU.REGISTERS[n];e[r]||(e[r]=n)}var _=map_each_n(e,function(e,n){return"#define RC_"+e+"\t0x"+(1<<n+2).toString(16)});for(n=0;n<VM.CPU.REGISTER_COUNT;n++)_.push("#define RC_R"+n+"\t0x"+(1<<n+2).toString(16));return _.sort().join("\n")}function vm_generate_c_registers(){var e=[];for(var n in VM.CPU.REGISTERS){var r=VM.CPU.REGISTERS[n];e[r]||(e[r]=n)}var _=map_each_n(e,function(e,n){return"#define BC_REG_"+e+"\t0x"+n.toString(16)});for(n=0;n<VM.CPU.REGISTER_COUNT;n++)_.push("#define BC_REG_R"+n+"\t0x"+n.toString(16));return _.sort().join("\n")}function each_ins(e,n,r){r||(r=[]),e||(e=VM.CPU.INS_DISPATCH);for(var _=e.max,t=0;t<=_;t++)try{var a=e.get(e.mask_op(t));a.name?r.push(n(a)):a.mask&&each_ins(a,n,r)}catch(e){if(e!=DispatchTable.UnknownKeyError)throw e}return r}function vm_generate_c_ops(){return each_ins(VM.CPU.INS_DISPATCH,function(e,n){return"#define BC_OP_"+e.name+"\t0x"+e.op.toString(16)}).sort().join("\n")}function vm_generate_c_header(){return["#ifndef BACAW_VM_H","#define BACAW_VM_H","","#define NB_REGS\t"+VM.CPU.REGISTER_COUNT,"",vm_generate_c_registers(),"",vm_generate_c_register_class_names(),"",vm_generate_c_register_classes(),"",vm_generate_c_ops(),"","#endif /* BACAW_VM_H_ */"].join("\n")}require("vm.js");

},{"vm.js":80}],111:[function(require,module,exports){
const DispatchTable=require("vm/dispatch_table.js"),util=require("util.js");function html_append(e,t){"object"==typeof t?e.appendChild(t):e.innerHTML=t}function html_table(e,t,n){var a=document.createElement("table");if(n){var r=document.createElement("tr"),d=document.createElement("td");r.appendChild(d),a.appendChild(r);for(var l=0;l<n.length;l++){d=document.createElement("td");r.appendChild(d),html_append(d,n[l])}}for(var c=0;c<e.length;c++){var o=e[c];r=document.createElement("tr");if(a.appendChild(r),t&&t[c])html_append(d=document.createElement("td"),t[c]),r.appendChild(d);for(l=0;l<o.length;l++){html_append(d=document.createElement("td"),o[l]),r.appendChild(d)}}return a}function html_attr_table(e){var t=document.createElement("table");for(var n in e){var a=document.createElement("tr");t.appendChild(a);var r=document.createElement("th");r.textContent=n,a.appendChild(r);var d=document.createElement("td");d.textContent=e[n],a.appendChild(d)}return t}function html_dl(e){var t=document.createElement("dl");for(var n in e){var a=document.createElement("dt");html_append(t,n),t.appendChild(a);var r=document.createElement("dd");html_append(r,e[n]),t.appendChild(r)}return t}function html_dl_arr(e){for(var t=document.createElement("dl"),n=0;n<e.length;n++){var a=e[n],r=document.createElement("dt");html_append(r,a[0]),t.appendChild(r);var d=document.createElement("dd");html_append(d,a[1]),t.appendChild(d)}return t}function build_ins_doc_def(e){var t=document.createElement("div");t.className="hover doc";var n,a,r,d="ins-"+(e&&e.name||"noname")+"-doc";if(t.id=d,e){var l=document.createElement("a");l.name=d,t.appendChild(l);var c=document.createElement("span");c.className="bacaw",c.textContent=util.map_each_n((e.op.toString(16).padStart(2,"0").match(/../g)||[]).reverse(),function(e){return e}).join(),t.appendChild(c);var o=document.createElement("p");o.textContent=e.doc,t.appendChild(o);var i=[];for(var m in e.arg_masks)n=e.arg_masks[m],a=void 0,r=void 0,a=n.shiftr,r=(r=n.mask.toString(16)).padStart(2*VM.CPU.INSTRUCTION_SIZE,"0"),i.push([m,r,">>"+a]);e.has_literal&&i.push(["","data",e.has_literal.name]),t.appendChild(html_table(i))}return t}function build_ins_doc_table(){for(var e=[],t=[],n=[],a=0;a<16;a++){(d=document.createElement("span")).className="bacaw",d.textContent=a.toString(16)+"0",n[a]=d}for(var r=0;r<16;r++){var d;(d=document.createElement("span")).className="bacaw",d.textContent=r.toString(16),t[r]=d,e[r]=[];for(a=0;a<16;a++){var l,c=document.createElement("div");c.className="instruction";try{(l=VM.CPU.INS_DISPATCH.get(r)).constructor==DispatchTable&&(l=l.get(a<<4))}catch(e){if(e!=DispatchTable.UnknownKeyError)throw e;l=null}if(l){c.onclick=function(e){return function(t){window.location.hash="ins-"+e.name+"-doc"}}(l);var o=document.createElement("p");o.className="name",o.textContent=l.name,l.impl?o.className+=" implemented":o.className+=" not-implemented",c.appendChild(o)}e[r][a]=c}}return html_table(e,t,n)}function collect_ins(e,t){t||(t=[]),e||(e=VM.CPU.INS_DISPATCH);for(var n=e.max,a=0;a<=n;a++)try{var r=e.get(e.mask_op(a));r.name?t.push([r.name,build_ins_doc_def(r)]):r.mask&&collect_ins(r,t)}catch(e){if(e!=DispatchTable.UnknownKeyError)throw e}return t}function build_ins_list(){return html_dl_arr(collect_ins(VM.CPU.INS_DISPATCH).sort(function(e,t){return e[0]<t[0]?-1:e[0]>t[0]?1:0}))}function build_ins_doc(){var e=build_ins_doc_table(),t=build_ins_list(),n=document.createElement("div");return n.appendChild(e),n.appendChild(t),n}function build_reg_doc(){var e=document.createElement("div"),t=[];for(var n in VM.CPU.REGISTERS)t[VM.CPU.REGISTERS[n]]||(t[VM.CPU.REGISTERS[n]]=[VM.CPU.REGISTERS[n].toString(16),n]);for(n=0;n<VM.CPU.REGISTER_COUNT;n++)t[n]||(t[n]=[n.toString(16).padStart(2,"0"),"R"+n]);return e.appendChild(html_table(t)),e}require("vm.js"),"undefined"!=typeof module&&(module.exports={build_reg_doc:build_reg_doc,build_ins_doc:build_ins_doc});

},{"util.js":77,"vm.js":80,"vm/dispatch_table.js":102}],112:[function(require,module,exports){
(function (global){
"use strict";require("vm");const Terminal=require("vm/devices/terminal"),DevCon=require("vm/devices/console.js"),RAM=require("vm/devices/ram.js"),Timer=require("vm/devices/timer.js"),RTC=require("vm/devices/rtc.js"),Sound=require("vm/devices/sound.js"),KeyStore=require("vm/devices/keystore.js"),KeyValue=require("key_value"),VMWorker=require("vm/service_worker"),Binaries={},BinaryURLs=["north-stage0.bin","north-stage1.bin","north-stage0-min.bin","north-stage1-min.bin"],DefaultStage="north-stage1.bin";function basename(e){var r=e.split("/");return r[r.length-1]}function index_init(e,r,n){console.log("Initializing...");var i=document.getElementById(n.run),a=document.getElementById(n.reset),t=document.getElementById(n.reload),o=document.getElementById(n.stage_selector);VMWorker.register("service_worker.js",window.location).then(e=>{e,console.log("ServiceWorker register",e)}).catch(e=>{console.log("ServiceWorker failed to register",e)});var m=new Terminal(document.getElementById(r),{fontFamily:'"Unscii 8", Inconsolata, Unifont, "GNU Unifont", courier-new, courier, monospace',fontSize:16,scrollBar:!1}),d=vm_init(e,m,{run:function(e){i.value="Stop"},stopped:function(e){i.value="Run"}});for(var u of(i.onclick=function(){d.running?d.stop():d.run()},a.onclick=function(){m.clear(),d.reset()},t.onclick=function(){var e=Binaries[o.value];null==e&&(e=Binaries[DefaultStage]),d.mem.memwrite(0,e)},o.onchange=function(){d.mem.memwrite(0,Binaries[o.value])},BinaryURLs))global.fetch(u).then(e=>{e.ok&&e.arrayBuffer().then(r=>{var n=basename(new URL(e.url).pathname),i=document.createElement("option");i.value=n,i.innerText=n,o.appendChild(i),Binaries[n]=new Uint8Array(r),n==DefaultStage&&(o.value=n,d.mem.memwrite(0,Binaries[n]))})})}function vm_init(e,r,n){var i=new VM.Container(n);"undefined"!=typeof window&&(window.vm=i);var a=new VM.MemoryBus;a.map_memory(0,e,new RAM(e)),i.add_device(a);var t=new VM.CPU(a,e);i.add_device(t);var o=new DevCon;a.map_memory(4026535936,o.ram_size(),o),i.add_device(o);var m=i.interrupt_handle(VM.CPU.INTERRUPTS.user+2),d=new Timer(m,1<<20);a.map_memory(4026540032,d.ram_size(),d),i.add_device(d);var u=new RTC;a.map_memory(4026556416,u.ram_size(),u),i.add_device(u);var s=new KeyValue.Storage(localStorage),l=i.interrupt_handle(VM.CPU.INTERRUPTS.user+6),c=new KeyStore(s,a,l,"LocalStorage");i.mem.map_memory(4026560512,c.ram_size(),c),i.add_device(c);var v=new KeyValue.Storage(sessionStorage),_=i.interrupt_handle(VM.CPU.INTERRUPTS.user+7),y=new KeyStore(v,a,_,"SessionStorage");i.mem.map_memory(4026564608,y.ram_size(),y),i.add_device(y);var S=new KeyValue.IDB("bacaw",e=>{console.log("IDBStore",e)}),p=i.interrupt_handle(VM.CPU.INTERRUPTS.user+8),g=new KeyStore(S,a,p,"IndexedDB Storage");i.mem.map_memory(4026568704,g.ram_size(),g),i.add_device(g);var w=new KeyValue.IPFS(global.IPFS),T=i.interrupt_handle(VM.CPU.INTERRUPTS.user+9),f=new KeyStore(w,a,T,"IPFS Storage");i.mem.map_memory(4026572800,f.ram_size(),f),i.add_device(f);var U=new KeyValue.HTTP(global.fetch),R=i.interrupt_handle(VM.CPU.INTERRUPTS.user+10),P=new KeyStore(U,a,R,"HTTP Storage");i.mem.map_memory(4026576896,P.ram_size(),P),i.add_device(P);var h=new KeyValue.Table,I=i.interrupt_handle(VM.CPU.INTERRUPTS.user+11),V=new KeyStore(h,a,I,"Table Storage");i.mem.map_memory(4026580992,V.ram_size(),V),i.add_device(V);var B=i.interrupt_handle(VM.CPU.INTERRUPTS.user+4),M=r.get_input_device(1024,B);i.mem.map_memory(4026548224,M.ram_size(),M),i.add_device(M);var C=i.interrupt_handle(VM.CPU.INTERRUPTS.user+3),E=r.get_output_device(1024,C);i.mem.map_memory(4026544128,E.ram_size(),E),i.add_device(E);var q=i.interrupt_handle(VM.CPU.INTERRUPTS.user+12),z=new Sound(32,a,q,"Sound");return i.mem.map_memory(4026585088,z.ram_size(),z),i.add_device(z),i.info={devcon:{addr:4026535936},timer:{addr:4026540032,irq:m},rtc:{addr:4026556416},input:{addr:4026548224,irq:B},output:{addr:4026544128,irq:C},sound:{addr:4026585088,irq:q.toInt()}},i}"undefined"!=typeof module&&(module.exports=index_init),"undefined"!=typeof window&&(window.index_init=index_init);

}).call(this,typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"key_value":69,"vm":121,"vm/devices/console.js":84,"vm/devices/keystore.js":90,"vm/devices/ram.js":93,"vm/devices/rtc.js":94,"vm/devices/sound.js":95,"vm/devices/terminal":100,"vm/devices/timer.js":101,"vm/service_worker":108}],113:[function(require,module,exports){
"use strict";exports.byteLength=byteLength,exports.toByteArray=toByteArray,exports.fromByteArray=fromByteArray;for(var lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;i<len;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;function getLens(o){var r=o.length;if(r%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=o.indexOf("=");return-1===e&&(e=r),[e,e===r?0:4-e%4]}function byteLength(o){var r=getLens(o),e=r[0],t=r[1];return 3*(e+t)/4-t}function _byteLength(o,r,e){return 3*(r+e)/4-e}function toByteArray(o){for(var r,e=getLens(o),t=e[0],n=e[1],u=new Arr(_byteLength(o,t,n)),p=0,a=n>0?t-4:t,h=0;h<a;h+=4)r=revLookup[o.charCodeAt(h)]<<18|revLookup[o.charCodeAt(h+1)]<<12|revLookup[o.charCodeAt(h+2)]<<6|revLookup[o.charCodeAt(h+3)],u[p++]=r>>16&255,u[p++]=r>>8&255,u[p++]=255&r;return 2===n&&(r=revLookup[o.charCodeAt(h)]<<2|revLookup[o.charCodeAt(h+1)]>>4,u[p++]=255&r),1===n&&(r=revLookup[o.charCodeAt(h)]<<10|revLookup[o.charCodeAt(h+1)]<<4|revLookup[o.charCodeAt(h+2)]>>2,u[p++]=r>>8&255,u[p++]=255&r),u}function tripletToBase64(o){return lookup[o>>18&63]+lookup[o>>12&63]+lookup[o>>6&63]+lookup[63&o]}function encodeChunk(o,r,e){for(var t,n=[],u=r;u<e;u+=3)t=(o[u]<<16&16711680)+(o[u+1]<<8&65280)+(255&o[u+2]),n.push(tripletToBase64(t));return n.join("")}function fromByteArray(o){for(var r,e=o.length,t=e%3,n=[],u=0,p=e-t;u<p;u+=16383)n.push(encodeChunk(o,u,u+16383>p?p:u+16383));return 1===t?(r=o[e-1],n.push(lookup[r>>2]+lookup[r<<4&63]+"==")):2===t&&(r=(o[e-2]<<8)+o[e-1],n.push(lookup[r>>10]+lookup[r>>4&63]+lookup[r<<2&63]+"=")),n.join("")}revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63;

},{}],114:[function(require,module,exports){
"use strict";var base64=require("base64-js"),ieee754=require("ieee754");exports.Buffer=Buffer,exports.SlowBuffer=SlowBuffer,exports.INSPECT_MAX_BYTES=50;var K_MAX_LENGTH=2147483647;function typedArraySupport(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()}catch(e){return!1}}function createBuffer(e){if(e>K_MAX_LENGTH)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=Buffer.prototype,t}function Buffer(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return allocUnsafe(e)}return from(e,t,r)}function from(e,t,r){if("string"==typeof e)return fromString(e,t);if(ArrayBuffer.isView(e))return fromArrayLike(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(isInstance(e,ArrayBuffer)||e&&isInstance(e.buffer,ArrayBuffer))return fromArrayBuffer(e,t,r);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return Buffer.from(n,t,r);var f=fromObject(e);if(f)return f;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return Buffer.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function assertSize(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function alloc(e,t,r){return assertSize(e),e<=0?createBuffer(e):void 0!==t?"string"==typeof r?createBuffer(e).fill(t,r):createBuffer(e).fill(t):createBuffer(e)}function allocUnsafe(e){return assertSize(e),createBuffer(e<0?0:0|checked(e))}function fromString(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!Buffer.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var r=0|byteLength(e,t),n=createBuffer(r),f=n.write(e,t);return f!==r&&(n=n.slice(0,f)),n}function fromArrayLike(e){for(var t=e.length<0?0:0|checked(e.length),r=createBuffer(t),n=0;n<t;n+=1)r[n]=255&e[n];return r}function fromArrayBuffer(e,t,r){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw new RangeError('"length" is outside of buffer bounds');var n;return(n=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r)).__proto__=Buffer.prototype,n}function fromObject(e){if(Buffer.isBuffer(e)){var t=0|checked(e.length),r=createBuffer(t);return 0===r.length?r:(e.copy(r,0,0,t),r)}return void 0!==e.length?"number"!=typeof e.length||numberIsNaN(e.length)?createBuffer(0):fromArrayLike(e):"Buffer"===e.type&&Array.isArray(e.data)?fromArrayLike(e.data):void 0}function checked(e){if(e>=K_MAX_LENGTH)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+K_MAX_LENGTH.toString(16)+" bytes");return 0|e}function SlowBuffer(e){return+e!=e&&(e=0),Buffer.alloc(+e)}function byteLength(e,t){if(Buffer.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||isInstance(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var r=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;for(var f=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return utf8ToBytes(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return base64ToBytes(e).length;default:if(f)return n?-1:utf8ToBytes(e).length;t=(""+t).toLowerCase(),f=!0}}function slowToString(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return hexSlice(this,t,r);case"utf8":case"utf-8":return utf8Slice(this,t,r);case"ascii":return asciiSlice(this,t,r);case"latin1":case"binary":return latin1Slice(this,t,r);case"base64":return base64Slice(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function swap(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function bidirectionalIndexOf(e,t,r,n,f){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),numberIsNaN(r=+r)&&(r=f?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(f)return-1;r=e.length-1}else if(r<0){if(!f)return-1;r=0}if("string"==typeof t&&(t=Buffer.from(t,n)),Buffer.isBuffer(t))return 0===t.length?-1:arrayIndexOf(e,t,r,n,f);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?f?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):arrayIndexOf(e,[t],r,n,f);throw new TypeError("val must be string, number or Buffer")}function arrayIndexOf(e,t,r,n,f){var i,o=1,u=e.length,s=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;o=2,u/=2,s/=2,r/=2}function a(e,t){return 1===o?e[t]:e.readUInt16BE(t*o)}if(f){var h=-1;for(i=r;i<u;i++)if(a(e,i)===a(t,-1===h?0:i-h)){if(-1===h&&(h=i),i-h+1===s)return h*o}else-1!==h&&(i-=i-h),h=-1}else for(r+s>u&&(r=u-s),i=r;i>=0;i--){for(var c=!0,l=0;l<s;l++)if(a(e,i+l)!==a(t,l)){c=!1;break}if(c)return i}return-1}function hexWrite(e,t,r,n){r=Number(r)||0;var f=e.length-r;n?(n=Number(n))>f&&(n=f):n=f;var i=t.length;n>i/2&&(n=i/2);for(var o=0;o<n;++o){var u=parseInt(t.substr(2*o,2),16);if(numberIsNaN(u))return o;e[r+o]=u}return o}function utf8Write(e,t,r,n){return blitBuffer(utf8ToBytes(t,e.length-r),e,r,n)}function asciiWrite(e,t,r,n){return blitBuffer(asciiToBytes(t),e,r,n)}function latin1Write(e,t,r,n){return asciiWrite(e,t,r,n)}function base64Write(e,t,r,n){return blitBuffer(base64ToBytes(t),e,r,n)}function ucs2Write(e,t,r,n){return blitBuffer(utf16leToBytes(t,e.length-r),e,r,n)}function base64Slice(e,t,r){return 0===t&&r===e.length?base64.fromByteArray(e):base64.fromByteArray(e.slice(t,r))}function utf8Slice(e,t,r){r=Math.min(e.length,r);for(var n=[],f=t;f<r;){var i,o,u,s,a=e[f],h=null,c=a>239?4:a>223?3:a>191?2:1;if(f+c<=r)switch(c){case 1:a<128&&(h=a);break;case 2:128==(192&(i=e[f+1]))&&(s=(31&a)<<6|63&i)>127&&(h=s);break;case 3:i=e[f+1],o=e[f+2],128==(192&i)&&128==(192&o)&&(s=(15&a)<<12|(63&i)<<6|63&o)>2047&&(s<55296||s>57343)&&(h=s);break;case 4:i=e[f+1],o=e[f+2],u=e[f+3],128==(192&i)&&128==(192&o)&&128==(192&u)&&(s=(15&a)<<18|(63&i)<<12|(63&o)<<6|63&u)>65535&&s<1114112&&(h=s)}null===h?(h=65533,c=1):h>65535&&(h-=65536,n.push(h>>>10&1023|55296),h=56320|1023&h),n.push(h),f+=c}return decodeCodePointsArray(n)}exports.kMaxLength=K_MAX_LENGTH,Buffer.TYPED_ARRAY_SUPPORT=typedArraySupport(),Buffer.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(Buffer.prototype,"parent",{enumerable:!0,get:function(){if(Buffer.isBuffer(this))return this.buffer}}),Object.defineProperty(Buffer.prototype,"offset",{enumerable:!0,get:function(){if(Buffer.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&Buffer[Symbol.species]===Buffer&&Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),Buffer.poolSize=8192,Buffer.from=function(e,t,r){return from(e,t,r)},Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array,Buffer.alloc=function(e,t,r){return alloc(e,t,r)},Buffer.allocUnsafe=function(e){return allocUnsafe(e)},Buffer.allocUnsafeSlow=function(e){return allocUnsafe(e)},Buffer.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==Buffer.prototype},Buffer.compare=function(e,t){if(isInstance(e,Uint8Array)&&(e=Buffer.from(e,e.offset,e.byteLength)),isInstance(t,Uint8Array)&&(t=Buffer.from(t,t.offset,t.byteLength)),!Buffer.isBuffer(e)||!Buffer.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;for(var r=e.length,n=t.length,f=0,i=Math.min(r,n);f<i;++f)if(e[f]!==t[f]){r=e[f],n=t[f];break}return r<n?-1:n<r?1:0},Buffer.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return Buffer.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var n=Buffer.allocUnsafe(t),f=0;for(r=0;r<e.length;++r){var i=e[r];if(isInstance(i,Uint8Array)&&(i=Buffer.from(i)),!Buffer.isBuffer(i))throw new TypeError('"list" argument must be an Array of Buffers');i.copy(n,f),f+=i.length}return n},Buffer.byteLength=byteLength,Buffer.prototype._isBuffer=!0,Buffer.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)swap(this,t,t+1);return this},Buffer.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)swap(this,t,t+3),swap(this,t+1,t+2);return this},Buffer.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)swap(this,t,t+7),swap(this,t+1,t+6),swap(this,t+2,t+5),swap(this,t+3,t+4);return this},Buffer.prototype.toString=function(){var e=this.length;return 0===e?"":0===arguments.length?utf8Slice(this,0,e):slowToString.apply(this,arguments)},Buffer.prototype.toLocaleString=Buffer.prototype.toString,Buffer.prototype.equals=function(e){if(!Buffer.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===Buffer.compare(this,e)},Buffer.prototype.inspect=function(){var e="",t=exports.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"},Buffer.prototype.compare=function(e,t,r,n,f){if(isInstance(e,Uint8Array)&&(e=Buffer.from(e,e.offset,e.byteLength)),!Buffer.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===f&&(f=this.length),t<0||r>e.length||n<0||f>this.length)throw new RangeError("out of range index");if(n>=f&&t>=r)return 0;if(n>=f)return-1;if(t>=r)return 1;if(this===e)return 0;for(var i=(f>>>=0)-(n>>>=0),o=(r>>>=0)-(t>>>=0),u=Math.min(i,o),s=this.slice(n,f),a=e.slice(t,r),h=0;h<u;++h)if(s[h]!==a[h]){i=s[h],o=a[h];break}return i<o?-1:o<i?1:0},Buffer.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},Buffer.prototype.indexOf=function(e,t,r){return bidirectionalIndexOf(this,e,t,r,!0)},Buffer.prototype.lastIndexOf=function(e,t,r){return bidirectionalIndexOf(this,e,t,r,!1)},Buffer.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var f=this.length-t;if((void 0===r||r>f)&&(r=f),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var i=!1;;)switch(n){case"hex":return hexWrite(this,e,t,r);case"utf8":case"utf-8":return utf8Write(this,e,t,r);case"ascii":return asciiWrite(this,e,t,r);case"latin1":case"binary":return latin1Write(this,e,t,r);case"base64":return base64Write(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,e,t,r);default:if(i)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),i=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;function decodeCodePointsArray(e){var t=e.length;if(t<=MAX_ARGUMENTS_LENGTH)return String.fromCharCode.apply(String,e);for(var r="",n=0;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=MAX_ARGUMENTS_LENGTH));return r}function asciiSlice(e,t,r){var n="";r=Math.min(e.length,r);for(var f=t;f<r;++f)n+=String.fromCharCode(127&e[f]);return n}function latin1Slice(e,t,r){var n="";r=Math.min(e.length,r);for(var f=t;f<r;++f)n+=String.fromCharCode(e[f]);return n}function hexSlice(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var f="",i=t;i<r;++i)f+=toHex(e[i]);return f}function utf16leSlice(e,t,r){for(var n=e.slice(t,r),f="",i=0;i<n.length;i+=2)f+=String.fromCharCode(n[i]+256*n[i+1]);return f}function checkOffset(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function checkInt(e,t,r,n,f,i){if(!Buffer.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>f||t<i)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function checkIEEE754(e,t,r,n,f,i){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function writeFloat(e,t,r,n,f){return t=+t,r>>>=0,f||checkIEEE754(e,t,r,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(e,t,r,n,23,4),r+4}function writeDouble(e,t,r,n,f){return t=+t,r>>>=0,f||checkIEEE754(e,t,r,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(e,t,r,n,52,8),r+8}Buffer.prototype.slice=function(e,t){var r=this.length;(e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e);var n=this.subarray(e,t);return n.__proto__=Buffer.prototype,n},Buffer.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||checkOffset(e,t,this.length);for(var n=this[e],f=1,i=0;++i<t&&(f*=256);)n+=this[e+i]*f;return n},Buffer.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||checkOffset(e,t,this.length);for(var n=this[e+--t],f=1;t>0&&(f*=256);)n+=this[e+--t]*f;return n},Buffer.prototype.readUInt8=function(e,t){return e>>>=0,t||checkOffset(e,1,this.length),this[e]},Buffer.prototype.readUInt16LE=function(e,t){return e>>>=0,t||checkOffset(e,2,this.length),this[e]|this[e+1]<<8},Buffer.prototype.readUInt16BE=function(e,t){return e>>>=0,t||checkOffset(e,2,this.length),this[e]<<8|this[e+1]},Buffer.prototype.readUInt32LE=function(e,t){return e>>>=0,t||checkOffset(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},Buffer.prototype.readUInt32BE=function(e,t){return e>>>=0,t||checkOffset(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},Buffer.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||checkOffset(e,t,this.length);for(var n=this[e],f=1,i=0;++i<t&&(f*=256);)n+=this[e+i]*f;return n>=(f*=128)&&(n-=Math.pow(2,8*t)),n},Buffer.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||checkOffset(e,t,this.length);for(var n=t,f=1,i=this[e+--n];n>0&&(f*=256);)i+=this[e+--n]*f;return i>=(f*=128)&&(i-=Math.pow(2,8*t)),i},Buffer.prototype.readInt8=function(e,t){return e>>>=0,t||checkOffset(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},Buffer.prototype.readInt16LE=function(e,t){e>>>=0,t||checkOffset(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},Buffer.prototype.readInt16BE=function(e,t){e>>>=0,t||checkOffset(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},Buffer.prototype.readInt32LE=function(e,t){return e>>>=0,t||checkOffset(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},Buffer.prototype.readInt32BE=function(e,t){return e>>>=0,t||checkOffset(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},Buffer.prototype.readFloatLE=function(e,t){return e>>>=0,t||checkOffset(e,4,this.length),ieee754.read(this,e,!0,23,4)},Buffer.prototype.readFloatBE=function(e,t){return e>>>=0,t||checkOffset(e,4,this.length),ieee754.read(this,e,!1,23,4)},Buffer.prototype.readDoubleLE=function(e,t){return e>>>=0,t||checkOffset(e,8,this.length),ieee754.read(this,e,!0,52,8)},Buffer.prototype.readDoubleBE=function(e,t){return e>>>=0,t||checkOffset(e,8,this.length),ieee754.read(this,e,!1,52,8)},Buffer.prototype.writeUIntLE=function(e,t,r,n){(e=+e,t>>>=0,r>>>=0,n)||checkInt(this,e,t,r,Math.pow(2,8*r)-1,0);var f=1,i=0;for(this[t]=255&e;++i<r&&(f*=256);)this[t+i]=e/f&255;return t+r},Buffer.prototype.writeUIntBE=function(e,t,r,n){(e=+e,t>>>=0,r>>>=0,n)||checkInt(this,e,t,r,Math.pow(2,8*r)-1,0);var f=r-1,i=1;for(this[t+f]=255&e;--f>=0&&(i*=256);)this[t+f]=e/i&255;return t+r},Buffer.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||checkInt(this,e,t,1,255,0),this[t]=255&e,t+1},Buffer.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||checkInt(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},Buffer.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||checkInt(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},Buffer.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||checkInt(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},Buffer.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||checkInt(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},Buffer.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var f=Math.pow(2,8*r-1);checkInt(this,e,t,r,f-1,-f)}var i=0,o=1,u=0;for(this[t]=255&e;++i<r&&(o*=256);)e<0&&0===u&&0!==this[t+i-1]&&(u=1),this[t+i]=(e/o>>0)-u&255;return t+r},Buffer.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var f=Math.pow(2,8*r-1);checkInt(this,e,t,r,f-1,-f)}var i=r-1,o=1,u=0;for(this[t+i]=255&e;--i>=0&&(o*=256);)e<0&&0===u&&0!==this[t+i+1]&&(u=1),this[t+i]=(e/o>>0)-u&255;return t+r},Buffer.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||checkInt(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},Buffer.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||checkInt(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},Buffer.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||checkInt(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},Buffer.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||checkInt(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},Buffer.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||checkInt(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},Buffer.prototype.writeFloatLE=function(e,t,r){return writeFloat(this,e,t,!0,r)},Buffer.prototype.writeFloatBE=function(e,t,r){return writeFloat(this,e,t,!1,r)},Buffer.prototype.writeDoubleLE=function(e,t,r){return writeDouble(this,e,t,!0,r)},Buffer.prototype.writeDoubleBE=function(e,t,r){return writeDouble(this,e,t,!1,r)},Buffer.prototype.copy=function(e,t,r,n){if(!Buffer.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var f=n-r;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,r,n);else if(this===e&&r<t&&t<n)for(var i=f-1;i>=0;--i)e[i+t]=this[i+r];else Uint8Array.prototype.set.call(e,this.subarray(r,n),t);return f},Buffer.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!Buffer.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){var f=e.charCodeAt(0);("utf8"===n&&f<128||"latin1"===n)&&(e=f)}}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var i;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(i=t;i<r;++i)this[i]=e;else{var o=Buffer.isBuffer(e)?e:Buffer.from(e,n),u=o.length;if(0===u)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<r-t;++i)this[i+t]=o[i%u]}return this};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;function base64clean(e){if((e=(e=e.split("=")[0]).trim().replace(INVALID_BASE64_RE,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}function toHex(e){return e<16?"0"+e.toString(16):e.toString(16)}function utf8ToBytes(e,t){var r;t=t||1/0;for(var n=e.length,f=null,i=[],o=0;o<n;++o){if((r=e.charCodeAt(o))>55295&&r<57344){if(!f){if(r>56319){(t-=3)>-1&&i.push(239,191,189);continue}if(o+1===n){(t-=3)>-1&&i.push(239,191,189);continue}f=r;continue}if(r<56320){(t-=3)>-1&&i.push(239,191,189),f=r;continue}r=65536+(f-55296<<10|r-56320)}else f&&(t-=3)>-1&&i.push(239,191,189);if(f=null,r<128){if((t-=1)<0)break;i.push(r)}else if(r<2048){if((t-=2)<0)break;i.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;i.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;i.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return i}function asciiToBytes(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}function utf16leToBytes(e,t){for(var r,n,f,i=[],o=0;o<e.length&&!((t-=2)<0);++o)n=(r=e.charCodeAt(o))>>8,f=r%256,i.push(f),i.push(n);return i}function base64ToBytes(e){return base64.toByteArray(base64clean(e))}function blitBuffer(e,t,r,n){for(var f=0;f<n&&!(f+r>=t.length||f>=e.length);++f)t[f+r]=e[f];return f}function isInstance(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function numberIsNaN(e){return e!=e}

},{"base64-js":113,"ieee754":115}],115:[function(require,module,exports){
exports.read=function(a,o,t,r,h){var M,p,w=8*h-r-1,f=(1<<w)-1,e=f>>1,i=-7,N=t?h-1:0,n=t?-1:1,s=a[o+N];for(N+=n,M=s&(1<<-i)-1,s>>=-i,i+=w;i>0;M=256*M+a[o+N],N+=n,i-=8);for(p=M&(1<<-i)-1,M>>=-i,i+=r;i>0;p=256*p+a[o+N],N+=n,i-=8);if(0===M)M=1-e;else{if(M===f)return p?NaN:1/0*(s?-1:1);p+=Math.pow(2,r),M-=e}return(s?-1:1)*p*Math.pow(2,M-r)},exports.write=function(a,o,t,r,h,M){var p,w,f,e=8*M-h-1,i=(1<<e)-1,N=i>>1,n=23===h?Math.pow(2,-24)-Math.pow(2,-77):0,s=r?0:M-1,u=r?1:-1,l=o<0||0===o&&1/o<0?1:0;for(o=Math.abs(o),isNaN(o)||o===1/0?(w=isNaN(o)?1:0,p=i):(p=Math.floor(Math.log(o)/Math.LN2),o*(f=Math.pow(2,-p))<1&&(p--,f*=2),(o+=p+N>=1?n/f:n*Math.pow(2,1-N))*f>=2&&(p++,f/=2),p+N>=i?(w=0,p=i):p+N>=1?(w=(o*f-1)*Math.pow(2,h),p+=N):(w=o*Math.pow(2,N-1)*Math.pow(2,h),p=0));h>=8;a[t+s]=255&w,s+=u,w/=256,h-=8);for(p=p<<h|w,e+=h;e>0;a[t+s]=255&p,s+=u,p/=256,e-=8);a[t+s-u]|=128*l};

},{}],116:[function(require,module,exports){
"function"==typeof Object.create?module.exports=function(t,e){t.super_=e,t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}})}:module.exports=function(t,e){t.super_=e;var o=function(){};o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t};

},{}],117:[function(require,module,exports){
exports.endianness=function(){return"LE"},exports.hostname=function(){return"undefined"!=typeof location?location.hostname:""},exports.loadavg=function(){return[]},exports.uptime=function(){return 0},exports.freemem=function(){return Number.MAX_VALUE},exports.totalmem=function(){return Number.MAX_VALUE},exports.cpus=function(){return[]},exports.type=function(){return"Browser"},exports.release=function(){return"undefined"!=typeof navigator?navigator.appVersion:""},exports.networkInterfaces=exports.getNetworkInterfaces=function(){return{}},exports.arch=function(){return"javascript"},exports.platform=function(){return"browser"},exports.tmpdir=exports.tmpDir=function(){return"/tmp"},exports.EOL="\n",exports.homedir=function(){return"/"};

},{}],118:[function(require,module,exports){
var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(e){if(cachedSetTimeout===setTimeout)return setTimeout(e,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(e,0);try{return cachedSetTimeout(e,0)}catch(t){try{return cachedSetTimeout.call(null,e,0)}catch(t){return cachedSetTimeout.call(this,e,0)}}}function runClearTimeout(e){if(cachedClearTimeout===clearTimeout)return clearTimeout(e);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(e);try{return cachedClearTimeout(e)}catch(t){try{return cachedClearTimeout.call(null,e)}catch(t){return cachedClearTimeout.call(this,e)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var e=runTimeout(cleanUpNextTick);draining=!0;for(var t=queue.length;t;){for(currentQueue=queue,queue=[];++queueIndex<t;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,t=queue.length}currentQueue=null,draining=!1,runClearTimeout(e)}}function Item(e,t){this.fun=e,this.array=t}function noop(){}process.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];queue.push(new Item(e,t)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(e){return[]},process.binding=function(e){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(e){throw new Error("process.chdir is not supported")},process.umask=function(){return 0};

},{}],119:[function(require,module,exports){
module.exports=function(o){return o&&"object"==typeof o&&"function"==typeof o.copy&&"function"==typeof o.fill&&"function"==typeof o.readUInt8};

},{}],120:[function(require,module,exports){
(function (process,global){
var formatRegExp=/%[sdj%]/g;exports.format=function(e){if(!isString(e)){for(var r=[],t=0;t<arguments.length;t++)r.push(inspect(arguments[t]));return r.join(" ")}t=1;for(var n=arguments,i=n.length,o=String(e).replace(formatRegExp,function(e){if("%%"===e)return"%";if(t>=i)return e;switch(e){case"%s":return String(n[t++]);case"%d":return Number(n[t++]);case"%j":try{return JSON.stringify(n[t++])}catch(e){return"[Circular]"}default:return e}}),s=n[t];t<i;s=n[++t])isNull(s)||!isObject(s)?o+=" "+s:o+=" "+inspect(s);return o},exports.deprecate=function(e,r){if(isUndefined(global.process))return function(){return exports.deprecate(e,r).apply(this,arguments)};if(!0===process.noDeprecation)return e;var t=!1;return function(){if(!t){if(process.throwDeprecation)throw new Error(r);process.traceDeprecation?console.trace(r):console.error(r),t=!0}return e.apply(this,arguments)}};var debugEnviron,debugs={};function inspect(e,r){var t={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(t.depth=arguments[2]),arguments.length>=4&&(t.colors=arguments[3]),isBoolean(r)?t.showHidden=r:r&&exports._extend(t,r),isUndefined(t.showHidden)&&(t.showHidden=!1),isUndefined(t.depth)&&(t.depth=2),isUndefined(t.colors)&&(t.colors=!1),isUndefined(t.customInspect)&&(t.customInspect=!0),t.colors&&(t.stylize=stylizeWithColor),formatValue(t,e,t.depth)}function stylizeWithColor(e,r){var t=inspect.styles[r];return t?"["+inspect.colors[t][0]+"m"+e+"["+inspect.colors[t][1]+"m":e}function stylizeNoColor(e,r){return e}function arrayToHash(e){var r={};return e.forEach(function(e,t){r[e]=!0}),r}function formatValue(e,r,t){if(e.customInspect&&r&&isFunction(r.inspect)&&r.inspect!==exports.inspect&&(!r.constructor||r.constructor.prototype!==r)){var n=r.inspect(t,e);return isString(n)||(n=formatValue(e,n,t)),n}var i=formatPrimitive(e,r);if(i)return i;var o=Object.keys(r),s=arrayToHash(o);if(e.showHidden&&(o=Object.getOwnPropertyNames(r)),isError(r)&&(o.indexOf("message")>=0||o.indexOf("description")>=0))return formatError(r);if(0===o.length){if(isFunction(r)){var u=r.name?": "+r.name:"";return e.stylize("[Function"+u+"]","special")}if(isRegExp(r))return e.stylize(RegExp.prototype.toString.call(r),"regexp");if(isDate(r))return e.stylize(Date.prototype.toString.call(r),"date");if(isError(r))return formatError(r)}var c,a="",l=!1,p=["{","}"];(isArray(r)&&(l=!0,p=["[","]"]),isFunction(r))&&(a=" [Function"+(r.name?": "+r.name:"")+"]");return isRegExp(r)&&(a=" "+RegExp.prototype.toString.call(r)),isDate(r)&&(a=" "+Date.prototype.toUTCString.call(r)),isError(r)&&(a=" "+formatError(r)),0!==o.length||l&&0!=r.length?t<0?isRegExp(r)?e.stylize(RegExp.prototype.toString.call(r),"regexp"):e.stylize("[Object]","special"):(e.seen.push(r),c=l?formatArray(e,r,t,s,o):o.map(function(n){return formatProperty(e,r,t,s,n,l)}),e.seen.pop(),reduceToSingleString(c,a,p)):p[0]+a+p[1]}function formatPrimitive(e,r){if(isUndefined(r))return e.stylize("undefined","undefined");if(isString(r)){var t="'"+JSON.stringify(r).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return e.stylize(t,"string")}return isNumber(r)?e.stylize(""+r,"number"):isBoolean(r)?e.stylize(""+r,"boolean"):isNull(r)?e.stylize("null","null"):void 0}function formatError(e){return"["+Error.prototype.toString.call(e)+"]"}function formatArray(e,r,t,n,i){for(var o=[],s=0,u=r.length;s<u;++s)hasOwnProperty(r,String(s))?o.push(formatProperty(e,r,t,n,String(s),!0)):o.push("");return i.forEach(function(i){i.match(/^\d+$/)||o.push(formatProperty(e,r,t,n,i,!0))}),o}function formatProperty(e,r,t,n,i,o){var s,u,c;if((c=Object.getOwnPropertyDescriptor(r,i)||{value:r[i]}).get?u=c.set?e.stylize("[Getter/Setter]","special"):e.stylize("[Getter]","special"):c.set&&(u=e.stylize("[Setter]","special")),hasOwnProperty(n,i)||(s="["+i+"]"),u||(e.seen.indexOf(c.value)<0?(u=isNull(t)?formatValue(e,c.value,null):formatValue(e,c.value,t-1)).indexOf("\n")>-1&&(u=o?u.split("\n").map(function(e){return"  "+e}).join("\n").substr(2):"\n"+u.split("\n").map(function(e){return"   "+e}).join("\n")):u=e.stylize("[Circular]","special")),isUndefined(s)){if(o&&i.match(/^\d+$/))return u;(s=JSON.stringify(""+i)).match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(s=s.substr(1,s.length-2),s=e.stylize(s,"name")):(s=s.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),s=e.stylize(s,"string"))}return s+": "+u}function reduceToSingleString(e,r,t){return e.reduce(function(e,r){return 0,r.indexOf("\n")>=0&&0,e+r.replace(/\u001b\[\d\d?m/g,"").length+1},0)>60?t[0]+(""===r?"":r+"\n ")+" "+e.join(",\n  ")+" "+t[1]:t[0]+r+" "+e.join(", ")+" "+t[1]}function isArray(e){return Array.isArray(e)}function isBoolean(e){return"boolean"==typeof e}function isNull(e){return null===e}function isNullOrUndefined(e){return null==e}function isNumber(e){return"number"==typeof e}function isString(e){return"string"==typeof e}function isSymbol(e){return"symbol"==typeof e}function isUndefined(e){return void 0===e}function isRegExp(e){return isObject(e)&&"[object RegExp]"===objectToString(e)}function isObject(e){return"object"==typeof e&&null!==e}function isDate(e){return isObject(e)&&"[object Date]"===objectToString(e)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(e){return"function"==typeof e}function isPrimitive(e){return null===e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||"symbol"==typeof e||void 0===e}function objectToString(e){return Object.prototype.toString.call(e)}function pad(e){return e<10?"0"+e.toString(10):e.toString(10)}exports.debuglog=function(e){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),e=e.toUpperCase(),!debugs[e])if(new RegExp("\\b"+e+"\\b","i").test(debugEnviron)){var r=process.pid;debugs[e]=function(){var t=exports.format.apply(exports,arguments);console.error("%s %d: %s",e,r,t)}}else debugs[e]=function(){};return debugs[e]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow",boolean:"yellow",undefined:"grey",null:"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var e=new Date,r=[pad(e.getHours()),pad(e.getMinutes()),pad(e.getSeconds())].join(":");return[e.getDate(),months[e.getMonth()],r].join(" ")}function hasOwnProperty(e,r){return Object.prototype.hasOwnProperty.call(e,r)}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(e,r){if(!r||!isObject(r))return e;for(var t=Object.keys(r),n=t.length;n--;)e[t[n]]=r[t[n]];return e};

}).call(this,require('_process'),typeof global !== "undefined" ? global : typeof self !== "undefined" ? self : typeof window !== "undefined" ? window : {})
},{"./support/isBuffer":119,"_process":118,"inherits":116}],121:[function(require,module,exports){
var indexOf=function(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0;n<e.length;n++)if(e[n]===t)return n;return-1},Object_keys=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var n in e)t.push(n);return t},forEach=function(e,t){if(e.forEach)return e.forEach(t);for(var n=0;n<e.length;n++)t(e[n],n,e)},defineProp=function(){try{return Object.defineProperty({},"_",{}),function(e,t,n){Object.defineProperty(e,t,{writable:!0,enumerable:!1,configurable:!0,value:n})}}catch(e){return function(e,t,n){e[t]=n}}}(),globals=["Array","Boolean","Date","Error","EvalError","Function","Infinity","JSON","Math","NaN","Number","Object","RangeError","ReferenceError","RegExp","String","SyntaxError","TypeError","URIError","decodeURI","decodeURIComponent","encodeURI","encodeURIComponent","escape","eval","isFinite","isNaN","parseFloat","parseInt","undefined","unescape"];function Context(){}Context.prototype={};var Script=exports.Script=function(e){if(!(this instanceof Script))return new Script(e);this.code=e};Script.prototype.runInContext=function(e){if(!(e instanceof Context))throw new TypeError("needs a 'context' argument.");var t=document.createElement("iframe");t.style||(t.style={}),t.style.display="none",document.body.appendChild(t);var n=t.contentWindow,r=n.eval,o=n.execScript;!r&&o&&(o.call(n,"null"),r=n.eval),forEach(Object_keys(e),function(t){n[t]=e[t]}),forEach(globals,function(t){e[t]&&(n[t]=e[t])});var c=Object_keys(n),i=r.call(n,this.code);return forEach(Object_keys(n),function(t){(t in e||-1===indexOf(c,t))&&(e[t]=n[t])}),forEach(globals,function(t){t in e||defineProp(e,t,n[t])}),document.body.removeChild(t),i},Script.prototype.runInThisContext=function(){return eval(this.code)},Script.prototype.runInNewContext=function(e){var t=Script.createContext(e),n=this.runInContext(t);return e&&forEach(Object_keys(t),function(n){e[n]=t[n]}),n},forEach(Object_keys(Script.prototype),function(e){exports[e]=Script[e]=function(t){var n=Script(t);return n[e].apply(n,[].slice.call(arguments,1))}}),exports.isContext=function(e){return e instanceof Context},exports.createScript=function(e){return exports.Script(e)},exports.createContext=Script.createContext=function(e){var t=new Context;return"object"==typeof e&&forEach(Object_keys(e),function(n){t[n]=e[n]}),t};

},{}]},{},[112]);
